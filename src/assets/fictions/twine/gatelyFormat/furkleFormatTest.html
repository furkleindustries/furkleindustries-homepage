<!DOCTYPE html>
<html lang="en">
<head>
<title>furkleFormatTest</title>
<meta charset="utf-8">
<style>
/* global containers */
html {
	background-color: white;
}
html, body {
	width: 100%;
	height: 100%;
}
body {
	position: relative;
	margin: 0;
	font: 1rem "Helvetica Neue", Helvetica, Arial, sans-serif;
}
/* basic story elements */
tw-storydata {
	display: none;
}
tw-story, #passage {
	position: absolute;
	width: 80%;
	padding: 2.5rem;
	line-height: 145%;
}
#passage *, #passagePane *, #displayPane *, #defaultMenu * {
	font-size: inherit;
}
tw-passage {
	position: relative;
	display: inline-block;
	width: 100%;
	padding: 0.66rem;
	margin-bottom: 0.33rem;
	box-sizing: border-box;
}
tw-passage.current {
	padding: 0.66rem;
	margin-bottom: 0.33rem;
}
tw-passage.current[data-render-type="jonah"] {
	border: 0.2rem solid gold;
}
tw-passage.current[data-render-type="sugarcube"] {
	border: 0.2rem solid black;
}
tw-passage:not(.current) {
	opacity: 0.35;
	cursor: pointer;
}
tw-passage:not(.current):hover {
	box-shadow: 0 0 0.33rem black;
}
tw-passage:not(.current) {
	border: 0.2rem solid black;
}
tw-passage:not(.current) :not(.rewind):not(.fastForward) {
	pointer-events: none;
}
tw-link {
	color: red;
	font-weight: bold;
	cursor: pointer;
}
tw-history-button.back {
	top: 5%;
}
tw-history-button.forward {
	top: 35%;
}
tw-history-button {
	position: absolute;
	left: -5%;
	font-size: 1.5rem;
	font-weight: bold;
	cursor: pointer;
	visibility: hidden;
}
tw-passage.rewind tw-history-button.back {
	visibility: visible;
}
tw-passage.fastForward tw-history-button.forward {
	visibility: visible;
}
tw-header, tw-footer {
	display: block;
}
tw-transition-container[data-transition-type="dissolve"] {
	-webkit-animation-name: dissolve;
	-moz-animation-name: dissolve;
	-o-animation-name: dissolve;
	animation-name: dissolve;
}
tw-save {
	display: none;
}
/* default menu content */
#defaultMenu {
	position: fixed;
	right: 0.67em;
	top: 0.3em;
	max-width: 92.5%;
	max-width: calc(100% - 5em);
	max-height: 95%;
	max-height: calc(100% - 3.5em);
	padding-top: 0.8em;
	margin: 1.1em 1.5em 1em 0;
	box-sizing: border-box;
	z-index: 1;
	background: rgba(255, 255, 255, 0.95);
}
#defaultMenu > :not(tw-element-resizer):not(.collapser):not(.destructor):not(.active) {
	display: none;
}
#defaultMenu > .active:not(tw-element-resizer) {
	display: block;
	float: right;
	min-width: 92.5%;
	min-width: calc(100% - 1em);
	max-width: 92.5%;
	max-width: calc(100% - 1em);
}
#defaultMenu[data-choice="accessibility"] {
	right: 0;
	top: 0;
	font-size: 14pt;
	padding-top: 0.7em;
	margin: 1.1em 2em 1em 0;
}
#defaultMenu[data-choice="accessibility"] .collapser, #defaultMenu[data-choice="accessibility"] .destructor {
	right: -2em;
	top: -1em;
	font-size: 1em;
}
#defaultMenu[data-choice="accessibility"] .collapser, #defaultMenu[data-choice="accessibility"] .destructor {
	right: -2em;
	top: -1em;
	font-size: 1em;
}
#defaultMenu tw-element-resizer {
	left: -0.75em;
	bottom: -0.8em;
	border: 0.20em outset rgba(220, 220, 220, 0.8);
	box-shadow: 0 0 0.15em rgba(0, 0, 0, 0.5);
}
#defaultMenu > :not(.displayer):not(.collapser):not(.destructor):not(tw-element-resizer) {
	min-width: 20rem;
	max-width: 96.5%;
}
.collapser, .destructor {
	position: absolute;
	width: auto !important;
	height: auto !important;
	margin-left: 0.25rem;
	z-index: 1;
	cursor: pointer;
	font-size: 1rem;
}
#defaultMenu .collapser, #defaultMenu .destructor {
	right: -2rem;
	top: -1rem;
}
#defaultMenu.collapsed .collapser {
	right: -0.5rem;
	top: 0.1rem;
}
#defaultOptions tw-option {
	position: relative;
	display: block;
	border: 1px solid black;
	padding: 0.25rem;
}
#defaultOptions tw-option:not(:last-of-type) {
	margin-bottom: 0.5rem;
}
#defaultOptions tw-option:not(:first-of-type) {
	margin-top: 0.5rem;
}
#defaultOptions tw-option > button {
	position: absolute;
	display: block;
	right: 0.125rem;
	top: 0.1rem;
	width: 4.5rem;
	background: white;
}
#defaultOptions tw-option > label {
	padding: 0.2rem 0 0.1rem 0rem;
	display: inline-block;
}
#saveFilename {
	display: block;
	width: 98%;
	width: calc(100% - 6px);
}
#defaultAccessibilityDisplay div {
	position: relative;
}
#defaultAccessibilityDisplay > div:not(:first-of-type) {
	padding: 1em 2em 0 1em;
}
#defaultAccessibilityDisplay > div:not(:last-of-type) {
	padding: 0 2em 1em 1em;
}
#defaultMenu .rangeReadout {
	display: inline-block;
	width: 2.25em;
}
#defaultMenu[data-choice="addnodes"] {
	min-height: 95%;
	min-height: calc(100% - 3.5rem);
}
#defaultNodeAdder {
	display: block;
	min-width: 30rem;
}
#nodeAdderTextarea {
	position: absolute;
	width: 100%;
	height: 95%;
	height: calc(100% - 4rem);
}
#addNodesAndSave {
	position: absolute;
	bottom: 0;
}
#defaultMenu[data-choice="transcript"] {
	min-width: 40rem;
}
#defaultTranscriptDisplay {
	padding: 1rem;
	border: 0.15rem solid rgba(0, 0, 0, 0.5);
	word-break: break-word;
}
#defaultTranscriptFrame {
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	border: 0;
}
#transcriptDetailsDiv b.title {
	background: white;
	z-index: 2;
	position: relative;
}
#transcriptDetailsDiv div {
	margin-bottom: 1rem;
}
.collapsed {
	margin: 0 !important;
	padding: 0 !important;
	border: 0 !important;
}
.collapsed > :not(.collapser):not(.destructor):not(.title) {
	display: none !important;
}
tw-element-resizer {
	position: absolute;
	left: -0.75rem;
	top: 0;
	bottom: -0.8rem;
	border: 0.20rem outset rgba(220, 220, 220, 0.8);
	box-shadow: 0 0 0.15rem rgba(0, 0, 0, 0.5);
	box-sizing: border-box;
	cursor: ew-resize;
}
/* transcript iframe contents */
#passagePane, #displayPane {
	position: fixed;
	top: 0;
	width: 48.5%;
	height: 100%;
	word-break: break-word;
	overflow-y: scroll;
}
/* passagePane content */
#passagePane .entry .state:not(:last-of-type) {
	margin-bottom: 0.33rem;
}
#passagePane .title, #passagePane .value {
	position: relative;
	background: white;
	padding-right: 0.33rem;
	z-index: 1;
}
#passagePane .entry {
	position: relative;
	border: 1px solid black;
	padding: 0.33rem;
	margin: 0.5rem;
}
#passagePane .entry .title {
	font-size: 1.2rem;
	font-weight: bold;
	margin-top: 0;
}
#passagePane .entry .subtitle {
	font-weight: bold;
	cursor: pointer;
}
#passagePane tw-link {
	cursor: default;
}
#displayPane .spanner {
	position: absolute;
	top: 0;
	width: 92.5%;
	height: 0;
	cursor: pointer;
	border-top: 1px solid gray;
	padding: 2px 0 2px 0;
	margin-top: 0.825rem;
}
#displayPane p.spacer {
	margin-top: -0.67rem;
}
#passagePane tw-passage {
	border: 1px solid black !important;
}
/* displayPane content */
#displayPane {
	right: 0;
}
#displayPane > :not(tw-element-resizer):not(.collapser):not(.destructor):not(.active) {
	display: none;
}
#displayPane > .active, #displayPane #transcriptTabControl {
	display: block;
}
#transcriptTabControl {
	position: relative;
}
tw-tab {
	display: inline-block;
	border-width: 0.15rem;
	border-style: outset;
	padding: 0.15rem;
	cursor: pointer;
}
tw-tab::after {
	position: absolute;
	left: 0.01rem;
	bottom: 0;
	width: 100%;
	border-bottom: 0.15rem solid grey;
	content: "";
}
tw-tab.active {
	position: relative;
}
tw-tab.active::after {
	left: -0.1rem;
	bottom: -0.15rem;
	width: 105%;
	width: calc(100% + 0.1rem);
	border-color: white;
	z-index: 1;
}
tw-tab:not(.active) {
	background-color: buttonface;
}
#displayPane .collapser, #passagePane .collapser, #defaultAccessibilityDisplay .collapser, #displayPane .destructor, #passagePane .destructor, #defaultAccessibilityDisplay .destructor {
	right: 0;
	top: 0;
	background: white;
}
#displayPane span {
	display: block;
}
#displayPane .container {
	position: relative;
	margin: 0.75rem 0 0 2rem;
}
tw-transcript-event {
	font-weight: bold;
	color: rgba(0, 0, 255, 0.5);
	margin: 0 0.5rem 0 0.25rem;
	cursor: pointer;
	display: inline-block;
}
tw-transcript-event:hover {
	color: rgba(0, 0, 255, 0.75);
}
tw-transcript-event[unprocessed] {
	display: none;
}
/* global helpers */
.hidden {
	display: none !important;
}
.centerHorizontally {
	left: 50%;
	-webkit-transform: translateX(-50%);
	-moz-transform: translateX(-50%);
	-o-transform: translateX(-50%);
	transform: translateX(-50%);
}
.centerVertically {
	top: 50%;
	-webkit-transform: translateY(-50%);
	-moz-transform: translateY(-50%);
	-o-transform: translateY(-50%);
	transform: translateY(-50%);
}
.centerVertically {
	left: 50%;
	top: 50%;
	-webkit-transform: translate(-50%, -50%);
	-moz-transform: translateY(-50%, -50%);
	-o-transform: translateY(-50%, -50%);
	transform: translateY(-50%, -50%);
}
/* named animations */
@-webkit-keyframes dissolve {
	from {
		opacity: 0;
	}
	to {
		opacity: 1;
	}
}
@-moz-keyframes dissolve {
	from {
		opacity: 0;
	}
	to {
		opacity: 1;
	}
}
@-o-keyframes dissolve {
	from {
		opacity: 0;
	}
	to {
		opacity: 1;
	}
}
@keyframes dissolve {
	from {
		opacity: 0;
	}
	to {
		opacity: 1;
	}
	}
@keyframes dissolve {
	from {
		opacity: 0;
	}
	to {
		opacity: 1;
	}
}
</style>
<script id="jquery">/*! jQuery v2.2.4 | (c) jQuery Foundation | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=a.document,e=c.slice,f=c.concat,g=c.push,h=c.indexOf,i={},j=i.toString,k=i.hasOwnProperty,l={},m="2.2.4",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return e.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:e.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a){return n.each(this,a)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(e.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor()},push:g,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=n.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){var b=a&&a.toString();return!n.isArray(a)&&b-parseFloat(b)+1>=0},isPlainObject:function(a){var b;if("object"!==n.type(a)||a.nodeType||n.isWindow(a))return!1;if(a.constructor&&!k.call(a,"constructor")&&!k.call(a.constructor.prototype||{},"isPrototypeOf"))return!1;for(b in a);return void 0===b||k.call(a,b)},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?i[j.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=n.trim(a),a&&(1===a.indexOf("use strict")?(b=d.createElement("script"),b.text=a,d.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(s(a)){for(c=a.length;c>d;d++)if(b.call(a[d],d,a[d])===!1)break}else for(d in a)if(b.call(a[d],d,a[d])===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):g.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:h.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,e,g=0,h=[];if(s(a))for(d=a.length;d>g;g++)e=b(a[g],g,c),null!=e&&h.push(e);else for(g in a)e=b(a[g],g,c),null!=e&&h.push(e);return f.apply([],h)},guid:1,proxy:function(a,b){var c,d,f;return"string"==typeof b&&(c=a[b],b=a,a=c),n.isFunction(a)?(d=e.call(arguments,2),f=function(){return a.apply(b||this,d.concat(e.call(arguments)))},f.guid=a.guid=a.guid||n.guid++,f):void 0},now:Date.now,support:l}),"function"==typeof Symbol&&(n.fn[Symbol.iterator]=c[Symbol.iterator]),n.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(a,b){i["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=!!a&&"length"in a&&a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1*new Date,v=a.document,w=0,x=0,y=ga(),z=ga(),A=ga(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=[],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",N="\\["+L+"*("+M+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+M+"))|)"+L+"*\\]",O=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+N+")*)|.*)\\)|)",P=new RegExp(L+"+","g"),Q=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),R=new RegExp("^"+L+"*,"+L+"*"),S=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),T=new RegExp("="+L+"*([^\\]'\"]*?)"+L+"*\\]","g"),U=new RegExp(O),V=new RegExp("^"+M+"$"),W={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M+"|[*])"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},X=/^(?:input|select|textarea|button)$/i,Y=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,$=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,_=/[+~]/,aa=/'|\\/g,ba=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),ca=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},da=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E[v.childNodes.length].nodeType}catch(ea){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function fa(a,b,d,e){var f,h,j,k,l,o,r,s,w=b&&b.ownerDocument,x=b?b.nodeType:9;if(d=d||[],"string"!=typeof a||!a||1!==x&&9!==x&&11!==x)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==x&&(o=$.exec(a)))if(f=o[1]){if(9===x){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(w&&(j=w.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(o[2])return H.apply(d,b.getElementsByTagName(a)),d;if((f=o[3])&&c.getElementsByClassName&&b.getElementsByClassName)return H.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+" "]&&(!q||!q.test(a))){if(1!==x)w=b,s=a;else if("object"!==b.nodeName.toLowerCase()){(k=b.getAttribute("id"))?k=k.replace(aa,"\\$&"):b.setAttribute("id",k=u),r=g(a),h=r.length,l=V.test(k)?"#"+k:"[id='"+k+"']";while(h--)r[h]=l+" "+qa(r[h]);s=r.join(","),w=_.test(a)&&oa(b.parentNode)||b}if(s)try{return H.apply(d,w.querySelectorAll(s)),d}catch(y){}finally{k===u&&b.removeAttribute("id")}}}return i(a.replace(Q,"$1"),b,d,e)}function ga(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function ha(a){return a[u]=!0,a}function ia(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ja(a,b){var c=a.split("|"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function ka(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function la(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function na(a){return ha(function(b){return b=+b,ha(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function oa(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=fa.support={},f=fa.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=fa.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener("unload",da,!1):e.attachEvent&&e.attachEvent("onunload",da)),c.attributes=ia(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ia(function(a){return a.appendChild(n.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Z.test(n.getElementsByClassName),c.getById=ia(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return"undefined"!=typeof b.getElementsByClassName&&p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=Z.test(n.querySelectorAll))&&(ia(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\r\\' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("[msallowcapture^='']").length&&q.push("[*^$]="+L+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+L+"*(?:value|"+K+")"),a.querySelectorAll("[id~="+u+"-]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+*").length||q.push(".#.+[+~]")}),ia(function(a){var b=n.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+L+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=Z.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ia(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",O)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=Z.test(o.compareDocumentPosition),t=b||Z.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return ka(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?ka(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},fa.matches=function(a,b){return fa(a,null,null,b)},fa.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(T,"='$1']"),c.matchesSelector&&p&&!A[b+" "]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return fa(b,n,null,[a]).length>0},fa.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},fa.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},fa.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},fa.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=fa.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=fa.selectors={cacheLength:50,createPseudo:ha,match:W,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ba,ca),a[3]=(a[3]||a[4]||a[5]||"").replace(ba,ca),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||fa.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&fa.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return W.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&U.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ba,ca).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=fa.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(P," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||fa.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ha(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ha(function(a){var b=[],c=[],d=h(a.replace(Q,"$1"));return d[u]?ha(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ha(function(a){return function(b){return fa(a,b).length>0}}),contains:ha(function(a){return a=a.replace(ba,ca),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ha(function(a){return V.test(a||"")||fa.error("unsupported lang: "+a),a=a.replace(ba,ca).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Y.test(a.nodeName)},input:function(a){return X.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:na(function(){return[0]}),last:na(function(a,b){return[b-1]}),eq:na(function(a,b,c){return[0>c?c+b:c]}),even:na(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:na(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:na(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:na(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=la(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=ma(b);function pa(){}pa.prototype=d.filters=d.pseudos,d.setFilters=new pa,g=fa.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){c&&!(e=R.exec(h))||(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=S.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(Q," ")}),h=h.slice(c.length));for(g in d.filter)!(e=W[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?fa.error(a):z(a,i).slice(0)};function qa(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function ra(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j,k=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(j=b[u]||(b[u]={}),i=j[b.uniqueID]||(j[b.uniqueID]={}),(h=i[d])&&h[0]===w&&h[1]===f)return k[2]=h[2];if(i[d]=k,k[2]=a(b,c,g))return!0}}}function sa(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function ta(a,b,c){for(var d=0,e=b.length;e>d;d++)fa(a,b[d],c);return c}function ua(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(c&&!c(f,d,e)||(g.push(f),j&&b.push(h)));return g}function va(a,b,c,d,e,f){return d&&!d[u]&&(d=va(d)),e&&!e[u]&&(e=va(e,f)),ha(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||ta(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:ua(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=ua(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?J(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=ua(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function wa(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=ra(function(a){return a===b},h,!0),l=ra(function(a){return J(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];f>i;i++)if(c=d.relative[a[i].type])m=[ra(sa(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return va(i>1&&sa(m),i>1&&qa(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(Q,"$1"),c,e>i&&wa(a.slice(i,e)),f>e&&wa(a=a.slice(e)),f>e&&qa(a))}m.push(c)}return sa(m)}function xa(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s="0",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG("*",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=F.call(i));u=ua(u)}H.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&fa.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ha(f):f}return h=fa.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=wa(b[c]),f[u]?d.push(f):e.push(f);f=A(a,xa(e,d)),f.selector=a}return f},i=fa.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(ba,ca),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=W.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(ba,ca),_.test(j[0].type)&&oa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&qa(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||_.test(a)&&oa(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ia(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ia(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ja("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ia(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||ja("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ia(function(a){return null==a.getAttribute("disabled")})||ja(K,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),fa}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.uniqueSort=n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},v=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},w=n.expr.match.needsContext,x=/^<([\w-]+)\s*\/?>(?:<\/\1>|)$/,y=/^.[^:#\[\.,]*$/;function z(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(y.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return h.call(b,a)>-1!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;c>b;b++)if(n.contains(e[b],this))return!0}));for(b=0;c>b;b++)n.find(a,e[b],d);return d=this.pushStack(c>1?n.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(z(this,a||[],!1))},not:function(a){return this.pushStack(z(this,a||[],!0))},is:function(a){return!!z(this,"string"==typeof a&&w.test(a)?n(a):a||[],!1).length}});var A,B=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=n.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||A,"string"==typeof a){if(e="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:B.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),x.test(e[1])&&n.isPlainObject(b))for(e in b)n.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}return f=d.getElementById(e[2]),f&&f.parentNode&&(this.length=1,this[0]=f),this.context=d,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?void 0!==c.ready?c.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};C.prototype=n.fn,A=n(d);var D=/^(?:parents|prev(?:Until|All))/,E={children:!0,contents:!0,next:!0,prev:!0};n.fn.extend({has:function(a){var b=n(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(n.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=w.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.uniqueSort(f):f)},index:function(a){return a?"string"==typeof a?h.call(n(a),this[0]):h.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.uniqueSort(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function F(a,b){while((a=a[b])&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return u(a,"parentNode")},parentsUntil:function(a,b,c){return u(a,"parentNode",c)},next:function(a){return F(a,"nextSibling")},prev:function(a){return F(a,"previousSibling")},nextAll:function(a){return u(a,"nextSibling")},prevAll:function(a){return u(a,"previousSibling")},nextUntil:function(a,b,c){return u(a,"nextSibling",c)},prevUntil:function(a,b,c){return u(a,"previousSibling",c)},siblings:function(a){return v((a.parentNode||{}).firstChild,a)},children:function(a){return v(a.firstChild)},contents:function(a){return a.contentDocument||n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(E[a]||n.uniqueSort(e),D.test(a)&&e.reverse()),this.pushStack(e)}});var G=/\S+/g;function H(a){var b={};return n.each(a.match(G)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?H(a):n.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:"")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){n.each(b,function(b,c){n.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&"string"!==n.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return n.each(arguments,function(a,b){var c;while((c=n.inArray(b,f,c))>-1)f.splice(c,1),h>=c&&h--}),this},has:function(a){return a?n.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c="",this},disabled:function(){return!f},lock:function(){return e=g=[],c||(f=c=""),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().progress(c.notify).done(c.resolve).fail(c.reject):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=e.call(arguments),d=c.length,f=1!==d||a&&n.isFunction(a.promise)?d:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?e.call(arguments):d,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(d>1)for(i=new Array(d),j=new Array(d),k=new Array(d);d>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().progress(h(b,j,i)).done(h(b,k,c)).fail(g.reject):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(d,[n]),n.fn.triggerHandler&&(n(d).triggerHandler("ready"),n(d).off("ready"))))}});function J(){d.removeEventListener("DOMContentLoaded",J),a.removeEventListener("load",J),n.ready()}n.ready.promise=function(b){return I||(I=n.Deferred(),"complete"===d.readyState||"loading"!==d.readyState&&!d.documentElement.doScroll?a.setTimeout(n.ready):(d.addEventListener("DOMContentLoaded",J),a.addEventListener("load",J))),I.promise(b)},n.ready.promise();var K=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)K(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},L=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function M(){this.expando=n.expando+M.uid++}M.uid=1,M.prototype={register:function(a,b){var c=b||{};return a.nodeType?a[this.expando]=c:Object.defineProperty(a,this.expando,{value:c,writable:!0,configurable:!0}),a[this.expando]},cache:function(a){if(!L(a))return{};var b=a[this.expando];return b||(b={},L(a)&&(a.nodeType?a[this.expando]=b:Object.defineProperty(a,this.expando,{value:b,configurable:!0}))),b},set:function(a,b,c){var d,e=this.cache(a);if("string"==typeof b)e[b]=c;else for(d in b)e[d]=b[d];return e},get:function(a,b){return void 0===b?this.cache(a):a[this.expando]&&a[this.expando][b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,n.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=a[this.expando];if(void 0!==f){if(void 0===b)this.register(a);else{n.isArray(b)?d=b.concat(b.map(n.camelCase)):(e=n.camelCase(b),b in f?d=[b,e]:(d=e,d=d in f?[d]:d.match(G)||[])),c=d.length;while(c--)delete f[d[c]]}(void 0===b||n.isEmptyObject(f))&&(a.nodeType?a[this.expando]=void 0:delete a[this.expando])}},hasData:function(a){var b=a[this.expando];return void 0!==b&&!n.isEmptyObject(b)}};var N=new M,O=new M,P=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Q=/[A-Z]/g;function R(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(Q,"-$&").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:P.test(c)?n.parseJSON(c):c;
}catch(e){}O.set(a,b,c)}else c=void 0;return c}n.extend({hasData:function(a){return O.hasData(a)||N.hasData(a)},data:function(a,b,c){return O.access(a,b,c)},removeData:function(a,b){O.remove(a,b)},_data:function(a,b,c){return N.access(a,b,c)},_removeData:function(a,b){N.remove(a,b)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=O.get(f),1===f.nodeType&&!N.get(f,"hasDataAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),R(f,d,e[d])));N.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){O.set(this,a)}):K(this,function(b){var c,d;if(f&&void 0===b){if(c=O.get(f,a)||O.get(f,a.replace(Q,"-$&").toLowerCase()),void 0!==c)return c;if(d=n.camelCase(a),c=O.get(f,d),void 0!==c)return c;if(c=R(f,d,void 0),void 0!==c)return c}else d=n.camelCase(a),this.each(function(){var c=O.get(this,d);O.set(this,d,b),a.indexOf("-")>-1&&void 0!==c&&O.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){O.remove(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=N.get(a,b),c&&(!d||n.isArray(c)?d=N.access(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return N.get(a,c)||N.access(a,c,{empty:n.Callbacks("once memory").add(function(){N.remove(a,[b+"queue",c])})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=N.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var S=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,T=new RegExp("^(?:([+-])=|)("+S+")([a-z%]*)$","i"),U=["Top","Right","Bottom","Left"],V=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)};function W(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return n.css(a,b,"")},i=h(),j=c&&c[3]||(n.cssNumber[b]?"":"px"),k=(n.cssNumber[b]||"px"!==j&&+i)&&T.exec(n.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do f=f||".5",k/=f,n.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var X=/^(?:checkbox|radio)$/i,Y=/<([\w:-]+)/,Z=/^$|\/(?:java|ecma)script/i,$={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};$.optgroup=$.option,$.tbody=$.tfoot=$.colgroup=$.caption=$.thead,$.th=$.td;function _(a,b){var c="undefined"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||"*"):"undefined"!=typeof a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&n.nodeName(a,b)?n.merge([a],c):c}function aa(a,b){for(var c=0,d=a.length;d>c;c++)N.set(a[c],"globalEval",!b||N.get(b[c],"globalEval"))}var ba=/<|&#?\w+;/;function ca(a,b,c,d,e){for(var f,g,h,i,j,k,l=b.createDocumentFragment(),m=[],o=0,p=a.length;p>o;o++)if(f=a[o],f||0===f)if("object"===n.type(f))n.merge(m,f.nodeType?[f]:f);else if(ba.test(f)){g=g||l.appendChild(b.createElement("div")),h=(Y.exec(f)||["",""])[1].toLowerCase(),i=$[h]||$._default,g.innerHTML=i[1]+n.htmlPrefilter(f)+i[2],k=i[0];while(k--)g=g.lastChild;n.merge(m,g.childNodes),g=l.firstChild,g.textContent=""}else m.push(b.createTextNode(f));l.textContent="",o=0;while(f=m[o++])if(d&&n.inArray(f,d)>-1)e&&e.push(f);else if(j=n.contains(f.ownerDocument,f),g=_(l.appendChild(f),"script"),j&&aa(g),c){k=0;while(f=g[k++])Z.test(f.type||"")&&c.push(f)}return l}!function(){var a=d.createDocumentFragment(),b=a.appendChild(d.createElement("div")),c=d.createElement("input");c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),b.appendChild(c),l.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var da=/^key/,ea=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,fa=/^([^.]*)(?:\.(.+)|)/;function ga(){return!0}function ha(){return!1}function ia(){try{return d.activeElement}catch(a){}}function ja(a,b,c,d,e,f){var g,h;if("object"==typeof b){"string"!=typeof c&&(d=d||c,c=void 0);for(h in b)ja(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&("string"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=ha;else if(!e)return a;return 1===f&&(g=e,e=function(a){return n().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=n.guid++)),a.each(function(){n.event.add(this,b,e,d,c)})}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=N.get(a);if(r){c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=n.guid++),(i=r.events)||(i=r.events={}),(g=r.handle)||(g=r.handle=function(b){return"undefined"!=typeof n&&n.event.triggered!==b.type?n.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(G)||[""],j=b.length;while(j--)h=fa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o&&(l=n.event.special[o]||{},o=(e?l.delegateType:l.bindType)||o,l=n.event.special[o]||{},k=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},f),(m=i[o])||(m=i[o]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,p,g)!==!1||a.addEventListener&&a.addEventListener(o,g)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),n.event.global[o]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=N.hasData(a)&&N.get(a);if(r&&(i=r.events)){b=(b||"").match(G)||[""],j=b.length;while(j--)if(h=fa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=i[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;while(f--)k=m[f],!e&&q!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete i[o])}else for(o in i)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(i)&&N.remove(a,"handle events")}},dispatch:function(a){a=n.event.fix(a);var b,c,d,f,g,h=[],i=e.call(arguments),j=(N.get(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())a.rnamespace&&!a.rnamespace.test(g.namespace)||(a.handleObj=g,a.data=g.data,d=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==d&&(a.result=d)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&("click"!==a.type||isNaN(a.button)||a.button<1))for(;i!==this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?n(e,this).index(i)>-1:n.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,e,f,g=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||d,e=c.documentElement,f=c.body,a.pageX=b.clientX+(e&&e.scrollLeft||f&&f.scrollLeft||0)-(e&&e.clientLeft||f&&f.clientLeft||0),a.pageY=b.clientY+(e&&e.scrollTop||f&&f.scrollTop||0)-(e&&e.clientTop||f&&f.clientTop||0)),a.which||void 0===g||(a.which=1&g?1:2&g?3:4&g?2:0),a}},fix:function(a){if(a[n.expando])return a;var b,c,e,f=a.type,g=a,h=this.fixHooks[f];h||(this.fixHooks[f]=h=ea.test(f)?this.mouseHooks:da.test(f)?this.keyHooks:{}),e=h.props?this.props.concat(h.props):this.props,a=new n.Event(g),b=e.length;while(b--)c=e[b],a[c]=g[c];return a.target||(a.target=d),3===a.target.nodeType&&(a.target=a.target.parentNode),h.filter?h.filter(a,g):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==ia()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===ia()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&n.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}}},n.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?ga:ha):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={constructor:n.Event,isDefaultPrevented:ha,isPropagationStopped:ha,isImmediatePropagationStopped:ha,isSimulated:!1,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=ga,a&&!this.isSimulated&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=ga,a&&!this.isSimulated&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=ga,a&&!this.isSimulated&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return e&&(e===d||n.contains(d,e))||(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),n.fn.extend({on:function(a,b,c,d){return ja(this,a,b,c,d)},one:function(a,b,c,d){return ja(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return b!==!1&&"function"!=typeof b||(c=b,b=void 0),c===!1&&(c=ha),this.each(function(){n.event.remove(this,a,c,b)})}});var ka=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi,la=/<script|<style|<link/i,ma=/checked\s*(?:[^=]|=\s*.checked.)/i,na=/^true\/(.*)/,oa=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function pa(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function qa(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function ra(a){var b=na.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function sa(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(N.hasData(a)&&(f=N.access(a),g=N.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)n.event.add(b,e,j[e][c])}O.hasData(a)&&(h=O.access(a),i=n.extend({},h),O.set(b,i))}}function ta(a,b){var c=b.nodeName.toLowerCase();"input"===c&&X.test(a.type)?b.checked=a.checked:"input"!==c&&"textarea"!==c||(b.defaultValue=a.defaultValue)}function ua(a,b,c,d){b=f.apply([],b);var e,g,h,i,j,k,m=0,o=a.length,p=o-1,q=b[0],r=n.isFunction(q);if(r||o>1&&"string"==typeof q&&!l.checkClone&&ma.test(q))return a.each(function(e){var f=a.eq(e);r&&(b[0]=q.call(this,e,f.html())),ua(f,b,c,d)});if(o&&(e=ca(b,a[0].ownerDocument,!1,a,d),g=e.firstChild,1===e.childNodes.length&&(e=g),g||d)){for(h=n.map(_(e,"script"),qa),i=h.length;o>m;m++)j=e,m!==p&&(j=n.clone(j,!0,!0),i&&n.merge(h,_(j,"script"))),c.call(a[m],j,m);if(i)for(k=h[h.length-1].ownerDocument,n.map(h,ra),m=0;i>m;m++)j=h[m],Z.test(j.type||"")&&!N.access(j,"globalEval")&&n.contains(k,j)&&(j.src?n._evalUrl&&n._evalUrl(j.src):n.globalEval(j.textContent.replace(oa,"")))}return a}function va(a,b,c){for(var d,e=b?n.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||n.cleanData(_(d)),d.parentNode&&(c&&n.contains(d.ownerDocument,d)&&aa(_(d,"script")),d.parentNode.removeChild(d));return a}n.extend({htmlPrefilter:function(a){return a.replace(ka,"<$1></$2>")},clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=n.contains(a.ownerDocument,a);if(!(l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(g=_(h),f=_(a),d=0,e=f.length;e>d;d++)ta(f[d],g[d]);if(b)if(c)for(f=f||_(a),g=g||_(h),d=0,e=f.length;e>d;d++)sa(f[d],g[d]);else sa(a,h);return g=_(h,"script"),g.length>0&&aa(g,!i&&_(a,"script")),h},cleanData:function(a){for(var b,c,d,e=n.event.special,f=0;void 0!==(c=a[f]);f++)if(L(c)){if(b=c[N.expando]){if(b.events)for(d in b.events)e[d]?n.event.remove(c,d):n.removeEvent(c,d,b.handle);c[N.expando]=void 0}c[O.expando]&&(c[O.expando]=void 0)}}}),n.fn.extend({domManip:ua,detach:function(a){return va(this,a,!0)},remove:function(a){return va(this,a)},text:function(a){return K(this,function(a){return void 0===a?n.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=a)})},null,a,arguments.length)},append:function(){return ua(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=pa(this,a);b.appendChild(a)}})},prepend:function(){return ua(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=pa(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return ua(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return ua(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(n.cleanData(_(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return K(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!la.test(a)&&!$[(Y.exec(a)||["",""])[1].toLowerCase()]){a=n.htmlPrefilter(a);try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(_(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=[];return ua(this,arguments,function(b){var c=this.parentNode;n.inArray(this,a)<0&&(n.cleanData(_(this)),c&&c.replaceChild(b,this))},a)}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=[],e=n(a),f=e.length-1,h=0;f>=h;h++)c=h===f?this:this.clone(!0),n(e[h])[b](c),g.apply(d,c.get());return this.pushStack(d)}});var wa,xa={HTML:"block",BODY:"block"};function ya(a,b){var c=n(b.createElement(a)).appendTo(b.body),d=n.css(c[0],"display");return c.detach(),d}function za(a){var b=d,c=xa[a];return c||(c=ya(a,b),"none"!==c&&c||(wa=(wa||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=wa[0].contentDocument,b.write(),b.close(),c=ya(a,b),wa.detach()),xa[a]=c),c}var Aa=/^margin/,Ba=new RegExp("^("+S+")(?!px)[a-z%]+$","i"),Ca=function(b){var c=b.ownerDocument.defaultView;return c&&c.opener||(c=a),c.getComputedStyle(b)},Da=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e},Ea=d.documentElement;!function(){var b,c,e,f,g=d.createElement("div"),h=d.createElement("div");if(h.style){h.style.backgroundClip="content-box",h.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===h.style.backgroundClip,g.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",g.appendChild(h);function i(){h.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",h.innerHTML="",Ea.appendChild(g);var d=a.getComputedStyle(h);b="1%"!==d.top,f="2px"===d.marginLeft,c="4px"===d.width,h.style.marginRight="50%",e="4px"===d.marginRight,Ea.removeChild(g)}n.extend(l,{pixelPosition:function(){return i(),b},boxSizingReliable:function(){return null==c&&i(),c},pixelMarginRight:function(){return null==c&&i(),e},reliableMarginLeft:function(){return null==c&&i(),f},reliableMarginRight:function(){var b,c=h.appendChild(d.createElement("div"));return c.style.cssText=h.style.cssText="-webkit-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",c.style.marginRight=c.style.width="0",h.style.width="1px",Ea.appendChild(g),b=!parseFloat(a.getComputedStyle(c).marginRight),Ea.removeChild(g),h.removeChild(c),b}})}}();function Fa(a,b,c){var d,e,f,g,h=a.style;return c=c||Ca(a),g=c?c.getPropertyValue(b)||c[b]:void 0,""!==g&&void 0!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),c&&!l.pixelMarginRight()&&Ba.test(g)&&Aa.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f),void 0!==g?g+"":g}function Ga(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Ha=/^(none|table(?!-c[ea]).+)/,Ia={position:"absolute",visibility:"hidden",display:"block"},Ja={letterSpacing:"0",fontWeight:"400"},Ka=["Webkit","O","Moz","ms"],La=d.createElement("div").style;function Ma(a){if(a in La)return a;var b=a[0].toUpperCase()+a.slice(1),c=Ka.length;while(c--)if(a=Ka[c]+b,a in La)return a}function Na(a,b,c){var d=T.exec(b);return d?Math.max(0,d[2]-(c||0))+(d[3]||"px"):b}function Oa(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+U[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+U[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+U[f]+"Width",!0,e))):(g+=n.css(a,"padding"+U[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+U[f]+"Width",!0,e)));return g}function Pa(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=Ca(a),g="border-box"===n.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=Fa(a,b,f),(0>e||null==e)&&(e=a.style[b]),Ba.test(e))return e;d=g&&(l.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Oa(a,b,c||(g?"border":"content"),d,f)+"px"}function Qa(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=N.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&V(d)&&(f[g]=N.access(d,"olddisplay",za(d.nodeName)))):(e=V(d),"none"===c&&e||N.set(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Fa(a,"opacity");return""===c?"1":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;return b=n.cssProps[h]||(n.cssProps[h]=Ma(h)||h),g=n.cssHooks[b]||n.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=T.exec(c))&&e[1]&&(c=W(a,b,e),f="number"),null!=c&&c===c&&("number"===f&&(c+=e&&e[3]||(n.cssNumber[h]?"":"px")),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=Ma(h)||h),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=Fa(a,b,d)),"normal"===e&&b in Ja&&(e=Ja[b]),""===c||c?(f=parseFloat(e),c===!0||isFinite(f)?f||0:e):e}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?Ha.test(n.css(a,"display"))&&0===a.offsetWidth?Da(a,Ia,function(){return Pa(a,b,d)}):Pa(a,b,d):void 0},set:function(a,c,d){var e,f=d&&Ca(a),g=d&&Oa(a,b,d,"border-box"===n.css(a,"boxSizing",!1,f),f);return g&&(e=T.exec(c))&&"px"!==(e[3]||"px")&&(a.style[b]=c,c=n.css(a,b)),Na(a,c,g)}}}),n.cssHooks.marginLeft=Ga(l.reliableMarginLeft,function(a,b){return b?(parseFloat(Fa(a,"marginLeft"))||a.getBoundingClientRect().left-Da(a,{marginLeft:0},function(){return a.getBoundingClientRect().left}))+"px":void 0}),n.cssHooks.marginRight=Ga(l.reliableMarginRight,function(a,b){return b?Da(a,{display:"inline-block"},Fa,[a,"marginRight"]):void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+U[d]+b]=f[d]||f[d-2]||f[0];return e}},Aa.test(a)||(n.cssHooks[a+b].set=Na)}),n.fn.extend({css:function(a,b){return K(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Ca(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return Qa(this,!0)},hide:function(){return Qa(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){V(this)?n(this).show():n(this).hide()})}});function Ra(a,b,c,d,e){return new Ra.prototype.init(a,b,c,d,e)}n.Tween=Ra,Ra.prototype={constructor:Ra,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||n.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=Ra.propHooks[this.prop];return a&&a.get?a.get(this):Ra.propHooks._default.get(this)},run:function(a){var b,c=Ra.propHooks[this.prop];return this.options.duration?this.pos=b=n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Ra.propHooks._default.set(this),this}},Ra.prototype.init.prototype=Ra.prototype,Ra.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0)},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[n.cssProps[a.prop]]&&!n.cssHooks[a.prop]?a.elem[a.prop]=a.now:n.style(a.elem,a.prop,a.now+a.unit)}}},Ra.propHooks.scrollTop=Ra.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:"swing"},n.fx=Ra.prototype.init,n.fx.step={};var Sa,Ta,Ua=/^(?:toggle|show|hide)$/,Va=/queueHooks$/;function Wa(){return a.setTimeout(function(){Sa=void 0}),Sa=n.now()}function Xa(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=U[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function Ya(a,b,c){for(var d,e=(_a.tweeners[b]||[]).concat(_a.tweeners["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function Za(a,b,c){var d,e,f,g,h,i,j,k,l=this,m={},o=a.style,p=a.nodeType&&V(a),q=N.get(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,l.always(function(){l.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=n.css(a,"display"),k="none"===j?N.get(a,"olddisplay")||za(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(o.display="inline-block")),c.overflow&&(o.overflow="hidden",l.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],Ua.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(p?"hide":"show")){if("show"!==e||!q||void 0===q[d])continue;p=!0}m[d]=q&&q[d]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(m))"inline"===("none"===j?za(a.nodeName):j)&&(o.display=j);else{q?"hidden"in q&&(p=q.hidden):q=N.access(a,"fxshow",{}),f&&(q.hidden=!p),p?n(a).show():l.done(function(){n(a).hide()}),l.done(function(){var b;N.remove(a,"fxshow");for(b in m)n.style(a,b,m[b])});for(d in m)g=Ya(p?q[d]:0,d,l),d in q||(q[d]=g.start,p&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function $a(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function _a(a,b,c){var d,e,f=0,g=_a.prefilters.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Sa||Wa(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{},easing:n.easing._default},c),originalProperties:b,originalOptions:c,startTime:Sa||Wa(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?(h.notifyWith(a,[j,1,0]),h.resolveWith(a,[j,b])):h.rejectWith(a,[j,b]),this}}),k=j.props;for($a(k,j.opts.specialEasing);g>f;f++)if(d=_a.prefilters[f].call(j,a,k,j.opts))return n.isFunction(d.stop)&&(n._queueHooks(j.elem,j.opts.queue).stop=n.proxy(d.stop,d)),d;return n.map(k,Ya,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(_a,{tweeners:{"*":[function(a,b){var c=this.createTween(a,b);return W(c.elem,a,T.exec(b),c),c}]},tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.match(G);for(var c,d=0,e=a.length;e>d;d++)c=a[d],_a.tweeners[c]=_a.tweeners[c]||[],_a.tweeners[c].unshift(b)},prefilters:[Za],prefilter:function(a,b){b?_a.prefilters.unshift(a):_a.prefilters.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,null!=d.queue&&d.queue!==!0||(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(V).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=_a(this,n.extend({},a),f);(e||N.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=N.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&Va.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));!b&&c||n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=N.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Xa(b,!0),a,d,e)}}),n.each({slideDown:Xa("show"),slideUp:Xa("hide"),slideToggle:Xa("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=0,c=n.timers;for(Sa=n.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||n.fx.stop(),Sa=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){Ta||(Ta=a.setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){a.clearInterval(Ta),Ta=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(b,c){return b=n.fx?n.fx.speeds[b]||b:b,c=c||"fx",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a=d.createElement("input"),b=d.createElement("select"),c=b.appendChild(d.createElement("option"));a.type="checkbox",l.checkOn=""!==a.value,l.optSelected=c.selected,b.disabled=!0,l.optDisabled=!c.disabled,a=d.createElement("input"),a.value="t",a.type="radio",l.radioValue="t"===a.value}();var ab,bb=n.expr.attrHandle;n.fn.extend({attr:function(a,b){return K(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return"undefined"==typeof a.getAttribute?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),e=n.attrHooks[b]||(n.expr.match.bool.test(b)?ab:void 0)),void 0!==c?null===c?void n.removeAttr(a,b):e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+""),c):e&&"get"in e&&null!==(d=e.get(a,b))?d:(d=n.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(G);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)}}),ab={set:function(a,b,c){return b===!1?n.removeAttr(a,c):a.setAttribute(c,c),c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=bb[b]||n.find.attr;bb[b]=function(a,b,d){var e,f;return d||(f=bb[b],bb[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,bb[b]=f),e}});var cb=/^(?:input|select|textarea|button)$/i,db=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return K(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[n.propFix[a]||a]})}}),n.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&n.isXMLDoc(a)||(b=n.propFix[b]||b,e=n.propHooks[b]),
void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):cb.test(a.nodeName)||db.test(a.nodeName)&&a.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null},set:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this});var eb=/[\t\r\n\f]/g;function fb(a){return a.getAttribute&&a.getAttribute("class")||""}n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,fb(this)))});if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=fb(c),d=1===c.nodeType&&(" "+e+" ").replace(eb," ")){g=0;while(f=b[g++])d.indexOf(" "+f+" ")<0&&(d+=f+" ");h=n.trim(d),e!==h&&c.setAttribute("class",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,fb(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=fb(c),d=1===c.nodeType&&(" "+e+" ").replace(eb," ")){g=0;while(f=b[g++])while(d.indexOf(" "+f+" ")>-1)d=d.replace(" "+f+" "," ");h=n.trim(d),e!==h&&c.setAttribute("class",h)}}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):n.isFunction(a)?this.each(function(c){n(this).toggleClass(a.call(this,c,fb(this),b),b)}):this.each(function(){var b,d,e,f;if("string"===c){d=0,e=n(this),f=a.match(G)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else void 0!==a&&"boolean"!==c||(b=fb(this),b&&N.set(this,"__className__",b),this.setAttribute&&this.setAttribute("class",b||a===!1?"":N.get(this,"__className__")||""))})},hasClass:function(a){var b,c,d=0;b=" "+a+" ";while(c=this[d++])if(1===c.nodeType&&(" "+fb(c)+" ").replace(eb," ").indexOf(b)>-1)return!0;return!1}});var gb=/\r/g,hb=/[\x20\t\r\n\f]+/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(gb,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.trim(n.text(a)).replace(hb," ")}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],(c.selected||i===e)&&(l.optDisabled?!c.disabled:null===c.getAttribute("disabled"))&&(!c.parentNode.disabled||!n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=n.inArray(n.valHooks.option.get(d),f)>-1)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>-1:void 0}},l.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var ib=/^(?:focusinfocus|focusoutblur)$/;n.extend(n.event,{trigger:function(b,c,e,f){var g,h,i,j,l,m,o,p=[e||d],q=k.call(b,"type")?b.type:b,r=k.call(b,"namespace")?b.namespace.split("."):[];if(h=i=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!ib.test(q+n.event.triggered)&&(q.indexOf(".")>-1&&(r=q.split("."),q=r.shift(),r.sort()),l=q.indexOf(":")<0&&"on"+q,b=b[n.expando]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=r.join("."),b.rnamespace=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=e),c=null==c?[b]:n.makeArray(c,[b]),o=n.event.special[q]||{},f||!o.trigger||o.trigger.apply(e,c)!==!1)){if(!f&&!o.noBubble&&!n.isWindow(e)){for(j=o.delegateType||q,ib.test(j+q)||(h=h.parentNode);h;h=h.parentNode)p.push(h),i=h;i===(e.ownerDocument||d)&&p.push(i.defaultView||i.parentWindow||a)}g=0;while((h=p[g++])&&!b.isPropagationStopped())b.type=g>1?j:o.bindType||q,m=(N.get(h,"events")||{})[b.type]&&N.get(h,"handle"),m&&m.apply(h,c),m=l&&h[l],m&&m.apply&&L(h)&&(b.result=m.apply(h,c),b.result===!1&&b.preventDefault());return b.type=q,f||b.isDefaultPrevented()||o._default&&o._default.apply(p.pop(),c)!==!1||!L(e)||l&&n.isFunction(e[q])&&!n.isWindow(e)&&(i=e[l],i&&(e[l]=null),n.event.triggered=q,e[q](),n.event.triggered=void 0,i&&(e[l]=i)),b.result}},simulate:function(a,b,c){var d=n.extend(new n.Event,c,{type:a,isSimulated:!0});n.event.trigger(d,null,b)}}),n.fn.extend({trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),l.focusin="onfocusin"in a,l.focusin||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a))};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=N.access(d,b);e||d.addEventListener(a,c,!0),N.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=N.access(d,b)-1;e?N.access(d,b,e):(d.removeEventListener(a,c,!0),N.remove(d,b))}}});var jb=a.location,kb=n.now(),lb=/\?/;n.parseJSON=function(a){return JSON.parse(a+"")},n.parseXML=function(b){var c;if(!b||"string"!=typeof b)return null;try{c=(new a.DOMParser).parseFromString(b,"text/xml")}catch(d){c=void 0}return c&&!c.getElementsByTagName("parsererror").length||n.error("Invalid XML: "+b),c};var mb=/#.*$/,nb=/([?&])_=[^&]*/,ob=/^(.*?):[ \t]*([^\r\n]*)$/gm,pb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,qb=/^(?:GET|HEAD)$/,rb=/^\/\//,sb={},tb={},ub="*/".concat("*"),vb=d.createElement("a");vb.href=jb.href;function wb(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(G)||[];if(n.isFunction(c))while(d=f[e++])"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function xb(a,b,c,d){var e={},f=a===tb;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function yb(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&n.extend(!0,a,d),a}function zb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function Ab(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:jb.href,type:"GET",isLocal:pb.test(jb.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":ub,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?yb(yb(a,n.ajaxSettings),b):yb(n.ajaxSettings,a)},ajaxPrefilter:wb(sb),ajaxTransport:wb(tb),ajax:function(b,c){"object"==typeof b&&(c=b,b=void 0),c=c||{};var e,f,g,h,i,j,k,l,m=n.ajaxSetup({},c),o=m.context||m,p=m.context&&(o.nodeType||o.jquery)?n(o):n.event,q=n.Deferred(),r=n.Callbacks("once memory"),s=m.statusCode||{},t={},u={},v=0,w="canceled",x={readyState:0,getResponseHeader:function(a){var b;if(2===v){if(!h){h={};while(b=ob.exec(g))h[b[1].toLowerCase()]=b[2]}b=h[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===v?g:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return v||(a=u[c]=u[c]||a,t[a]=b),this},overrideMimeType:function(a){return v||(m.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>v)for(b in a)s[b]=[s[b],a[b]];else x.always(a[x.status]);return this},abort:function(a){var b=a||w;return e&&e.abort(b),z(0,b),this}};if(q.promise(x).complete=r.add,x.success=x.done,x.error=x.fail,m.url=((b||m.url||jb.href)+"").replace(mb,"").replace(rb,jb.protocol+"//"),m.type=c.method||c.type||m.method||m.type,m.dataTypes=n.trim(m.dataType||"*").toLowerCase().match(G)||[""],null==m.crossDomain){j=d.createElement("a");try{j.href=m.url,j.href=j.href,m.crossDomain=vb.protocol+"//"+vb.host!=j.protocol+"//"+j.host}catch(y){m.crossDomain=!0}}if(m.data&&m.processData&&"string"!=typeof m.data&&(m.data=n.param(m.data,m.traditional)),xb(sb,m,c,x),2===v)return x;k=n.event&&m.global,k&&0===n.active++&&n.event.trigger("ajaxStart"),m.type=m.type.toUpperCase(),m.hasContent=!qb.test(m.type),f=m.url,m.hasContent||(m.data&&(f=m.url+=(lb.test(f)?"&":"?")+m.data,delete m.data),m.cache===!1&&(m.url=nb.test(f)?f.replace(nb,"$1_="+kb++):f+(lb.test(f)?"&":"?")+"_="+kb++)),m.ifModified&&(n.lastModified[f]&&x.setRequestHeader("If-Modified-Since",n.lastModified[f]),n.etag[f]&&x.setRequestHeader("If-None-Match",n.etag[f])),(m.data&&m.hasContent&&m.contentType!==!1||c.contentType)&&x.setRequestHeader("Content-Type",m.contentType),x.setRequestHeader("Accept",m.dataTypes[0]&&m.accepts[m.dataTypes[0]]?m.accepts[m.dataTypes[0]]+("*"!==m.dataTypes[0]?", "+ub+"; q=0.01":""):m.accepts["*"]);for(l in m.headers)x.setRequestHeader(l,m.headers[l]);if(m.beforeSend&&(m.beforeSend.call(o,x,m)===!1||2===v))return x.abort();w="abort";for(l in{success:1,error:1,complete:1})x[l](m[l]);if(e=xb(tb,m,c,x)){if(x.readyState=1,k&&p.trigger("ajaxSend",[x,m]),2===v)return x;m.async&&m.timeout>0&&(i=a.setTimeout(function(){x.abort("timeout")},m.timeout));try{v=1,e.send(t,z)}catch(y){if(!(2>v))throw y;z(-1,y)}}else z(-1,"No Transport");function z(b,c,d,h){var j,l,t,u,w,y=c;2!==v&&(v=2,i&&a.clearTimeout(i),e=void 0,g=h||"",x.readyState=b>0?4:0,j=b>=200&&300>b||304===b,d&&(u=zb(m,x,d)),u=Ab(m,u,x,j),j?(m.ifModified&&(w=x.getResponseHeader("Last-Modified"),w&&(n.lastModified[f]=w),w=x.getResponseHeader("etag"),w&&(n.etag[f]=w)),204===b||"HEAD"===m.type?y="nocontent":304===b?y="notmodified":(y=u.state,l=u.data,t=u.error,j=!t)):(t=y,!b&&y||(y="error",0>b&&(b=0))),x.status=b,x.statusText=(c||y)+"",j?q.resolveWith(o,[l,y,x]):q.rejectWith(o,[x,y,t]),x.statusCode(s),s=void 0,k&&p.trigger(j?"ajaxSuccess":"ajaxError",[x,m,j?l:t]),r.fireWith(o,[x,y]),k&&(p.trigger("ajaxComplete",[x,m]),--n.active||n.event.trigger("ajaxStop")))}return x},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax(n.extend({url:a,type:b,dataType:e,data:c,success:d},n.isPlainObject(a)&&a))}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){var b;return n.isFunction(a)?this.each(function(b){n(this).wrapAll(a.call(this,b))}):(this[0]&&(b=n(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return n.isFunction(a)?this.each(function(b){n(this).wrapInner(a.call(this,b))}):this.each(function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}}),n.expr.filters.hidden=function(a){return!n.expr.filters.visible(a)},n.expr.filters.visible=function(a){return a.offsetWidth>0||a.offsetHeight>0||a.getClientRects().length>0};var Bb=/%20/g,Cb=/\[\]$/,Db=/\r?\n/g,Eb=/^(?:submit|button|image|reset|file)$/i,Fb=/^(?:input|select|textarea|keygen)/i;function Gb(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||Cb.test(a)?d(a,e):Gb(a+"["+("object"==typeof e&&null!=e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)Gb(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)Gb(c,a[c],b,e);return d.join("&").replace(Bb,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&Fb.test(this.nodeName)&&!Eb.test(a)&&(this.checked||!X.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(Db,"\r\n")}}):{name:b.name,value:c.replace(Db,"\r\n")}}).get()}}),n.ajaxSettings.xhr=function(){try{return new a.XMLHttpRequest}catch(b){}};var Hb={0:200,1223:204},Ib=n.ajaxSettings.xhr();l.cors=!!Ib&&"withCredentials"in Ib,l.ajax=Ib=!!Ib,n.ajaxTransport(function(b){var c,d;return l.cors||Ib&&!b.crossDomain?{send:function(e,f){var g,h=b.xhr();if(h.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(g in b.xhrFields)h[g]=b.xhrFields[g];b.mimeType&&h.overrideMimeType&&h.overrideMimeType(b.mimeType),b.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest");for(g in e)h.setRequestHeader(g,e[g]);c=function(a){return function(){c&&(c=d=h.onload=h.onerror=h.onabort=h.onreadystatechange=null,"abort"===a?h.abort():"error"===a?"number"!=typeof h.status?f(0,"error"):f(h.status,h.statusText):f(Hb[h.status]||h.status,h.statusText,"text"!==(h.responseType||"text")||"string"!=typeof h.responseText?{binary:h.response}:{text:h.responseText},h.getAllResponseHeaders()))}},h.onload=c(),d=h.onerror=c("error"),void 0!==h.onabort?h.onabort=d:h.onreadystatechange=function(){4===h.readyState&&a.setTimeout(function(){c&&d()})},c=c("abort");try{h.send(b.hasContent&&b.data||null)}catch(i){if(c)throw i}},abort:function(){c&&c()}}:void 0}),n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(e,f){b=n("<script>").prop({charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&f("error"===a.type?404:200,a.type)}),d.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Jb=[],Kb=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Jb.pop()||n.expando+"_"+kb++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Kb.test(b.url)?"url":"string"==typeof b.data&&0===(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Kb.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Kb,"$1"+e):b.jsonp!==!1&&(b.url+=(lb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?n(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Jb.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||d;var e=x.exec(a),f=!c&&[];return e?[b.createElement(e[1])]:(e=ca([a],b,f),f&&f.length&&n(f).remove(),n.merge([],e.childNodes))};var Lb=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&Lb)return Lb.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>-1&&(d=n.trim(a.slice(h)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e||"GET",dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(this,f||[a.responseText,b,a])})}),this},n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};function Mb(a){return n.isWindow(a)?a:9===a.nodeType&&a.defaultView}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,n.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,n.contains(b,d)?(e=d.getBoundingClientRect(),c=Mb(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===n.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(d=a.offset()),d.top+=n.css(a[0],"borderTopWidth",!0),d.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-n.css(c,"marginTop",!0),left:b.left-d.left-n.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Ea})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c="pageYOffset"===b;n.fn[a]=function(d){return K(this,function(a,d,e){var f=Mb(a);return void 0===e?f?f[b]:a[d]:void(f?f.scrollTo(c?f.pageXOffset:e,c?e:f.pageYOffset):a[d]=e)},a,d,arguments.length)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=Ga(l.pixelPosition,function(a,c){return c?(c=Fa(a,b),Ba.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return K(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)},size:function(){return this.length}}),n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var Nb=a.jQuery,Ob=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=Ob),b&&a.jQuery===n&&(a.jQuery=Nb),n},b||(a.jQuery=a.$=n),n});</script>
<script id="tracery">/**
 * @author Kate
 */

var tracery = function() {
	var rng = Math.random;

	var setRng = function setRng(newRng) {
		rng = newRng;
	};

	var TraceryNode = function(parent, childIndex, settings) {
		this.errors = [];

		// No input? Add an error, but continue anyways
		if (settings.raw === undefined) {
			this.errors.push("Empty input for node");
			settings.raw = "";
		}

		// If the root node of an expansion, it will have the grammar passed as the 'parent'
		//  set the grammar from the 'parent', and set all other values for a root node
		if ( parent instanceof tracery.Grammar) {
			this.grammar = parent;
			this.parent = null;
			this.depth = 0;
			this.childIndex = 0;
		} else {
			this.grammar = parent.grammar;
			this.parent = parent;
			this.depth = parent.depth + 1;
			this.childIndex = childIndex;
		}

		this.raw = settings.raw;
		this.type = settings.type;
		this.isExpanded = false;

		if (!this.grammar) {
			console.warn("No grammar specified for this node", this);
		}

	};

	TraceryNode.prototype.toString = function() {
		return "Node('" + this.raw + "' " + this.type + " d:" + this.depth + ")";
	};

	// Expand the node (with the given child rule)
	//  Make children if the node has any
	TraceryNode.prototype.expandChildren = function(childRule, preventRecursion) {
		this.children = [];
		this.finishedText = "";

		// Set the rule for making children,
		// and expand it into section
		this.childRule = childRule;
		if (this.childRule !== undefined) {
			var sections = tracery.parse(childRule);

			// Add errors to this
			if (sections.errors.length > 0) {
				this.errors = this.errors.concat(sections.errors);

			}

			for (var i = 0; i < sections.length; i++) {
				this.children[i] = new TraceryNode(this, i, sections[i]);
				if (!preventRecursion)
					this.children[i].expand(preventRecursion);

				// Add in the finished text
				this.finishedText += this.children[i].finishedText;
			}
		} else {
			// In normal operation, this shouldn't ever happen
			this.errors.push("No child rule provided, can't expand children");
			console.warn("No child rule provided, can't expand children");
		}
	};

	// Expand this rule (possibly creating children)
	TraceryNode.prototype.expand = function(preventRecursion) {

		if (!this.isExpanded) {
			this.isExpanded = true;

			this.expansionErrors = [];

			// Types of nodes
			// -1: raw, needs parsing
			//  0: Plaintext
			//  1: Tag ("#symbol.mod.mod2.mod3#" or "#[pushTarget:pushRule]symbol.mod")
			//  2: Action ("[pushTarget:pushRule], [pushTarget:POP]", more in the future)

			switch(this.type) {
			// Raw rule
			case -1:

				this.expandChildren(this.raw, preventRecursion);
				break;

			// plaintext, do nothing but copy text into finsihed text
			case 0:
				this.finishedText = this.raw;
				break;

			// Tag
			case 1:
				// Parse to find any actions, and figure out what the symbol is
				this.preactions = [];
				this.postactions = [];

				var parsed = tracery.parseTag(this.raw);

				// Break into symbol actions and modifiers
				this.symbol = parsed.symbol;
				this.modifiers = parsed.modifiers;

				// Create all the preactions from the raw syntax
				for (var i = 0; i < parsed.preactions.length; i++) {
					this.preactions[i] = new NodeAction(this, parsed.preactions[i].raw);
				}
				for (var i = 0; i < parsed.postactions.length; i++) {
					//   this.postactions[i] = new NodeAction(this, parsed.postactions[i].raw);
				}

				// Make undo actions for all preactions (pops for each push)
				for (var i = 0; i < this.preactions.length; i++) {
					if (this.preactions[i].type === 0)
						this.postactions.push(this.preactions[i].createUndo());
				}

				// Activate all the preactions
				for (var i = 0; i < this.preactions.length; i++) {
					this.preactions[i].activate();
				}

				this.finishedText = this.raw;

				// Expand (passing the node, this allows tracking of recursion depth)

				var selectedRule = this.grammar.selectRule(this.symbol, this, this.errors);

				this.expandChildren(selectedRule, preventRecursion);

				// Apply modifiers
				// TODO: Update parse function to not trigger on hashtags within parenthesis within tags,
				//   so that modifier parameters can contain tags "#story.replace(#protagonist#, #newCharacter#)#"
				for (var i = 0; i < this.modifiers.length; i++) {
					var modName = this.modifiers[i];
					var modParams = [];
					if (modName.indexOf("(") > 0) {
						var regExp = /\(([^)]+)\)/;

						// Todo: ignore any escaped commas.  For now, commas always split
						var results = regExp.exec(this.modifiers[i]);
						if (!results || results.length < 2) {
						} else {
							var modParams = results[1].split(",");
							modName = this.modifiers[i].substring(0, modName.indexOf("("));
						}

					}

					var mod = this.grammar.modifiers[modName];

					// Missing modifier?
					if (!mod) {
						this.errors.push("Missing modifier " + modName);
						this.finishedText += "((." + modName + "))";
					} else {
						this.finishedText = mod(this.finishedText, modParams);

					}

				}

				// Perform post-actions
				for (var i = 0; i < this.postactions.length; i++) {
					this.postactions[i].activate();
				}
				break;
			case 2:

				// Just a bare action?  Expand it!
				this.action = new NodeAction(this, this.raw);
				this.action.activate();

				// No visible text for an action
				// TODO: some visible text for if there is a failure to perform the action?
				this.finishedText = "";
				break;

			}

		} else {
			//console.warn("Already expanded " + this);
		}

	};

	TraceryNode.prototype.clearEscapeChars = function() {

		this.finishedText = this.finishedText.replace(/\\\\/g, "DOUBLEBACKSLASH").replace(/\\/g, "").replace(/DOUBLEBACKSLASH/g, "\\");
	};

	// An action that occurs when a node is expanded
	// Types of actions:
	// 0 Push: [key:rule]
	// 1 Pop: [key:POP]
	// 2 function: [functionName(param0,param1)] (TODO!)
	function NodeAction(node, raw) {
		/*
		 if (!node)
		 console.warn("No node for NodeAction");
		 if (!raw)
		 console.warn("No raw commands for NodeAction");
		 */

		this.node = node;

		var sections = raw.split(":");
		this.target = sections[0];

		// No colon? A function!
		if (sections.length === 1) {
			this.type = 2;

		}

		// Colon? It's either a push or a pop
		else {
			this.rule = sections[1];
			if (this.rule === "POP") {
				this.type = 1;
			} else {
				this.type = 0;
			}
		}
	}


	NodeAction.prototype.createUndo = function() {
		if (this.type === 0) {
			return new NodeAction(this.node, this.target + ":POP");
		}
		// TODO Not sure how to make Undo actions for functions or POPs
		return null;
	};

	NodeAction.prototype.activate = function() {
		var grammar = this.node.grammar;
		switch(this.type) {
		case 0:
			// split into sections (the way to denote an array of rules)
			this.ruleSections = this.rule.split(",");
			this.finishedRules = [];
			this.ruleNodes = [];
			for (var i = 0; i < this.ruleSections.length; i++) {
				var n = new TraceryNode(grammar, 0, {
					type : -1,
					raw : this.ruleSections[i]
				});

				n.expand();

				this.finishedRules.push(n.finishedText);
			}

			// TODO: escape commas properly
			grammar.pushRules(this.target, this.finishedRules, this);
			break;
		case 1:
			grammar.popRules(this.target);
			break;
		case 2:
			grammar.flatten(this.target, true);
			break;
		}

	};

	NodeAction.prototype.toText = function() {
		switch(this.type) {
		case 0:
			return this.target + ":" + this.rule;
		case 1:
			return this.target + ":POP";
		case 2:
			return "((some function))";
		default:
			return "((Unknown Action))";
		}
	};

	// Sets of rules
	// Can also contain conditional or fallback sets of rulesets)
	function RuleSet(grammar, raw) {
		this.raw = raw;
		this.grammar = grammar;
		this.falloff = 1;

		if (Array.isArray(raw)) {
			this.defaultRules = raw;
		} else if ( typeof raw === 'string' || raw instanceof String) {
			this.defaultRules = [raw];
		} else if (raw === 'object') {
			// TODO: support for conditional and hierarchical rule sets
		}

	};

	RuleSet.prototype.selectRule = function(errors) {
		// console.log("Get rule", this.raw);
		// Is there a conditional?
		if (this.conditionalRule) {
			var value = this.grammar.expand(this.conditionalRule, true);
			// does this value match any of the conditionals?
			if (this.conditionalValues[value]) {
				var v = this.conditionalValues[value].selectRule(errors);
				if (v !== null && v !== undefined)
					return v;
			}
			// No returned value?
		}

		// Is there a ranked order?
		if (this.ranking) {
			for (var i = 0; i < this.ranking.length; i++) {
				var v = this.ranking.selectRule();
				if (v !== null && v !== undefined)
					return v;
			}

			// Still no returned value?
		}

		if (this.defaultRules !== undefined) {
			var index = 0;
			// Select from this basic array of rules

			// Get the distribution from the grammar if there is no other
			var distribution = this.distribution;
			if (!distribution)
				distribution = this.grammar.distribution;

			switch(distribution) {
			case "shuffle":

				// create a shuffle desk
				if (!this.shuffledDeck || this.shuffledDeck.length === 0) {
					// make an array
					this.shuffledDeck = fyshuffle(Array.apply(null, {
						length : this.defaultRules.length
					}).map(Number.call, Number), this.falloff);

				}

				index = this.shuffledDeck.pop();

				break;
			case "weighted":
				errors.push("Weighted distribution not yet implemented");
				break;
			case "falloff":
				errors.push("Falloff distribution not yet implemented");
				break;
			default:

				index = Math.floor(Math.pow(rng(), this.falloff) * this.defaultRules.length);
				break;
			}

			if (!this.defaultUses)
				this.defaultUses = [];
			this.defaultUses[index] = ++this.defaultUses[index] || 1;
			return this.defaultRules[index];
		}

		errors.push("No default rules defined for " + this);
		return null;

	};

	RuleSet.prototype.clearState = function() {

		if (this.defaultUses) {
			this.defaultUses = [];
		}
	};

	function fyshuffle(array, falloff) {
		var currentIndex = array.length,
		    temporaryValue,
		    randomIndex;

		// While there remain elements to shuffle...
		while (0 !== currentIndex) {

			// Pick a remaining element...
			randomIndex = Math.floor(rng() * currentIndex);
			currentIndex -= 1;

			// And swap it with the current element.
			temporaryValue = array[currentIndex];
			array[currentIndex] = array[randomIndex];
			array[randomIndex] = temporaryValue;
		}

		return array;
	}

	var Symbol = function(grammar, key, rawRules) {
		// Symbols can be made with a single value, and array, or array of objects of (conditions/values)
		this.key = key;
		this.grammar = grammar;
		this.rawRules = rawRules;

		this.baseRules = new RuleSet(this.grammar, rawRules);
		this.clearState();

	};

	Symbol.prototype.clearState = function() {

		// Clear the stack and clear all ruleset usages
		this.stack = [this.baseRules];

		this.uses = [];
		this.baseRules.clearState();
	};

	Symbol.prototype.pushRules = function(rawRules) {
		var rules = new RuleSet(this.grammar, rawRules);
		this.stack.push(rules);
	};

	Symbol.prototype.popRules = function() {
		this.stack.pop();
	};

	Symbol.prototype.selectRule = function(node, errors) {
		this.uses.push({
			node : node
		});

		if (this.stack.length === 0) {
			errors.push("The rule stack for '" + this.key + "' is empty, too many pops?");
			return "((" + this.key + "))";
		}

		return this.stack[this.stack.length - 1].selectRule();
	};

	Symbol.prototype.getActiveRules = function() {
		if (this.stack.length === 0) {
			return null;
		}
		return this.stack[this.stack.length - 1].selectRule();
	};

	Symbol.prototype.rulesToJSON = function() {
		return JSON.stringify(this.rawRules);
	};

	var Grammar = function(raw, settings) {
		this.modifiers = {};
		this.loadFromRawObj(raw);
	};

	Grammar.prototype.clearState = function() {
		var keys = Object.keys(this.symbols);
		for (var i = 0; i < keys.length; i++) {
			this.symbols[keys[i]].clearState();
		}
	};

	Grammar.prototype.addModifiers = function(mods) {

		// copy over the base modifiers
		for (var key in mods) {
			if (mods.hasOwnProperty(key)) {
				this.modifiers[key] = mods[key];
			}
		};

	};

	Grammar.prototype.loadFromRawObj = function(raw) {

		this.raw = raw;
		this.symbols = {};
		this.subgrammars = [];

		if (this.raw) {
			// Add all rules to the grammar
			for (var key in this.raw) {
				if (this.raw.hasOwnProperty(key)) {
					this.symbols[key] = new Symbol(this, key, this.raw[key]);
				}
			}
		}
	};

	Grammar.prototype.createRoot = function(rule) {
		// Create a node and subnodes
		var root = new TraceryNode(this, 0, {
			type : -1,
			raw : rule,
		});

		return root;
	};

	Grammar.prototype.expand = function(rule, allowEscapeChars) {
		var root = this.createRoot(rule);
		root.expand();
		if (!allowEscapeChars)
			root.clearEscapeChars();

		return root;
	};

	Grammar.prototype.flatten = function(rule, allowEscapeChars) {
		var root = this.expand(rule, allowEscapeChars);

		return root.finishedText;
	};

	Grammar.prototype.toJSON = function() {
		var keys = Object.keys(this.symbols);
		var symbolJSON = [];
		for (var i = 0; i < keys.length; i++) {
			var key = keys[i];
			symbolJSON.push(' "' + key + '" : ' + this.symbols[key].rulesToJSON());
		}
		return "{\n" + symbolJSON.join(",\n") + "\n}";
	};

	// Create or push rules
	Grammar.prototype.pushRules = function(key, rawRules, sourceAction) {

		if (this.symbols[key] === undefined) {
			this.symbols[key] = new Symbol(this, key, rawRules);
			if (sourceAction)
				this.symbols[key].isDynamic = true;
		} else {
			this.symbols[key].pushRules(rawRules);
		}
	};

	Grammar.prototype.popRules = function(key) {
		if (!this.symbols[key])
			this.errors.push("Can't pop: no symbol for key " + key);
		this.symbols[key].popRules();
	};

	Grammar.prototype.selectRule = function(key, node, errors) {
		if (this.symbols[key]) {
			var rule = this.symbols[key].selectRule(node, errors);

			return rule;
		}

		// Failover to alternative subgrammars
		for (var i = 0; i < this.subgrammars.length; i++) {

			if (this.subgrammars[i].symbols[key])
				return this.subgrammars[i].symbols[key].selectRule();
		}

		// No symbol?
		errors.push("No symbol for '" + key + "'");
		return "((" + key + "))";
	};

	// Parses a plaintext rule in the tracery syntax
	tracery = {

		createGrammar : function(raw) {
			return new Grammar(raw);
		},

		// Parse the contents of a tag
		parseTag : function(tagContents) {

			var parsed = {
				symbol : undefined,
				preactions : [],
				postactions : [],
				modifiers : []
			};
			var sections = tracery.parse(tagContents);
			var symbolSection = undefined;
			for (var i = 0; i < sections.length; i++) {
				if (sections[i].type === 0) {
					if (symbolSection === undefined) {
						symbolSection = sections[i].raw;
					} else {
						throw ("multiple main sections in " + tagContents);
					}
				} else {
					parsed.preactions.push(sections[i]);
				}
			}

			if (symbolSection === undefined) {
				//   throw ("no main section in " + tagContents);
			} else {
				var components = symbolSection.split(".");
				parsed.symbol = components[0];
				parsed.modifiers = components.slice(1);
			}
			return parsed;
		},

		parse : function(rule) {
			var depth = 0;
			var inTag = false;
			var sections = [];
			var escaped = false;

			var errors = [];
			var start = 0;

			var escapedSubstring = "";
			var lastEscapedChar = undefined;

			if (rule === null) {
				var sections = [];
				sections.errors = errors;

				return sections;
			}

			function createSection(start, end, type) {
				if (end - start < 1) {
					if (type === 1)
						errors.push(start + ": empty tag");
					if (type === 2)
						errors.push(start + ": empty action");

				}
				var rawSubstring;
				if (lastEscapedChar !== undefined) {
					rawSubstring = escapedSubstring + "\\" + rule.substring(lastEscapedChar + 1, end);

				} else {
					rawSubstring = rule.substring(start, end);
				}
				sections.push({
					type : type,
					raw : rawSubstring
				});
				lastEscapedChar = undefined;
				escapedSubstring = "";
			};

			for (var i = 0; i < rule.length; i++) {

				if (!escaped) {
					var c = rule.charAt(i);

					switch(c) {

					// Enter a deeper bracketed section
					case '[':
						if (depth === 0 && !inTag) {
							if (start < i)
								createSection(start, i, 0);
							start = i + 1;
						}
						depth++;
						break;

					case ']':
						depth--;

						// End a bracketed section
						if (depth === 0 && !inTag) {
							createSection(start, i, 2);
							start = i + 1;
						}
						break;

					// Hashtag
					//   ignore if not at depth 0, that means we are in a bracket
					case '#':
						if (depth === 0) {
							if (inTag) {
								createSection(start, i, 1);
								start = i + 1;
							} else {
								if (start < i)
									createSection(start, i, 0);
								start = i + 1;
							}
							inTag = !inTag;
						}
						break;

					case '\\':
						escaped = true;
						escapedSubstring = escapedSubstring + rule.substring(start, i);
						start = i + 1;
						lastEscapedChar = i;
						break;
					}
				} else {
					escaped = false;
				}
			}
			if (start < rule.length)
				createSection(start, rule.length, 0);

			if (inTag) {
				errors.push("Unclosed tag");
			}
			if (depth > 0) {
				errors.push("Too many [");
			}
			if (depth < 0) {
				errors.push("Too many ]");
			}

			// Strip out empty plaintext sections

			sections = sections.filter(function(section) {
				if (section.type === 0 && section.raw.length === 0)
					return false;
				return true;
			});
			sections.errors = errors;
			return sections;
		},
	};

	// Externalize
	tracery.TraceryNode = TraceryNode;

	tracery.Grammar = Grammar;
	tracery.Symbol = Symbol;
	tracery.RuleSet = RuleSet;

	tracery.setRng = setRng;

	return tracery;
}();

//module.exports = tracery; 

/**
 * @author Kate
 */

tracery.Grammar.prototype.calculateDepth = function(originWord) {
    // Iterate through the grammar and tag each symbol with the depth it's visited at
    var keys = Object.keys(this.symbols);
    var symbols = this.symbols;
    $.each(keys, function(index, key) {
       
        var symbol = symbols[key];
        symbol.stats = {
            visits : [],
            leafPct : 0,
        };

        // Flag if a leaf symbol
        var rules = symbol.getActiveRules();
     //   console.log(rules);

    });
};

tracery.Grammar.prototype.distributionVisualization = function(holder, settings) {
    // Create the visualization of usages
    // For each symbol in the grammar, count how many times it was used
    holder.html("");
    var keys = Object.keys(this.symbols);
    var unused = [];
    $.each(keys, function(index, key) {
        var s = app.grammar.symbols[key];
        if (s.uses.length > 0) {
            // Analyze use data
            var totalDepth = 0;
            for (var i = 0; i < s.uses.length; i++) {
                totalDepth += s.uses[i].node.depth;
            }
            totalDepth /= s.uses.length;

            var div = $("<div/>", {
                class : "tracery-usage-graph",
            }).appendTo(holder);

            var label = $("<div/>", {
                class : "label",
                text : key + ": " + s.uses.length + " d:" + totalDepth.toFixed(1)
            }).appendTo(div);

            var graph = $("<div/>", {
                class : "bars",
            }).appendTo(div);

            /*
             $.each(s.uses, function(index, use) {
             var use = $("<div/>", {
             class : "use",
             html : use.node.raw + " " + use.node.depth,
             }).appendTo(graph);
             });
             */

            if (s.baseRules.defaultRules) {
                var count = s.baseRules.defaultRules.length;
                var max = 0;
                $.each(s.baseRules.defaultRules, function(index, rule) {
                    if (s.baseRules.defaultUses[index])
                        max = Math.max(s.baseRules.defaultUses[index], max);
                });
                $.each(s.baseRules.defaultRules, function(index, rule) {

                    var useCount = 0;
                    var h = 1;
                    if (s.baseRules.defaultUses[index]) {
                        h = s.baseRules.defaultUses[index] / max * 100;
                        useCount = s.baseRules.defaultUses[index];
                    }
                    var bar = $("<div/>", {
                        class : "bar",
                    }).appendTo(graph).css({
                        width : h + "%",
                        top : ((index / count) * 100) + "%",
                        height : ((1 / count) * 100) + "%",

                    });

                    var label = $("<div/>", {
                        class : "bar-label",
                        text : useCount + " " + rule ,
                    }).appendTo(bar);

                });
            }
        } else {
            unused.push(s);
        }
        // console.log(unused);
    });

};

tracery.Grammar.prototype.cascadeVisualization = function(holder, settings) {
    var symbols = $("<div/>", {
        class : "grammar-viz",
    }).appendTo(holder);

    for (var key in this.symbols) {
        var symbol = this.symbols[key];

        var symbolDiv = $("<div/>", {
            class : "symbol",
        }).appendTo(symbols);

        var header = $("<div/>", {
            class : "header",
            text : key
        }).appendTo(symbolDiv);

        // Show all the rules

        var baseRuleHolder = $("<div/>", {
            class : "rules",

        }).appendTo(symbolDiv);

        var rules = symbol.baseRules;
        if (!rules) {
            console.log(symbol);
        }

        for (var i = 0; i < rules.length; i++) {
            ruleToDiv(rules[i]).appendTo(baseRuleHolder);
        }
    }
};

function ruleToDiv(rule) {
    var sections = tracery.parse(rule);

    var div = $("<div/>", {
        class : "rule",

    });

    for (var i = 0; i < sections.length; i++) {
        var sectionDiv = $("<div/>", {
            class : "section section" + sections[i].type,
            text : sections[i].raw,
        }).appendTo(div);
    }

    return div;
};

tracery.Grammar.prototype.referenceVisualization = function(holder, settings) {

};

tracery.TraceryNode.prototype.visualizeExpansion = function(holder, settings) {

    var div = $("<div/>", {
        class : "tracery-node tracery-node" + this.type,
    }).appendTo(holder);

    if (this === settings.active) {
        div.addClass("active");
    }

    if (this.grammar.symbols[this.symbol]) {

        if (this.grammar.symbols[this.symbol].isDynamic) {
            div.addClass("dynamic");
        }
    } else {
        div.addClass("missing");

    }

    var header = $("<div/>", {
        class : "header",
    }).appendTo(div);

    if (this.type === 1) {
        header.text(this.symbol);
    } else {
        header.text(this.finishedText);
    }

    if (this.preActions) {
        $.each(this.preActions, function(index, action) {
            var command = $("<div/>", {
                class : "action-command",
                text : action.target + ":" + action.rule
            }).appendTo(div);

            var text = $("<div/>", {
                class : "action-text",
                text : action.ruleText
            }).appendTo(div);
        });
    }

    if (this.children) {
        var childHolder = $("<div/>", {
            class : "children",

        }).appendTo(div);

        for (var i = 0; i < this.children.length; i++) {
            this.children[i].visualizeExpansion(childHolder, settings);
        }
    }
};

tracery.rawGrammarToPrettyHTML = function(raw) {

    // Escape any raw html
    var s = "";
    var keyOutputs = [];
    for (var key in raw) {
        if (raw.hasOwnProperty(key)) {
            var rules = JSON.stringify(raw[key]);
            rules = escapeHTML(rules);
            keyOutputs.push("<b>\"" + key + "\":</b>" + rules);
        }
    }
    return keyOutputs.join(",<br>");
};

/**
 * @author Kate
 */

function isVowel(c) {
	var c2 = c.toLowerCase();
	return (c2 === 'a') || (c2 === 'e') || (c2 === 'i') || (c2 === 'o') || (c2 === 'u');
};

function isAlphaNum(c) {
	return (c >= 'a' && c <= 'z') || (c >= 'A' && c <= 'Z') || (c >= '0' && c <= '9');
};
function escapeRegExp(str) {
	return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
}

var baseEngModifiers = {

	replace : function(s, params) {
		//http://stackoverflow.com/questions/1144783/replacing-all-occurrences-of-a-string-in-javascript
		return s.replace(new RegExp(escapeRegExp(params[0]), 'g'), params[1]);
	},

	capitalizeAll : function(s) {
		var s2 = "";
		var capNext = true;
		for (var i = 0; i < s.length; i++) {

			if (!isAlphaNum(s.charAt(i))) {
				capNext = true;
				s2 += s.charAt(i);
			} else {
				if (!capNext) {
					s2 += s.charAt(i);
				} else {
					s2 += s.charAt(i).toUpperCase();
					capNext = false;
				}

			}
		}
		return s2;
	},

	capitalize : function(s) {
		return s.charAt(0).toUpperCase() + s.substring(1);
	},

	a : function(s) {
		if (s.length > 0) {
			if (s.charAt(0).toLowerCase() === 'u') {
				if (s.length > 2) {
					if (s.charAt(2).toLowerCase() === 'i')
						return "a " + s;
				}
			}

			if (isVowel(s.charAt(0))) {
				return "an " + s;
			}
		}

		return "a " + s;

	},

	firstS : function(s) {
		console.log(s);
		var s2 = s.split(" ");

		var finished = baseEngModifiers.s(s2[0]) + " " + s2.slice(1).join(" ");
		console.log(finished);
		return finished;
	},

	s : function(s) {
		switch (s.charAt(s.length -1)) {
		case 's':
			return s + "es";
			break;
		case 'h':
			return s + "es";
			break;
		case 'x':
			return s + "es";
			break;
		case 'y':
			if (!isVowel(s.charAt(s.length - 2)))
				return s.substring(0, s.length - 1) + "ies";
			else
				return s + "s";
			break;
		default:
			return s + "s";
		}
	},
	ed : function(s) {
		switch (s.charAt(s.length -1)) {
		case 's':
			return s + "ed";
			break;
		case 'e':
			return s + "d";
			break;
		case 'h':
			return s + "ed";
			break;
		case 'x':
			return s + "ed";
			break;
		case 'y':
			if (!isVowel(s.charAt(s.length - 2)))
				return s.substring(0, s.length - 1) + "ied";
			else
				return s + "d";
			break;
		default:
			return s + "ed";
		}
	}
};

/**
 * @author Kate
 */

function NodeIterator(node) {
    this.node = node;
    this.childIndex = -1;

    this.mode = 0;

};

var itSpacer = "";
// Go to the next
NodeIterator.prototype.next = function() {

    // Actions for this node
    // 0: Just entered
    // 1: Start children
    // 2: Children finished, exit

    switch(this.mode) {
    case 0:
        itSpacer += "   ";
        this.mode = 1;
        return {
            log : itSpacer + "Enter " + this.node
        };

        break;
    case 1:
        if (!this.node.children || this.node.children.length === 0) {
            this.mode = 2;
            return {
                log : itSpacer + "start children: no children"
            };
        } else {
            var childCount = this.node.children.length;
            this.node = this.node.children[0];
            this.mode = 0;
            return {
                log : itSpacer + "starting 0 of " + childCount + " children"
            };
        }
        break;
    case 2:
        itSpacer = itSpacer.substring(3);

        // Find a sibling
        if (this.node.parent) {

            // Attempt sibling
            var nextSib = (this.node.childIndex + 1);
            if (this.node.parent.children[nextSib] !== undefined) {
                this.node = this.node.parent.children[nextSib];
                this.mode = 0;
                return {
                    log : itSpacer + " starting sibling " + nextSib
                };
            } else {
                this.node = this.node.parent;
                this.mode = 2;
                return {
                    log : itSpacer + " no remaining siblings, exit to parent"
                };
            }

        } else {

            return null;

        }

        break;
    };};</script>
</head>
<body>
<tw-storydata name="furkleFormatTest" startnode="1" creator="Twine" creator-version="2.0.11" ifid="1BFE71D7-D5AB-4127-85E0-AA92A4414BDE" format="Gately" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">tw-link.passage {
	color: blue;	
}
tw-link.click {
	color: red;	
}
tw-link.clickReplace {
	color: red;	
}

p:first-of-type {
	margin-top: 0;	
}
p:last-of-type {
	margin-bottom: 0;
}













</style><script role="script" id="twine-user-script" type="text/twine-javascript">Config.editNewlineType(Config.newlineHandlingTypes.noNewlines);















</script><tw-passagedata pid="1" name="courtyard" tags="world-location" position="769,508"></tw-passagedata>
<tw-passagedata pid="2" name="entrance" tags="world-location" position="766,664"></tw-passagedata>
<tw-passagedata pid="3" name="footer" tags="footer" position="434,498">(if: (strcontains: (passageinfo: &quot;tags&quot;), &quot;world-location&quot;))[
&lt;p&gt;
    You are currently in (world.print: &quot;?location&quot;, &quot;%@name%&quot;).
    
    (if: (world.is-set: &quot;?location&quot;, &quot;description&quot;))[
        (world.print: &quot;?location&quot;, &quot;%description%&quot;)
    ]
&lt;/p&gt;

(set: $lookClicker to &quot;(click: &#39;Look&#39;)[
    (set: $status to &#39;%description%&#39;)
]&quot;)
&lt;p&gt;
    (set: $directions to
        (array: &quot;north&quot;, &quot;south&quot;, &quot;east&quot;, &quot;west&quot;)
    )
    (foreach: $directions, &quot;$dir&quot;) [
        (foreach: (world.associated: &quot;?location&quot;, $dir), &quot;$this&quot;)
        [ 
            (world.print: $this,
                &quot;To the $dir of you is {{%@name%-&gt;%name%}}. &quot; +
                $lookClicker,
                &quot;newLine&quot;)
        ]
    ]
&lt;/p&gt;

(set: $takeClicker to &quot;(click: &#39;Take&#39;)[
    (silently:)[
        (world.take: &#39;#player&#39;, &#39;#%name%&#39;)
        (updatebindings:)
    ]
]&quot;)
(set: $dropClicker to &quot;(click: &#39;Drop&#39;)[
    (silently:)[
        (world.take: &#39;?location&#39;, &#39;#%name%&#39;)
        (updatebindings:)
    ]
]&quot;)

&lt;p&gt;
    (bind: &quot;(world.get: &#39;#player &gt; .object&#39;)&quot;)[
        (if: (world.contains: &quot;#player&quot;, &quot;.object&quot;, &quot;children&quot;))[
            You have:
            &lt;br&gt;
            (foreach: (world.get: &quot;#player &gt; .object&quot;), &quot;$this&quot;)[
                (world.print: $this,
                    &quot;%@name% &quot; +
                    $dropClicker +
                    &quot; &quot; +
                    $lookClicker,
                    &quot;newline&quot;)
            ]
        ]
    ]
&lt;/p&gt;

&lt;p&gt;
    (bind: &quot;(world.get: &#39;?location &gt; .object&#39;)&quot;)[
        (if: (world.contains: &quot;?location&quot;,
            &quot;.object&quot;,
            &quot;children&quot;))
        [
            Here, you see:
            &lt;br&gt;
            (foreach: (world.get: &quot;?location &gt; .object&quot;),&quot;$this&quot;)
            [
                (world.print: $this,
                    &quot;%@name% &quot; +
                    $takeClicker +
                    &quot; &quot; +
                    $lookClicker,
                    &quot;newline&quot;)
            ]
        ]
    ]
&lt;/p&gt;
]

(set: $status to &quot;&quot;)

(bind: &quot;$status&quot;)[ (if: $status)[ &lt;br&gt;&lt;p&gt;$status&lt;/p&gt; ] ]</tw-passagedata>
<tw-passagedata pid="4" name="definitions" tags="load" position="198,493">&lt;!-- adds #courtyard, #entrance, #greatHall, #kitchen, #coatRoom --&gt;
(world.populateFromPassages: &quot;location&quot;)

(world.addAlias: &quot;#entrance&quot;, &quot;name&quot;, &quot;the entrance/exit to the inside of the castle&quot;)
(world.set: &quot;#entrance&quot;, &quot;description&quot;, &quot;An enormously old tunnel, the sunlight barely reaching the point at which the candlelight is visible.&quot;)

(world.addAlias: &quot;#greatHall&quot;, &quot;name&quot;, &quot;the great hall&quot;)
(world.set: &quot;#greatHall&quot;, &quot;description&quot;, &quot;Sprawling, dim, the hall awaits, filled with tables covered in roasted meat and dried, candied fruits. There is a flagon of ale with your name on it, somewhere in the mix.&quot;)

(world.addAlias: &quot;#kitchen&quot;, &quot;name&quot;, &quot;the kitchen&quot;)
(world.set: &quot;#kitchen&quot;, &quot;description&quot;, &quot;The dishes are still dirty, the fires still lit, and an aroma of tender lamb fills the air.&quot;)

(silently:)[(world.addAlias: &quot;#courtyard&quot;, &quot;name&quot;, &quot;the castle courtyard&quot;)
(world.set: &quot;#courtyard&quot;, &quot;description&quot;, &quot;Wide, bright, filled with browning grass and bare hibernating {{trees}}. The sounds of distant birds come in snatches as the wind shifts directions.&quot;)]

(world.addAlias: &quot;#coatRoom&quot;, &quot;name&quot;, &quot;the coat room&quot;)
(world.set: &quot;#coatRoom&quot;, &quot;description&quot;, &quot;It&#39;s a room. It&#39;s full of coats.&quot;)

(world.take: &quot;#courtyard&quot;, &quot;#player&quot;)

(world.add: &quot;corpse&quot;, &quot;object&quot;, &quot;#courtyard&quot;)
(world.set: &quot;#corpse&quot;, &quot;description&quot;, &quot;This man is dead yo.&quot;)

(world.add: &quot;coins&quot;, &quot;object&quot;, &quot;#corpse&quot;)
(world.set: &quot;#coins&quot;, &quot;description&quot;, &quot;MONEY YO.&quot;)

(world.add: &quot;cheese&quot;, &quot;object&quot;, &quot;#courtyard&quot;)
(world.set: &quot;#cheese&quot;, &quot;description&quot;, &quot;A delicious cheese from a time of yore.&quot;)

(world.add: &quot;dagger&quot;, &quot;object&quot;, &quot;#player&quot;)
(world.set: &quot;#dagger&quot;, &quot;description&quot;, &quot;knife whom poke things.&quot;)

(world.associate: &quot;#entrance&quot;, &quot;north&quot;, &quot;#courtyard&quot;, &quot;converse&quot;)

(world.associate: &quot;#greatHall&quot;, &quot;north&quot;, &quot;#entrance&quot;, &quot;converse&quot;)

(world.associate: &quot;#kitchen&quot;, &quot;east&quot;, &quot;#greatHall&quot;, &quot;converse&quot;)

(world.associate: &quot;#coatRoom&quot;, &quot;west&quot;, &quot;#greatHall&quot;, &quot;converse&quot;)

(world.addAlias: &quot;#tree&quot;, &quot;name&quot;, &quot;the tree&quot;)
(world.set: &quot;#tree&quot;, &quot;description&quot;, &quot;da big tree.&quot;)</tw-passagedata>
<tw-passagedata pid="5" name="greatHall" tags="world-location" position="774,834"></tw-passagedata>
<tw-passagedata pid="6" name="coatRoom" tags="world-location" position="601,836"></tw-passagedata>
<tw-passagedata pid="7" name="kitchen" tags="world-location" position="956,833"></tw-passagedata>
<tw-passagedata pid="8" name="trees" tags="" position="947,512">There are hundreds of trees spread across the castle&#39;s grounds. Each is bare, leaves scattered around their base like old, bleached bones. But there is [[a single lush, full tree-&gt;full tree]] against one of the walls.
&lt;br&gt;
&lt;br&gt;
[[Go back-&gt;courtyard]]</tw-passagedata>
<tw-passagedata pid="9" name="full tree" tags="" position="1128,510">You are before the tree, its leaves rattling and sighing in the just-palpable wind.
&lt;br&gt;
&lt;br&gt;
[[Climb the tree-&gt;tree]]
&lt;br&gt;
[[Go back-&gt;trees]]</tw-passagedata>
<tw-passagedata pid="10" name="tree" tags="world-location" position="1127,660">(silently:)[(world-associate: &quot;#tree&quot;, &quot;west&quot;, &quot;#courtyard&quot;, &quot;converse&quot;)
(world-set: &quot;#tree&quot;, &quot;description&quot;, &quot;Immense and full, you can barely see the castle, or the ground.&quot;)
(world-addAlias: &quot;#tree&quot;, &quot;description&quot;, &quot;the tree&quot;)]</tw-passagedata>
</tw-storydata>

<tw-menu id="defaultMenu" class="collapsed" data-choice="options">
<button class="collapser" data-on=">" data-off="<"><</button>
<tw-element-resizer data-selector="#defaultOptions"></tw-element-resizer>
<tw-options id="defaultOptions" class="active">
<tw-option id="saveGameToFile">
<label for="saveGame">Save Game</label>
<button id="saveGame">Save</button>
<p><label for="saveFilename">Filename:</label><input id="saveFilename" type="text"></input></p>
</tw-option>
<tw-option id="adjustAudio">
<label for="gotoAudio">Audio Options</label>
<button id="gotoAudio">Change</button>
</tw-option>
<tw-option id="adjustAccessibility">
<label for="gotoAccessibility">Accessibility Options</label>
<button id="gotoAccessibility">Change</button>
</tw-option>
<tw-option id="addNewTwineNodes">
<label for="gotoAddNodes">Add New Twine Nodes</label>
<button id="gotoAddNodes">Display</button>
</tw-option>
<tw-option id="toggleTranscriptRecording">
<label for="toggleTranscript">Toggle Transcript Recording</label>
<button id="toggleTranscript">On</button>
</tw-option>
<tw-option id="displayTranscriptInSidebar">
<label for="gotoTranscript">Display Transcript In Sidebar</label>
<button id="gotoTranscript">Display</button>
</tw-option>
<tw-option id="printTranscriptToConsole" class="hidden">
<label for="printTranscript">Print Transcript To Console</label>
<button id="printTranscript">Print</button>
</tw-option>
</tw-options>
<tw-audio-display id="defaultAudioDisplay" class="displayer"></tw-audio-display>
<tw-accessibility-display id="defaultAccessibilityDisplay" class="displayer">
<div id="optionsFontSize">
<button class="collapser" data-on="-" data-off="+">-</button>
<span class="title">Font Size</span>
<div>
<input class="accessibilityInput" type="range" value="100" min="1" max="500"></input>
<span class="rangeReadout">100</span><span>%</span>
</div>
</div>
<div id="optionsBackgroundColor">
<button class="collapser" data-on="-" data-off="+">-</button>
<span class="title">Background Color</span>
<div>
<input class="accessibilityInput" type="range" value="255" min="0" max="255"></input>
<span class="rangeReadout">255</span>
</div>
<div>
<input class="accessibilityInput" type="range" value="255" min="0" max="255"></input>
<span class="rangeReadout">255</span>
</div>
<div>
<input class="accessibilityInput" type="range" value="255" min="0" max="255"></input>
<span class="rangeReadout">255</span>
</div>
</div>
<div id="optionsBrightness">
<button class="collapser" data-on="-" data-off="+">-</button>
<span class="title">Brightness</span>
<input class="accessibilityInput" type="range" value="1" min="0.25" max="3" step="0.01"></input>
<span class="rangeReadout">1</span>
</div>
<div id="optionsContrast">
<button class="collapser" data-on="-" data-off="+">-</button>
<span class="title">Contrast</span>
<input class="accessibilityInput" type="range" value="1" min="0.25" max="3" step="0.01"></input>
<span class="rangeReadout">1</span>
</div>
<div id="optionsSaturation">
<button class="collapser" data-on="-" data-off="+">-</button>
<span class="title">Saturation</span>
<input class="accessibilityInput" type="range" value="1" min="0.25" max="10" step="0.05"></input>
<span class="rangeReadout">1</span>
</div>
</tw-accessibility-display>
<tw-nodeadder-display id="defaultNodeadderDisplay" class="displayer">
<label for="nodeAdderTextarea">Paste ::- or ::@name-separated passages here</label>
<textarea id="nodeAdderTextarea"></textarea>
<button id="addNodesAndSave">Add Nodes And Save Expanded File</button>
</tw-nodeadder-display>
<tw-transcript-display id="defaultTranscriptDisplay" class="displayer">
<iframe id="defaultTranscriptFrame"></iframe>
</tw-transcript-display>
</tw-menu>
<tw-story id="passage" class="centerHorizontally"></tw-story>
<script id="gatelyInit">
	(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};(function(){//'use strict';
window.Config={renderTypes:{jonah:'jonah',sugarcube:'sugarcube',harlowe:'sugarcube'},newlineHandlingTypes:{newlineToBr:'newlineToBr',noNewlines:'noNewlines'},chronologyButtonDirections:{rewind:'rewind',fastForward:'fastForward'},errorLevels:{alert:'alert',console:'console',inline:'inline'},editTheme:function editTheme(configObjOrString){if(typeof configObjOrString==='string'){if(!configObjOrString){wideAlert('The configObjOrString argument provided to '+'Config.editTheme is a string, but it is empty. '+'Cannot execute.');return;}var trimmed=configObjOrString.trim();var trimLowered=trimmed.toLowerCase();if(trimmed in Config.renderTypes){handleRenderTypeChange(trimmed);}else if(trimmed in Config.newlineHandlingTypes){handleNewlineTypeChange(trimmed);}else if(trimmed in chronologyButtonDirections){handleRewindFastForwardChange(trimmed);}else if(trimmed in Config.errorLevels){var errorLevels=State.currentTheme.errorLevels;handleErrorLevelsChange(trimmed,!errorLevels[trimmed]);}}else if((typeof configObjOrString==='undefined'?'undefined':_typeof(configObjOrString))==='object'){if(!configObjOrString){wideAlert('The configObjOrString argument provided to '+'Config.editTheme is an object, but it is null. '+'Cannot execute.');return;}if('length'in configObjOrString){var arraylike=configObjOrString;if(!arraylike.length){wideAlert('The configObjOrString argument provided '+'to Config.editTheme is an array-like object, '+'its length is 0. Cannot execute.');return;}for(var ii=0;ii<arraylike.length;ii++){var index=arraylike[ii];if(!index||typeof index!=='string'){continue;}if(index in Config.renderTypes){handleRenderTypeChange(index);}else if(index in Config.newlineHandlingTypes){handleNewlineTypeChange(index);}else if(index in chronologyButtonDirections){handleRewindFastForwardChange(index);}else if(index in Config.errorLevels){var _errorLevels=State.currentTheme.errorLevels;handleErrorLevelsChange(index,!_errorLevels[index]);}}}else{var obj=configObjOrString;if(obj.renderType in Config.renderTypes){handleRenderTypeChange(obj.renderType);}if(obj.newlineHandlingType in Config.newlineHandlingTypes){handleNewlineTypeChange(obj.newlineHandlingType);}if(typeof obj.rewind==='boolean'){handleRewindFastForwardChange('rewind',obj.rewind);}if(typeof obj.fastForward==='boolean'){handleRewindFastForwardChange('fastforward',obj.fastForward);}if(obj.errorLevels&&_typeof(obj.errorLevels)==='object'){if(typeof obj.errorLevels.alert==='boolean'){handleErrorLevelsChange('alert',obj.errorLevels.alert);}if(typeof obj.errorLevels.console==='boolean'){handleErrorLevelsChange('console',obj.errorLevels.console);}if(typeof obj.errorLevels.inline==='boolean'){handleErrorLevelsChange('inline',obj.errorLevels.inline);}}}}else{wideAlert('The configObjOrString argument passed to '+'Config.newTheme is neither an object nor a string. '+'Cannot execute.');return;}},editRenderType:function editRenderType(renderType){if(!renderType){wideAlert('The renderType argument provided to '+'Config.editRenderType argument is not a string or is '+'empty. Cannot execute.');return;}else if(typeof renderType==='string'){if(renderType in Config.renderTypes){handleRenderTypeChange(renderType);}else{wideAlert('The renderType argument provided to '+'Config.editRenderType is a string, but does not '+'match one of the render types in '+'Config.renderTypes. Cannot execute.');return;}}else{wideAlert('The renderType argument provided to '+'Config.editRenderType is not a string. Cannot execute.');return;}},editNewlineType:function editNewlineType(newlineType){if(!newlineType){wideAlert('The newlineType argument provided to '+'Config.editNewlineType argument is not a string or is '+'empty. Cannot execute.');return;}else if(typeof newlineType==='string'){if(newlineType in Config.newlineHandlingTypes){handleNewlineTypeChange(newlineType);}else{wideAlert('The newlineType argument provided to '+'Config.editNewlineType does not match one of the '+'newline types in Config.newlineHandlingTypes. '+'Cannot execute.');return;}}else{wideAlert('The newlineType argument provided to '+'Config.editNewlineType is not a string. Cannot '+'execute.');return;}},editRewind:function editRewind(value){if(typeof value!=='boolean'){wideAlert('The value argument provided to '+'Config.editRewind is not a boolean. Cannot execute.');return;}handleRewindFastForwardChange('rewind',value);},editFastForward:function editFastForward(value){if(typeof value!=='boolean'){wideAlert('The value argument provided to '+'Config.editFastForward is not a boolean. Cannot '+'execute.');return;}handleRewindFastForwardChange('fastforward',value);},editErrorLevel:function editErrorLevel(level,value){if(level in Config.errorLevels){if(typeof value!=='boolean'){wideAlert('The value argument provided to '+'Config.editErrorLevel is not a boolean. Cannot '+'execute.');return;}handleErrorLevelsChange(level,value);}else{wideAlert('The level argument provided to '+'Config.editErrorLevel does not match one of the '+'errorLevel types in Config.errorLevels. Cannot '+'execute.');}}};function handleRenderTypeChange(renderType){State.currentTheme.renderType=renderType;Renderer.handleBackAndForwardButtons();}function handleNewlineTypeChange(newlineType){var currentTheme=State.currentTheme;if(newlineType===currentTheme.newlineHandlingType){return;}currentTheme.newlineHandlingType=newlineType;Renderer.undoNewlineHandling($('tw-passage.current'));if(newlineType===Config.newlineHandlingTypes.newlineToBr){Renderer.newlineToBr($currentNode);}}function handleRewindFastForwardChange(property,value){var $currentNode=$('tw-passage.current');if(property==='rewind'){if(value){$currentNode.addClass('rewind');}else{$currentNode.addClass('rewind');}}else if(change==='fastforward'){if(value){$currentNode.addClass('fastforward');}else{$currentNode.removeClass('fastforward');}}else{return;}State.currentTheme.rewind=change;}function handleErrorLevelsChange(level,value){State.currentTheme.errorLevels[level]=value;}})();

},{}],2:[function(require,module,exports){
'use strict';require('./globals.js');require('./config.js');require('./state.js');require('./macros.js');require('./worldmodel.js');require('./parser.js');require('./renderer.js');require('./options.js');require('./mixer.js');require('./onstart.js');

},{"./config.js":1,"./globals.js":3,"./macros.js":4,"./mixer.js":5,"./onstart.js":6,"./options.js":7,"./parser.js":8,"./renderer.js":9,"./state.js":10,"./worldmodel.js":11}],3:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};(function(){'use strict';var $=window.jQuery;window.wideAlert=function(message){if(State.currentTheme.errorLevels.console){console.log(message);console.trace('stack trace');}if(State.currentTheme.errorLevels.alert){alert(message);}};window.gatelyLog=function(message){if(State.currentTheme.errorLevels.console){console.log(message);console.trace('stack trace');}};window.gatelyAlert=function(message){if(State.currentTheme.errorLevel.alert){alert(message);}};window.noop=function noop(){/* do nothing */};window.from=Array.from;window.getOwnPropertyNames=Object.getOwnPropertyNames;window.$storydata=$('tw-storydata');window.$startPassage=$('tw-passagedata[pid="'+$storydata.attr('startNode')+'"]');window.isFunction=function(toCheck){return toCheck&&{}.toString.call(toCheck)==='[object Function]';};window.isNode=function(target){var node=void 0;if((typeof Node==='undefined'?'undefined':_typeof(Node))==='object'){node=target instanceof Node;}else{node=target;}return node&&(typeof target==='undefined'?'undefined':_typeof(target))==='object'&&typeof target.nodeType==='number'&&typeof target.nodeName==='string';};//Returns true if it is a DOM element    
window.isElement=function(target){var elem=void 0;if((typeof HTMLElement==='undefined'?'undefined':_typeof(HTMLElement))==='object'){elem=target instanceof HTMLElement;}else{elem=target;}return elem&&(typeof target==='undefined'?'undefined':_typeof(target))==="object"&&target!==null&&target.nodeType===1&&typeof target.nodeName==='string';};window.saferEval=function(str){try{return eval(str);}catch(e){try{return eval(str.replace(/\n/g,'\\n').replace(/\t/g,'\\t').replace(/&quot;/g,'"'));}catch(e){return str;}}};window.saferEvalToString=function(str){if(typeof str!=='string'){return str;}var evalled=void 0;try{evalled=eval(str);}catch(e){try{evalled=eval(str.replace(/\n/g,'\\n').replace(/\t/g,'\\t').replace(/&quot;/g,'"'));}catch(e){/* do nothing */}}if(typeof evalled==='string'){return evalled;}else{return str;}};window.saferJSONParse=function(str){if(typeof str!=='string'){return str;}try{return JSON.parse(str);}catch(e){try{return JSON.parse(str.replace(/\n/g,'\\n').replace(/\t/g,'\\t').replace(/&quot;/g,'"'));}catch(e){return str;}}};window.saferCombinedParse=function(str){try{return JSON.parse(str);}catch(e){try{return JSON.parse(str.replace(/\n/g,'\\n').replace(/\t/g,'\\t').replace(/&quot;/g,'"'));}catch(e){try{return eval(str);}catch(e){try{return eval(str.replace(/\n/g,'\\n').replace(/\t/g,'\\t').replace(/&quot;/g,'"'));}catch(e){return str;}}}}};window.getAllContainedTextNodes=function(nodeOrSelector){if((typeof nodeOrSelector==='undefined'?'undefined':_typeof(nodeOrSelector))!=='object'||nodeOrSelector===null){wideAlert('The nodeOrSelector argument passed to '+'getAllContainedTextNodes is not valid. '+'Cannot get text nodes.');return;}var $node=$(nodeOrSelector);if(!$node.length){wideAlert('The nodeOrSelector argument passed to '+'getAllContainedTextNodes is not valid, or is '+'not a selector representative of an existing element. '+'Cannot get text nodes.');return;}return $node.find('*').contents().filter(function(_,node){return node.nodeType===3&&node.parentNode.tagName!=='SCRIPT'&&node.parentNode.tagName!=='STYLE';});};window.saveFile=function(fileName,extension,textOrElement){var $a=$('<a class="downloader"></a>');$('head').append($a);var text=void 0;if(typeof textOrElement==='string'&&text!==''){text=textOrElement;}else if(textOrElement instanceof HTMLElement){text=textOrElement.outerHTML;}else if(textOrElement[0]&&textOrElement[0]instanceof HTMLElement){text=textOrElement[0].outerHTML;}else{var html=$('html')[0].cloneNode(true);var selector='tw-save#defaultSave, a.downloader';$(html).find(selector).remove();var stateStr=JSON.stringify(State);var $save=$('<tw-save id="defaultSave">'+stateStr+'</tw-save>');html.querySelector('head').appendChild($save[0]);var storydata=html.querySelector('tw-storydata');storydata.setAttribute('flags','save');text=html.outerHTML;}var blob=new Blob([text],{type:'octet/stream'});var url=window.URL.createObjectURL(blob);$a[0].href=url;if(!fileName){fileName='save';}if(extension){extension='.'+extension;}else{extension='';}$a[0].download=fileName+extension;$a[0].click();$a.remove();window.URL.revokeObjectURL(url);};window.isElementRawString=function(str){try{return $(str)[0]!==$(str)[0];}catch(e){return false;}};})();

},{}],4:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}(function(){'use strict';var getOwnPropertyNames=Object.getOwnPropertyNames;var from=Array.from;window.Macro={handlerID:0,global:{namespace:'global',handler:null},getNewHandlerId:function getNewHandlerId(){return Macro.handlerID++;},has:function has(name){return isFunction(Macro[name]);},add:function add(name,defObj,namespace,doOverride,noFreeze){if(!name){wideAlert('The name argument must be provided to the add '+'function.');return;}else if(!defObj||!isFunction(defObj.handler)){wideAlert('The defObj must exist and must have a valid '+'handler property.');return;}defObj.handler=Object.freeze(defObj.handler);var namespaceObj=void 0;if(!namespace||typeof namespace==='string'&&namespace.toLowerCase()==='global'){namespaceObj=Macro.global;}else if(!(namespace in Macro)){wideAlert('There is no property in the Macro object with '+'the name '+namespace+'. Cannot execute.');return;}else if(!('namespace'in Macro[namespace])){wideAlert('An object was found in the Macro object '+'with a name matching the namespace argument, '+namespace+', but it has no namespace property, '+'and does not appear to be a namespace. Cannot execute.');return;}else{namespaceObj=Macro[namespace];}if(name in namespaceObj&&doOverride!==true&&(typeof doOverride!=='string'||doOverride.toLowerCase()!=='override')){wideAlert('The '+namespaceObj.namespace+' object '+'already contains a '+name+' object. If you want '+'to overwrite a pre-existing macro, please provide a '+'doOverride argument to Macro.add with a value of true '+'or "override".');return;}if(noFreeze===true||typeof noFreeze==='string'&&noFreeze.toLowerCase()==='nofreeze'){namespaceObj[name]=defObj;}else{namespaceObj[name]=Object.freeze(defObj);}},addNamespace:function addNamespace(name,macros,handler){if(typeof name!=='string'){wideAlert('The name argument provided to '+'Macro.addNamespace is not a string. Cannot execute.');return;}else if(!name){wideAlert('The name argument provided to '+'Macro.addNamespace is an empty string. Cannot execute.');return;}var handlerVal=void 0;if(typeof handler!=='undefined'){if(isFunction(handler)){handlerVal=handler;}else{wideAlert('A handler argument was provided to '+'Macro.addNamespace, but does not appear to be a '+'function. Cannot execute.');return;}}Macro[name]={namespace:name};if(handlerVal){Macro[name].handler=handlerVal;}if(macros&&(typeof macros==='undefined'?'undefined':_typeof(macros))==='object'){for(var macroName in macros){// add validation here?
Macro.add(macroName,macros[macroName],name);}}},delete:function _delete(name){delete Macro[name];},equalTypes:['=','+=','-=','*=','/=','%=']};Macro.add('set',{handler:function handler(){if(arguments.length===0){wideAlert('The set macro cannot be empty!');return;}for(var ii=0;ii<arguments.length;ii++){if(typeof arguments[ii]!=='string'){wideAlert('The data type of each argument passed '+'to Macro.set must be a string. Skipping '+'triplet.');continue;}var arg=arguments[ii];var splitIndex=arg.search(/(\+=|-=|\*=|\/=|%=|=)/);if(splitIndex===-1){wideAlert('No equals type was found in the '+'argument. Skipping triplet.');continue;}var equalsType=void 0;var triplet=[];if(arg[splitIndex+1]==='='){triplet.push(arg.slice(0,splitIndex).trim());triplet.push(arg.slice(splitIndex,splitIndex+2).trim());triplet.push(arg.slice(splitIndex+2,arg.length));}else{triplet.push(arg.slice(0,splitIndex).trim());triplet.push(arg[splitIndex].trim());triplet.push(arg.slice(splitIndex+1,arg.length));}if(!triplet[0]){wideAlert('There is no variable in the set macro '+'within the triplet at position '+ii);continue;}else if(Macro.equalTypes.indexOf(triplet[1])===-1){wideAlert('The second component in each part of a '+'set assignment must be one of the following:\n'+Macro.equalTypes.join('\n'));continue;}if(isElementRawString(triplet[2])){triplet[2]=$(triplet[2])[0];}else{var temp=saferCombinedParse(triplet[2]);if(typeof temp!=='undefined'){triplet[2]=temp;}}State.setVariable.apply(null,triplet);}}},'global');Macro.add('print',{handler:function handler(){var match=$('<tw-match class="printContainer">'+from(arguments).join('')+'</tw-match>')[0];Parser.parseNode(match);return match;}},'global');Macro.add('silently',{isDoubleTag:true,handler:noop},'global');Macro.add('if',{isDoubleTag:true,dataType:'html',handler:function handler(bool,ifBoolTrue,ifBoolFalse){if(bool&&bool.textContent){bool=saferEval(bool.textContent);}else{bool=saferEval(bool);}if(bool){return ifBoolTrue;}else{return ifBoolFalse;}}},'global');Macro.add('elseif',{isDoubleTag:true,handler:noop});Macro.global['else-if']=Macro.global.elseif;Macro.add('else',{isDoubleTag:true,handler:noop},'global');Macro.add('click',{isDoubleTag:true,defer:true,handler:function handler(linkText,callback){if(typeof linkText!=='string'||!linkText){wideAlert('The linkText argument passed to '+'Macro.clickreplace is not valid.');return;}if(typeof callback!=='string'||!callback){wideAlert('The linkText argument passed to '+'Macro.clickreplace is not valid.');return;}var $node=$('<tw-link></tw-link>');$node.addClass('clickHandler click');$node.append('<span>'+linkText+'</span>');var defer='<tw-deferrer class="hidden">'+callback+'</tw-deferrer></tw-link>';$node.append(defer);$node.click(function(e){var $deferred=$node.children('tw-deferrer');if($deferred.length){Parser.parseText($deferred.html());}});return $node[0];}},'global');/* Macro.add('clickreplace',
        {
            isDoubleTag: true,
            defer: true,
            handler(linkText, replaceText) {
                if (typeof(linkText) !== 'string' || !linkText) {
                    wideAlert('The linkText argument passed to ' +
                        'Macro.clickreplace is not valid.');
                    return;
                }

                if (typeof(replaceText) !== 'string' || !replaceText) {
                    wideAlert('The replaceText argument passed to ' +
                        'Macro.clickreplace is not valid.');
                    return;
                }

                const $node = $('<tw-link></tw-link');
                $node.addClass('clickHandler clickReplace');
                $node.append('<span>' + linkText + '</span>');

                const defer = '<tw-deferrer class="hidden">' + replaceText +
                    '</tw-deferrer></tw-link>';
                $node.append(defer);
           
                const selector = Macro.getHandlerSelector(id);
                $node.click(function(e) {
                    const $deferred = $node.children('tw-deferrer');
                    if ($deferred.length) {
                        Parser.parseNode($deferred);
                        if ($node[0].parentElement) {
                            $node[0].outerHTML = $deferred.html();
                        } else {
                            wideAlert('Cannot replace deferral element ' +
                                'its parentNode no longer exists.',
                                $node);
                        }
                    }
                });

                return $node[0];
            },
        });
    Macro.global['click-replace'] = Macro.global.clickreplace; */Macro.add('linkgoto',{handler:function handler(text,linkName){var linkStr=void 0;if(typeof linkName==='undefined'){linkStr='<tw-link class="passage" name="'+text+'">'+text+'</tw-link>';}else{linkStr='<tw-link class="passage" name="'+linkName+'">'+text+'</tw-link>';}return linkStr;}});Macro.global['link-goto']=Macro.global.linkgoto;Macro.add('linkreveal',{isDoubleTag:true,defer:true,handler:function handler(linkText,revealText){var $node=$('<tw-link class="reveal"></tw-link>');$node.addClass('reveal');$node.append('<span>'+linkText+'</span>');$node.append('<tw-deferrer class="hidden">'+revealText+'</tw-deferrer>');$node.click(function(e){var $deferred=$node.children('tw-deferrer');if($deferred.length){Parser.parseNode($deferred);if($node[0].parentNode){var $children=$deferred.remove().children();var $match=$('<tw-match></tw-match>');$match.append($children);$match.insertAfter($node);$node.remove();}}});return $node[0];}});Macro.global['link-reveal']=Macro.global.linkreveal;Macro.add('cyclinglink',{handler:function handler(){var stringArgs=[];var variableName=void 0;var $node=$('<tw-link class="cycling"></tw-link>');if(arguments.length<2){wideAlert('The cyclinglink macro needs at least two '+'arguments to function. Cannot create.');return;}else if(arguments.length===2){stringArgs=from(arguments);}else{if(typeof arguments[0]==='string'&&arguments[0].trim()[0]==='$'){$node.addClass('setter');variableName=arguments[0].trim().slice(1);}else{stringArgs.unshift(arguments[0]);}if(arguments.length>3){stringArgs=stringArgs.concat(from(arguments).slice(1,-2));var out=arguments[arguments.length-2];var _passageName=arguments[arguments.length-1];if(out===true&&typeof _passageName==='string'){$node.addClass('out');$node.attr('data-out-passage-name',arguments[arguments.length-1]);}else{stringArgs=stringArgs.concat(arguments.slice(1,-2));}}else{stringArgs=from(arguments).slice(1);}}if(variableName){State.currentVariableState[variableName]=stringArgs[0];}$node.html(args[0]);var currentIndex=0;$node.click(function(e){stringArgs.push(stringArgs.shift());currentIndex++;$node.html(stringArgs[0]);/* if the variable name was set, update the corresponding
                     * variable to reflect the current value of the link. */if(variableName){State.currentVariableState[variableName]=stringArgs[0];}if(currentIndex===currentList.length){currentIndex=0;if($node.hasClass('out')){Renderer.render(passageName);}}});return $node[0];}});Macro.global['cycling-link']=Macro.global.cyclinglink;Macro.add('br',{handler:function handler(){return document.createElement('br');}});Macro.global.newline=Macro.global.br;Macro.global['new-line']=Macro.global.br;Macro.add('display',{handler:function handler(passageName){var selector='tw-passagedata[name="'+passageName+'"]';var $passage=$(selector);if(!$passage.length){wideAlert('There is no passage to display named '+passageName+'"]');return;}var match=$('<tw-match class="display">'+$passage.html()+'</tw-match>')[0];Parser.parseNode(match);return match;}});Macro.add('replace',{handler:function handler(selectorOrMatch,replaceText){if(typeof selectorOrMatch!=='string'||!selectorOrMatch){wideAlert('The passageNameOrMatchText argument passed to '+'Macro.replace is not a string or is an empty '+'string. Cannot replace.');return;}else if(typeof replaceText!=='string'||!replaceText){wideAlert('The replaceText argument passed to '+'Macro.replace is not a string or is an empty '+'string. Cannot replace.');return;}else if(selectorOrMatch===replaceText){wideAlert('The passageNameOrMatch and replaceText '+'arguments passed to Macro.replace are identical. '+'This will result in an infinite loop. '+'Cannot replace.');return;}var $elem=void 0;// don't try searching if it's not an ID or class selector
if(selectorOrMatch[0]==='#'||selectorOrMatch[0]==='.'){try{$elem=$(selectorOrMatch);}catch(e){/* do nothing */}}if($elem){$elem.html(replaceText);}else{if(selectorOrMatch.indexOf(replaceText)!==-1){// TODO: fix this pls
wideAlert('The text to be replaced cannot contain '+'the replacement text in it. Cannot replace.');return;}var currentPassage=$('tw-passage.current')[0];if(!currentPassage){alert('The story has become corrupted '+'the current passage cannot be found.');throw new Error('The story has become corrupted '+'the current passage cannot be found.');}var textNodes=getAllContainedTextNodes(currentPassage);for(var ii=0;ii<textNodes.length;ii++){var node=textNodes[ii];var text=node.textContent;while(text.indexOf(selectorOrMatch)!==-1){text=text.replace(selectorOrMatch,replaceText);}node.textContent=text;}}}});Macro.add('textcolor',{isDoubleTag:true,handler:function handler(color,inner){if(typeof color!=='string'||color===''){wideAlert('The color argument passed to Macro.textcolor '+'is not a string or is an empty string. '+'Cannot change text color.');return;}else if(typeof inner!=='string'&&inner===''&&!isElement(inner)&&!isNode(inner)){wideAlert('The innerText argument passed to '+'Macro.textcolor is not a string or is '+'an empty string. Cannot change text color.');return;}var $elem=void 0;if(isElement(inner)||isNode(inner)){$elem=$(inner);}else{$elem=$('<span></span>');$elem.text(inner);}return $elem[0];}});Macro.global['text-color']=Macro.global.textcolor;Macro.global.textcolour=Macro.global.textcolor;Macro.global['text-colour']=Macro.global.textcolor;Macro.add('textstyle',{isDoubleTag:true,handler:function handler(inner){var _toSearch,_arguments=arguments;if(typeof inner!=='string'&&inner===''&&!isElement(inner)&&!isNode(inner)){wideAlert('The innerText argument passed to '+'Macro.textcolor is not a string or is '+'an empty string. Cannot change text color.');return;}else if(arguments.length===1||!arguments[1]){wideAlert('The first value argument passed to '+'Macro.textstyle is not a string or is an empty '+'string. Cannot change text style.');return;}var toSearch=(_toSearch={'font-family':['cursive','fantasy','monospace','sans-serif','serif'],'font-size':['large','larger','medium','small','smaller','x-large','x-small','xx-large','xx-small'],'font-stretch':['condensed','expanded','extra-condensed','extra-expanded','narrower','semi-condensed','semi-expanded','ultra-condensed','ultra-expanded','wider'],'font-style':['italic','normal','oblique']},_defineProperty(_toSearch,'font-style',['small-caps']),_defineProperty(_toSearch,'font-weight',['bold','bolder','lighter']),_defineProperty(_toSearch,'text-combine-upright',['all','none']),_defineProperty(_toSearch,'text-decoration',['blink','line-through','overline','underline']),_defineProperty(_toSearch,'text-orientation',['mixed','sideways','upright']),_defineProperty(_toSearch,'text-overflow',['clip','ellipsis']),_defineProperty(_toSearch,'text-rendering',['auto','geometricPrecision','optimizeLegibility','optimizeSpeed']),_defineProperty(_toSearch,'text-transform',['capitalize','lowercase','uppercase']),_toSearch);var $elem=void 0;if(isElement(inner)||isNode(inner)){$elem=$(inner);}else{$elem=$('<span></span>');$elem.text(inner);}var set=false;var _loop=function _loop(ii){var value=_arguments[ii];getOwnPropertyNames(toSearch).forEach(function(name){if(toSearch[name].indexOf(value)!==-1){$elem.css(name,value);set=true;}});};for(var ii=1;ii<arguments.length;ii++){_loop(ii);}if(!set){wideAlert('The value(s) passed to Macro.textstyle is/are not '+'currently supported. The element will be '+'displayed, but no style rules will be added.');}return $elem[0];}});Macro.global['text-style']=Macro.global.textstyle;// TODO: ADD OTHER STYLES
Macro.add('transition',{isDoubleTag:true,handler:function handler(type,transitionArgsOrInOrOut,milliseconds,innerText){type=type.trim();var str='<tw-transition-container></tw-transition-container>';var $node=$(str);var args=void 0;if(arguments.length===0){wideAlert('No arguments were provided for '+'Macro.transition. Cannot transition.');return;}else if(arguments.length===1){wideAlert('Either no transition type was provided to '+'Macro.transition, or there is nothing provided to '+'transition.');return;}else if(!type){wideAlert('The type argument provided to Macro.transition '+'is not valid. Cannot transition.');return;}else if(arguments.length===2){args=['type','innerText'];innerText=transitionArgsOrInOrOut;}else if(arguments.length===3){args=['type','transitionArgsOrInOrOut','innerText'];innerText=milliseconds;}else{args=['type','transitionArgsOrInOrOut','milliseconds','innerText'];}if(args.indexOf('transitionArgsOrInOrOut')!==-1&&transitionArgsOrInOrOut){var arg=transitionArgsOrInOrOut;var transitionObj=saferCombinedParse(arg);if(typeof transitionArgsOrInOrOut==='string'){var timeVal=transitionArgsOrInOrOut;if(args.indexOf('milliseconds')!==-1){var boolEval=saferEval(milliseconds);if(boolEval===true||milliseconds==='milliseconds'){timeVal+='ms';}else{timeVal+='s';}}else{timeVal+='s';}$node.css({'-webkit-animation-duration':timeVal,'-moz-animation-duration':timeVal,'-o-animation-duration':timeVal,'animation-duration':timeVal});}else if((typeof transitionObj==='undefined'?'undefined':_typeof(transitionObj))==='object'){var transArgs=transitionArgsOrInOrOut;var _timeVal=transArgs.duration;var transType=_typeof(transArgs.duration);if(transType!=='undefined'){var mills=transArgs.durationInMilliseconds;if(args.indexOf('milliseconds')!==-1){var _boolEval=saferEval(mills);if(_boolEval===true||mills==='milliseconds'){_timeVal+='ms';}else{_timeVal+='s';}}else{_timeVal+='s';}}else{_timeVal+='1s';}$node.css({'-webkit-animation-duration':_timeVal,'-moz-animation-duration':_timeVal,'-o-animation-duration':_timeVal,'animation-duration':_timeVal});if(typeof transArgs.delay!=='undefined'){var _timeVal2=transArgs.delay;var _mills=transArgs.delayInMilliseconds;if(args.indexOf('milliseconds')!==-1){var _boolEval2=saferEval(_mills);if(_boolEval2===true||_mills==='milliseconds'){_timeVal2+='ms';}else{_timeVal2+='s';}}else{_timeVal2+='s';}$node.css('transition-delay',_timeVal2);}if(typeof transArgs.timing==='string'&&transArgs.timing){var timing=transArgs.timing;$node.css({'-webkit-animation-timing-function':timing,'-moz-animation-timing-function':timing,'-o-animation-timing-function':timing,'animation-timing-function':timing});}}}else{$node.css({'-webkit-animation-duration':'1s','-moz-animation-duration':'1s','-o-animation-duration':'1s','animation-duration':'1s'});}if(type==='dissolve'){$node.attr('data-transition-type','dissolve');}else{// add default handler
}var inOrOut=saferCombinedParse(transitionArgsOrInOrOut);if(inOrOut&&inOrOut.toLowerCase){inOrOut=inOrOut.toLowerCase();}if(inOrOut==='in'||inOrOut==='out'){$node.attr('data-transition-direction',inOrOut);}$node.html(innerText);return $node[0];}});Macro.add('array',{handler:function handler(){var array=from(arguments).map(function(index){return saferCombinedParse(index);});return JSON.stringify(array);}});Macro.global.a=Macro.global.array;Macro.add('addathead',{handler:function handler(arrOrStrOrVarName){if(!arrOrStrOrVarName){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.addathead is not valid. Cannot add.');return;}else if(typeof arrOrStrOrVarName!=='string'&&(typeof arrOrStrOrVarName==='undefined'?'undefined':_typeof(arrOrStrOrVarName))!=='object'||typeof arrOrStrOrVarName.length!=='number'||!isFunction(arrOrStrOrVarName.slice)){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.addathead is not a string or array. '+'Cannot add.');return;}else if(arguments.length===1){wideAlert('There is no value provided to add to the '+'array or string. Cannot add.');return;}var arrOrStr=arrOrStrOrVarName;var currentVS=State.currentVariableState;var saving=false;if(typeof arrOrStr==='string'){if(arrOrStr[0]==='$'){var smaller=arrOrStr.trim().slice(1);var stored=currentVS[smaller];var type=typeof stored==='undefined'?'undefined':_typeof(stored);if((type==='string'||type==='object')&&typeof stored.length==='number'&&isFunction(stored.slice)){arrOrStr=stored;saving=true;}else{wideAlert('The Twinescript variable referred '+'to by the arrOrStrOrVarName argument '+'passed to Macro.addathead is not a '+'string or array. Cannot add.');return;}}else{var _arrOrStr=saferCombinedParse(arrOrStrOrVarName);if((typeof _arrOrStr==='undefined'?'undefined':_typeof(_arrOrStr))!=='object'||typeof _arrOrStr.length!=='number'||!isFunction(_arrOrStr.slice)){_arrOrStr=arrOrStrOrVarName;}}}var temp=from(arguments).slice(1).map(function(index){var val=saferCombinedParse(index);if(typeof arrOrStr==='string'){return val.toString();}else{return val;}}).concat(arrOrStr);if(typeof arrOrStr==='string'){arrOrStr=temp.join('');}else{arrOrStr=temp;}if(saving){State.setVariable(arrOrStrOrVarName.slice(1),'=',arrOrStr);}if((typeof arrOrStr==='undefined'?'undefined':_typeof(arrOrStr))==='object'){return JSON.stringify(arrOrStr);}else{return arrOrStr;}}});Macro.global['add-at-head']=Macro.global.addathead;Macro.add('addatend',{handler:function handler(arrOrStrOrVarName){if(!arrOrStrOrVarName){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.addatend is not valid. Cannot add.');return;}else if(typeof arrOrStrOrVarName!=='string'&&(typeof arrOrStrOrVarName==='undefined'?'undefined':_typeof(arrOrStrOrVarName))!=='object'||typeof arrOrStrOrVarName.length!=='number'||!isFunction(arrOrStrOrVarName.slice)){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.addatend is not a string or array. '+'Cannot add.');return;}else if(arguments.length===1){wideAlert('There is no value provided to add to the '+'array or string. Cannot add.');return;}var arrOrStr=arrOrStrOrVarName;var currentVS=State.currentVariableState;var saving=false;if(typeof arrOrStr==='string'){if(arrOrStr[0]==='$'){var smaller=arrOrStr.trim().slice(1);var stored=currentVS[smaller];var type=typeof stored==='undefined'?'undefined':_typeof(stored);if((type==='string'||type==='object')&&typeof stored.length==='number'&&isFunction(stored.slice)){arrOrStr=stored;saving=true;}else{wideAlert('The Twinescript variable referred '+'to by the arrOrStrOrVarName argument '+'passed to Macro.addatend is not a string '+'or array. Cannot add.');return;}}else{var _arrOrStr2=saferCombinedParse(arrOrStrOrVarName);if((typeof _arrOrStr2==='undefined'?'undefined':_typeof(_arrOrStr2))!=='object'||typeof _arrOrStr2.length!=='number'||!isFunction(_arrOrStr2.slice)){_arrOrStr2=arrOrStrOrVarName;}}}var temp=arrOrStr.concat(from(arguments).slice(1).map(function(index){var val=saferCombinedParse(index);if(typeof arrOrStr==='string'){return val.toString();}else{return val;}}));if(typeof arrOrStr==='string'){arrOrStr=temp.join('');}else{arrOrStr=temp;}if(saving){State.setVariable(arrOrStrOrVarName.slice(1),'=',arrOrStr);}if((typeof arrOrStr==='undefined'?'undefined':_typeof(arrOrStr))==='object'){return JSON.stringify(arrOrStr);}else{return arrOrStr;}}});Macro.global['add-at-end']=Macro.global.addatend;Macro.add('addatindex',{handler:function handler(arrOrStrOrVarName,index){if(!arrOrStrOrVarName){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.addatindex is not valid. Cannot add.');return;}else if(typeof arrOrStrOrVarName!=='string'&&(typeof arrOrStrOrVarName==='undefined'?'undefined':_typeof(arrOrStrOrVarName))!=='object'||typeof arrOrStrOrVarName.length!=='number'||!isFunction(arrOrStrOrVarName.slice)){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.addatindex is not a string or array. '+'Cannot add.');return;}else if(arguments.length===2){wideAlert('There is no value provided to add to the '+'array or string. Cannot add.');return;}var arrOrStr=arrOrStrOrVarName;var currentVS=State.currentVariableState;var saving=false;if(typeof arrOrStr==='string'){if(arrOrStr[0]==='$'){var smaller=arrOrStr.trim().slice(1);var stored=currentVS[smaller];var type=typeof stored==='undefined'?'undefined':_typeof(stored);if((type==='string'||type==='object')&&typeof stored.length==='number'&&isFunction(stored.slice)){arrOrStr=stored;saving=true;}else{wideAlert('The Twinescript variable referred '+'to by the arrOrStrOrVarName argument '+'passed to Macro.addatindex is not a '+'string or array. Cannot add.');return;}}else{var _arrOrStr3=saferCombinedParse(arrOrStrOrVarName);if((typeof _arrOrStr3==='undefined'?'undefined':_typeof(_arrOrStr3))!=='object'||typeof _arrOrStr3.length!=='number'||!isFunction(_arrOrStr3.slice)){_arrOrStr3=arrOrStrOrVarName;}}}var intIndex=Math.floor(Number(index));if(intIndex>=arrOrStr.length){wideAlert('The index provided is greater than the '+'length of the array or string represented by the '+'arrOrStrOrVarName argument passed to '+'Macro.addatindex. Cannot add.');return;}var temp=arrOrStr.slice(0,intIndex).concat(from(arguments).slice(2).map(function(index){var val=saferCombinedParse(index);if(typeof arrOrStr==='string'){return val.toString();}else{return val;}})).concat(arrOrStr.slice(intIndex));if(typeof arrOrStr==='string'){arrOrStr=temp.join('');}else{arrOrStr=temp;}if(saving){State.setVariable(arrOrStrOrVarName.slice(1),'=',arrOrStr);}if((typeof arrOrStr==='undefined'?'undefined':_typeof(arrOrStr))==='object'){return JSON.stringify(arrOrStr);}else{return arrOrStr;}}});Macro.global['add-at-index']=Macro.global.addatindex;Macro.add('removeathead',{handler:function handler(arrOrStrOrVarName,numberToRemove){if(!arrOrStrOrVarName){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.removeathead is not valid. Cannot remove.');return;}else if(typeof arrOrStrOrVarName!=='string'&&(typeof arrOrStrOrVarName==='undefined'?'undefined':_typeof(arrOrStrOrVarName))!=='object'||typeof arrOrStrOrVarName.length!=='number'||!isFunction(arrOrStrOrVarName.slice)){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.removeathead is not a string or array. '+'Cannot remove.');return;}var arrOrStr=arrOrStrOrVarName;var currentVS=State.currentVariableState;var saving=false;if(typeof arrOrStr==='string'){if(arrOrStr[0]==='$'){var smaller=arrOrStr.trim().slice(1);var stored=currentVS[smaller];var type=typeof stored==='undefined'?'undefined':_typeof(stored);if((type==='string'||type==='object')&&typeof stored.length==='number'&&isFunction(stored.slice)){arrOrStr=stored;saving=true;}else{wideAlert('The Twinescript variable referred '+'to by the arrOrStrOrVarName argument '+'passed to Macro.removeathead is not a '+'string or array. Cannot remove.');return;}}else{var _arrOrStr4=saferCombinedParse(arrOrStrOrVarName);if((typeof _arrOrStr4==='undefined'?'undefined':_typeof(_arrOrStr4))!=='object'||typeof _arrOrStr4.length!=='number'||!isFunction(_arrOrStr4.slice)){_arrOrStr4=arrOrStrOrVarName;}}}if(typeof numberToRemove==='undefined'){arrOrStr=arrOrStr.slice(1);}else{var intToRemove=Math.floor(Number(numberToRemove));if(Number.isNaN(intToRemove)||intToRemove<1){wideAlert('The numberToRemove argument passed to '+'Macro.removeathead is not a valid, >= 1 '+'number. Cannot remove.');return;}arrOrStr=arrOrStr.slice(intToRemove);}if(saving){State.setVariable(arrOrStrOrVarName.slice(1),arrOrStr);}if((typeof arrOrStr==='undefined'?'undefined':_typeof(arrOrStr))==='object'){return JSON.stringify(arrOrStr);}else{return arrOrStr;}}});Macro.global['remove-at-head']=Macro.global.removeathead;Macro.add('removeatend',{handler:function handler(arrOrStrOrVarName,numberToRemove){if(!arrOrStrOrVarName){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.removeatend is not valid. Cannot remove.');return;}else if(typeof arrOrStrOrVarName!=='string'&&(typeof arrOrStrOrVarName==='undefined'?'undefined':_typeof(arrOrStrOrVarName))!=='object'||typeof arrOrStrOrVarName.length!=='number'||!isFunction(arrOrStrOrVarName.slice)){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.removeatend is not a string or array. '+'Cannot remove.');return;}var arrOrStr=arrOrStrOrVarName;var currentVS=State.currentVariableState;var saving=false;if(typeof arrOrStr==='string'){if(arrOrStr[0]==='$'){var smaller=arrOrStr.trim().slice(1);var stored=currentVS[smaller];var type=typeof stored==='undefined'?'undefined':_typeof(stored);if((type==='string'||type==='object')&&typeof stored.length==='number'&&isFunction(stored.slice)){arrOrStr=stored;saving=true;}else{wideAlert('The Twinescript variable referred '+'to by the arrOrStrOrVarName argument '+'passed to Macro.removeatend is not a '+'string or array. Cannot remove.');return;}}else{var _arrOrStr5=saferCombinedParse(arrOrStrOrVarName);if((typeof _arrOrStr5==='undefined'?'undefined':_typeof(_arrOrStr5))!=='object'||typeof _arrOrStr5.length!=='number'||!isFunction(_arrOrStr5.slice)){_arrOrStr5=arrOrStrOrVarName;}}}if(typeof numberToRemove==='undefined'){arrOrStr=arrOrStr.slice(0,arrOrStr.length-1);}else{var intToRemove=Math.floor(Number(numberToRemove));if(Number.isNaN(intToRemove)||intToRemove<1){wideAlert('The numberToRemove argument passed to '+'Macro.removeatend is not a valid, >= 1 '+'number. Cannot remove.');return;}arrOrStr=arrOrStr.slice(0,arrOrStr.length-intToRemove);}if(saving){State.setVariable(arrOrStrOrVarName.slice(1),'=',arrOrStr);}if((typeof arrOrStr==='undefined'?'undefined':_typeof(arrOrStr))==='object'){return JSON.stringify(arrOrStr);}else{return arrOrStr;}}});Macro.global['remove-at-end']=Macro.global.removeatend;Macro.add('removeatindex',{handler:function handler(arrOrStrOrVarName,index,numberToRemove){if(!arrOrStrOrVarName){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.removeatindex is not valid. Cannot remove.');return;}else if(typeof arrOrStrOrVarName!=='string'&&(typeof arrOrStrOrVarName==='undefined'?'undefined':_typeof(arrOrStrOrVarName))!=='object'||typeof arrOrStrOrVarName.length!=='number'||!isFunction(arrOrStrOrVarName.slice)){wideAlert('The arrOrStrOrVarName argument passed to '+'Macro.removeatindex is not a string or array. '+'Cannot remove.');return;}var arrOrStr=arrOrStrOrVarName;var currentVS=State.currentVariableState;var saving=false;if(typeof arrOrStr==='string'){if(arrOrStr[0]==='$'){var smaller=arrOrStr.trim().slice(1);var stored=currentVS[smaller];var type=typeof stored==='undefined'?'undefined':_typeof(stored);if((type==='string'||type==='object')&&typeof stored.length==='number'&&isFunction(stored.slice)){arrOrStr=stored;saving=true;}else{wideAlert('The Twinescript variable referred '+'to by the arrOrStrOrVarName argument '+'passed to Macro.removeatindex is not a '+'string or array. Cannot remove.');return;}}else{var _arrOrStr6=saferCombinedParse(arrOrStrOrVarName);if((typeof _arrOrStr6==='undefined'?'undefined':_typeof(_arrOrStr6))!=='object'||typeof _arrOrStr6.length!=='number'||!isFunction(_arrOrStr6.slice)){_arrOrStr6=arrOrStrOrVarName;}}}var intIndex=Math.floor(Number(index));while(intIndex<0){intIndex=arrOrStr.length+index;}if(typeof numberToRemove==='undefined'){arrOrStr=arrOrStr.slice(0,intIndex).concat(arrOrStr.slice(intIndex+1));}else{var intToRemove=Math.floor(Number(numberToRemove));if(Number.isNaN(intToRemove)||intToRemove<1){wideAlert('The numberToRemove argument passed to '+'Macro.removeatindex is not a valid, >= 1 '+'number. Cannot remove.');return;}arrOrStr=arrOrStr.slice(0,intIndex).concat(arrOrStr.slice(intIndex+intToRemove));}if(saving){State.setVariable(arrOrStrOrVarName.slice(1),'=',arrOrStr);}if((typeof arrOrStr==='undefined'?'undefined':_typeof(arrOrStr))==='object'){return JSON.stringify(arrOrStr);}else{return arrOrStr;}}});Macro.global['remove-at-index']=Macro.global.removeatindex;Macro.add('arrayfilter',{isDoubleTag:true,defer:true,handler:function handler(array,variable,callback){var arr=void 0;if(!array){wideAlert('The array parameter passed to Macro.arrayfilter '+'is not valid. Cannot filter.');return;}else if((typeof array==='undefined'?'undefined':_typeof(array))==='object'&&'length'in object){arr=array;}else if(typeof array==='string'){var _str=array.trim();if(_str[0]==='$'&&_str.slice(1)in State.currentVariableState){var varName=_str.slice(1);var varInst=State.currentVariableState[varName];if(varInst&&(typeof varInst==='undefined'?'undefined':_typeof(varInst))==='object'&&'length'in varInst){arr=varInst;}}else{var temp=saferCombinedParse(array);if(temp&&(typeof temp==='undefined'?'undefined':_typeof(temp))==='object'&&'length'in temp){arr=temp;}}}arr=from(arr);if(!arr){wideAlert('The array argument passed to Macro.arrayfilter '+'is not valid. Cannot filter.');return;}if(!callback){wideAlert('The callback parameter passed to '+'Macro.arrayfilter is not valid. Cannot filter.');return;}else if(!variable||typeof variable!=='string'){wideAlert('The variable argument passed to '+'Macro.arrayfilter is not valid. Cannot filter.');return;}var callCopy=void 0;if(isElement(callback)||isNode(callback)){callCopy=callback.textContent;}else{callCopy=callback.toString();}var filtered=[];for(var ii=0;ii<arr.length;ii++){var string=arr[ii];if(typeof str!=='string'){string=JSON.stringify(string);}if(variable.indexOf(string)!==-1){wideAlert('The variable argument, '+variable+', contains an incidence of the array '+'index, '+string+'. This will result in '+'an infinite loop when replacing variable '+'with index. Cannot filter.');return;}else if(string.indexOf(variable)!==-1){wideAlert('The array index, '+string+', contains an incidence of the variable '+'argument, '+variable+'. This will '+'result in an infinite loop when replacing '+'variable with index. Cannot filter.');return;}var call=callCopy;while(call.indexOf(variable)!==-1){call=call.replace(variable,string);}var result=Parser.parseText(call);if(result&&result!==false&&result.trim()!=='false'){filtered.push(arr[ii]);}}return JSON.stringify(filtered);}});Macro.global['array-filter']=Macro.global.arrayfilter;Macro.add('dict',{handler:function handler(){if(arguments.length<2){wideAlert('The Macro.dict constructor must have an '+'even number of arguments greater than 2. Cannot '+'construct.');}else if(arguments.length%2!==0){wideAlert('The Macro.dict constructor must have an '+'even number of arguments in the form key, value, '+'key, value, etc. Cannot construct.');return;}var dict={};for(var ii=0;ii<arguments.length;ii+=2){var _value=saferCombinedParse(arguments[ii+1]);dict[arguments[ii]]=_value;}return JSON.stringify(dict);}});Macro.global.dictionary=Macro.global.dict;Macro.global.datamap=Macro.global.dict;Macro.add('setkeyvalues',{handler:function handler(dict,key,value){if((typeof dict==='undefined'?'undefined':_typeof(dict))!=='object'||!dict){wideAlert('The dict argument passed to '+'Macro.setkeyvalues is not a valid object. Cannot '+'set.');return;}else if(typeof key!=='string'||!key){wideAlert('The key argument passed to '+'Macro.setkeyvalues is not a valid string. Cannot '+'set.');return;}else if(typeof value==='undefined'){wideAlert('The value argument passed to '+'Macro.setkeyvalues is undefined. Cannot set.');return;}if(arguments.length%2!==1){wideAlert('The Macro.setkeyvalues constructor must '+'have an odd number of arguments, with the dict '+'argument followed by pairs of the form key, '+'value, key, value, etc.');return;}for(var ii=1;ii<arguments.length;ii+=2){var _value2=saferCombinedParse(arguments[ii+1]);dict[arguments[ii]]=_value2;}dict[key]=value;}});Macro.global['set-key-values']=Macro.global.setkeyvalues;Macro.add('in',{handler:function handler(toSearch,key){if(typeof toSearch==='undefined'||toSearch===''){return false;}var search=saferCombinedParse(toSearch);if(!search||(typeof search==='undefined'?'undefined':_typeof(search))!=='object'){wideAlert('The toSearch argument passed to Macro.in '+'is not an object and cannot be parsed to one. '+'Macro.in can only be used on objects or string '+'representations thereof. Cannot execute.');return false;}else{return key in toSearch;}}});Macro.add('stringcontains',{handler:function handler(str,substr){if(arguments.length===0){wideAlert('No arguments were passed to '+'Macro.stringcontains. Cannot execute.');return;}else if(typeof str!=='string'){wideAlert('The str argument passed to '+'Macro.stringcontains is not a string. Cannot '+'execute.');return false;}else if(!str){gatelyLog('The str argument passed to '+'Macro.stringcontains is an empty string. Cannot '+'execute.');return false;}else if(arguments.length===1){wideAlert('The substr argument was not provided to '+'Macro.stringcontains. Cannot execute.');return false;}else if(typeof substr!=='string'){wideAlert('The substr argument passed to '+'Macro.stringcontains is not a string. Cannot '+'execute.');return false;}else if(!substr){gatelyLog('The substr argument passed to '+'Macro.stringcontains is an empty string. Cannot '+'execute.');return false;}return str.indexOf(substr)!==-1;}});Macro.global['string-contains']=Macro.global.stringcontains;Macro.global['strcontains']=Macro.global.stringcontains;Macro.global['str-contains']=Macro.global.stringcontains;Macro.add('objectcontains',{handler:function handler(obj,value){if(arguments.length===0){wideAlert('No arguments were provided to '+'Macro.objectcontains. Cannot execute.');return;}else if(arguments.length===1){wideAlert('The value argument was not provided to '+'Macro.objectcontains. Cannot execute.');return;}else if((typeof obj==='undefined'?'undefined':_typeof(obj))!=='object'&&typeof obj!=='string'){wideAlert('The obj argument passed to '+'Macro.objectcontains is not an object or string. '+'Cannot execute.');return false;}else if(!obj){wideAlert('The obj argument passed to '+'Macro.objectcontains is not valid. Cannot execute.');return false;}else if(arguments.length===1){wideAlert('The value argument was not provided to '+'Macro.objectcontains. Cannot execute.');return false;}var search=saferCombinedParse(obj);var parsedVal=saferJSONParse(value);var val=JSON.stringify(parsedVal);var names=getOwnPropertyNames(search);for(var ii=0;ii<names.length;ii++){var name=names[ii];var curVal=JSON.stringify(search[name]);if(curVal===val){return true;}}return false;}});Macro.global['object-contains']=Macro.global.objectcontains;Macro.global['objcontains']=Macro.global.objectcontains;Macro.global['object-contains']=Macro.global.objectcontains;Macro.add('arrayconcat',{handler:function handler(){var array=[];from(arguments).forEach(function(arg){var parsed=saferCombinedParse(arg);if(parsed&&(typeof parsed==='undefined'?'undefined':_typeof(parsed))==='object'&&isFunction(parsed.concat)){array=array.concat(parsed);}else{wideAlert('The argument provided to '+'Macro.arrayconcat, '+arg+', is not an '+'non-null object, and/or lacks a concat '+'method. Skipping argument.');return;}});return JSON.stringify(array);}});Macro.global['array-concat']=Macro.global.arrayconcat;Macro.global.arrconcat=Macro.global.arrayconcat;Macro.global['arr-concat']=Macro.global.arrayconcat;Macro.add('foreach',{isDoubleTag:true,defer:true,handler:function handler(collection,variable,callback){var processedCollection=collection;if(typeof collection==='string'){var trimmed=collection.trim();if(trimmed.startsWith('[')&&trimmed.endsWith(']')){processedCollection=saferEval(collection);}else{processedCollection=saferJSONParse(collection);}if(!processedCollection||processedCollection===collection||(typeof processedCollection==='undefined'?'undefined':_typeof(processedCollection))!=='object'&&typeof processedCollection!=='string'){if(collection.indexOf(',')===-1){wideAlert('The collection passed to '+'Macro.foreach cannot be parsed or '+'evalled, and is not comma-separated. '+'Cannot execute.');return;}processedCollection=collection.split(',');}}else if((typeof collection==='undefined'?'undefined':_typeof(collection))!=='object'){wideAlert('The collection argument '+'passed to Macro.foreach is not an object '+'or string. Cannot execute.');return;}// is worldmodel collection
if(processedCollection.type==='collection'&&'children'in processedCollection){processedCollection=getOwnPropertyNames(processedCollection.children).map(function(name){var val=processedCollection.children[name];var strVal=JSON.stringify(val);return'<tw-argument>'+strVal+'</tw-argument>';});}if(!isFunction(processedCollection.forEach)){// handle array-like objects
processedCollection=from(processedCollection);}var selector='<tw-match class="eachContainer">'+'</tw-match>';var returnElem=$(selector)[0];processedCollection.forEach(function(index){var currentFunc=callback;while(currentFunc.indexOf(variable)!==-1){currentFunc=currentFunc.replace(variable,index);}var retNode=$('<tw-match>'+currentFunc+'</tw-match>')[0];Parser.parseNode(retNode);returnElem.appendChild(retNode);});return returnElem;}});Macro.global['for-each']=Macro.global.foreach;Macro.add('range',{handler:function handler(lower,upper,step){/*! http://mths.be/codepointat v0.1.0 by @mathias */if(!String.prototype.codePointAt){(function(){'use strict';// needed to support `apply`/`call` with `undefined`/`null`
var codePointAt=function codePointAt(position){if(this==null){throw TypeError();}var string=String(this);var size=string.length;// `ToInteger`
var index=position?Number(position):0;if(index!=index){// better `isNaN`
index=0;}// Account for out-of-bounds indices:
if(index<0||index>=size){return undefined;}// Get the first code unit
var first=string.charCodeAt(index);var second;if(// check if its the start of a surrogate pair
first>=0xD800&&first<=0xDBFF&&// high surrogate
size>index+1// there is a next code unit
){second=string.charCodeAt(index+1);if(second>=0xDC00&&second<=0xDFFF){// low surrogate
// http://mathiasbynens.be/notes/javascript-encoding#surrogate-formulae
return(first-0xD800)*0x400+second-0xDC00+0x10000;}}return first;};if(Object.defineProperty){Object.defineProperty(String.prototype,'codePointAt',{'value':codePointAt,'configurable':true,'writable':true});}else{String.prototype.codePointAt=codePointAt;}})();}/* *//*! http://mths.be/fromcodepoint v0.1.0 by @mathias */if(!String.fromCodePoint){(function(){var defineProperty=function(){// IE 8 only supports `Object.defineProperty` on DOM elements
try{var object={};var $defineProperty=Object.defineProperty;var result=$defineProperty(object,object,object)&&$defineProperty;}catch(error){}return result;}();var stringFromCharCode=String.fromCharCode;var floor=Math.floor;var fromCodePoint=function fromCodePoint(){var MAX_SIZE=0x4000;var codeUnits=[];var highSurrogate;var lowSurrogate;var index=-1;var length=arguments.length;if(!length){return'';}var result='';while(++index<length){var codePoint=Number(arguments[index]);if(!isFinite(codePoint)||// `NaN`, `+Infinity`, or `-Infinity`
codePoint<0||// not a valid Unicode code point
codePoint>0x10FFFF||// not a valid Unicode code point
floor(codePoint)!=codePoint// not an integer
){throw RangeError('Invalid code point: '+codePoint);}if(codePoint<=0xFFFF){// BMP code point
codeUnits.push(codePoint);}else{// Astral code point; split in surrogate halves
// http://mathiasbynens.be/notes/javascript-encoding#surrogate-formulae
codePoint-=0x10000;highSurrogate=(codePoint>>10)+0xD800;lowSurrogate=codePoint%0x400+0xDC00;codeUnits.push(highSurrogate,lowSurrogate);}if(index+1==length||codeUnits.length>MAX_SIZE){result+=stringFromCharCode.apply(null,codeUnits);codeUnits.length=0;}}return result;};if(defineProperty){defineProperty(String,'fromCodePoint',{'value':fromCodePoint,'configurable':true,'writable':true});}else{String.fromCodePoint=fromCodePoint;}})();}/* */if(arguments.length===0){wideAlert('No arguments were provided to Macro.range. '+'Cannot execute.');return;}else if(typeof lower!=='number'){if(typeof lower!=='string'){wideAlert('The lower argument provided to '+'Macro.range is not a number or string. Cannot '+'execute.');return;}else if(lower.length!==1){wideAlert('The lower argument provided to '+'Macro.range is a string, but is not of length '+'1. Cannot execute.');return;}}else if(Number.isNaN(lower)){wideAlert('The lower argument provided to Macro.range '+'is NaN. Cannot execute.');return;}else if(lower===Number.POSITIVE_INFINITY){wideAlert('The lower argument provided to Macro.range '+'is positive Infinity. Cannot execute.');return;}else if(lower===Number.NEGATIVE_INFINITY){wideAlert('The lower argument provided to Macro.range '+'is negative Infinity. Cannot execute.');return;}else if(arguments.length===1){wideAlert('The upper argument was not provided to '+'Macro.range. Cannot execute.');return;}if(typeof upper!=='number'){if(typeof upper!=='string'){wideAlert('The upper argument provided to '+'Macro.range is not a number or string. Cannot '+'execute.');return;}else if(upper.length!==1){wideAlert('The upper argument provided to '+'Macro.range is a string, but is not of length '+'1. Cannot execute.');return;}}else if(Number.isNaN(upper)){wideAlert('The upper argument provided to Macro.range '+'is NaN. Cannot execute.');return;}else if(upper===Number.POSITIVE_INFINITY){wideAlert('The upper argument provided to Macro.range '+'is positive Infinity. Cannot execute.');return;}else if(upper===Number.NEGATIVE_INFINITY){wideAlert('The upper argument provided to Macro.range '+'is negative Infinity. Cannot execute.');return;}if((typeof lower==='undefined'?'undefined':_typeof(lower))!==(typeof upper==='undefined'?'undefined':_typeof(upper))){wideAlert('The type of the lower argument provided to '+'Macro.range does not match that of the upper '+'argument. Either both must be a number, or both '+'must be a string.');return;}if(typeof step!=='undefined'){if(typeof step!=='number'){wideAlert('The step argument is provided to '+'Macro.range, but is not a number. Cannot '+'execute.');return;}else if(Number.isNaN(step)){wideAlert('The step argument provided to '+'Macro.range is NaN. Cannot execute.');return;}else if(step===Number.POSITIVE_INFINITY){wideAlert('The step argument provided to Macro.range '+'is positive Infinity. Cannot execute.');return;}else if(step===Number.NEGATIVE_INFINITY){wideAlert('The step argument provided to Macro.range '+'is negative Infinity. Cannot execute.');return;}else if(step<=0){wideAlert('The step argument provided to '+'Macro.range must be a number greater than 0. '+'Cannot execute.');return;}}var container=[];var stepNum=step;if(typeof step==='undefined'){stepNum=1;}if(typeof lower==='number'){if(lower>=upper){wideAlert('The lower argument passed to '+'Macro.range is greater than or equal to the '+'upper argument. Cannot execute.');return;}var index=lower;// upper-exclusive bound
while(index<upper){container.push(index);index+=stepNum;}}else if(typeof lower==='string'){var lowerCodePoint=lower.codePointAt(0);var upperCodePoint=upper.codePointAt(0);if(lowerCodePoint>=upperCodePoint){wideAlert('The lower character argument passed to '+'Macro.range has a code point greater than or '+'equal to the upper character argument\'s code '+'point. Cannot execute.');return;}if(stepNum%1!==0){wideAlert('The step provided to Macro.range is not '+'an integer. Cannot execute.');return;}var _index=lowerCodePoint;// upper-inclusive bound
while(_index<=upperCodePoint){try{var _str2=String.fromCodePoint(_index);if(_str2){container.push(_str2);}}catch(e){wideAlert('The following error was encountered '+'when trying to produce a string from the '+'following codepoint: '+_index);wideAlert(e);}_index+=stepNum;}}return JSON.stringify(container);}});Macro.add('either',{handler:function handler(arraylike){var array=void 0;if(arguments.length===0){wideAlert('There were no arguments provided to '+'Macro.either. Cannot execute.');return;}else if(arguments.length===1){if(!arraylike){wideAlert('The only argument provided to '+'Macro.either is neither an object nor a '+'(non-empty) string. Cannot execute.');return;}else if((typeof arraylike==='undefined'?'undefined':_typeof(arraylike))==='object'){if(!('length'in arraylike)){wideAlert('An object was provided as the '+'only argument to Macro.either, but '+'it has no length property. Cannot execute.');return;}else if(!arraylike.length){wideAlert('An array-like object was provided '+'as the only argument to '+'Macro.either, but it is empty. Cannot '+'execute.');return;}array=arraylike;}else if(typeof arraylike==='string'){array=saferCombinedParse(arraylike);if(!array||(typeof array==='undefined'?'undefined':_typeof(array))!=='object'){wideAlert('The only argument provided to '+'Macro.either does not parse to a non-null '+'object. Cannot execute.');return;}else if(!('length'in array)){wideAlert('An string was provided as the '+'only argument to Macro.either, but '+'the object parsed from it has no length '+'property. Cannot execute.');return;}else if(!array.length){wideAlert('An string was provided '+'as the only argument to '+'Macro.either, but the array-like object '+'parsed from it is empty. Cannot execute.');return;}}else{wideAlert('Only one argument was passed to '+'Macro.either, and this argument is not an array or '+'arraylike object. Cannot execute.');return;}}else{array=arguments;}var index=Math.floor(Math.random()*array.length);var either=array[index];if((typeof either==='undefined'?'undefined':_typeof(either))==='object'){return JSON.stringify(either);}else{return either;}}});Macro.add('random',{handler:function handler(floor,ceiling,float,exclusive){if(typeof floor!=='number'&&typeof floor!=='undefined'){wideAlert('The floor argument provided to '+'Macro.random is not a number. '+'Cannot execute.');return;}else if(Number.isNaN(floor)){wideAlert('The floor argument provided to '+'Macro.random is NaN. Cannot execute.');return;}else if(floor===Number.POSITIVE_INFINITY){wideAlert('The floor argument provided to '+'Macro.random is positive Infinity. Cannot '+'execute.');return;}else if(floor===Number.NEGATIVE_INFINITY){wideAlert('The floor argument provided to '+'Macro.random is negative Infinity. Cannot '+'execute.');return;}else if(typeof ceiling!=='number'&&typeof ceiling!=='undefined'){wideAlert('The ceiling argument provided to '+'Macro.random is not a number. '+'Cannot execute.');return;}else if(Number.isNaN(ceiling)){wideAlert('The ceiling argument provided to '+'Macro.random is NaN. Cannot execute.');return;}else if(ceiling===Number.POSITIVE_INFINITY){wideAlert('The ceiling argument provided to '+'Macro.random is positive Infinity. Cannot '+'execute.');return;}else if(ceiling===Number.NEGATIVE_INFINITY){wideAlert('The ceiling argument provided to '+'Macro.random is negative Infinity. Cannot '+'execute.');return;}var floorVal=floor;var ceilingVal=ceiling;if(floorVal>=ceilingVal){wideAlert('The floor argument provided to '+'Macro.random cannot be greater than or '+'equal to the ceiling argument. Cannot create '+'random number.');return;}if(typeof floor==='undefined'){floorVal=0;}if(typeof ceiling==='undefined'){ceilingVal=1;}var floatVal=float===true||typeof float==='string'&&float.toLowerCase()==='float';var exclusiveVal=void 0;if(exclusive===true||typeof exclusive==='string'&&exclusive.toLowerCase()==='exclusive'){exclusiveVal=true;}else if(typeof exclusive==='string'&&exclusive.toLowerCase()==='floor'){exclusiveVal='floor';}else if(typeof exclusive==='string'&&exclusive.toLowerCase()==='ceiling'){exclusiveVal='ceiling';}if(!floatVal&&floorVal+1>=ceilingVal&&exclusiveVal){wideAlert('The arguments for Macro.random indicate '+'an integer product with exclusive bounds, but '+'the ceiling argument is 1 or less greater than '+'the floor argument. Cannot execute.');return;}var rand=Math.random()*(ceilingVal-floorVal)+floorVal;if(!floatVal){rand=Math.round(rand);}if(rand<=floor){rand=floor;if(exclusiveVal===true||exclusiveVal==='floor'){if(floatVal){rand+=Number.EPSILON;}else{rand++;}}}else if(rand>=ceiling){rand=ceiling;if(exclusiveVal===true||exclusiveVal==='ceiling'){if(floatVal){rand-=Number.EPSILON;}else{rand--;}}}if(rand===-0){rand=0;}return rand;}});Macro.global.rand=Macro.global.random;Macro.add('randomfloat',{handler:function handler(floor,ceiling,exclusive){if(typeof floor!=='number'&&typeof floor!=='undefined'){wideAlert('The floor argument provided to '+'Macro.randomfloat is not a number. '+'Cannot execute.');return;}else if(Number.isNaN(floor)){wideAlert('The floor argument provided to '+'Macro.randomfloat is NaN. Cannot execute.');return;}else if(floor===Number.POSITIVE_INFINITY){wideAlert('The floor argument provided to '+'Macro.randomfloat is positive Infinity. Cannot '+'execute.');return;}else if(floor===Number.NEGATIVE_INFINITY){wideAlert('The floor argument provided to '+'Macro.randomfloat is negative Infinity. Cannot '+'execute.');return;}else if(typeof ceiling!=='number'&&typeof ceiling!=='undefined'){wideAlert('The ceiling argument provided to '+'Macro.randomfloat is not a number. '+'Cannot execute.');return;}else if(Number.isNaN(ceiling)){wideAlert('The ceiling argument provided to '+'Macro.randomfloat is NaN. Cannot execute.');return;}else if(ceiling===Number.POSITIVE_INFINITY){wideAlert('The ceiling argument provided to '+'Macro.randomfloat is positive Infinity. Cannot '+'execute.');return;}else if(ceiling===Number.NEGATIVE_INFINITY){wideAlert('The ceiling argument provided to Macro.random '+'is negative Infinity. Cannot execute.');return;}var floorVal=floor;var ceilingVal=ceiling;if(floorVal>=ceilingVal){wideAlert('The floor argument provided to '+'Macro.randomfloat cannot be greater than or equal '+'to the ceiling argument. Cannot execute.');return;}if(typeof floor==='undefined'){floorVal=0;}if(typeof ceiling==='undefined'){ceilingVal=1;}var exclusiveVal=void 0;if(exclusive===true||typeof exclusive==='string'&&exclusive.toLowerCase()==='exclusive'){exclusiveVal=true;}else if(typeof exclusive==='string'&&exclusive.toLowerCase()==='floor'){exclusiveVal='floor';}else if(typeof exclusive==='string'&&exclusive.toLowerCase()==='ceiling'){exclusiveVal='ceiling';}var rand=Math.random()*(ceilingVal-floorVal)+floorVal;if(rand===floor){if(exclusiveVal===true||exclusiveVal==='floor'){rand+=Number.EPSILON;}}else if(rand===ceiling){if(exclusiveVal===true||exclusiveVal==='ceiling'){rand-=Number.EPSILON;}}if(rand===-0){rand=0;}return rand;}});Macro.global['random-float']=Macro.global.randomfloat;Macro.global.randfloat=Macro.global.randomfloat;Macro.global['rand-float']=Macro.global.randomfloat;Macro.add('randominteger',{handler:function handler(floor,ceiling,exclusive,negative){if(typeof floor!=='number'&&typeof floor!=='undefined'){wideAlert('The floor argument provided to '+'Macro.randominteger is not a number. '+'Cannot execute.');return;}else if(Number.isNaN(floor)){wideAlert('The floor argument provided to '+'Macro.randominteger is NaN. Cannot execute.');return;}else if(floor===Number.POSITIVE_INFINITY){wideAlert('The floor argument provided to '+'Macro.randominteger is positive Infinity. Cannot '+'execute.');return;}else if(floor===Number.NEGATIVE_INFINITY){wideAlert('The floor argument provided to '+'Macro.randominteger is negative Infinity. Cannot '+'execute.');return;}else if(typeof ceiling!=='number'&&typeof ceiling!=='undefined'){wideAlert('The ceiling argument provided to '+'Macro.randominteger is not a number. '+'Cannot execute.');return;}else if(Number.isNaN(ceiling)){wideAlert('The ceiling argument provided to '+'Macro.randominteger is NaN. Cannot execute.');return;}else if(ceiling===Number.POSITIVE_INFINITY){wideAlert('The ceiling argument provided to '+'Macro.randominteger is positive Infinity. Cannot '+'execute.');return;}else if(ceiling===Number.NEGATIVE_INFINITY){wideAlert('The ceiling argument provided to '+'Macro.randominteger is negative Infinity. Cannot '+'execute.');return;}var floorVal=floor;var ceilingVal=ceiling;if(floorVal>=ceilingVal){wideAlert('The floor argument provided to '+'Macro.randominteger cannot be greater than or '+'equal to the ceiling argument. Cannot execute.');return;}if(typeof floor==='undefined'){floorVal=0;}if(typeof ceiling==='undefined'){ceilingVal=1;}var exclusiveVal=void 0;if(exclusive===true||typeof exclusive==='string'&&exclusive.toLowerCase()==='exclusive'){exclusiveVal=true;}else if(typeof exclusive==='string'&&exclusive.toLowerCase()==='floor'){exclusiveVal='floor';}else if(typeof exclusive==='string'&&exclusive.toLowerCase()==='ceiling'){exclusiveVal='ceiling';}if(floorVal+1>=ceilingVal&&exclusiveVal){wideAlert('The arguments for Macro.randominteger '+'indicate exclusive bounds, but the ceiling '+'argument is 1 or less greater than the floor '+'argument. Cannot execute.');return;}var rand=Math.round(Math.random()*(ceilingVal-floorVal)+floorVal);if(rand===floor){if(exclusiveVal===true||exclusiveVal==='floor'){rand++;}}else if(rand===ceiling){if(exclusiveVal===true||exclusiveVal==='ceiling'){rand--;}}if(rand===-0){rand=0;}return rand;}});Macro.global['random-integer']=Macro.global.randominteger;Macro.global.randomint=Macro.global.randominteger;Macro.global['random-int']=Macro.global.randominteger;Macro.global.randinteger=Macro.global.randominteger;Macro.global['rand-integer']=Macro.global.randominteger;Macro.global.randint=Macro.global.randominteger;Macro.global['rand-int']=Macro.global.randominteger;Macro.add('rolldice',{handler:function handler(dice,returnType,discard){/* Production steps of ECMA-262, Edition 5, 15.4.4.21
                 * Reference: http://es5.github.io/#x15.4.4.21 */if(!Array.prototype.reduce){Array.prototype.reduce=function(callback/*, initialValue*/){'use strict';if(this==null){throw new TypeError('Array.prototype.reduce called on null or undefined');}if(typeof callback!=='function'){throw new TypeError(callback+' is not a function');}var t=Object(this),len=t.length>>>0,k=0,value;if(arguments.length==2){value=arguments[1];}else{while(k<len&&!(k in t)){k++;}if(k>=len){throw new TypeError('Reduce of empty array with no initial value');}value=t[k++];}for(;k<len;k++){if(k in t){value=callback(value,t[k],k,t);}}return value;};}/* */var diceVal=void 0;if(typeof dice==='string'){diceVal=saferCombinedParse(dice);if(typeof diceVal==='string'){diceVal=dice.split(' ');}else if(!diceVal||(typeof diceVal==='undefined'?'undefined':_typeof(diceVal))!=='object'){wideAlert('The dice argument provied to '+'Macro.rolldice is not valid. A valid argument '+'is either an array-like object or a string.');return;}else{diceVal=from(diceVal);}}if(!('length'in diceVal)){wideAlert('The object provided to Macro.rolldice as '+'the dice argument does not have a length property. '+'Cannot execute.');return;}else if(!diceVal.length){wideAlert('The array provided to Macro.rolldice as the '+'dice argument is empty. Cannot execute.');return;}else{var filtered=diceVal.filter(function(aa){return typeof aa==='string'&&aa.trim()!=='';});if(filtered.length===0){wideAlert('The dice argument provided to '+'Macro.rolldice is not valid. A valid argument '+'is either an array or string, either containing '+'one or more strings of the type XdY, where X '+'is the number of times to roll that die, and '+'Y is the number of faces on that die.');return;}}var rolls=[];var regex=/\d+d\d+/;for(var ii=0;ii<diceVal.length;ii++){var portion=diceVal[ii];if(typeof portion!=='string'){wideAlert('The portion of the dice argument '+'provided to Macro.diceroll, '+portion+', '+'is not a string. Cannot execute.');continue;}else if(!portion){wideAlert('The portion of the dice argument '+'provided to Macro.diceroll is empty. Ignoring '+'portion.');continue;}else if(!regex.test(portion)){wideAlert('The portion of the dice argument '+'provided to Macro.diceroll, '+portion+', '+'does not match the valid dice pattern. The '+'valid pattern is an integer, immediately '+'followed by the letter d, immediately '+'followed by another integer, e.g. 2d6, or '+'11d4, or 12d18.');continue;}else if(portion.length!==portion.match(regex)[0].length){wideAlert('The portion of the dice argument '+'provided to Macro.diceroll, '+portion+', is not valid. It contains characters '+'extraneous to the valid dice pattern. The '+'valid pattern is an integer, immediately '+'followed by the letter d, immediately '+'followed by another integer, e.g. 3d4, or '+'6d11, or 10d12.');continue;}var split=portion.split('d');var times=Number(split[0]);var sides=Number(split[1]);for(var jj=0;jj<times;jj++){rolls.push(Math.floor(Math.random()*sides)+1);}}rolls=rolls.sort();if(discard&&typeof discard==='string'){var discardVal=discard.toLowerCase().replace(/[ .-]/g,'');var _split=discardVal.toString().split(/\d/);var constant=discardVal.split(/[^\d%]/).slice(-1)[0];var percent=false;if(constant[constant.length-1]==='%'){percent=true;constant=Number(constant.slice(0,-1))/100;}constant=Number(constant);if(percent){if(_split[0]==='lowest'){var lowIndex=Math.round(rolls.length*constant);rolls=rolls.slice(rolls.length*Number(_split[1]));}else if(_split[0]==='highest'){var highIndex=Math.round(rolls.length-rolls.length*constant);rolls=rolls.slice(0,highIndex);}else if(_split[0]==='both'){var _lowIndex=Math.round(rolls.length*constant);var _highIndex=Math.round(rolls.length-rolls.length*constant);rolls=rolls.slice(_lowIndex,_highIndex);}else{wideAlert('The discard argument provided to '+'Macro.rolldice is not valid. Returning as '+'is.');}}else{if(_split[0]==='lowest'){var _lowIndex2=constant;rolls=rolls.slice(_lowIndex2);}else if(_split[0]==='highest'){var _highIndex2=rolls.length-constant;rolls=rolls.slice(0,_highIndex2);}else if(_split[0]==='both'){var _lowIndex3=constant;var _highIndex3=rolls.length-constant;rolls=rolls.slice(_lowIndex3,_highIndex3);}else{wideAlert('The discard argument provided to '+'Macro.rolldice is not valid. Returning as '+'is.');}}}if(!returnType||typeof returnType==='string'&&returnType.toLowerCase()==='sum'){return rolls.reduce(function(a,b){return a+b;});}else{return rolls;}}});Macro.global['roll-dice']=Macro.global.rolldice;Macro.global.diceroll=Macro.global.rolldice;Macro.global['dice-roll']=Macro.global.rolldice;Macro.add('function',{isDoubleTag:true,defer:true,handler:function handler(name,callbackOrOverride,callback){if(arguments.length<2){wideAlert('At least two arguments, the function name '+'and the callback, must be provided to '+'Macro.function to create a function/widget.');return;}else if(arguments.length===2){State.addFunction(name,callbackOrOverride);}else if(arguments.length===3){State.addFunction(name,callback,callbackOrOverride);}}});Macro.global.widget=Macro.global.function;Macro.global.lambda=Macro.global.function;Macro.add('bind',{isDoubleTag:true,defer:true,handler:function handler(name,callback){if(typeof name!=='string'||!name){wideAlert('The nameOrExpression argument passed to '+'Macro.bind is not valid. Cannot bind.');return;}else if(!callback){wideAlert('The callback argument passed to Macro.bind is '+'not valid or is empty. Cannot bind.');return;}var nameVal=name.trim();if(nameVal[0]==='$'){nameVal=nameVal.slice(1);}var selector='data-binding-selector';var $match=$('<tw-binding>'+callback+'</tw-binding>');$match.attr(selector,nameVal);State.addBinding($match.attr(selector),callback);Parser.parseNode($match);return $match[0];}});Macro.add('updatebinding',{handler:function handler(name){if(!name||typeof name!=='string'){wideAlert('The name argument passed to '+'Macro.updatebinding is not valid. Not updating.');return;}State.updateBinding(nameOrExpression);}});Macro.global['update-binding']=Macro.global.updatebinding;Macro.add('updatebindings',{handler:function handler(){State.updateBindings();}});Macro.global['update-bindings']=Macro.global.updatebindings;Macro.add('requestanimationframe',{isDoubleTag:true,defer:true,handler:function handler(callback){var $span=$('<span></span>');$(this).contents().filter(function(_,node){var dataType=$(node).attr('data-type');return dataType!=='openTagTerminator';}).appendTo($span);var func=function func(){Parser.parseNode($span[0]);};requestAnimationFrame(func);return $span[0];}});Macro.global['request-animation-frame']=Macro.global.requestanimationframe;Macro.global.requestanimframe=Macro.global.requestanimationframe;Macro.global['request-anim-frame']=Macro.global.requestanimationframe;Macro.global.raf=Macro.global.requestanimationframe;Macro.add('live',{isDoubleTag:true,defer:true,handler:function handler(time,callback){if(!time){wideAlert('The time argument passed to Macro.live is not '+'valid. Cannot perform live.');return;}else if(!callback){wideAlert('The callback argument passed to Macro.live is '+'not valid. Cannot perform live.');return;}var timeObj={amt:0,unit:'ms'};if(typeof time==='string'){time=time.trim().toLowerCase();if(time.endsWith('ms')){var num=Number(time.split('ms').slice(0,-1).join());if(Number.isNaN(num)||num<=0){wideAlert('The time value passed to Macro.live, '+time+', is not valid.');return;}timeObj.amt=num;}else if(time.endsWith('s')){var _num=Number(time.split('s').slice(0,-1).join());if(Number.isNaN(_num)||_num<=0){wideAlert('The time value passed to Macro.live, '+time+', is not valid.');return;}timeObj.amt=_num;timeObj.unit='s';}else{wideAlert('The time value passed to Macro.live, '+time+', is not valid.');return;}}else if(typeof time==='number'){if(time<=0){wideAlert('The time argument passed to Macro.live must '+'be greater than zero. Cannot perform live.');return;}timeObj.amt=time;}var displayer=$('<span></span>')[0];var deferrer=$('<tw-deferrer class="hidden"></tw-deferrer>')[0];deferrer.innerHTML=callback;var timeVal=timeObj.amt;if(timeObj.unit==='s'){timeVal*=1000;}var intID=window.setInterval(function(){displayer.innerHTML=deferrer.innerHTML;Parser.parseNode(displayer);},timeVal);$(displayer).attr('data-interval-id',intID);$(deferrer).attr('data-interval-id',intID);var parent=$('<span></span>')[0];parent.appendChild(displayer);parent.appendChild(deferrer);return parent;}});Macro.global.interval=Macro.global.live;Macro.global.setinterval=Macro.global.live;Macro.global['set-interval']=Macro.global.live;Macro.add('delay',{isDoubleTag:true,defer:true,handler:function handler(time,callback){if(!time){wideAlert('The time argument passed to Macro.live is '+'not valid. Cannot execute.');return;}else if(!callback){wideAlert('The callback argument passed to Macro.live '+'is not valid. Cannot execute.');return;}var timeObj={amt:0,unit:'ms'};if(typeof time==='string'){time=time.trim().toLowerCase();if(time.endsWith('ms')){var num=Number(time.split('ms').slice(0,-1).join());if(Number.isNaN(num)||num<=0){wideAlert('The time argument passed to '+'Macro.live, '+time+', is not valid. '+'Cannot execute.');return;}timeObj.amt=num;}else if(time.endsWith('s')){var _num2=Number(time.split('s').slice(0,-1).join());if(Number.isNaN(_num2)||_num2<=0){wideAlert('The time argument passed to '+'Macro.live, '+time+', is not valid. '+'Cannot execute.');return;}timeObj.amt=_num2;timeObj.unit='s';}else{wideAlert('The time argument passed to Macro.live, '+time+', is not valid. Cannot execute.');return;}}else if(typeof time==='number'){if(time<=0){wideAlert('The time argument passed to Macro.live '+'must be greater than zero. Cannot execute.');return;}timeObj.amt=time;}var displayer=$('<span></span>')[0];var deferrer=$('<tw-deferrer class="hidden"></tw-deferrer>')[0];deferrer.innerHTML=callback;var timeVal=timeObj.amt;if(timeObj.unit==='s'){timeVal*=1000;}var intID=window.setTimeout(function(){displayer.innerHTML=deferrer.innerHTML;Parser.parseNode(displayer);$(displayer).parent().remove();},timeVal);$(displayer).attr('data-timeout-id',intID);$(deferrer).attr('data-timeout-id',intID);var span=$('<span></span>')[0];span.appendChild(displayer);span.appendChild(deferrer);return span;}});Macro.global.timeout=Macro.global.delay;Macro.global.settimeout=Macro.global.delay;Macro.global['set-timeout']=Macro.global.delay;Macro.add('stop',{handler:function handler(){var selector='[data-interval-id], [data-timeout-id]';var $elem=$(this).parents(selector);if(!$elem.length){wideAlert('Macro.stop/clear can only be used within '+'macros that also contain a live/interval or '+'delay/timeout macro. Cannot execute.');return;}var id=$elem.attr('data-interval-id');if(id){var intervalIDParsed=Math.floor(Number(id));window.clearInterval(intervalIDParsed);}else{id=$elem.attr('data-timeout-id');var timeoutIDParsed=Math.floor(Number(id));}$elem.parent().remove();}});Macro.global.clear=Macro.global.stop;//Macro.global.cleartimeout = Macro.global.stop;
//Macro.global['clear-timeout'] = Macro.global.stop;
Macro.global.clearinterval=Macro.global.stop;Macro.global['clear-interval']=Macro.global.stop;Macro.add('script',{isDoubleTag:true,defer:true,handler:function handler(){for(var ii=0;ii<arguments.length;ii++){var processed=arguments[ii].toString().replace(/[\n\r\t]/g,'');// remove hooks
if(this.getAttribute('data-dialect')==='harlowe'){processed=processed.replace(/^\s*\[|\s*]$/g,'');}try{eval(processed);}catch(e){wideAlert(e);}}}});Macro.add('tojson',{isDoubleTag:true,defer:true,handler:function handler(value){var processed=value.replace(/[\n\r\t]/g,'');// remove hooks
if(this.getAttribute('data-dialect')==='harlowe'){processed=processed.replace(/^\s*\[|\s*]$/g,'');}processed='('+processed+')';try{return JSON.stringify(eval(processed));}catch(e){wideAlert(e);}}});Macro.global['to-json']=Macro.global.tojson;Macro.global.jsonstringify=Macro.global.tojson;Macro.global['json-stringify']=Macro.global.tojson;Macro.add('alert',{handler:function handler(){alert(from(arguments).join(' '));}});Macro.add('log',{handler:function handler(){console.log(from(arguments).join(' '));}});Macro.global.consolelog=Macro.global.log;Macro.global['console-log']=Macro.global.log;Macro.add('passageinfo',{handler:function handler(propName,passageName){var passage=void 0;if(passageName){passage=passageName;}else{passage=State.currentPassageName;}var selector='tw-passagedata[name="'+passage+'"]';var $curPass=$(selector);if(!$curPass.length){if(passageName){wideAlert('There is no tw-passagedata element '+'corresponding to the name, '+passageName+', passed to Macro.passageinfo. Cannot execute.');return;}else{wideAlert('When calling Macro.passageinfo, it was '+'determined that the current state of the '+'story has become corrupted and the '+'State.currentPassageName property is inaccurate. '+'Cannot execute.');return;}}var passObj={pid:$curPass.attr('pid'),name:passage,text:$curPass.text(),html:$curPass.html(),tags:$curPass.attr('tags'),position:$curPass.attr('position')};if(typeof propName!=='undefined'){if(typeof passObj[propName]==='undefined'){wideAlert('There is no '+propName+' property '+'within the generated passage object. '+'Cannot retrieve.');return;}return JSON.stringify(passObj[propName]);}else{return JSON.stringify(passObj);}}});Macro.global['passage-info']=Macro.global.passageinfo;Macro.add('getproperty',{handler:function handler(object,propName){var obj=void 0;if(typeof object==='string'){if(!object){wideAlert('A string was provided as the object '+'argument to Macro.getproperty, but it is '+'empty. Cannot execute.');return;}obj=Macro.saferCombinedParse(obj);if(!obj||(typeof obj==='undefined'?'undefined':_typeof(obj))!=='object'){wideAlert('The string provided as the object '+'argument to Macro.getproperty cannot be '+'parsed or evalled into a valid object. Cannot '+'execute.');return;}}else if((typeof object==='undefined'?'undefined':_typeof(object))==='object'){if(!object){wideAlert('An object was provided as the object '+'argument to Macro.getproperty, but it is '+'null, and null does not have properties. '+'Cannot execute.');return;}obj=object;}else{wideAlert('The object argument provided to '+'Macro.getproperty is neither an object nor a '+'string. Cannot execute.');return;}if(!propName||typeof propName!=='string'){wideAlert('The propName argument provided to '+'Macro.getproperty is not a string, or is an empty '+'string. Cannot execute.');return;}else if(!(propName in obj)){wideAlert('There is no '+propName+' property in '+'the object argument provided to '+'Macro.getproperty. Cannot execute.');return;}if(_typeof(object[propName])==='object'){return JSON.stringify(object[propName]);}else{return propName;}}});Macro.global['get-property']=Macro.global.getproperty;Macro.global.getprop=Macro.global.getproperty;Macro.global['get-prop']=Macro.global.getproperty;Macro.add('math',{handler:function handler(propName){if(typeof propName!=='string'||!propName){wideAlert('The propName argument passed to Macro.math is '+'not valid. Cannot perform action.');return;}var prop=Math[propName];if(!prop){wideAlert('The propName argument passed to Macro.math does '+'not correspond to a property within the Math '+'object. Cannot perform action.');return;}if(isFunction(prop)){return prop.apply(null,from(arguments).slice(1));}else{return prop;}}});Macro.add('number',{handler:function handler(propName){if(typeof propName!=='string'||!propName){wideAlert('The propName argument passed to Macro.number '+'is not valid. Cannot perform action.');return;}var prop=Number[propName];if(!prop){wideAlert('The propName argument passed to Macro.number '+'does not correspond to a property within the '+'Number object. Cannot perform action.');return;}if(isFunction(prop)){return prop.apply(null,from(arguments).slice(1));}else{return prop;}}});Macro.add('access',{handler:function handler(propName){if(!propName||typeof propName!=='string'){wideAlert('The propName argument passed to '+'Macro.access is not valid. Cannot execute.');return;}var split=propName.split('.');var parent=saferEval(split[0]);var child=parent[split[1]];for(var ii=2;ii<split.length;ii++){parent=child;child=parent[split[ii]];}var prop=child;if(typeof parent==='undefined'||typeof child==='undefined'){prop=saferEval(propName);}if(!prop){wideAlert('The propName argument provided to '+'Macro.access does not correspond to any '+'properties. Cannot execute.');return;}var result=void 0;if(isFunction(prop)){result=prop.apply(parent,from(arguments).slice(1));}else{result=prop;}if((typeof result==='undefined'?'undefined':_typeof(result))==='object'){return JSON.stringify(result);}else{return result;}}});Macro.add('addtracerygrammar',{isDoubleTag:true,handler:function handler(name,grammar,modifiers){if(typeof name!=='string'||name===''){wideAlert('The name argument passed to '+'Macro.printtracerygrammar is not valid. Cannot '+'add.');return;}else if(!grammar){wideAlert('The grammar argument passed to '+'Macro.printtracerygrammar is not valid. Cannot '+'add.');return;}State.addTraceryGrammar(name,grammar,modifiers);}});Macro.global['add-tracery-grammar']=Macro.global.addtracerygrammar;Macro.add('setgrammarmodifiers',{handler:function handler(name,modifiers){if(typeof name!=='string'||name===''){wideAlert('The name argument passed to '+'Macro.setgrammarmodifiers is not valid. Cannot '+'modify.');return;}else if(!(name in State.traceryStore)){wideAlert('There is no tracery grammer by the name '+name+' in State.traceryStore. Add the grammar before '+'attempting to modify it.');return;}else if(!modifiers){wideAlert('The modifiers argument passed to '+'Macro.setgrammarmodifiers is not valid. Cannot '+'modify.');}var json=State.traceryStore[name].toJSON();delete State.traceryStore[name];State.addTraceryGrammar(name,modifiers);}});Macro.global['set-grammar-modifiers']=Macro.global.setgrammarmodifiers;Macro.add('printtracerygrammar',{handler:function handler(name,rule,allowEscapeChars){if(typeof name!=='string'||name===''){wideAlert('The name argument passed to '+'Macro.printtracerygrammar is not valid. Cannot '+'print.');return;}else if(!(name in State.traceryStore)){wideAlert('There is no tracery grammer by the name '+name+' in State.traceryStore. Add the grammar before '+'attempting to print it.');return;}var grammar=State.traceryStore[name];if(!rule){rule='#origin#';}return grammar.flatten(rule,allowEscapeChars);}});Macro.global['print-tracery-grammar']=Macro.global.printtracerygrammar;Macro.add('mouseevent',{handler:function handler(propName){if(typeof propName==='undefined'){return window.mouseEvent;}else if(propName in window.mouseEvent){return window.mouseEvent[propName];}else{wideAlert('There is no '+propName+' property in window.mouseEvent.');return null;}}});Macro.global['mouse-event']=Macro.global.mouseevent;Macro.add('keyboardevent',{handler:function handler(key,propName){if(!key||key==='*'){return window.keyEvents;}else{if(!(key in window.keyEvents)){wideAlert('There is no '+key+' property in window.keyEvents.');return null;}if(!propName){return window.keyEvents[key];}else if(propName in window.keyEvents){return window.keyEvents[key][propName];}else{wideAlert('There is no '+propName+' property in window.keyEvents.');return null;}}}});Macro.global['keyboard-event']=Macro.global.keyboardevent;Macro.add('makeelement',{handler:function handler(str){if(!isElementRawString(str)){wideAlert('The str argument passed to '+'Macro.makeelement is not valid. Cannot make.');return;}var elem=$(str)[0];elem.setAttribute('data-gately','');return elem;}});Macro.global['make-element']=Macro.global.makeelement;Macro.add('maketextnode',{handler:function handler(content){if(!content){wideAlert('The content argument passed to '+'Macro.maketextnode is not valid. Cannot make.');return;}return document.createTextNode(content);}});Macro.global['make-text-node']=Macro.global.maketextnode;Macro.add('setelementcontent',{handler:function handler(element,content){if(!element||typeof element!=='string'&&!isElement(element)){wideAlert('The element argument passed to '+'Macro.setelementcontent is not valid. Cannot set '+'element content.');return;}else if(!content){wideAlert('The content argument passed to '+'Macro.setelementcontent is not valid. Cannot set '+'element content.');return;}var validElement=element;if(typeof validElement==='string'){try{validElement=document.querySelector(validElement);}catch(e){/* do nothing */}}if(isElement(content)||isNode(content)){$(element).contents().remove();element.parentElement.appendChild(content);}else{element.innerHTML=content;}return element;}});Macro.global['set-element-content']=Macro.global.setelementcontent;Macro.add('appendnode',{handler:function handler(parentElement,childElement){if(!parentElement||typeof parentElement!=='string'&&!isElement(parentElement)){wideAlert('The parentElement argument passed to '+'Macro.appendelement is not valid. Cannot append.');}else if(!childElement||typeof childElement!=='string'&&!isElement(childElement)&&!isNode(childElement)){wideAlert('The childElement argument passed to '+'Macro.appendelement is not valid. Cannot append.');}var validParent=parentElement;if(typeof validParent==='string'){try{validParent=document.querySelector(parentElement);}catch(e){/* do nothing */}if(!validParent){wideAlert('The string passed as the parentElement '+'argument to Macro.appendelement is not a '+'valid selector.');return;}}var validChild=childElement;if(typeof validChild==='string'){validChild=$(childElement)[0];if(!validChild){wideAlert('The string passed as the childElement '+'argument to Macro.appendelement is not a '+'valid selector.');return;}}validParent.appendChild(validChild);return validChild;}});Macro.global['append-node']=Macro.global.appendnode;Macro.add('removenode',{handler:function handler(node){if(!node||typeof node!=='string'&&!isNode(node)&&!isElement(node)){wideAlert('The node argument passed to '+'Macro.removenode is not valid. Cannot append.');}else if(!node.parentElement){wideAlert('The node.parentElement passed to '+'Macro.removeelement is not valid. Cannot append.');}var validNode=node;if(typeof node==='string'){try{validNode=document.querySelector(node);}catch(e){wideAlert('The string passed as the childElement '+'argument to Macro.removeelement is not a '+'valid selector.');return;}}validNode.parentElement.removeChild(validNode);return validNode;}});Macro.global['remove-node']=Macro.global.removenode;Macro.add('elementscss',{handler:function handler(elementsOrSelector,property,value){if(!elementsOrSelector||typeof elementsOrSelector!=='string'&&!isElement(elementsOrSelector)){wideAlert('The elementsOrSelector argument passed to '+'Macro.elementscss is not valid. Cannot change css.');return;}else if(isElementRawString(validElements)){wideAlert('The Macro.elementscss method can only '+'be used to modify the inline style of '+'pre-existing elements, not construct new '+'elements. Cannot change css.');return;}else if(!property){wideAlert('The property argument passed to '+'Macro.elementscss is not valid. Cannot change css.');return;}else if(typeof value==='undefined'){wideAlert('The value argument passed to '+'Macro.elementscss is not set. Cannot change css.');return;}var $validElements=$(elementsOrSelector);$validElements.css(property,value);return from($(elementsOrSelector));}});Macro.global['elements-css']=Macro.global.elementscss;Macro.add('elementsattr',{handler:function handler(elementsOrSelector,property,value){if(!elementsOrSelector||typeof elementsOrSelector!=='string'&&!isElement(elementsOrSelector)){wideAlert('The elementsOrSelector argument passed to '+'Macro.elementsattr is not valid. Cannot change '+'attr.');return;}else if(isElementRawString(validElements)){wideAlert('The Macro.elementsattr method can only '+'be used to modify the attributes of '+'pre-existing elements, not construct new '+'elements. Cannot change attr.');return;}else if(!property){wideAlert('The property argument passed to '+'Macro.elementsattr is not valid. Cannot change '+'attr.');return;}else if(typeof value==='undefined'){wideAlert('The value argument passed to '+'Macro.elementsattr is not set. Cannot change attr.');return;}var $validElements=$(elementsOrSelector);$validElements.attr(property,value);return from($(elementsOrSelector));}});Macro.global['elements-attr']=Macro.global.elementsattr;Macro.add('jquery',{handler:function handler(selector,extension,value){var $jqObj=$(selector);if(extension){if(!(extension in $jqObj)){wideAlert('The property '+extension+' does not '+'exist in the jQuery ($) object.');return;}else if(Macro.isFunction($jqObj[extension])){return $jqObj[extension](value);}else{if(typeof value==='undefined'){return $jqObj[extension];}else{wideAlert('The '+extension+' property in '+'the jQuery object is not a function. '+'Cannot execute.');return;}}}else{return $jqObj;}}});Macro.global.$=Macro.global.jquery;Macro.add('addmacroalias',{handler:function handler(macroName,aliasName,disposeAfterPassage,override){if(!macroName){wideAlert('The macroName argument passed to '+'Macro.addmacroalias is not valid. Cannot add macro alias.');return;}else if(!aliasName){wideAlert('The aliasName argument passed to '+'Macro.addmacroalias is not valid. Cannot add macro alias.');return;}State.addMacroAlias(macroName,aliasName,disposeAfterPassage,override);}});Macro.global['add-macro-alias']=Macro.global.addmacroalias;Macro.add('printmacroinfo',{handler:function handler(macroName){if(!macroName){wideAlert('The macroName argument passed to '+'Macro.printmacroinfo is not valid. Cannot print.');return;}else if(macroName in Macro){var macro=Macro[macroName];return'isDoubleTag: '+(macro.isDoubleTag||false)+'\n'+'defer: '+(macro.defer||false)+'\n'+'source: '+(macro.handler.toString()||'Empty!');}else if(macroName in State.macroAliasStore){// TODO
}else if(macroName in State.functionStore){// TODO
}else{wideAlert('There is no object by the name '+macroName+' in the Macro object, the State.macroAliasStore '+'object, or the State.functionStore object. Cannot '+'print.');return;}}});Macro.global['print-macro-info']=Macro.global.printmacroinfo;Macro.add('config',{handler:function handler(property,value){if(!property){wideAlert('The property argument passed to Macro.config '+'is not valid. Cannot alter configuration.');return;}else if(typeof value==='undefined'){wideAlert('The value argument passed to Macro.config '+'is not valid. Cannot alter configuration.');return;}var obj={};obj[property]=value;Config.editTheme(obj);}});Macro.add('storyvolume',{handler:function handler(volume){var val=Math.floor(Number(volume));if(volume==='quieter'){val=Math.max(0,Mixer.getStoryVolume()-0.1);Mixer.setStoryVolume(val);}else if(volume==='louder'){val=Math.min(1,Mixer.getStoryVolume()+0.1);}else if(val<=0){wideAlert('The volume argument passed to '+'Macro.soundvolume is not a valid, positive '+'number.');return;}Mixer.setStoryVolume(val);}});Macro.global['story-volume']=Macro.global.storyvolume;Macro.add('newsound',{handler:function handler(name,channel,src,autoplay,loop,volume,fade){new Sound(name,channel,src,autoplay,loop,volume,fade);}});Macro.global['new-sound']=Macro.global.newsound;Macro.add('soundduration',{handler:function handler(soundName,duration){var sound=Mixer.sounds[soundName];if(!sound){wideAlert('There is no sound in Mixer.sounds with the '+'name '+soundName+'. Cannot alter duration.');return;}var val=Math.floor(Number(duration));if(val<=0){wideAlert('The duration argument passed to '+'Macro.soundduration is not a valid, positive '+'number.');return;}sound.duration=val;}});Macro.global['sound-duration']=Macro.global.soundduration;Macro.add('soundchannel',{handler:function handler(soundName,channelName){var sound=Mixer.sounds[soundName];if(!sound){wideAlert('There is no sound in Mixer.sounds with the '+'name '+soundName+'. Cannot assign to channel.');return;}var channel=Mixer.channels[channelName];if(!channel){wideAlert('There is no channel in Mixer.channels with '+'the name '+channelName+'. Cannot assign to '+'channel.');return;}sound.channel=channel;}});Macro.global['sound-channel']=Macro.global.soundchannel;Macro.add('soundsrc',{handler:function handler(soundName,src){var sound=Mixer.sounds[soundName];if(!sound){wideAlert('There is no sound in Mixer.sounds with the '+'name '+soundName+'. Cannot assign to channel.');return;}if(!src){wideAlert('The src argument passed to Macro.soundsrc '+'is not a valid, non-empty string.');return;}sound.audioElement.src=src;}});Macro.global['sound-src']=Macro.global.soundsrc;Macro.add('soundloop',{handler:function handler(soundName,loop){var sound=Mixer.sounds[soundName];if(!sound){wideAlert('There is no sound in Mixer.sounds with the '+'name '+soundName+'. Cannot assign to channel.');return;}if(loop||typeof loop==='undefined'){sound.loop();}else{sound.unloop();}}});Macro.global['sound-loop']=Macro.global.soundloop;Macro.add('soundvolume',{handler:function handler(soundName,volume){var sound=Mixer.sounds[soundName];if(!sound){wideAlert('There is no sound in Mixer.sounds with the '+'name '+soundName+'. Cannot adjust volume.');return;}var val=Math.floor(Number(volume));if(val==='quieter'){sound.quieter();}else if(val==='louder'){sound.louder();}else if(val<=0){wideAlert('The volume argument passed to '+'Macro.soundvolume is not a valid, positive '+'number.');return;}else{sound.setVolume(val);}}});Macro.global['sound-volume']=Macro.global.soundvolume;Macro.add('soundfade',{handler:function handler(soundName,fade){var sound=Mixer.sounds[soundName];if(!sound){wideAlert('There is no sound in Mixer.sounds with the '+'name '+soundName+'. Cannot assign to channel.');return;}if(!fade){wideAlert('The fade argument passed to Macro.soundfade '+'is not valid.');return;}sound.setFade(fade);}});Macro.global['sound-fade']=Macro.global.soundfade;Macro.add('crossfade',{handler:function handler(outSoundName,inSoundName,which){var outSound=Mixer.sounds[outSoundName];if(!outSound){wideAlert('There is no sound in Mixer.sounds with '+'the name '+outSoundName+'. Cannot crossfade.');return;}var inSound=Mixer.sounds[inSoundName];if(!inSound){wideAlert('There is no sound in Mixer.sounds with the '+'name '+inSoundName+'. Cannot crossfade.');return;}outSound.crossfade(inSound,which);}});Macro.global['cross-fade']=Macro.global.crossfade;Macro.add('newchannel',{handler:function handler(name,defaultVolume,sounds){if(!name){wideAlert('The name argument passed to '+'Macro.newchannel is not valid. Cannot create new '+'channel.');return;}var soundObjs=[];for(var ii=0;ii<sounds.length;ii++){var _sound=sounds[ii];if(_sound in Mixer.sounds){soundObjs.push(Mixer.sounds[_sound]);}else{gatelyLog('Could not find sound: '+_sound+'. '+'Cannot add to new channel: '+name+'.');}}new Channel(name,defaultVolume,soundObjs);}});Macro.global['new-channel']=Macro.global.newchannel;Macro.add('channelvolume',{handler:function handler(channelName,volume){var channel=Mixer.channels[channelName];if(!sound){wideAlert('There is no channel in Mixer.channels with '+'the name '+channelName+'. Cannot adjust '+'volume.');return;}var val=Math.floor(Number(volume));if(val==='quieter'){channel.quieter();}else if(val==='louder'){channel.louder();}else if(val<=0){wideAlert('The volume argument passed to '+'Macro.soundvolume is not a valid, positive '+'number.');return;}else{channel.setVolume(val);}}});Macro.global['channel-volume']=Macro.global.channelvolume;Macro.add('makefade',{handler:function handler(isFading,easing,timing,steps){var fade=new Fade(isFading,easing,timing,steps);return JSON.stringify(fade);}});Macro.global['make-fade']=Macro.global.makefade;})();

},{}],5:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}(function(){'use strict';var $=window.jQuery;var getOwnPropertyNames=Object.getOwnPropertyNames;var from=Array.from;var easings={/** Move at a linear rate from start to finish. Note: timing does not
        * affect linear fading. volume = x. */LINEAR:'linear',/** Move at a quadratic rate from start to finish. volume = x^2. */QUADRATIC:'quadratic',/** Move at a cubic rate from start to finish. volume = x^3. */CUBIC:'cubic',/** Move at a quartic rate from start to finish. volume = x^4. */QUARTIC:'quartic',/** Move at a quintic rate from start to finish. volume = x^5. */QUINTIC:'quintic',/** Move at a exponential rate from start to finish. volume = x^10. */EXPONENTIAL:'exponential'};easings=Object.freeze(Object.seal(easings));if(isFunction(window.Proxy)){easings=new window.Proxy(easings,{set:function set(){gatelyLog('Mixer.easings is frozen and '+'sealed, and cannot be altered.');}});}var FADING_EASING_TYPE=easings.LINEAR;/** 
     * An immutable enum-like object containing the possible values for 
     * timings used to fade sounds. It is impossible to change anything
     * within this object or add to it. In ES6, attempting to do so will
     * produce a log message; changes made in earlier versions of ES will
     * fail silently.
     * @global
     * @enum {string}
     * @const
     */var timings={/** Perform easing during the first half of the fade. */EASEIN:'easeIn',/** Perform easing during the second half of the fade. */EASEOUT:'easeOut',/** Perform easing at for the whole of the fade. */EASEINOUT:'easeInOut'};timings=Object.freeze(Object.seal(timings));if(isFunction(window.Proxy)){timings=new window.Proxy(timings,{set:function set(){gatelyLog('Mixer.timings is frozen and sealed, '+'and cannot be altered.');}});}var FADING_TIMING_TYPE=timings.EASEINOUT;var userVolume=1;var storyVolume=1;window.Mixer={easings:easings,timings:timings,channels:{},sounds:{},getUserVolume:function getUserVolume(){return userVolume;},getStoryVolume:function getStoryVolume(){return storyVolume;},setStoryVolume:function setStoryVolume(value){storyVolume=Number(value);Mixer.updateVolumes();},updateVolume:function updateVolume(sound){var totalVolume=userVolume*storyVolume*Mixer.channels[sound.channel].getVolume()*sound.getVolume();sound.audioElement.volume=totalVolume;},updateVolumes:function updateVolumes(){getOwnPropertyNames(Mixer.channels).forEach(function(name){var channel=Mixer.channels[name];getOwnPropertyNames(channel.sounds).forEach(function(name){Mixer.updateVolume(Mixer.sounds[name]);});});}};function updateAudioDisplay(){// add audio channels
var $audioDisplay=$('#defaultAudioDisplay');$audioDisplay.children().remove();var selector='<tw-audio-channel></tw-audio-channel>';var $global=$(selector);$('<span>Master Volume</span>').appendTo($global);$('<br>').appendTo($global);var $input=$('<input></input>');$input.attr({type:'range',value:userVolume,min:'0',max:'1',step:'0.01'});$input.on('change mousemove',function(e){userVolume=e.currentTarget.value;Mixer.updateVolumes();});$input.appendTo($global);$('<span class="rangeReadout">1</span>').appendTo($global);$global.appendTo($audioDisplay);getOwnPropertyNames(Mixer.channels).forEach(function(name){// don't display none channel
if(name==='none'){return;}var channelData=Mixer.channels[name];var selector='<tw-audio-channel></tw-audio-channel>';var $channel=$(selector);var $title=$('<span></span>');$title.text(channelData.getName());$title.appendTo($channel);var $range=$('<input></input>');$range.attr({type:'range',step:'0.01',min:'0',max:'1',value:channelData.getVolume().toString()});$range.appendTo($channel);$range.on('change mousemove',function(e){channelData.setVolume(e.currentTarget.value,'noupdate');});var $readout=$('<span class="rangeReadout"></span>');$readout.text(channelData.getVolume());$readout.appendTo($channel);$channel.appendTo($audioDisplay);});}window.updateAudioDisplay=updateAudioDisplay;var Channel=function Channel(name,defaultVolume,sounds){_classCallCheck(this,Channel);if(!name||typeof name!=='string'){throw new Error('The name argument passed to the Channel '+'constructor is not valid. Cannot add.');}else if(name in Mixer.channels){throw new Error('A channel by that name already exists. '+'Cannot add.');}var storyName=name;this.getName=function getName(){return storyName;};var channelVolume=Number(defaultVolume);if(channelVolume>1){throw new Error('The default volume of a Channel cannot be '+'greater than 1. Cannot create Channel.');}else if(channelVolume<0){throw new Error('The default volume of a Channel cannot be '+'less than 0. Cannot create Channel.');}else if(Number.isNaN(channelVolume)){if(typeof defaultVolume==='undefined'){channelVolume=1;}else{throw new Error('The defaultVolume argument passed to '+'the Channel constructor is not valid. Cannot '+'create Channel.');}}this.getVolume=function getVolume(){return channelVolume;};this.setVolume=function setVolume(value,noupdate){var val=Number(value);if(!validateVolume(val,'setVolume method')){return;}channelVolume=Math.min(1,Math.max(0,val));var soundVals=getOwnPropertyNames(this.sounds).map(function(name){return Mixer.sounds[name];});soundVals.forEach(function(sound){Mixer.updateVolume(sound);});if(noupdate!==true&&noupdate!=='noupdate'){updateAudioDisplay();}};this.quieter=function quieter(){channelVolume=Math.max(0,channelVolume-0.1);};this.louder=function louder(){channelVolume=Math.min(1,channelVolume+0.1);};Mixer.channels[name]=this;this.sounds={};var soundObjs=[];if(typeof sounds==='undefined'||sounds===null){soundObjs=[];}else{soundObjs=from(sounds);}for(var ii=0;ii<soundObjs.length;ii++){var sound=soundObjs[ii];if(!('name'in sound)){gatelyLog('There is no name property in the Sound '+'object '+sound+'. Cannot add Sound to Channel.');continue;}else if(!sound.getName()){gatelyLog('The name property in the Sound object '+sound+' is not valid. Cannot add Sound to '+'Channel.');continue;}var channel=Mixer.channels[sound.channel];var soundName=sound.getName();delete channel.sounds[soundName];sound.channel=this.getName();this.sounds[soundName]=sound;}Mixer.updateVolumes();updateAudioDisplay();};Mixer.channels.none=new Channel('none');window.Channel=Channel;/* ====================================================================
     * Adapted from Robert Penner's Easing Equations v2.01                *
     * (c) 2003 Robert Penner, all rights reserved.                       *
     * These equations are subject to the terms in                        *
     * http://www.robertpenner.com/easing_terms_of_use.html.              *
     * ==================================================================== */function linearEasing(time,initial,change,duration){return change*time/duration+initial;}function quadEasing(time,initial,change,duration,timing){if(timing===Mixer.timings.EASE_IN){return change*(time/=duration)*time+initial;}else if(timing===Mixer.timings.EASE_OUT){return-change*(time/=duration)*(time-2)+initial;}else if(timing===Mixer.timings.EASE_IN_OUT){if((time/=duration/2)<1){return change/2*time*time+initial;}return-change/2*(--time*(time-2)-1)+initial;}}function cubeEasing(time,initial,change,duration,timing){if(timing===Mixer.timings.EASE_IN){return change*(time/=duration)*time*time+initial;}else if(timing===Mixer.timings.EASE_OUT){return change*((time=time/duration-1)*time*time+1)+initial;}else if(timing===Mixer.timings.EASE_IN_OUT){if((time/=duration/2)<1){return change/2*time*time*time+initial;}return change/2*((time-=2)*time*time+2)+initial;}}function quartEasing(time,initial,change,duration,timing){if(timing===Mixer.timings.EASE_IN){return change*(time/=duration)*time*time*time+initial;}else if(timing===Mixer.timings.EASE_OUT){return-change*((time=time/duration-1)*time*time*time-1)+initial;}else if(timing===Mixer.timings.EASE_IN_OUT){if((time/=duration/2)<1){return change/2*time*time*time*time+initial;}return-change/2*((time-=2)*time*time*time-2)+initial;}}function quintEasing(time,initial,change,duration,timing){if(timing===Mixer.timings.EASE_IN){return change*(time/=duration)*time*time*time*time+initial;}else if(timing===Mixer.timings.EASE_OUT){return change*((time=time/duration-1)*time*time*time*time+1)+initial;}else if(timing===Mixer.timings.EASE_IN_OUT){if((time/=duration/2)<1){return change/2*time*time*time*time*time+initial;}return change/2*((time-=2)*time*time*time*time+2)+initial;}}function expEasing(time,initial,change,duration,timing){if(timing===Mixer.timings.EASE_IN){return time===0?initial:change*Math.pow(2,10*(time/duration-1))+initial;}else if(timing===Mixer.timings.EASE_OUT){return time===duration?initial+change:change*(-Math.pow(2,-10*time/duration)+1)+initial;}else if(timing===Mixer.timings.EASE_IN_OUT){if(time===0){return initial;}else if(time===duration){return initial+change;}else if((time/=duration/2)<1){return change/2*Math.pow(2,10*(time-1))+initial;}return change/2*(-Math.pow(2,-10*--time)+2)+initial;}}var easingFunctions={};easingFunctions[Mixer.easings.LINEAR]=linearEasing;easingFunctions[Mixer.easings.QUADRATIC]=quadEasing;easingFunctions[Mixer.easings.CUBIC]=cubeEasing;easingFunctions[Mixer.easings.QUARTIC]=quartEasing;easingFunctions[Mixer.easings.QUINTIC]=quintEasing;easingFunctions[Mixer.easings.EXPONENTIAL]=expEasing;function doFade(soundObj,action,value){if(action==='volume'&&!validateVolume(value)){return;}else if(Number(value)===soundObj.getVolume()){gatelyLog('Can\'t fade to volume ('+value+')  '+'the currently set volume is the same.');return;}var fade=soundObj.fade;if(!fade){wideAlert('the fuckin fade isn\'t valid');}if(fade&&typeof fade.timing!=='string'&&fade.easing!==Mixer.easings.LINEAR){gatelyLog('The sound object\'s fade.easing property is set '+'to '+fade.easing+', which requires the sound '+'object\'s fade.timing property to be set to a valid '+'timing property. However, the current value of '+'fade.timing is '+fade.timing);// return here? idk lol
}var time=0;var initial=void 0;var volume=soundObj.getVolume();var change=void 0;if(action==='play'){initial=0;change=volume;}else if(action==='pause'||action==='stop'){initial=volume;change=-volume;}else if(action==='volume'){initial=volume;change=value-volume;}var duration=fade.duration;var step=duration/fade.steps;var timing=fade.timing;var func=easingFunctions[fade.easing.toLowerCase()];if(!func){wideAlert('The func for the easing don\'t work!!!!!!!!!');return;}var soundObjDup=soundObj;var fadeInterval=window.setInterval(function(){var stepVolume=func(time,initial,change,duration,timing);if(typeof stepVolume==='undefined'||Number.isNaN(Number(stepVolume))){window.clearInterval(fadeInterval);return;}soundObjDup.setVolume(stepVolume);//gatelyLog(soundObjDup.audioElement.volume);
time+=step;if(time>=duration){soundObjDup.setVolume(initial+change);window.clearInterval(fadeInterval);return;}},step);}function createAudioWithErrorHandling(){var audio=new Audio();audio.addEventListener('error',function(e){var err=e.target.error;switch(err.code){case err.MEDIA_ERR_ABORTED:gatelyLog('You aborted the video playback.');break;case err.MEDIA_ERR_NETWORK:gatelyLog('A network error caused the audio download '+'to fail.');break;case err.MEDIA_ERR_DECODE:gatelyLog('The audio playback was aborted due to a '+'corruption problem or because the video used '+'features your browser did not support.');break;case err.MEDIA_ERR_SRC_NOT_SUPPORTED:gatelyLog('The video audio not be loaded, either '+'because the server or network failed or because '+'the format is not supported.');break;default:gatelyLog('An unknown error occurred.');break;}});return audio;}function validateVolume(value,source,suppressLogs){if(!source){source='(source not provided)';}if(!value&&value!==0&&value!=='1'){if(!suppressLogs){gatelyLog('The volume value parameter ('+value+'), '+'in the '+source+', is not valid. The parameter '+'must be a Number or a string representation of a '+'valid Number.');}return false;}else if(Number.isNaN(Number(value))){if(!suppressLogs){gatelyLog('The volume value parameter ('+value+'), '+'in the '+source+', is not a number.');}return false;}else if(Number(value)<0){if(!suppressLogs){gatelyLog('The volume value parameter ('+value+'), '+'in the '+source+', is less than 0.');}return false;}else if(Number(value)>1){if(!suppressLogs){gatelyLog('The volume value parameter ('+value+'), '+'in the '+source+', is greater than 1.');}return false;}return true;}// default Sound constants
var MASTER_VOLUME_LEVEL=1;var MASTER_VOLUME_STEP=0.01;var ELEMENT_VOLUME=1;var FADING_STATUS=false;var FADING_DURATION=1000;var FADING_STEPS=100;var Sound=function(){function Sound(name,channel,src,autoplay,loop,volume,fade){_classCallCheck(this,Sound);if(typeof name!=='string'||!name){wideAlert('The name property ('+name+'), in the Sound '+'constructor, is not a valid string.');return;}else if(typeof src!=='string'||!src){wideAlert('The src property ('+src+'), in the Sound '+'constructor, is not a valid string.');return;}/**
             * @type {string}
             */var storyName=name;this.getName=function getName(){return storyName;};Mixer.sounds[name]=this;if(autoplay===true){this.audioElement.autoplay=true;}if(loop===true){this.audioElement.loop=true;}/**
             * @type {HTMLAudioElement}
             */this.audioElement=createAudioWithErrorHandling();this.audioElement.src=src;if(channel){this.channel=channel;Mixer.channels[channel].sounds[storyName]=storyName;}else{this.channel='none';Mixer.channels.none.sounds[storyName]=storyName;}/**
             * @type {number}
             */var soundVolume=void 0;this.getVolume=function getVolume(){return soundVolume;};/**
             * Sets the volume of the Sound and updates its real volume.
             * @global
             * @param {string|number} value
             * @param {...string|Sound} [variadic]
             * @returns {undefined}
             */this.setVolume=function setVolume(value){var val=Number(value);if(!validateVolume(val,'setVolume method')){return;}soundVolume=Math.min(1,Math.max(0,val));Mixer.updateVolume(this);};if(typeof volume==='number'){this.setVolume(volume);}else{this.setVolume(1);}/** Contains the
             * @type {object}
             * @property {string} [fade.easing='linear']
             * @property {string} [fade.timing='easeInOut']
             * @property {number} [fade.duration=1000]
             * @property {number} [fade.steps=100]
             */var source=Object.freeze(Object.seal(new Fade(FADING_EASING_TYPE,FADING_TIMING_TYPE,FADING_DURATION,FADING_STEPS)));/**
             * Sets the fade options for the Sound. Details on the forms the
             * fade argument can take can be found {@link fuMakeSound here}.
             * @global
             * @param {boolean|string|object} fade {@link fuMakeSound link}
             * @param {...string|FuSound} [variadic]
             * @returns {undefined}
             */this.setFade=function setFade(fade){if(!fade){/* gatelyLog('The fade argument (' + fade + ') passed to ' +
                        'the Sound constructor is not valid.'); */return;}if(!this.fade){this.fade=JSON.parse(JSON.stringify(source));}if(typeof fade==='string'){var fadeVal=saferJSONParse(fade);if(validateFade(fade)){for(var _name in fadeVal){this.fade[_name]=fadeVal[_name];}}else{var easeNames=getOwnPropertyNames(Mixer.easings);var timeNames=getOwnPropertyNames(Mixer.timings);var fadeStr=fade.toUpperCase();if(fadeStr in Mixer.easings){this.fade.easing=Mixer.easings[fadeStr];}else if(fadeStr in Mixer.timings){this.fade.timing=Mixer.timings[fadeStr];}else{gatelyLog('The string passed to the arg '+'parameter ('+fade+') is not a valid '+'easing or timing.');return;}}}else if((typeof fade==='undefined'?'undefined':_typeof(fade))==='object'){if(typeof fade.easing==='string'){var easing=fade.easing.toUpperCase();if(easing in Mixer.easings){this.fade.easing=Mixer.easings[easing];}}else if(_typeof(fade.easing)==='object'){// custom easing support here
}if(typeof fade.timing==='string'){var timing=fade.timing.toUpperCase();if(timing in Mixer.timings){this.fade.timing=Mixer.timings[timing];}}if(fade.duration>0){this.fade.duration=fade.duration;}else{gatelyLog('The duration argument passed to '+'Sound.setFade must be a number greater than 0.');}if(fade.steps>0){this.fade.steps=fade.steps;}else{gatelyLog('The steps argument passed to '+'Sound.setFade must be a number greater than 0.');}}/* const easings = getOwnPropertyNames(Mixer.easings)
                    .map(function(name) {
                        return Mixer.easings[name];
                    });

                const timings = getOwnPropertyNames(Mixer.timings)
                    .map(function(name) {
                        return Mixer.timings[name];
                    });

                if (this.fade.isFading !== false &&
                    typeof(this.fade.isFading) === 'boolean' &&
                    easings.indexOf(this.fade.easing.name) !== -1 &&
                    timings.indexOf(this.fade.timing) !== -1 &&
                    this.fade.duration > 0 &&
                    this.fade.steps > 0)
                {
                    this.fade.isFading = true;
                } */};this.setFade(fade);updateAudioDisplay();}/**
         * Plays the audio element. Will fade if the Sound's fade object is
         * valid.
         * and the 
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */_createClass(Sound,[{key:'play',value:function play(toFade,newFade){if(!this.audioElement.paused){wideAlert('You cannot play a Sound that is already playing.');return;}if(typeof newFade!=='undefined'){this.setFade(newFade);}this.audioElement.play();if(toFade===true||toFade==='toFade'){doFade(this,'play');}}/**
         * Pauses the audio element.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'pause',value:function pause(toFade,newFade){if(this.audioElement.paused){wideAlert('You cannot pause a Sound that is already paused.');return;}if(typeof newFade!=='undefined'){this.setFade(newFade);}this.audioElement.pause();if(toFade===true||toFade==='toFade'){doFade(this,'pause');}}/**
         * Stops the audio element. In effect, this is pausing the element
         * and setting the position to 0.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'stop',value:function stop(toFade,newFade){if(this.audioElement.paused&&this.audioElement.currentTime===0){wideAlert('You cannot stop a Sound that is already stopped.');return;}if(typeof newFade!=='undefined'){this.setFade(fade);}this.pause();this.setPosition(0);if(toFade===true||toFade==='toFade'){doFade(this,'play','fromaction');}}/**
         * Rewinds the audio element to the beginning, without pausing it.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'restart',value:function restart(){this.setPosition(0);}/**
         * Sets the currentTime position of the audio element.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'setPosition',value:function setPosition(position){var posi=Number(position);if(Number.isNaN(posi)){wideAlert('The position argument passed to '+'Sound.rewindSound is not a valid number. Cannot '+'set position.');return;}else{this.audioElement.currentTime=posi;}}/**
         * Lowers the volume of the Sound by 0.1. The lowest possible value is
         * 0; lowering it beyond this will have no effect or warning.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'quieter',value:function quieter(){this.setVolume(this.getVolume()-0.1);}/**
         * Raises the volume of the Sound by 0.1. The highest possible value
         * is 1; lowering it beyond this will have no effect or warning.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'louder',value:function louder(){this.setVolume(this.getVolume()+0.1);}/**
         * Sets the audio element's loop property to true.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'loop',value:function loop(){this.audioElement.loop=true;}},{key:'unloop',/**
         * Sets the audio element's loop property to false.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */value:function unloop(){this.audioElement.unloop=false;}/**
         * Deletes all references to the Sound in the Mixer and Channels.
         * @global
         * @param {...string|FuSound} [variadic]
         * @returns {undefined}
         */},{key:'delete',value:function _delete(){if(!this.getName()){wideAlert('This Sound does not have a valid name property. '+'Cannot delete.');return;}else if(!this.channel){wideAlert('This Sound does not have a valid channel '+'property. Cannot delete.');return;}else if(!this.channel.sounds){wideAlert('This Sound does not have a valid channel.sounds '+'property. Cannot delete.');return;}delete Mixer.sounds[this.getName()];delete Mixer.channels[this.channel].sounds[this.getName()];}/**
         * Stops a playing Sound and plays a stopped or paused Sound, fading
         * the two in/out in an identical fashion. The FuSound being faded out
         * must be playing, and the FuSound being faded in must be paused,
         * otherwise the crossfade will not be performed. By default, the
         * specific manner in which the fades are performed on both Sounds
         * are taken from the sound being faded out and applied to both.
         * However, if the which argument is either "in" or equal to the Sound
         * being faded in, the fade information will be taken from the Sound
         * being faded in.
         * @global
         * @param {string|FuSound} [which] If the value of which is "in," or
         * the value of which is equal to the inSoundObj argument,
         * inSoundObj.fade will be used to determine how the fade is
         * performed, rather than outSoundObj.fade.
         * @returns {undefined}
         */},{key:'crossFade',value:function crossFade(inSoundObj,which){if(!inSoundObj||typeof inSoundObj!=='string'&&(typeof inSoundObj==='undefined'?'undefined':_typeof(inSoundObj))!=='object'){gatelyLog('The inSoundObj argument ('+inSoundObj+') is invalid.');return;}if(typeof inSoundObj==='string'){inSoundObj=Mixer.sounds[inSoundObj];}if(this.audioElement.paused){gatelyLog('Cannot fade  the outSoundObj is not playing.');return;}else if(!inSoundObj.audioElement.paused){gatelyLog('Cannot fade  the inSoundObj is already '+'playing.');return;}var fade=this.fade;if(which==='in'||which===inSoundObj){fade=inSoundObj.fade;}if(typeof fade.easing!=='string'||!(fade.easing.toUpperCase()in Mixer.easings)||typeof fade.timing!=='string'||!(fade.timing.toUpperCase()in Mixer.timings)||typeof fade.duration!=='number'||fade.duration<=0||typeof fade.steps!=='number'||fade.steps<=0){gatelyLog('One or more of the values in the '+'outSoundObj\'s fade property is invalid. Cannot '+'crossfade.');return;}var duration=fade.duration;var step=duration/fade.steps;var timing=fade.timing;var easer=easingFunctions[fade.easing.toLowerCase()];if(!isFunction(easer)){gatelyLog('The easer function\'s all fucked up!!!!');return;}var outSoundObj=this;var outTime=outSoundObj.audioElement.currentTime*1000;var outInitial=this.getVolume();var outChange=-this.getVolume();var outFadeInterval=window.setInterval(function(){var stepVolume=easer(outTime,outInitial,outChange,duration,timing);if(typeof stepVolume==='undefined'||Number.isNaN(Number(stepVolume))){window.clearInterval(outFadeInterval);return;}outSoundObj.setVolume(stepVolume);if(outSoundObj.audioElement.paused||outTime+duration>=outSoundObj.audioElement.currentTime){outSoundObj.setVolume(outInitial+outChange);Mixer.updateVolume(outSoundObj);if(outSoundObj.audioElement.paused){outSoundObj.setPosition(0);}else{outSoundObj.stop();}window.clearInterval(outFadeInterval);return;}},step);var inTime=inSoundObj.audioElement.currentTime*1000;var inInitial=0;var inChange=outInitial;var inFadeInterval=window.setInterval(function(){var stepVolume=easer(inTime,inInitial,inChange,duration,timing);if(typeof stepVolume==='undefined'||Number.isNaN(Number(stepVolume))){window.clearInterval(inFadeInterval);return;}inSoundObj.setVolume(stepVolume);if(inSoundObj.audioElement.paused||inTime+duration>=outSoundObj.audioElement.currentTime){inSoundObj.setVolume(inInitial+inChange);Mixer.updateVolume(inSoundObj);window.clearInterval(inFadeInterval);return;}},step);inSoundObj.play();}}]);return Sound;}();window.Sound=Sound;var Fade=function Fade(easing,timing,duration,steps){_classCallCheck(this,Fade);this.easing=easing;this.timing=timing;this.duration=duration;this.steps=steps;};window.Fade=Fade;function validateFade(fade){return fade&&(typeof fade==='undefined'?'undefined':_typeof(fade))==='object'&&fade.duration>0;}var Playlist=function(){function Playlist(sounds,autoplay,repeat,fade,queryInterval){_classCallCheck(this,Playlist);this.sounds=sounds;this.autoplay=autoplay;this.repeat=repeat;this.fade=fade;this.index=0;this.intervalID=null;this.currentlyPlaying=null;this.queryInterval=250;if(!Number.isNaN(Number(queryInterval))){this.queryInterval=Math.floor(Number(queryInterval));}if(this.autoplay===true||this.autoplay==='autoplay'){this.play();}}_createClass(Playlist,[{key:'getQueryInterval',value:function getQueryInterval(){return this.queryInterval;}},{key:'play',value:function play(){var currentSound=this.sounds[this.index];var validatePSR=validatePlaylistSoundReadiness;if(!validatePSR(currentSound)){return;}currentSound.play(Boolean(this.fade),this.fade);this.currentlyPlaying=currentSound;var playlist=this;this.intervalID=window.setInterval(function(){// retain 'this' reference
playlist.poll.call(playlist);},this.getQueryInterval());}},{key:'poll',value:function poll(){var currentSound=this.currentlyPlaying;var duration=currentSound.audioElement.duration*1000;var currentTime=currentSound.audioElement.currentTime*1000;var playbackRate=currentSound.audioElement.playbackRate;var outTooShort=void 0;var inTooShort=void 0;if(this.fade){outTooShort=duration/2<=this.fade.duration;if(outTooShort&&currentTime<=this.getQueryInterval()){gatelyLog('Out sound too short for specified fade. Any '+'sound being crossfaded in a Playlist must be more '+'than twice the length of the playlist\'s fade '+'duration. Not fading.');}var inSound=this.sounds[this.index+1]||this.sounds[0];inTooShort=inSound.audioElement.duration*1000/2<=this.fade.duration;if(inTooShort&&currentTime<=this.getQueryInterval()){gatelyLog('In sound too short for specified fade. Any '+'sound being crossfaded in a Playlist must be more '+'than twice the length of the playlist\'s fade '+'duration. Not fading.');}}if(this.fade&&this.fade.duration&&!inTooShort&&!outTooShort){playlistPlayWithFade(this);}else if(duration-currentTime<this.getQueryInterval()){playlistPlayWithoutFade(this);}}},{key:'stop',value:function stop(){if(this.currentlyPlaying&&isFunction(this.currentlyPlaying.stop)){this.currentlyPlaying.stop();}resetPlaylist(this);}}]);return Playlist;}();window.Playlist=Playlist;function playlistPlayWithFade(playlist){var validatePSR=validatePlaylistSoundReadiness;var currentSound=playlist.currentlyPlaying;var duration=currentSound.audioElement.duration*1000;var currentTime=currentSound.audioElement.currentTime*1000;var totalTime=duration-playlist.fade.duration;if(currentTime+playlist.getQueryInterval()>=totalTime){currentSound.fade=playlist.fade;playlist.index++;currentSound=playlist.sounds[playlist.index];if(currentSound){if(validatePSR(currentSound)){playlist.currentlyPlaying.crossFade(currentSound);}else{resetPlaylist(playlist);}}else{if(playlist.repeat===true||playlist.repeat==='repeat'){playlist.index=0;currentSound=playlist.sounds[playlist.index];if(playlist.sounds.length>1){if(validatePSR(currentSound)){playlist.currentlyPlaying.crossFade(currentSound);}else{resetPlaylist(playlist);}}else{if(validatePSR(currentSound)){currentSound.play('fade');}else{resetPlaylist(playlist);}}}else{resetPlaylist(playlist);}}playlist.currentlyPlaying=currentSound;}}function playlistPlayWithoutFade(playlist){var validatePSR=validatePlaylistSoundReadiness;var currentSound=playlist.currentlyPlaying;currentSound.stop();playlist.index++;currentSound=playlist.sounds[playlist.index];if(currentSound){if(validatePSR(currentSound)){currentSound.play(Boolean(playlist.fade),playlist.fade);playlist.currentlyPlaying=currentSound;}else{resetPlaylist(playlist);}}else{playlist.index=0;if(playlist.repeat===true||playlist.repeat==='repeat'){currentSound=playlist.sounds[playlist.index];if(validatePSR(currentSound)){currentSound.play(Boolean(playlist.fade),playlist.fade);playlist.currentlyPlaying=currentSound;}else{resetPlaylist(playlist);}}else{resetPlaylist(playlist);}}}function validatePlaylistSoundReadiness(sound){if(!sound){gatelyLog('The current index of this Playlist does not '+'correspond to a valid Sound in the this.sounds '+'property. Cannot execute.');return false;}else if(!sound.audioElement.paused){gatelyLog('The current Sound object in this Playlist is '+'already playing. A Playlist can only play if every '+'Sound object is paused when it is reached.');return false;}/* else if (sound.audioElement.currentTime !== 0) {
            gatelyLog('The current Sound object in this Playlist is ' +
                'not at time 0. A Playlist can only play if every ' +
                'Sound object is paused and at position 0 when it is ' +
                'reached.');
            return false;
        } */return true;}function resetPlaylist(playlist){if(!playlist){gatelyLog('Invalid playlist argument provided to resetPlaylist.');return;}playlist.index=0;playlist.currentlyPlaying=null;window.clearInterval(playlist.intervalID);playlist.intervalID=null;}})();

},{}],6:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}(function(){'use strict';// The global debug flag for the story.
window.DEBUG=false;// Gately is now loading.
window.isLoading=true;// The time at which gately began loading.
window.gatelyLoadTime=new Date().getTime();// Push a new load frame to the state stack.
State.newState('load');// Set the current transcript entry to the load frame.
State.currentTranscriptEntry=State.transcriptHistory[0];var selector=void 0;// Process flags within the story <tw-storydata>.
var flags=$storydata.attr('flags');var processed=[];if(flags){var splitFlags=flags.split(' ');splitFlags.forEach(function(aa){if(processed.indexOf(aa)===-1){processed.push(aa);}});}// Check for DEBUG signs.
if(processed.indexOf('debug')!==-1||$storydata.find('[name="debug"]').length){window.DEBUG=true;}function proxyRecordState(name,target,property,value){var debug=window.DEBUG;var recording=State.recordingTranscript;var stateChanges=Options.recordingLevels.stateChanges;var load=Options.recordingLevels.load;var isLoading=window.isLoading;var render=Options.recordingLevels.render;var isRendering=Renderer.isRendering;if(debug||recording&&(isLoading&&load&&stateChanges||isRendering&&render&&stateChanges||!isLoading&&!isRendering&&stateChanges)){Options.captureStateChange(name,target,property,value);}}/* If the Proxy constructor is available, attach a Proxy to the State
     * object and each of the objects therein. This allows state changes
     * to be captured by the debugger. */if(isFunction(window.Proxy)){var _loop=function _loop(_name){if(_typeof(State[_name])==='object'&&State[_name]){State[_name]=new window.Proxy(State[_name],{set:function set(target,property,value){proxyRecordState(_name,target,property,value);target[property]=value;return true;}});}};for(var _name in State){_loop(_name);}State=new window.Proxy(State,{set:function set(target,property,value){proxyRecordState(name,target,property,value);target[property]=value;return true;}});}// Add the history buttons to the <tw-story> element.
var str='<tw-history-button class="back hidden">'+'\<'+'</tw-history-button>';$('tw-story#passage').append(str);str='<tw-history-button class="forward hidden">'+'\>'+'</tw-history-button>';$('tw-story#passage').append(str);/* Define important iframe contents and add all non-onstart scripts and
     * styles. */var frame=$('#defaultTranscriptFrame')[0];var frameHTML=frame.contentDocument.body.parentElement;var frameHead=frameHTML.querySelector('head');var frameBody=frameHTML.querySelector('body');var passagePane=$('<div id="passagePane"></div>')[0];frameBody.appendChild(passagePane);var $displayPane=$('<div id="displayPane"></div>');frameBody.appendChild($displayPane[0]);selector='<tw-tabcontrol id="transcriptTabControl"></tw-tabcontrol>';var tabControl=$(selector)[0];$displayPane.append(tabControl);// detail tab
selector='<tw-tab id="detailsTab" '+'class="active"'+'data-selector="#transcriptDetailsDiv">Details</tw-tab>';var detailsTab=$(selector)[0];tabControl.appendChild(detailsTab);// detail tab container
selector='<div id="transcriptDetailsDiv" class="active"></div>';var $transcriptDetailsDiv=$(selector);$displayPane.append($transcriptDetailsDiv);// flat tab
selector='<tw-tab id="flatTab" '+'data-selector="#transcriptFlatDiv">Flat</tw-tab>';var flatTab=$(selector)[0];tabControl.appendChild(flatTab);// flat tab container
var $transcriptFlatDiv=$('<div id="transcriptFlatDiv"></div>');$displayPane.append($transcriptFlatDiv);// animated tab
selector='<tw-tab id="animatedTab" '+'data-selector="#transcriptAnimatedDiv">Animated</tw-tab>';var animatedTab=$(selector)[0];tabControl.appendChild(animatedTab);// animated tab container
selector='<div id="transcriptAnimatedDiv"></div>';var $transcriptAnimatedDiv=$(selector);$displayPane.append($transcriptAnimatedDiv);// settings tab
selector='<tw-tab id="settingsTab" '+'data-selector="#transcriptSettingsDiv">Settings</tw-tab>';var settingsTab=$(selector)[0];tabControl.appendChild(settingsTab);// settings tab container
selector='<div id="transcriptSettingsDiv"></div>';var transcriptSettingsDiv=$(selector)[0];$displayPane.append(transcriptSettingsDiv);// transcript display settings
var displaySettingsSpan=$('<span>Display Settings</span>')[0];transcriptSettingsDiv.appendChild(displaySettingsSpan);var dispTextChangesSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(dispTextChangesSpan);selector='<input id="dispTextChangesCheckbox" type="checkbox"></input>';var dispTextChangesCheckbox=$(selector)[0];dispTextChangesSpan.appendChild(dispTextChangesCheckbox);selector='<label for="dispTextChangesCheckbox">'+'Display Text Changes</label>';var dispTextChangesLabel=$(selector)[0];dispTextChangesSpan.appendChild(dispTextChangesLabel);var dispPageEventsSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(dispPageEventsSpan);selector='<input id="dispPageEventsCheckbox" type="checkbox"></input>';var dispPageEventsCheckbox=$(selector)[0];dispPageEventsSpan.appendChild(dispPageEventsCheckbox);selector='<label for="dispPageEventsCheckbox">'+'Display Page Events</label>';var dispPageEventsLabel=$(selector)[0];dispPageEventsSpan.appendChild(dispPageEventsLabel);var dispStateChangesSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(dispStateChangesSpan);selector='<input id="dispStateChangesCheckbox" type="checkbox"></input>';var dispStateChangesCheckbox=$(selector)[0];dispStateChangesSpan.appendChild(dispStateChangesCheckbox);selector='<label for="dispStateChangesCheckbox">'+'Display State Changes</label>';var dispStateChangesLabel=$(selector)[0];dispStateChangesSpan.appendChild(dispStateChangesLabel);var dispLoadSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(dispLoadSpan);selector='<input id="dispLoadCheckbox" type="checkbox"></input>';var dispLoadCheckbox=$(selector)[0];dispLoadSpan.appendChild(dispLoadCheckbox);selector='<label for="dispLoadCheckbox">'+'Display Load</label>';var dispLoadLabel=$(selector)[0];dispLoadSpan.appendChild(dispLoadLabel);var dispParseSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(dispParseSpan);selector='<input id="dispParseCheckbox" type="checkbox"></input>';var dispParseCheckbox=$(selector)[0];dispParseSpan.appendChild(dispParseCheckbox);selector='<label for="dispLoadCheckbox">'+'Display Parse</label>';var dispParseLabel=$(selector)[0];dispParseSpan.appendChild(dispParseLabel);var dispRenderSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(dispParseSpan);selector='<input id="dispRenderCheckbox" type="checkbox"></input>';var dispRenderCheckbox=$(selector)[0];dispRenderSpan.appendChild(dispRenderCheckbox);selector='<label for="dispRenderCheckbox">'+'Display Render</label>';var dispRenderLabel=$(selector)[0];dispRenderSpan.appendChild(dispRenderLabel);transcriptSettingsDiv.appendChild(document.createElement('br'));// transcript recording settings
selector='<span class="title">Recording Settings</span>';var recordingSettingsTitle=$(selector)[0];transcriptSettingsDiv.appendChild(recordingSettingsTitle);var recTextChangesSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(recTextChangesSpan);selector='<input id="recTextChangesCheckbox" type="checkbox"'+'data-selector="#transcriptSettingsDiv"></input>';var recTextChangesCheckbox=$(selector)[0];recTextChangesSpan.appendChild(recTextChangesCheckbox);selector='<label for="recTextChangesCheckbox">'+'Record Text Changes</label>';var recTextChangesLabel=$(selector)[0];recTextChangesSpan.appendChild(recTextChangesLabel);var recPageEventsSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(recPageEventsSpan);selector='<input id="recPageEventsCheckbox" type="checkbox"></input>';var recPageEventsCheckbox=$(selector)[0];recPageEventsSpan.appendChild(recPageEventsCheckbox);selector='<label for="recPageEventsCheckbox">'+'Record Page Events</label>';var recPageEventsLabel=$(selector)[0];recPageEventsSpan.appendChild(recPageEventsLabel);var recStateChangesSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(recStateChangesSpan);selector='<input id="recStateChangesCheckbox" type="checkbox"></input>';var recStateChangesCheckbox=$(selector)[0];recStateChangesSpan.appendChild(recStateChangesCheckbox);selector='<label for="recStateChangesCheckbox">'+'Record State Changes</label>';var recStateChangesLabel=$(selector)[0];recStateChangesSpan.appendChild(recStateChangesLabel);var recLoadSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(recLoadSpan);selector='<input id="recLoadCheckbox" type="checkbox"></input>';var recLoadCheckbox=$(selector)[0];recLoadSpan.appendChild(recLoadCheckbox);selector='<label for="recLoadCheckbox">'+'Record Load</label>';var recLoadLabel=$(selector)[0];recLoadSpan.appendChild(recLoadLabel);var recParseSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(recParseSpan);selector='<input id="recParseCheckbox" type="checkbox"></input>';var recParseCheckbox=$(selector)[0];recParseSpan.appendChild(recParseCheckbox);selector='<label for="recLoadCheckbox">'+'Record Parse</label>';var recParseLabel=$(selector)[0];recParseSpan.appendChild(recParseLabel);var recRenderSpan=$('<span></span>')[0];transcriptSettingsDiv.appendChild(recParseSpan);selector='<input id="recRenderCheckbox" type="checkbox"></input>';var recRenderCheckbox=$(selector)[0];recRenderSpan.appendChild(recRenderCheckbox);selector='<label for="recRenderCheckbox">'+'Record Render</label>';var recRenderLabel=$(selector)[0];recRenderSpan.appendChild(recRenderLabel);frameBody.style.overflowY='hidden';selector='style';$(selector).each(function(_,style){var styleClone=style.cloneNode(true);// style does not work on append with type
styleClone.removeAttribute('type');frameHead.appendChild(styleClone);});var script=document.createElement('script');function resizeIframeHeight(){var lastHeight=0;window.sizeID=window.setInterval(function(){var compatibility=void 0;var highest=0;for(var ii=0;ii<document.body.childNodes.length;ii++){var child=document.body.childNodes[ii];compatibility=Math.max(child.clientHeight,child.scrollHeight);//, child.offsetHeight);
if(highest<compatibility){highest=compatibility;}}if(!highest){return;}var frameDisplay=top.document.querySelector('#defaultTranscriptDisplay');frameDisplay.style.height=highest+'px';var maxHeight=top.document.body.clientHeight*0.85+'px';frameDisplay.style.maxHeight=maxHeight;compatibility=Math.max(top.document.body.clientHeight,top.document.body.scrollHeight,//body.offsetHeight, 
top.document.body.parentElement.clientHeight,top.document.body.parentElement.scrollHeight);//, html.offsetHeight );
var passagePane=document.querySelector('#passagePane');if(passagePane){passagePane.style.maxHeight=maxHeight;}var displayPane=document.querySelector('#displayPane');if(displayPane){displayPane.style.maxHeight=maxHeight;}lastHeight=compatibility;},1000);};script.innerHTML=resizeIframeHeight.toString()+'\nresizeIframeHeight()';frameBody.appendChild(script);$displayPane.on('click','tw-tab',function(e){var $tabControl=$(e.currentTarget).parent();$tabControl.find('tw-tab').removeClass('active');var $tgt=$(e.currentTarget);$tgt.addClass('active');var selector=$tgt.attr('data-selector');$displayPane.children('div').removeClass('active');$displayPane.children(selector).addClass('active');});if(!State.currentTheme.debug.allowTranscripts&&!DEBUG){$('#printTranscriptToConsole').addClass('hidden');}var $displayPassage=$('#passage');// an enumeration of all known jquery handlers
var jqueryEvents=['click','blur','contextmenu','dblclick','error','focusin','focusout','hover','keydown','keypress','keyup','load','mousedown','mouseup','mouseenter','mouseleave','mousemove','mouseout','mouseover','mouseon','ready','scroll','select','submit','toggle','unload'];// checks for link clicks leading to a new passage and a new state head
// (as in the top of the stack)
$displayPassage.on('click','tw-link.passage',function(e){// clear intervals
$(e.target).parents('tw-passage').nextAll().each(function(_,node){var intervalEls=$(node).find('[data-interval-id]');intervalEls.each(function(_,intervalEl){if(!intervalEl.getAttribute){return;}intervalEl=intervalEl.getAttribute('data-interval-id');window.clearInterval(intervalEl);});});// clear timeouts
$(e.target).parents('tw-passage').nextAll().each(function(_,node){var timeoutEls=$(node).find('[data-timeout-id]');timeoutEls.each(function(_,timeoutEl){if(!timeoutEl.getAttribute){return;}timeoutEl=timeoutEl.getAttribute('data-timeout-id');window.clearTimeout(timeoutEl);});});// render binding selectors temporarily unusable
$('tw-binding').each(function(_,binding){var $binding=$(binding);var selector='data-binding-selector';var attr=$binding.attr(selector);if(!attr.startsWith('***')){$binding.attr(selector,'***'+attr);}attr=$binding.attr(selector);if(!attr.endsWith('***')){$binding.attr(selector,attr+'***');}});// delete all auto-disposable macro aliases
while(State.macroAliasDisposals.length){var _name2=State.macroAliasDisposals.pop();delete State.macroAliasStore[_name2];}// render the new passage
Renderer.render($(e.currentTarget).attr('passage-name'));// fix
/* $('html, body').animate({
            scrollTop: 10000
        }, 1250); */});// checks for jonah-style rewind actions
var pastSelector='tw-passage:not(.current):not(.future)';$displayPassage.on('click',pastSelector,function(e){// render binding selectors temporarily unusable
$('tw-binding').each(function(_,binding){var $binding=$(binding);var selector='data-binding-selector';var attr=$binding.attr(selector);if(!attr.startsWith('***')){$binding.attr(selector,'***'+attr);}attr=$binding.attr(selector);if(!attr.endsWith('***')){$binding.attr(selector,attr+'***');}});// remove ***  ***, reactivating bindings on the current passage
$(e.target).find('tw-binding').each(function(_,binding){var $binding=$(binding);var selector='data-binding-selector';var attr=$binding.attr(selector);$binding.attr(selector,attr.slice(3,-3));});var id=$(e.currentTarget).attr('data-id');Renderer.render(id,'rewind',Config.renderTypes.jonah);});// checks for jonah-style fast-forward actions
$displayPassage.on('click','tw-passage.future',function(e){// render binding selectors temporarily unusable
$('tw-binding').each(function(_,binding){var $binding=$(binding);var selector='data-binding-selector';var attr=$binding.attr(selector);if(!attr.startsWith('***')){$binding.attr(selector,'***'+attr);}attr=$binding.attr(selector);if(!attr.endsWith('***')){$binding.attr(selector,attr+'***');}});// remove ***  ***, reactivating bindings on the current passage
$(e.target).find('tw-binding').each(function(_,binding){var $binding=$(binding);var selector='data-binding-selector';var attr=$binding.attr(selector);$binding.attr(selector,attr.slice(3,-3));});var id=$(e.target).attr('data-id');Renderer.render(id,'fastforward',Config.renderTypes.jonah);});// checks for sugarcube-style rewind actions
$displayPassage.on('click','tw-history-button.back',function(e){var passageName=State.history[State.history.length-2];Renderer.render(passageName,'rewind',Config.renderTypes.sugarcube);});// checks for sugarcube-style fast-forward actions
$displayPassage.on('click','tw-history-button.forward',function(e){var passageName=State.historyFuture[0];Renderer.render(passageName,'fastforward',Config.renderTypes.sugarcube);});// checks for collapser clicks
var containers=$('#defaultMenu').add($displayPane).add(passagePane);containers.on('click','.collapser',function(e){var $target=$(e.currentTarget);var on=$target.attr('data-on');var off=$target.attr('data-off');var $parent=$target.parent();if($parent.hasClass('collapsed')){$target.text(on);$parent.removeClass('collapsed');}else{$target.text(off);$parent.addClass('collapsed');}});$(containers).on('click','.destructor',function(e){var $defaultMenu=$('#defaultMenu');$defaultMenu.attr('data-choice','options');$defaultMenu.find(':not(tw-element-resizer):not(.collapser)').removeClass('active');$defaultMenu.find('#defaultOptions').addClass('active');$defaultMenu.find('tw-element-resizer').attr('data-selector','#defaultOptions');$(e.currentTarget).remove();});containers.on('change mousemove','input[type="range"]',function(e){var $target=$(e.currentTarget);$(e.currentTarget).next('.rangeReadout').text($target.val());});var $defaultMenu=$('#defaultMenu');$('#gotoAudio').click(function(e){$defaultMenu.attr('data-choice','audio');$defaultMenu.find(':not(tw-element-resizer):not(.collapser)').removeClass('active');$defaultMenu.find('#defaultAudioDisplay').addClass('active');$defaultMenu.find('tw-element-resizer').attr('data-selector','tw-audio-display');if(!$(defaultMenu).find('.destructor').length){$defaultMenu.append('<button class="destructor">X</button>');}});$('#gotoAccessibility').click(function(e){$defaultMenu.attr('data-choice','accessibility');$defaultMenu.find(':not(tw-element-resizer):not(.collapser)').removeClass('active');$defaultMenu.find('#defaultAccessibilityDisplay').addClass('active');$defaultMenu.find('tw-element-resizer').attr('data-selector','#defaultAccessibilityDisplay');if(!$(defaultMenu).find('.destructor').length){$defaultMenu.append('<button class="destructor">X</button>');}});$('.accessibilityInput').on('change mousemove',function(e){var parentIDs=from($(e.currentTarget).parents()).map(function(parent){return parent.id;});if(parentIDs.indexOf('optionsFontSize')!==-1){setFontSize(e.currentTarget.value);}else if(parentIDs.indexOf('optionsBackgroundColor')!==-1){(function(){var colors=[];$('#optionsBackgroundColor').find('.accessibilityInput').each(function(_,input){colors.push(input.value);});if(colors.length<3){throw new Error('One of the accessibility color '+'sliders no longer exists. Cannot change color.');}setBackgroundColor(colors[0],colors[1],colors[2]);})();}else if(parentIDs.indexOf('optionsBrightness')!==-1||parentIDs.indexOf('optionsContrast')!==-1||parentIDs.indexOf('optionsSaturation')!==-1){var valueObj={brightness:$('#optionsBrightness').find('.accessibilityInput').val(),contrast:$('#optionsContrast').find('.accessibilityInput').val(),saturation:$('#optionsSaturation').find('.accessibilityInput').val()};setFilter(valueObj);}});var $htmls=$(document.body.parentElement).add(frameHTML);window.setFontSize=function(value){$htmls.css('font-size',value+'%');};window.setBackgroundColor=function(red,green,blue){var colorString='rgb('+red+', '+green+', '+blue+')';$htmls.css('background-color',colorString);};window.setFilter=function(valueObject){var filterString='brightness('+valueObject.brightness+') '+'contrast('+valueObject.contrast+') '+'saturate('+valueObject.saturation+')';$htmls.css({'-webkit-filter':filterString,'filter':filterString});};$('#gotoAddNodes').click(function(e){$defaultMenu.attr('data-choice','addnodes');$defaultMenu.find(':not(tw-element-resizer):not(.collapser)').removeClass('active');$defaultMenu.find('#defaultNodeadderDisplay').addClass('active');$defaultMenu.find('tw-element-resizer').attr('data-selector','#defaultNodeadderDisplay');if(!$(defaultMenu).find('.destructor').length){$defaultMenu.append('<button class="destructor">X</button>');}});$('#addNodesAndSave').click(function(e){var PIDs=[];var maxPID=0;var $storydata=$('tw-storydata');var $storyPassages=$storydata.find('tw-passagedata');var names=[];for(var ii=0;ii<$storyPassages.length;ii++){var child=$storyPassages[ii];var pid=child.getAttribute('pid');if(!pid){new wideAlert('One of the tw-passagedata nodes in the loaded story '+'lacks a pid attribute. Cannot add nodes.');return;}pid=Number.parseInt(pid);if(Number.isNaN(pid)){new wideAlert('One of the tw-passagedata nodes in the loaded '+'story has a pid attribute whose value is not a string '+'representation of an integer (1, 2, 3, etc.). Cannot '+'add nodes.');return;}else if(PIDs.indexOf(pid)!==-1){new wideAlert('At least two of the tw-passagedata nodes in the '+'loaded story have an identical pid attribute. Cannot '+'add nodes.');return;}PIDs.push(pid);maxPID=Math.max(maxPID,pid);var _name3=child.getAttribute('name');if(!_name3){wideAlert('One of the tw-passagedata nodes in the loaded story '+'lacks a name attribute. Cannot add nodes.');return;}if(names.indexOf(_name3)!==-1){new wideAlert('At least two of the tw-passagedata nodes in the '+'loaded story have an identical name attribute. Cannot '+'add nodes.');return;}names.push(_name3);}// go to the next unused value
maxPID++;var $textarea=$(e.target).parent().find('#nodeAdderTextarea');var content=$textarea.val();var splitContent=content.split('::').filter(function(a){return a.trim()!=='';});var newPassages=[];for(var _ii=0;_ii<splitContent.length;_ii++){var trimmed=splitContent[_ii].trim();var passageName=void 0;var passageText=splitContent[_ii];if(trimmed[0]==='@'&&trimmed[1].match(/\S/)){passageName=trimmed.slice(1).split(/\s/)[0];passageText=passageText.slice(passageText.search(/\n/)+1);}if(names.indexOf(passageName)!==-1){new wideAlert('The name, '+passageName+', already exists '+'in a tw-passagedata within the currently loaded '+'story. Cannot add nodes.');return;}newPassages.push({text:passageText,name:passageName,pid:null});}var $html=$(document.body.parentElement.cloneNode(true));var selector='body > :not(tw-storydata), head';$html.find(selector).remove();$storydata=$html.find('tw-storydata');$storydata.attr('flags','nodeexpanded');var index=0;newPassages.forEach(function(passage){var pid=maxPID++;if(!passage.name){passage.name='nodeMungerTemp'+pid;}var $newPassage=$('<tw-passagedata></tw-passagedata>');$newPassage.attr({pid:pid,name:passage.name,position:'1000, '+80*index++,tags:''});$newPassage.text(passage.text);$storydata.append($newPassage);});saveFile($html.find('tw-storydata').attr('name')+'Expanded','html',$html[0].outerHTML);});$('#toggleTranscript').click(function(e){Options.toggleTranscriptRecording();if(State.recordingTranscript){e.currentTarget.innerHTML='Off';$('#printTranscriptToConsole').removeClass('hidden');}else{e.currentTarget.innerHTML='On';$('#printTranscriptToConsole').addClass('hidden');}});$('#gotoTranscript').click(function(){$defaultMenu.attr('data-choice','transcript');$defaultMenu.find(':not(tw-element-resizer):not(.collapser)').removeClass('active');$defaultMenu.find('#defaultTranscriptDisplay').addClass('active');Options.updateTranscriptVisuals();$defaultMenu.find('tw-element-resizer').attr('data-selector','tw-transcript-display');if(!$(defaultMenu).find('.destructor').length){$defaultMenu.append('<button class="destructor">X</button>');}});$('#printTranscript').click(function(e){gatelyLog(State.printTranscript('text'));});$(frameBody).on('click','[data-transcript-identifier]',function(e){Options.setTranscriptDisplay(e.target);});$(frameBody).on('click','.spanner',function(e){var tgt=e.target;if(tgt&&tgt.parentNode&&tgt.parentNode.nextSibling){var toClick=tgt.parentNode.nextSibling.querySelector('.collapser');if(toClick){toClick.click();}}});var elementResizing=null;$('tw-element-resizer').mousedown(function(e){elementResizing=e.target;$(this).addClass('active');});window.mouseEvents={isDown:false};$('html').mousedown(function(e){window.mouseEvents.isDown=true;window.mouseEvents[e.which]={event:e,isDown:true};});$('html').mousemove(function(e){if(!e.which){window.mouseEvents={isDown:false};}if(e.which in window.mouseEvents){window.mouseEvents[e.which].event=e;}else{window.mouseEvents[e.which]={event:e,isDown:false};}});$('html').mouseup(function(e){window.mouseEvents[e.which]={event:e,isDown:false};$('tw-element-resizer').removeClass('active');elementResizing=null;});$('html').add(frameHTML).mousemove(function(e){if(e.which in window.mouseEvents&&window.mouseEvents[e.which].isDown&&elementResizing){widthElementToPercentage(elementResizing,e);}});window.keyEvents={};$('html').keydown(function(e){window.keyEvents[e.which]={event:e,isDown:false};window.keyEvents.isDown=true;});$('html').keyup(function(e){window.keyEvents[e.which]={event:e,isDown:false};var foundTrue=false;for(var key in window.keyEvents){if(_typeof(window.keyEvents[key])==='object'&&window.keyEvents[key]&&'keyDown'in window.keyEvents[key]&&window.keyEvents[key].keyDown===true){foundTrue=true;break;}}if(!foundTrue){window.keyEvents.isDown=false;}});function widthElementToPercentage(element,e){if(!element){gatelyLog('The element argument passed to '+'window.widthMenuElementToPercentage is not valid. Cannot '+'change element parent width.');return;}var width=$('html').width()-e.screenX;$($(element).attr('data-selector')).css(_defineProperty({'width':width+'px'},'width','calc('+width+'px - 4.67em)'));};window.widthElementToPercentage=widthElementToPercentage;$('#saveGame').click(function(e){saveFile($('#saveFilename').val(),'html');$('#saveFilename').val('');});if(processed.indexOf('save')!==-1){var saveElem=document.querySelector('tw-save#defaultSave');if(saveElem&&saveElem.childCount!==0){var stateObj=saferJSONParse(saveElem.innerText);if((typeof stateObj==='undefined'?'undefined':_typeof(stateObj))==='object'&&stateObj){for(var prop in stateObj){State[prop]=stateObj[prop];}}Macro.world.restoreModelProtoFuncs.handler();$('tw-save#defaultSave').remove();return;}else{throw new Error('There is a save flag on this HTML file but no '+'tw-save#defaultSave element that contains a state.');}}/* everything that follows must be non-event logic unneeded for
     * non-save launches */var startNode=$storydata.attr('startNode');var $startPassage=$('tw-passagedata[pid="'+startNode+'"]');// evals all story scripts
selector='script, tw-passagedata[tags~="script"]';$storydata.find(selector).each(function(_,aa){$(aa).attr('data-src','user-added script');eval(aa.innerText);});// appends all story styles
selector='style, tw-passagedata[tags~="style"]';$storydata.find(selector).each(function(_,aa){$('body').append('<style data-src="user-added style">'+aa.innerText+'</style>');});// fire all passages tagged load
selector='tw-passagedata[tags~=load]';$storydata.find(selector).each(function(_,aa){Parser.parseText(aa.innerHTML);});// wire up all passages tagged unload to the beforeunload event
selector='tw-passagedata[tags~=unload]';$storydata.find(selector).each(function(_,aa){$(window).on('beforeunload',function(e){return Parser.parseText(aa.innerHTML);});});window.updateAudioDisplay();// add tracery grammars in special html elements
selector='tw-passagedata[tags~="tracerystore"], '+'tw-passagedata[tags~="tracery-store"]';$storydata.find(selector).each(function(_,trace){var name=trace.getAttribute('name');if(!name){wideAlert('A passage tagged tracery-store lacks a name attribute. '+'Cannot add to tracery store.');}State.addTraceryGrammar(name,trace.innerHTML);});// renders the start passage
Renderer.render($startPassage.attr('name'));// gately is no longer loading
window.isLoading=false;})();

},{}],7:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};(function(){'use strict';var $=window.jQuery;var getOwnPropertyNames=Object.getOwnPropertyNames;var from=Array.from;var frame=$('#defaultTranscriptFrame')[0];var frameHTML=frame.contentDocument.body.parentElement;var frameHead=frameHTML.querySelector('head');var frameBody=frameHTML.querySelector('body');var $defaultMenu=$('#defaultMenu');window.Options={recordingLevels:{textChanges:true,pageEvents:true,stateChanges:true,load:false,parse:false,render:false},transcriptMutationObserver:null,toggleTranscriptRecording:function toggleTranscriptRecording(){State.recordingTranscript=!State.recordingTranscript;},startTranscriptEntry:function startTranscriptEntry(){var newState={};for(var name in State){var lowName=name.toLowerCase();var prop=State[name];if(lowName.indexOf('binding')===-1&&lowName.indexOf('transcript')===-1&&lowName.startsWith('current')&&!isFunction(prop)){newState[name]=State[name];}}State.currentTranscriptEntry={passageName:State.currentPassageName,textChanges:[],pageEvents:[],stateChanges:[],parses:[],macros:[]};State.transcriptHistory.push(State.currentTranscriptEntry);},endTranscriptEntry:function endTranscriptEntry(){// remove mutation observer
if(Options.transcriptMutationObserver&&Options.transcriptMutationObserver.disconnect){Options.transcriptMutationObserver.disconnect();}// remove current transcript entry property
State.currentTranscriptEntry=null;// remove event checker
$('tw-passage.current').off('click keydown');},printTranscript:function printTranscript(type){var printed=void 0;var lowerTrimType=void 0;if(typeof type==='string'){lowerTrimType=type.trim().toLowerCase();}if(lowerTrimType==='html'){printed=Options.printTranscriptToHTML();}else{wideAlert('The type argument passed to '+'Options.printTranscript is not recognized. Cannot print.');}return printed;},printTranscriptToHTML:function printTranscriptToHTML(){// generate primary container
var $node=$('<div id="container"></div>');for(var ii=0;ii<State.transcriptHistory.length;ii++){var id=ii.toString()+'_textChanges_0';var title='<p '+'id="'+id+'" class="title">'+State.history[ii]+'</p>';var $entry=$('<div class="entry"></div>');$entry.append(title);var $collapser=$('<button>-</button>');$collapser.attr({class:'collapser','data-on':'-','data-off':'+'});$entry.append($collapser);var transcriptEntry=State.transcriptHistory[ii];if(!transcriptEntry){$entry.append('<p>Empty!</p>');$node.append($entry);continue;}var changes=transcriptEntry.textChanges;for(var jj=0;jj<changes.length;jj++){var subID=id+'_'+jj;var $state=$('<div class="state" id="'+subID+'"></div>');$state.html(changes[jj].html);$state.find('tw-transcript-event').each(function(_,evt){evt.removeAttribute('unprocessed');evt.innerHTML=evt.getAttribute('data-transcript-index');});var $subtitle=$('<span class="subtitle">foo</span>');$subtitle.attr({'data-transcript-time':transcriptEntry.time,'data-transcript-identifier':ii.toString()+'_textChanges_0'});$state.prepend($subtitle);$entry.append($state);}//$contents.append($content);
$node.append($entry);}return $node[0].innerHTML;},setTranscriptDisplay:function setTranscriptDisplay(clicked){var node=document.createElement('div');if(!clicked){wideAlert('The clicked argument passed to '+'Options.setTranscriptDisplay is not valid. Cannot set '+'transcript display.');return;}var $currentTarget=$(clicked);var identifier=$currentTarget.attr('data-transcript-identifier');if(!identifier){wideAlert('A valid data-transcript-identifier does not exist '+'in the $currentTarget variable derived from the '+'clicked argument.');return;}var dataSrc=State.transcriptHistory;identifier.split('_').filter(function(aa){return aa!=='';}).forEach(function(id){if(id in dataSrc){dataSrc=dataSrc[id];}else{wideAlert('fuz!');return;}});var funcs={jqueryevt:saferJSONParse,state:saferJSONParse,time:Number.parseFloat,type:noop};var aliases={jqueryevt:'jQuery Event',state:'Current State',time:'Time Recorded',type:'Record Type'};getOwnPropertyNames(dataSrc).forEach(function(name){var div=document.createElement('div');var func=funcs[name];if(!func){return;}var alias=aliases[name.toLowerCase()];var processed=func(dataSrc[name]);if(alias){Options.varToHTML(div,processed,alias);}else{Options.varToHTML(div,processed,name);}node.appendChild(div);});var frame=$('#defaultTranscriptFrame')[0];var frameBody=frame.contentDocument.body;var $displayPane=$(frameBody.querySelector('#displayPane'));$displayPane.children('div').removeClass('active');$displayPane.children('#transcriptTabControl').children().removeClass('active');$displayPane.find('#detailsTab').addClass('active');var $details=$displayPane.find('#transcriptDetailsDiv');$details.addClass('active');$details.html(node.innerHTML);},varToHTML:function varToHTML(node,prop,propName){var container=document.createElement('div');container.className='container';node.appendChild(container);var textField=document.createElement('span');container.appendChild(textField);if(propName){var title=document.createElement('b');var formattedName=propName;title.className='title';if((typeof prop==='undefined'?'undefined':_typeof(prop))==='object'&&prop!==null&&prop.constructor&&prop.constructor.name){formattedName+=' ('+prop.constructor.name+')';}formattedName+=': ';title.innerText=formattedName;textField.appendChild(title);}if((typeof prop==='undefined'?'undefined':_typeof(prop))==='object'&&prop!==null){(function(){var spanner=document.createElement('span');spanner.className='spanner';textField.appendChild(spanner);var subEl=document.createElement('div');container.appendChild(subEl);subEl.className='collapsed';var collapser=document.createElement('button');collapser.className='collapser';collapser.innerText='+';collapser.setAttribute('data-on','-');collapser.setAttribute('data-off','+');subEl.appendChild(collapser);var subProps=Object.getOwnPropertyNames(prop);if(!subProps.length){var empty=document.createElement('span');empty.innerText='Empty!';subEl.appendChild(empty);}subProps.forEach(function(subProp){Options.varToHTML(subEl,prop[subProp],subProp);});})();}else{var valText=void 0;if(prop===null){valText='null';}else if(typeof prop==='undefined'){valText='undefined';}else if(prop.toString){valText=prop.toString();}if(typeof prop==='string'){valText='"'+valText+'"';}var valNode=document.createTextNode(valText);textField.appendChild(valNode);var spacer=document.createElement('p');spacer.className='spacer';container.appendChild(spacer);}},updateTranscriptVisuals:function updateTranscriptVisuals(){var passagePane=frameBody.querySelector('#passagePane');passagePane.innerHTML=Options.printTranscript('html');var choice=$defaultMenu.attr('data-choice');if(choice==='transcript'){$defaultMenu.attr('data-choice','transcript');if(!$(defaultMenu).find('.destructor').length){$defaultMenu.append('<button '+'class="destructor">X</button>');}$defaultMenu.find('tw-element-resizer').attr('data-selector','#defaultTranscriptDisplay');}},captureTextChanges:function captureTextChanges(){var $current=$('tw-passage.current');if(!$current.length){return;}var lastText=$current.text();var lastHTML=$current.html();Options.eventIndex=1;// create an observer instance
Options.transcriptMutationObserver=new MutationObserver(function(mutations){if(!Options.recordingLevels.textChanges||!State.recordingTranscript&&!window.DEBUG){return;}from(mutations).forEach(function(mutation){var entry=State.currentTranscriptEntry;var text=$current.text();var html=$current.html();// if the text has changed, add a new entry
if(text!==lastText){var _$current=$('tw-passage.current');// do not allow the events to persist
_$current.find('tw-transcript-event').remove();var newState={};for(var name in State){var lowName=name.toLowerCase();var prop=State[name];if(lowName.indexOf('binding')===-1&&lowName.indexOf('transcript')===-1&&lowName.startsWith('current')&&!isFunction(prop)){newState[name]=State[name];}}entry.textChanges.push({html:_$current[0].outerHTML,time:new Date().getTime().toString(),state:JSON.stringify(newState),type:'textchange'});Options.updateTranscriptVisuals();lastText=_$current.text();lastHTML=_$current.html();Options.eventIndex=1;}});});// configuration of the observer:
var observerConfig={childList:true,characterData:true,subtree:true};// pass in the target node, as well as the observer options
Options.transcriptMutationObserver.observe(document.body,observerConfig);},haltCaptureTextChanges:function haltCaptureTextChanges(){Options.transcriptMutationObserver.disconnect();},capturePageEvents:function capturePageEvents(){var $current=$('tw-passage.current');$current.on('click keydown',function(e){var valid=window.DEBUG||Options.recordingLevels.textChanges&&State.recordingTranscript;// don't register clicks on the passage element, and don't
// record unless the user state calls for it
if(e.target===$current[0]||!valid){return;}var time=new Date().getTime().toString();var $html=$(e.target);var $evt=$('<tw-transcript-event unprocessed>'+'</tw-transcript-event>');var decircled=e;delete decircled.originalEvent;delete decircled.view;delete decircled.target;delete decircled.currentTarget;delete decircled.handleObj;delete decircled.delegateTarget;delete decircled.relatedTarget;delete decircled.toElement;var decircTxt=JSON.stringify(decircled);var currentEntry=State.currentTranscriptEntry;var newState={};for(var name in State){var lowName=name.toLowerCase();var prop=State[name];if(lowName.indexOf('binding')===-1&&lowName.indexOf('transcript')===-1&&lowName.startsWith('current')&&!isFunction(prop)){newState[name]=State[name];}}var identifier=State.transcriptHistory.indexOf(currentEntry).toString()+'_pageEvents_'+String(Options.eventIndex-1);$evt.attr({'data-transcript-index':Options.eventIndex,'data-transcript-identifier':identifier,'data-transcript-time':time});$html.append($evt);if(currentEntry.textChanges.length){currentEntry.textChanges.slice(-1)[0].html=$current[0].outerHTML;}currentEntry.pageEvents.push({time:time,html:$current[0].outerHTML,state:JSON.stringify(newState),jqueryevt:decircTxt,type:e.type});Options.updateTranscriptVisuals();Options.eventIndex++;});},captureStateChange:function captureStateChange(name,target,property,value){var regex=/transcript|binding/;if(State.currentTranscriptEntry&&!regex.test(property.toLowerCase())&&property.toLowerCase().startsWith('current')&&target[property]!==value){State.currentTranscriptEntry.stateChanges.push({name:name,property:property,value:value});}}};})();

},{}],8:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};(function(){'use strict';var unusedMatchId=0;window.Matches={currentMatch:null,createMatchObject:function createMatchObject(dataType,parent,dialect,macroType){return{dataType:dataType,macroType:macroType,parent:parent,children:[],id:Matches.getNewMatchId(),finishedStartTag:false,dialect:dialect};},getCurrentMatchId:function getCurrentMatchId(){if(Matches.currentMatch){return Matches.currentMatch.id;}else{return null;}},getNewMatchId:function getNewMatchId(){return unusedMatchId++;},getDataType:function getDataType(match){if(match&&match.getAttribute&&match.getAttribute('data-type')){return match.getAttribute('data-type').replace(/&quot;|["']/g,'');}else if(match&&match.dataType&&match.dataType.replace){return match.dataType.replace(/&quot;|["']/g,'');}else{return null;}},getMacroType:function getMacroType(match){if(match&&match.getAttribute){return match.getAttribute('data-macro-type');}else if(match&&match.macroType){return match.macroType;}else{return null;}},getMacroObject:function getMacroObject(type){if(!type){console.log('Invalid type received by '+'Matches.getMacroObject.');return null;}var namespace=void 0;var macroObj=void 0;var typeSplit=type.split('.');if(typeSplit.length===1){namespace=Macro.global;macroObj=Macro.global[type];}else{namespace=Macro[typeSplit[0]];macroObj=namespace[typeSplit.slice(1).join('.')];}return macroObj;},getCurrentParent:function getCurrentParent(match){if(match&&match.parent){return match.parent;}else if(match&&match.parentNode){return match.parentNode;}else{return null;}},currentlyParsingString:function currentlyParsingString(){return Matches.currentMatch&&(Matches.currentMatch.dataType==='singleQuote'||Matches.currentMatch.dataType==='doubleQuote');},isDoubleTagMacroOpener:function isDoubleTagMacroOpener(match){if(!match||!match.dataType||match.dataType!=='macro'||match.finishedStartTag){return false;}var macro=Matches.getMacroObject(match.macroType);return macro&&macro.isDoubleTag;},isFinishedStartTag:function isFinishedStartTag(match){if(match){return match.finishedStartTag;}else{return false;}},reservedWordLookup:{/* 'eq': '==',
            'neq': '!=', */'is':'===','isnot':'!==','gt':'>','gte':'>=','lt':'<','lte':'<=','and':'&&','or':'||','not':'!','to':'=','it':'it'},harloweParentheses:0,macro:function macro(match){if(!match){wideAlert('Something went wrong! The match is undefined.');}var type=Matches.getMacroType(match);var macroObj=Matches.getMacroObject(type);if(!macroObj){macroObj=State.macroAliasStore[type];}if(!macroObj){macroObj=State.functionStore[type];}if(!macroObj){wideAlert('There is no macro object, alias, or '+'function/widget for a token of type: '+type);//match.innerHTML = '';
return;}var macroHandler=macroObj.handler;if(!macroHandler){wideAlert('There is no macro handler for a token of type: '+type);return;}if(type==='if'){Matches.if(match);return;}var tokenHTML='';var tokens=match.childNodes;var args=[];var allNumbers=null;var seenNonPlusOperator=null;var untransformed='';for(var ii=0;ii<tokens.length;ii++){var varToSet=void 0;while(ii<tokens.length){var dataType=Matches.getDataType(tokens[ii]);if(dataType==='comma'||dataType==='openTagTerminator'){break;}else if(!tokens[ii].textContent.trim()&&tokens[ii].nodeType===3){ii++;continue;}else if(type==='set'&&dataType==='variable'){if(tokenHTML.trim()===''){varToSet=tokens[ii].innerHTML;}else{var _html=tokens[ii].innerHTML;if(_html in State.currentVariableState){tokens[ii].innerHTML=State.currentVariableState[_html];}else{tokens[ii].innerHTML='0';}}}else if(dataType==='reservedWord'&&tokens[ii].textContent==='it'&&varToSet){if(varToSet in State.currentVariableState){tokens[ii].innerHTML=State.currentVariableState[varToSet];}else{tokens[ii].innerHTML='0';}if(typeof variable==='string'){tokens[ii].innerHTML='"'+variable.replace(/"/g,'&quot;')+'"';}else{tokens[ii].innerHTML=variable;}}var token=void 0;if(dataType||tokens[ii].tagName==='TW-ARGUMENT'){token=tokens[ii].innerHTML;}else if(isFunction(tokens[ii].hasAttribute)&&tokens[ii].hasAttribute('gately')){token=tokens[ii];}else{token=tokens[ii].outerHTML;}if(!token){token=tokens[ii].textContent;}if(dataType==='singleQuote'&&token.startsWith("'")&&token.endsWith("'")){token=token.slice(1,-1);}else if(dataType==='doubleQuote'&&token.startsWith('"')&&token.endsWith('"')){token=token.slice(1,-1);}var trim=token.trim();if(trim.length!==1||!/[+\-*\/%]/.test(trim[0])){if(dataType!=='number'&&!/[()]/.test(trim[0])){allNumbers=false;}else if(allNumbers===null){allNumbers=true;}tokenHTML+=token;}else if(trim.length===1&&/[\-*\/%]/.test(trim[0])){seenNonPlusOperator=true;}untransformed+=token;ii++;}// skip empty arguments
if(!tokenHTML.trim()){continue;}// use eval if and only if arithmetic is being performed
if(allNumbers){tokenHTML=saferEval(untransformed);}else if(seenNonPlusOperator){tokenHTML='NaN';}args.push(tokenHTML);tokenHTML='';allNumbers=null;seenNonPlusOperator=null;}var retVal=void 0;var typeSplit=type.split('.');var actionType=typeSplit.slice(-1)[0];var namespace=void 0;if(typeSplit.length===1){namespace=Macro.global;}else{namespace=Macro;var ns=typeSplit.slice(0,typeSplit.length-1);for(var _ii=0;_ii<ns.length;_ii++){namespace=namespace[ns[_ii]];}if(namespace===Macro){namespace={};}}if(isFunction(namespace.handler)){retVal=namespace.handler.apply(match,[actionType].concat(args));}else{retVal=macroHandler.apply(match,args);}if(typeof retVal==='undefined'){retVal='';}match.innerHTML='';if(isNode(retVal)||isElement(retVal)){match.appendChild(retVal);}else{match.innerHTML=retVal;}var html=document.querySelector('tw-passage.current');var htmltxt=void 0;if(html){htmltxt=html.outerHTML;}else{var elem=match;while(elem&&elem.parentElement){elem=elem.parentElement;}htmltxt=elem.innerHTML;}if(window.DEBUG||State.recordingTranscript&&Options.recordingLevels.render){State.currentTranscriptEntry.macros.push({passageName:State.currentPassageName,html:htmltxt,time:new Date().getTime().toString()});}},if:function _if(match){Matches.processIfBoolean(match,'nest');var before=match.childNodes[0].textContent;var after=void 0;try{after=saferEval(before);}catch(e){/* do nothing */}if(after){var nodes=from(match.childNodes);var terminatorIndex=nodes.map(function(node){return Matches.getDataType(node)==='openTagTerminator';}).indexOf(true);var $hook=$(match.childNodes[terminatorIndex+1]);// get the next non-text node
if($hook[0].nodeType===3){$hook=$hook.next();}Matches.handle($hook[0]);$hook.nextAll().remove();}else{// must be ahead of if: boolean argument and tag terminator
for(var ii=2;ii<match.children.length;ii++){var child=match.children[ii];var childMT=Matches.getMacroType(child);if(childMT==='elseif'||childMT==='else-if'||childMT==='else'){var _before=child.childNodes[0].textContent;var _after=void 0;try{_after=saferEval(_before);}catch(e){/* do nothing */}if(_after||childMT==='else'){// skip the tag terminator
var div=$('<div>'+child.children[1].outerHTML+'</div>')[0];Matches.handle(div);$(match.children[ii]).before('<tw-match data-type="comma"></tw-match>');match.children[ii+1].outerHTML=div.children[0].innerHTML;$(match.children[ii+1]).nextAll().remove();}else{$(child).remove();ii--;}}}}var args=[match.childNodes[0]].concat(from(match.children).slice(1));var value=Macro.global.if.handler.apply(this,args);$(match).replaceWith(value);},processIfBoolean:function processIfBoolean(match,nest){var pastOpenTag=false;var point='elseif';$(match).addClass('processedIf');var handleStr='';for(var ii=0;ii<match.childNodes.length;ii++){var child=match.childNodes[ii];var childDT=Matches.getDataType(child);var childMT=Matches.getMacroType(child);if(handleStr!==null){if(childDT!=='openTagTerminator'){if(child.outerHTML){handleStr+=match.childNodes[ii].outerHTML;}else{handleStr+=match.childNodes[ii].textContent;}}else{// remove all prior nodes
$(match.childNodes[ii]).prevAll().remove();var div=$('<div>'+handleStr+'</div>')[0];Matches.handle(div);var text=document.createTextNode(div.innerText);$(match.childNodes[0]).before(text);// prevent looking for else-ifs within else-ifs
if(nest!==true&&nest!=='nest'){return;}handleStr=null;ii=0;}}else{if(childMT==='elseif'||childMT==='else-if'){if(point==='else'){wideAlert('An else-if macro cannot follow an else '+'macro! Ignoring else-if.');child.outerHTML='';}else{Matches.processIfBoolean(child);}}else if(childMT==='else'){point='else';}}}},variable:function variable(match){// don't convert variables that are to be set
if(Matches.getMacroType(match.parentNode)==='set'){return;}var currentVarState=State.currentVariableState;var variable=currentVarState[match.innerHTML];if(typeof variable==='undefined'){variable='0';}var jsType=typeof variable==='undefined'?'undefined':_typeof(variable);match.setAttribute('data-javascript-type',jsType);if(isElement(variable)){match.innerHTML=variable.outerHTML;}else if(isNode(variable)){match.innerHTML=variable.textContent;}else if(jsType==='object'){match.innerHTML=JSON.stringify(variable);}else{match.innerHTML=variable;}},reservedWord:function reservedWord(match){if(match.innerText in Matches.reservedWordLookup){match.innerHTML=Matches.reservedWordLookup[match.innerHTML];}else{gatelyLog('There is no entry in the reserved word lookup '+'table for the match: '+match.innerHTML);}},html:function html(match){if(match.tagName==='SCRIPT'){try{eval(match.innerText);}catch(e){wideAlert(e);}}else{$(match).children().each(function(_,child){if(child.tagName==='SCRIPT'){try{eval(child.innerText);}catch(e){wideAlert(e);}}else if(child.tagName!=='STYLE'){Parser.parseNode(child);}});}},// TODO: make sure this isn't broken. it's probably broken.
singleQuote:function singleQuote(match){if(document.contains(match)){match.innerHTML=match.innerHTML.slice(1,-1);}},doubleQuote:function doubleQuote(match){if(document.contains(match)){match.innerHTML=match.innerHTML.slice(1,-1);}},handle:function handle(match){var ifs=['if','elseif','else-if','else'];var unfinishedIf=ifs.indexOf(Matches.getMacroType(match))!==-1&&!$(match).hasClass('processedIf');var defer=$(match).hasClass('defer');var seenTerminator=false;if(!unfinishedIf||defer&&seenTerminator){from(match.children).forEach(function(childMatch){if('children'in childMatch){Matches.handle(childMatch);}var type=Matches.getDataType(childMatch);// skip all plain, non-parsed nodes
if(!type){return;}else if(type==='openTagTerminator'){seenTerminator=true;}var handler=Matches[type];if(!handler){wideAlert('There is no match handler for a token of '+'type: '+type);}else{handler(childMatch);}});}}};Matches.singleQuote=noop;Matches.doubleQuote=noop;Matches.comma=noop;Matches.number=noop;Matches.openTagTerminator=noop;Matches.hook=noop;window.Parser={isEndingTag:function isEndingTag(tag){return tag[0]==='/'||tag.slice&&tag.slice(0,3)==='end';},isDeferred:function isDeferred(type){if(!type){return false;}var macroObj=Matches.getMacroObject(type);return macroObj&&macroObj.defer===true;},getMacroType:function getMacroType(text,id){var fragment=text.slice(text.indexOf('<tw-match data-gately-id="'+id+'"'));fragment=fragment.slice(fragment.indexOf('data-macro-type="')+17);var macroType=fragment.slice(0,fragment.indexOf('"')).trim().toLowerCase();return macroType;},createOpenTag:function createOpenTag(id,dataType,dialect,macroType){var text='<tw-match data-gately-id="'+id+'" ';if(Parser.isDeferred(macroType)){text+='class="defer" ';}if(dialect){text+='data-dialect="'+dialect+'" ';}if(macroType){text+='data-type="macro" data-macro-type="'+macroType+'">';}else{text+='data-type="'+dataType+'">';}return text;},addStringAtIndex:function addStringAtIndex(string,substring,index){return string.slice(0,index)+substring+string.slice(index);},removeCharactersAtIndex:function removeCharactersAtIndex(string,index,numToRemove){return string.slice(0,index)+string.slice(index+numToRemove);},parseNode:function parseNode(node){stackTrace={passage:State.currentPassageName,lineNumber:0,expression:null,error:null};// unpack jquery objects
if(node[0]){node=node[0];}Matches.currentMatch=null;if(!node||typeof node.innerHTML==='undefined'){wideAlert('The node argument to be parsed is not a valid HTML '+'element.',node);return;}var savedSSText=$(node).find('script, style').toArray().map(function(elem){return elem.innerText;});var text=node.innerHTML;var regex=/&lt;(?=\S+)/g;var match=void 0;var isOverriding=false;while(match=regex.exec(text)){if(text[match.index+4]==='-'){continue;}else if(isOverriding){isOverriding=false;continue;}else if(text.slice(match.index+4,match.index+8)==='&lt;'){isOverriding=true;}else{text=Parser.addStringAtIndex(Parser.removeCharactersAtIndex(text,match.index,4),'<',match.index);regex.lastIndex-=4;}}regex=/&gt;/g;while(match=regex.exec(text)){if(text[match.index-4]==='-'){continue;}else if(isOverriding){isOverriding=false;continue;}else if(text.slice(match.index+4,match.index+8)==='&gt;'){isOverriding=true;}else{text=Parser.addStringAtIndex(Parser.removeCharactersAtIndex(text,match.index,4),'>',match.index);regex.lastIndex-=4;}}text=text.replace(/<(?=\S+\|)/g,'&lt;');regex=/\|\S+(>)/;while(match=regex.exec(text)){text=text.replace(match[0],match[0].slice(0,match[0].length-1)+'&gt;');}node.innerHTML=text;/*// ensure scripts and styles are not affected by changes above
            $(node).find('script, style').each(function(index, node) {
                //node.innerText = savedSSText[index];
            });*/// process tracery containers
var renderTraceries=from(node.querySelectorAll('tw-tracery-render'));renderTraceries.forEach(function(trace){var object=void 0;try{object=eval('('+trace.innerHTML+')');}catch(e){wideAlert('Could not eval in-passage tracery source'+'(header).\n'+e.message);return;}if((typeof object==='undefined'?'undefined':_typeof(object))==='object'&&object!==null){var grammar=tracery.createGrammar(object);grammar.addModifiers(baseEngModifiers);var flattened=grammar.flatten("#origin#");trace.outerHTML=flattened;}});var storeTraceries=from(node.querySelectorAll('tw-tracery-store'));storeTraceries.forEach(function(trace){var name=trace.getAttribute('name');if(!name){wideAlert('A tw-tracery-store element does not have a name '+'attribute. Cannot store grammar.');trace.outerHTML='';return;}State.addTraceryGrammar(name,trace.innerHTML);trace.outerHTML='';});text=node.innerHTML;var index=0;var nodes=[];for(var _ii2=0;_ii2<node.children.length;_ii2++){var child=node.children[_ii2];// handle exact duplicates
index+=text.slice(index).indexOf(child.outerHTML);var start=index;if(child.tagName==='TW-ARGUMENT'){nodes.push(text.slice(start,start+child.outerHTML.length));}else{var newText=Parser.createOpenTag(Matches.getNewMatchId(),'html');// add new text
text=Parser.addStringAtIndex(text,newText,index);// add the length of the new text
index+=newText.length;index+=child.outerHTML.length;newText='</tw-match>';text=Parser.addStringAtIndex(text,newText,index);// add the length of the new text
index+=newText.length;nodes.push(text.slice(start,index));}}var origText=text;var origIndex=0;var matchOrigIndexes=[];var ii=0;while(ii<text.length){var startText=text;if(text[ii]==='"'||text[ii]==="'"){var quoteChar=text[ii];var quoteType='doubleQuote';var otherType='singleQuote';if(text[ii]==="'"){quoteType='singleQuote';otherType='doubleQuote';}// top-level quotes, single quotes inside valid double 
// quote blocks, and escaped quotes aren't treated as 
// semantic. there is probably a bug with successive
// backslashes
var current=Matches.currentMatch;if(!current||Matches.getDataType(current)==='html'||Matches.getDataType(current)==='hook'||Matches.getDataType(current)===otherType||text[ii-1]==='\\'||Matches.isFinishedStartTag(current)){ii++;origIndex++;continue;}var _newText=Parser.createOpenTag(Matches.getNewMatchId(),quoteType);// add the new text
text=Parser.addStringAtIndex(text,_newText,ii);// skip ahead the length of the added string
ii+=_newText.length+1;matchOrigIndexes.unshift(origIndex);origIndex++;// skip to the index after the next (unescaped)
// double quote
var backslashes=0;while(ii<text.length){if(text[ii]==='\\'){backslashes++;}else if(text[ii]===quoteChar&&backslashes%2===0){break;}else if(text[ii]==='<'&&backslashes%2===0){(function(){// handle valid html elements in strings
var after=text.slice(ii);var nodeMatches=nodes.map(function(aa){return after.slice(0,aa.length)===aa;});for(var jj=0;jj<nodeMatches.length;jj++){if(nodeMatches[jj]){ii+=nodes[jj].length-1;origIndex+=nodes[jj].length-1;break;}}})();}else{backslashes=0;}ii++;origIndex++;}// handle unclosed quotes
if(ii!==text.length){_newText='</tw-match>';text=Parser.addStringAtIndex(text,_newText,ii+1);ii+=_newText.length;matchOrigIndexes.shift();}}else if(Matches.currentlyParsingString()){ii++;origIndex++;continue;}else if(text[ii]==='<'){(function(){var after=text.slice(ii);var nodeMatches=nodes.map(function(aa){return after.slice(0,aa.length)===aa;});for(var jj=0;jj<nodeMatches.length;jj++){if(nodeMatches[jj]){ii+=nodes[jj].length-1;origIndex+=nodes[jj].length-1;break;}}})();}else if(text.slice(ii,ii+4)==='&lt;'&&text.slice(ii+4,ii+8)==='&lt;'){// macros names are terminated by a space or &gt;&gt;
var macroType=text.slice(ii+8).split(/ |&gt;&gt;/)[0];var _newText2='</tw-match>';// remove opening << brackets
text=Parser.removeCharactersAtIndex(text,ii,8+macroType.length);matchOrigIndexes.unshift(origIndex);origIndex+=8+macroType.length;// don't start a new macro if it's an ending tag
if(Matches.currentMatch){var currentMatchType=Matches.getMacroType(Matches.currentMatch);if(currentMatchType==='elseif'||currentMatchType==='else-if'||currentMatchType==='else'){if(currentMatchType!=='else'){if(macroType==='elseif'||macroType==='else-if'||macroType==='else'){text=Parser.addStringAtIndex(text,_newText2,ii);ii+=_newText2.length;var parent=Matches.getCurrentParent(Matches.currentMatch);Matches.currentMatch=parent;}}else{if(macroType==='/if'||macroType==='endif'){text=Parser.addStringAtIndex(text,_newText2,ii);ii+=_newText2.length;var _parent=Matches.getCurrentParent(Matches.currentMatch);Matches.currentMatch=_parent;}}}if(Parser.isEndingTag(macroType)){// remove closing &gt;&gt; brackets
text=Parser.removeCharactersAtIndex(text,ii,8);origIndex+=8;text=Parser.addStringAtIndex(text,_newText2,ii);ii+=_newText2.length;var _parent2=Matches.getCurrentParent(Matches.currentMatch);Matches.currentMatch=_parent2;matchOrigIndexes.shift();continue;}var newMatch=Matches.createMatchObject('macro',Matches.currentMatch,'sugarcube',macroType);Matches.currentMatch.children.push(newMatch);Matches.currentMatch=newMatch;}else{Matches.currentMatch=Matches.createMatchObject('macro',null,'sugarcube',macroType);}_newText2=Parser.createOpenTag(Matches.getCurrentMatchId(),'macro','sugarcube',macroType);// add new text
text=Parser.addStringAtIndex(text,_newText2,ii);// add the length of the new text
ii+=_newText2.length-1;}else if(text[ii]==='('){// harlowe macro names are terminated by a colon
var nextColon=text.slice(ii+1).search(':');var nextNonEnder=text.slice(ii+1).search(/[\s()>;'"]/);if(nextNonEnder!==-1&&(nextColon===-1||nextNonEnder<nextColon)){if(Matches.currentMatch&&Matches.currentMatch.dialect==='harlowe'){Matches.harloweParentheses++;}ii++;origIndex++;continue;}var _macroType=text.slice(ii+1).split(':')[0];// skip over the opening (, the macro name, and the
// terminal colon
text=Parser.removeCharactersAtIndex(text,ii,2+_macroType.length);matchOrigIndexes.unshift(origIndex);origIndex+=1+_macroType.length;if(Matches.currentMatch){var _newMatch=Matches.createMatchObject('macro',Matches.currentMatch,'harlowe',_macroType);Matches.currentMatch.children.push(_newMatch);Matches.currentMatch=_newMatch;}else{Matches.currentMatch=Matches.createMatchObject('macro',null,'harlowe',_macroType);}var _newText3=Parser.createOpenTag(Matches.getCurrentMatchId(),'macro','harlowe',_macroType);text=Parser.addStringAtIndex(text,_newText3,ii);// add the length of the new text
ii+=_newText3.length-1;}else if(text.slice(ii,ii+4)==='&gt;'&&text.slice(ii+4,ii+8)==='&gt;'){if(!Matches.currentMatch){ii++;origIndex++;continue;}var _newText4=void 0;var currentMatch=Matches.currentMatch;if(Matches.isDoubleTagMacroOpener(currentMatch)){Matches.currentMatch.finishedStartTag=true;}_newText4=Parser.createOpenTag(Matches.getNewMatchId(),'openTagTerminator','sugarcube');text=Parser.addStringAtIndex(text,_newText4,ii);ii+=_newText4.length;// remove closing >> brackets
text=Parser.removeCharactersAtIndex(text,ii,8);_newText4='</tw-match>';text=Parser.addStringAtIndex(text,_newText4,ii);ii+=_newText4.length-1;if(!Matches.currentMatch.finishedStartTag){var _parent3=Matches.getCurrentParent(Matches.currentMatch);Matches.currentMatch=_parent3;matchOrigIndexes.shift();}}else if(text[ii]===')'){if(Matches.harloweParentheses>0){Matches.harloweParentheses--;ii++;origIndex++;continue;}else if(!Matches.currentMatch||Matches.currentMatch.dialect==='sugarcube'){ii++;origIndex++;continue;}text=Parser.removeCharactersAtIndex(text,ii,1);var _currentMatch=Matches.currentMatch;var type=Matches.getMacroType(_currentMatch)||'';var macroObj=Matches.getMacroObject(type);if(!macroObj){macroObj=State.macroAliasStore[type];}if(!macroObj){macroObj=State.functionStore[type];}if(!macroObj){/*wideAlert('There is no macro definition for the ' +
                            'macro type ' + type + '.'); */macroObj={};}var _newText5=void 0;var nextHook=text.slice(ii).match(/\s*\[/);if(nextHook&&text.slice(ii).indexOf(nextHook[0])===0&&// breaks if replaced in any way???
macroObj.isDoubleTag){Matches.currentMatch.finishedStartTag=true;_newText5=Parser.createOpenTag(Matches.getNewMatchId(),'openTagTerminator','harlowe')+'</tw-match>';text=Parser.addStringAtIndex(text,_newText5,ii);ii+=_newText5.length-1;}else{Matches.currentMatch=Matches.currentMatch.parent;_newText5=Parser.createOpenTag(Matches.getNewMatchId(),'openTagTerminator','harlowe')+'</tw-match>';text=Parser.addStringAtIndex(text,_newText5,ii);ii+=_newText5.length;_newText5='</tw-match>';text=Parser.addStringAtIndex(text,_newText5,ii);ii+=_newText5.length-1;matchOrigIndexes.shift();}}else if(text[ii]===')'){if(Matches.harloweParentheses>0){Matches.harloweParentheses--;ii++;origIndex++;continue;}else if(!Matches.currentMatch||Matches.currentMatch.dialect==='sugarcube'){ii++;origIndex++;continue;}text=Parser.removeCharactersAtIndex(text,ii,1);var _newText6=void 0;var _nextHook=text.slice(ii).match(/\s*\[/);var _macroType2=Matches.getMacroType(Matches.currentMatch);/* if (!(macroType in Macro)) {
                        wideAlert('There is no handler for the Macro type ' +
                            macroType + '. Cannot process macro.');
                        Matches.currentMatch = null;
                        ii++;
                        origIndex++;
                        continue;
                    } */var _type=Matches.getMacroType(match);var _macroObj=Matches.getMacroObject(_type);var isDoubleTag=_macroObj.isDoubleTag;if(_nextHook&&text.slice(ii).indexOf(_nextHook[0])===0&&isDoubleTag){Matches.currentMatch.finishedStartTag=true;_newText6=Parser.createOpenTag(Matches.getNewMatchId(),'openTagTerminator','harlowe')+'</tw-match>';text=Parser.addStringAtIndex(text,_newText6,ii);ii+=_newText6.length-1;}else{Matches.currentMatch=Matches.currentMatch.parent;_newText6=Parser.createOpenTag(Matches.getNewMatchId(),'openTagTerminator','harlowe')+'</tw-match>';text=Parser.addStringAtIndex(text,_newText6,ii);ii+=_newText6.length;_newText6='</tw-match>';text=Parser.addStringAtIndex(text,_newText6,ii);ii+=_newText6.length-1;matchOrigIndexes.shift();}}else if(text[ii]==='['){if(Matches.currentMatch){var _newMatch2=Matches.createMatchObject('hook',Matches.currentMatch,'harlowe');Matches.currentMatch.children.push(_newMatch2);Matches.currentMatch=_newMatch2;}else{Matches.currentMatch=Matches.createMatchObject('hook',null,'harlowe');}text=Parser.removeCharactersAtIndex(text,ii,1);matchOrigIndexes.unshift(origIndex);var _newText7=Parser.createOpenTag(Matches.getCurrentMatchId(),'hook','harlowe');// add new text
text=Parser.addStringAtIndex(text,_newText7,ii);// add the length of the new text
ii+=_newText7.length-1;}else if(text[ii]===']'){if(!Matches.currentMatch){ii++;origIndex++;continue;}var hookID=Matches.getCurrentMatchId();text=Parser.removeCharactersAtIndex(text,ii,1);var _newText8='</tw-match>';text=Parser.addStringAtIndex(text,_newText8,ii);ii+=_newText8.length-1;Matches.currentMatch=Matches.getCurrentParent(Matches.currentMatch);var _type2=Matches.getMacroType(Matches.currentMatch);if(_type2&&Matches.isFinishedStartTag(Matches.currentMatch)){_newText8='</tw-match>';text=Parser.addStringAtIndex(text,_newText8,ii+1);ii+=_newText8.length;Matches.currentMatch=Matches.getCurrentParent(Matches.currentMatch);matchOrigIndexes.shift();}}else if(text[ii]==='$'){var _newText9=Parser.createOpenTag(Matches.getNewMatchId(),'variable');text=Parser.addStringAtIndex(text,_newText9,ii);ii+=_newText9.length;// skip past the $ given that we already know it's a
// variable
text=Parser.removeCharactersAtIndex(text,ii,1);var varLength=text.slice(ii).split(/[\s<>,()\[\]]/)[0].length;ii+=varLength;origIndex+=varLength;_newText9='</tw-match>';text=Parser.addStringAtIndex(text,_newText9,ii);// figure out why you need a - 1 here lol
ii+=_newText9.length-1;}else if(text[ii].match(/\d/)){// skip anything outside of matches
if(!Matches.currentMatch||Matches.isFinishedStartTag(Matches.currentMatch)||Matches.getDataType(Matches.currentMatch)==='hook'){ii++;origIndex++;continue;}/* get the next non-number character
                     * match all whitespace and mathematical operators and
                     * macro closures and commas, and ensure that the next
                     * non-number character is one */var temp=text.slice(ii).search(/[^\d]/);var firstPeriod=text.slice(ii).search(/\./);if(firstPeriod<=temp){temp=text.slice(ii+firstPeriod+1).search(/[^\d]/)+firstPeriod+1;}/* skip anything outside of matches, or invalid matches,
                     * or that's inside valid quotes */if(!text[ii+temp].match(/[\s+\-*\/%(),>(?:&gt;)]/)){ii++;origIndex++;continue;}var _newText10=Parser.createOpenTag(Matches.getNewMatchId(),'number');text=Parser.addStringAtIndex(text,_newText10,ii);ii+=temp+_newText10.length;origIndex+=temp;_newText10='</tw-match>';text=Parser.addStringAtIndex(text,_newText10,ii);ii+=_newText10.length-1;}else if(text[ii]==='\n'){stackTrace.lineNumber++;}else if(text[ii].match(/[^\s<>]/)){// skip anything outside of matches
if(!Matches.currentMatch||Matches.isFinishedStartTag(Matches.currentMatch)||Matches.getDataType(Matches.currentMatch)==='hook'){ii++;origIndex++;continue;}// handle commas for argument lists
if(text[ii]===','&&Matches.currentMatch.dataType==='macro'){var _newText11=Parser.createOpenTag(Matches.getNewMatchId(),'comma');text=Parser.addStringAtIndex(text,_newText11,ii);// skip ahead the length of the added string
ii+=_newText11.length;_newText11='</tw-match>';text=Parser.addStringAtIndex(text,_newText11,ii+1);ii+=_newText11.length;// TODO: test and fix for left-padded strings
// remove all spaces between comma-separated arguments
var _regex=/ /;while(_regex.test(text[ii+1])){text=Parser.removeCharactersAtIndex(text,ii+1,1);}}var word=text.slice(ii).split(/[\s<>)]/)[0];if(text[ii-1].match(/\s/)&&Matches.reservedWordLookup[word]){var _newText12=Parser.createOpenTag(Matches.getNewMatchId(),'reservedWord');text=Parser.addStringAtIndex(text,_newText12,ii);// skip ahead the length of the added string
ii+=_newText12.length;// skip to the index after the reserved word completes
ii+=word.length;origIndex+=word.length;_newText12='</tw-match>';text=Parser.addStringAtIndex(text,_newText12,ii);ii+=_newText12.length-1;}}if(startText!==text&&(window.DEBUG||State.recordingTranscript&&Options.recordingLevels.parse)){State.currentTranscriptEntry.parses.push({text:text,time:new Date().getTime().toString(),passageName:State.currentPassageName});}ii++;origIndex++;}if(Matches.currentMatch){gatelyLog('failed match:',Matches.currentMatch);var remainder=origText.slice(0,matchOrigIndexes[0])+'\n\nERROR FOLLOWS BELOW:\n'+origText.slice(matchOrigIndexes[0]);wideAlert('A match was never successfully ended. Incomplete '+(Matches.getMacroType(Matches.currentMatch)||Matches.getDataType(Matches.currentMatch))+'.\n\n'+remainder);Matches.currentMatch=null;}node.innerHTML=text;var ifs=node.querySelectorAll('tw-match[data-macro-type="if"]')||[];for(var _ii3=0;_ii3<ifs.length;_ii3++){var ifNode=ifs[_ii3];var _parent4=ifNode.parentNode;var found=false;for(var jj=0;jj<_parent4.children.length;jj++){var _child=_parent4.children[jj];if(_child===ifNode){found=true;}else if(found){var _type3=Matches.getMacroType(_child);if(_type3==='elseif'||_type3==='else-if'){ifNode.appendChild(_parent4.removeChild(_child));jj--;}else if(_type3==='else'){ifNode.appendChild(_parent4.removeChild(_child));break;}else{break;}}}}var deferred=from(node.querySelectorAll('tw-match.defer'));for(var _ii4=0;_ii4<deferred.length;_ii4++){var openTag='openTagTerminator';var defer=deferred[_ii4];var descendants=defer.querySelectorAll('*');var _jj=0;while(_jj<descendants.length&&(Matches.getDataType(descendants[_jj-1])!==openTag||descendants[_jj-1].parentNode!==defer)){_jj++;}if(descendants[_jj]){var children=from(descendants).slice(_jj).reverse();for(var kk=0;kk<children.length;kk++){Parser.unparseNode(children[kk]);var html=children[kk].innerHTML.trim();if(html.startsWith('[')&&html.endsWith(']')){children[kk].innerHTML=html.slice(1,-1);}}}}Matches.handle(node);},parseText:function parseText(text){var span=$('<tw-match class="parseContainer">'+text+'</tw-match>')[0];Parser.parseNode(span);return span.innerHTML;},unparseNode:function unparseNode(node){if(node[0]){node=node[0];}var dataType=Matches.getDataType(node);var macroType=Matches.getMacroType(node);if(dataType==='singleQuote'||dataType==='doubleQuote'||dataType==='reservedWord'||dataType==='comma'||dataType==='html'){node.outerHTML=node.innerHTML;}else if(dataType==='hook'){node.outerHTML='['+node.innerHTML+']';}else if(dataType==='variable'){node.outerHTML='$'+node.innerHTML;}else if(dataType==='macro'){var dialect=node.getAttribute('data-dialect');if(dialect==='harlowe'){node.outerHTML='('+Matches.getMacroType(node)+': '+node.innerHTML;}else if(dialect==='sugarcube'){if(Macro[macroType].isDoubleTag){node.outerText='&lt;&lt;'+Matches.getMacroType(node)+' '+node.innerHTML+'&lt;&lt;end'+macroType+'&gt;&gt;';}else{node.outerText='&lt;&lt;'+Matches.getMacroType(node)+' '+node.innerHTML;}}else{// wut?
wideAlert('The data-dialect value was not recognized. '+'The only currently-supported dialects are '+'Sugarcube and Harlowe.');}}else if(dataType==='openTagTerminator'){var _dialect=node.getAttribute('data-dialect');if(_dialect==='harlowe'){node.outerHTML=')';}else if(_dialect==='sugarcube'){node.outerHTML='&gt;&gt;';}else{// wut?
wideAlert('The data-dialect value was not recognized. The '+'only currently-supported dialects are Sugarcube '+'and Harlowe.');}}},unparseText:function unparseText(text){var $div=$('<div>'+text+'</div>');Parser.unparseNode($div);return $div.html();}};window.stackTrace={passage:'load',lineNumber:0,currentLine:null,error:null};})();

},{}],9:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};(function(){'use strict';var $=window.jQuery;var from=Array.from;var getOwnPropertyNames=Object.getOwnPropertyNames;var $displayPassage=$('tw-story#passage');var convertPlainLinks=function convertPlainLinks(text){var regex=/\[\[(\s*[^[\]\s][^[\]]*)\]\]/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<tw-link class="passage" passage-name="'+match[1]+'">'+match[1]+'</tw-link>';text=text.replace(match[0],matchStr);}return text;};var convertComplexLinks=function convertComplexLinks(text){var match=void 0;// sugarcube-style links
var regex=/\[\[(\s*[^[\]\s][^[\]]*\|\s*[^[\]\s][^[\]]*)]]/g;while(match=regex.exec(text)){var split=match[1].split('|');var matchStr='<tw-link class="passage" passage-name="'+split.slice(1,split.length).join('|')+'">'+split[0]+'</tw-link>';text=text.replace(match[0],matchStr);}// harlowe-style forward-arrow links
regex=/\[\[(\s*[^[\]\s][^[\]]*-&gt;\s*[^[\]\s][^[\]]*)]]/g;while(match=regex.exec(text)){var _split=match[1].split(/-(?:>|&gt;)/);var _matchStr='<tw-link class="passage" passage-name="'+_split[_split.length-1]+'">'+_split.slice(0,_split.length-1).join('->')+'</tw-link>';text=text.replace(match[0],_matchStr);}// harlowe-style backward-arrow links
regex=/\[\[(\s*[^[\]\s][^[\]]*&lt;-\s*[^[\]\s][^[\]]*)]]/g;while(match=regex.exec(text)){var _split2=match[1].split(/(?:<|&lt;)-/);text=text.replace(match[0],'<tw-link class="passage" passage-name="'+_split2[_split2.length-1]+'">'+_split2.slice(0,_split2.length-1).join('<-')+'</tw-link>');}return text;};var convertItalics=function convertItalics(text){var regex=/\/\/(\S+)\/\//g;var match=void 0;while(match=regex.exec(text)){var matchStr='<i class="gately">'+match[1]+'</i>';text=text.replace(match[0],matchStr);}return text;};var convertBolds=function convertBolds(text){var regex=/''(\S+)''/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<b class="gately">'+match[1]+'</b>';text=text.replace(match[0],matchStr);}return text;};var convertStrongs=function convertStrongs(text){var regex=/\*\*(\S+)\*\*/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<strong class="gately">'+match[1]+'</strong>';text=text.replace(match[0],matchStr);}return text;};var convertEmphases=function convertEmphases(text){var regex=/\*(\S+)\*/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<em class="gately">'+match[1]+'</em>';text=text.replace(match[0],matchStr);}return text;};var convertSupers=function convertSupers(text){var regex=/\^\^(\S+)\^\^/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<sup class="gately">'+match[1]+'</sup>';text=text.replace(match[0],matchStr);}return text;};var convertSubs=function convertSubs(text){var regex=/~~(\S+)~~/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<del class="gately">'+match[1]+'</del>';text=text.replace(match[0],matchStr);}return text;};var convertUnderlines=function convertUnderlines(text){var regex=/__(\S+)__/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<u class="gately">'+match[1]+'</u>';text=text.replace(match[0],matchStr);}return text;};var convertStrikethroughs=function convertStrikethroughs(text){var regex=/==(\S+)==/g;var match=void 0;while(match=regex.exec(text)){var matchStr='<u class="gately">'+match[1]+'</u>';text=text.replace(match[0],matchStr);}return text;};var conversions=[convertComplexLinks,convertPlainLinks,convertItalics,convertBolds,convertStrongs,convertEmphases,convertSupers,convertSubs,convertUnderlines,convertStrikethroughs];var addPassage=function addPassage(passageName,text){$('tw-passage').removeClass('current');var $newPassage=$('<tw-passage></tw-passage>');$newPassage.addClass('current');if(State.currentTheme.rewind){$newPassage.addClass('rewind');}if(State.currentTheme.fastForward){$newPassage.addClass('fastForward');}var type=State.currentTheme.renderType;$newPassage.attr('data-render-type',type);$displayPassage.append($newPassage);var finalText=text;var $passage=$('tw-passagedata[name="'+passageName+'"]');if($passage.length&&$passage.is('[tags~="tracery-render"]')){var object=void 0;try{object=eval('('+$passage.html()+')');}catch(e){wideAlert('Could not eval in-passage tracery source.\n'+e.message);}if((typeof object==='undefined'?'undefined':_typeof(object))==='object'&&object!==null){var grammar=tracery.createGrammar(object);grammar.addModifiers(baseEngModifiers);finalText=grammar.flatten("#origin#");}}$newPassage.attr('data-id',passageName);$newPassage[0].innerHTML=finalText;};window.Renderer={isRendering:false,render:function render(passageName,rewindFastForward,type){this.isRendering=true;if(typeof passageName!=='string'||!passageName){wideAlert('The passageName argument passed to '+'Renderer.render is not valid.');return;}var $passage=$('tw-passagedata[name="'+passageName+'"]');if(!$passage.length){wideAlert('The passage referred to by the passageName '+'argument passed to Renderer.render is not valid.');return;}$('tw-history-button').appendTo($('tw-story#passage'));Macro.world.restoreModelProtoFuncs.handler();// check is the new passage has a 
var tags=$passage.attr('tags');tags=tags.split(' ');var changedRenderType=false;tags.forEach(function(tag){tag=tag.trim();if(tag.startsWith(tag.match(/world-|world/))&&!tag.endsWith(tag.match(/world-|world/))){var trimmedTag=tag.split(/world-|world/)[1];var player=State.currentWorldModelState.all.player;player.current[trimmedTag]='#'+passageName;}else if(tag.startsWith(tag.match('config:'))&&!tag.endsWith(tag.match('config:'))){var payload=tag.split('config:')[1].trim().split('=').map(function(part){return part.trim();});if(payload[0]==='renderType'){if(payload[1]in Config.renderTypes){type=payload[1];changedRenderType=true;}}}});var renderTypes=Config.renderTypes;var theme=State.currentTheme;var makingNode=false;if(rewindFastForward==='rewind'){if(type===renderTypes.jonah){var $rewindTo=$('tw-passage[data-id="'+passageName+'"]');State.rewindTo(passageName);$('tw-passage').removeClass('current');$rewindTo.addClass('current');$rewindTo.nextAll().addClass('future');}else if(type===renderTypes.sugarcube){State.rewindTo(passageName);makingNode=true;}else{wideAlert('The type argument passed to Renderer.render '+'is not one of the recognized '+'Config.renderTypes. Cannot rewind.');return;}}else if(rewindFastForward==='fastforward'){if(type===renderTypes.jonah){var $fastForwardTo=$('tw-passage[data-id="'+passageName+'"]');State.unrewindTo(passageName);$('tw-passage').removeClass('current');$fastForwardTo.addClass('current');$fastForwardTo.removeClass('future');$fastForwardTo.prevAll('tw-passage').removeClass('future');}else if(type===renderTypes.sugarcube){State.unrewindTo(passageName);makingNode=true;}else{wideAlert('The type argument passed to Renderer.render '+'is not one of the recognized '+'Config.renderTypes. Cannot rewind.');return;}}else{// if a link is clicked, remove all future shit
$('tw-passage.future').remove();// create a new history state, carrying over prior variables
State.newState(passageName);makingNode=true;}if(makingNode){Renderer.makeNode(passageName);}var matches=$('tw-passage.current').find('tw-match').toArray().reverse();matches.forEach(function(match){// remove quotes from unevalled, still-existing string matches
if(match.getAttribute('data-javascript-type')==='string'&&match.innerHTML.startsWith('"')&&match.innerHTML.endsWith('"')){match.innerHTML=match.innerHTML.slice(1,match.innerHTML.length-1);}$(match).contents().each(function(_,node){match.parentElement.insertBefore(node,match);});// remove all tw-match tags
$(match).remove();});tags.forEach(function(tag){tag=tag.trim();if(tag.startsWith(tag.match('config:'))&&!tag.endsWith(tag.match('config:'))){var payload=tag.split('config:')[1].trim().split('=').map(function(part){return part.trim();});if(payload[0].toLowerCase()==='newlinehandlingtype'){if(payload[1]in Config.newlineHandlingTypes){Config.editTheme({newlineHandling:payload[1]});}}else if(payload[0]==='rewind'){Config.editTheme({rewind:payload[1]});}else if(payload[0]==='fastforward'){Config.editTheme({fastforward:payload[1]});}}});if(changedRenderType){Config.editTheme({renderType:type});}Renderer.handleBackAndForwardButtons();if(State.currentTheme.newlineHandlingType===Config.newlineHandlingTypes.newlineToBr){Renderer.newlineToBr(document.querySelector('tw-passage.current'));}$('body').scrollTop($('tw-passage.current').offset().top-5);this.isRendering=false;State.validateStateIntegrity();if(State.recordingTranscript){Options.updateTranscriptVisuals();}},makeNode:function makeNode(passageName){var $passage=$('tw-passagedata[name="'+passageName+'"]');var renderTypes=Config.renderTypes;var theme=State.currentTheme;var headerPassages=$storydata.find('tw-passagedata[tags~="header"], '+'tw-passagedata[tags~="prerender"], '+'tw-passagedata[tags~="pre-render"]').toArray();var footerPassages=$storydata.find('tw-passagedata[tags~="footer"], '+'tw-passagedata[tags~="postrender"], '+'tw-passagedata[tags~="post-render"]').toArray();// add a valid passage for rendering if one does not already exist
if(theme.renderType===renderTypes.jonah||!$('tw-passage.current').length){addPassage(passageName,$passage.html());}var $currentNode=$('tw-passage.current');if(theme.renderType===renderTypes.sugarcube){$currentNode[0].innerHTML=$passage.html();}Options.endTranscriptEntry();Options.startTranscriptEntry();var headerID=1;headerPassages.reverse().forEach(function(header){var text=header.innerHTML;if($(header).is('[tags~="tracery-render"]')){var object=void 0;try{object=eval('('+header.innerHTML+')');}catch(e){wideAlert('Could not eval in-passage tracery source'+'(header).\n'+e.message);}if((typeof object==='undefined'?'undefined':_typeof(object))==='object'&&object!==null){var grammar=tracery.createGrammar(object);grammar.addModifiers(baseEngModifiers);var flattened=grammar.flatten("#origin#");text=flattened;}}var headerStr='<tw-header id="header'+headerID+'">'+text+'</tw-header>';var html=$currentNode[0].innerHTML;$currentNode[0].innerHTML=headerStr+html;headerID++;});var footerID=1;footerPassages.forEach(function(footer){var text=footer.innerHTML;if($(footer).is('[tags~="tracery-render"]')){var object=void 0;try{object=eval('('+footer.innerHTML+')');}catch(e){wideAlert('Could not eval in-passage tracery source '+'(footer).\n'+e.message);}if((typeof object==='undefined'?'undefined':_typeof(object))==='object'&&object!==null){var grammar=tracery.createGrammar(object);grammar.addModifiers(baseEngModifiers);var flattened=grammar.flatten("#origin#");text=flattened;}}var footerStr='<tw-header id="header'+footerID+'">'+text+'</tw-header>';var html=$currentNode[0].innerHTML;$currentNode[0].innerHTML=html+footerStr;footerID++;});conversions.forEach(function(conversion){$currentNode[0].innerHTML=conversion($currentNode.html());});var textChanges=Options.recordingLevels.textChanges;if(window.DEBUG||textChanges){Options.captureTextChanges();}Parser.parseNode($currentNode);var pageEvents=Options.recordingLevels.pageEvents;if(window.DEBUG||pageEvents){Options.capturePageEvents();}},handleBackAndForwardButtons:function handleBackAndForwardButtons(){var $currentNode=$('tw-passage.current');var $backButton=$('tw-history-button.back');var $forwardButton=$('tw-history-button.forward');var $twStory=$('tw-story#passage');var configObj=State.currentTheme;if(configObj.renderType===Config.renderTypes.sugarcube){// first is load. can't go to load
var prevTheme=State.themeHistory[State.themeHistory.length-2];if(State.history.length>2&&prevTheme.renderType===Config.renderTypes.sugarcube){$backButton.removeClass('hidden').appendTo($currentNode);}else{$backButton.addClass('hidden').appendTo($twStory);}if(State.historyFuture.length>0&&State.themeHistoryFuture[0].renderType===Config.renderTypes.sugarcube){$forwardButton.removeClass('hidden').appendTo($currentNode);}else{$forwardButton.addClass('hidden').appendTo($twStory);}$currentNode.attr('data-render-type','sugarcube');}else if(configObj.renderType===Config.renderTypes.jonah){$backButton.add($forwardButton).addClass('hidden').appendTo($twStory);$currentNode.attr('data-render-type','jonah');}},newlineToBr:function newlineToBr(parent){var parentElem=parent;if(parentElem[0]){parentElem=parentElem[0];}var treeWalker=document.createTreeWalker(parentElem,NodeFilter.SHOW_TEXT,{acceptNode:function acceptNode(node){var parent=node.parentNode;if(parent&&parent.tagName!=='SCRIPT'&&parent.tagName!=='STYLE'){return NodeFilter.FILTER_ACCEPT;}else{return NodeFilter.FILTER_REJECT;}}},false);var nodeList=[];while(treeWalker.nextNode()){nodeList.push(treeWalker.currentNode);}nodeList.forEach(function(node){var replaced=node.textContent.replace(/\n/g,'<br class="gately">');$(node).replaceWith(replaced);});},undoNewlineHandling:function undoNewlineHandling(parent){var $tags=$(parent).find('br.gately');$tags.each(function(_,elem){elem.outerHTML='\n';});}};})();

},{}],10:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};(function(){'use strict';window.deepCopy=function(obj){if((typeof obj==='undefined'?'undefined':_typeof(obj))!=='object'){gatelyLog('obj argument passed to deepCopy is not an object.');return;}return JSON.parse(JSON.stringify(obj));};window.deepFreeze=function(obj){for(var name in obj){// Freeze prop if it is an object
if(_typeof(obj[name])==='object'&&obj[name]!==null){deepFreeze(obj[name]);}}// Freeze self (no-op if already frozen)
return Object.freeze(obj);};window.State={currentPassageName:null,history:[],historyFuture:[],currentTranscriptEntry:null,transcriptHistory:[{passageName:'load',textChanges:[],stateChanges:[],pageEvents:[],parses:[],macros:[]}],transcriptHistoryFuture:[],recordingTranscript:false,currentVariableState:null,variableHistory:[],variableHistoryFuture:[],currentWorldModelState:null,worldModelHistory:[],worldModelHistoryFuture:[],currentBindingState:null,bindingHistory:[],bindingHistoryFuture:[],currentHeaderID:1,currentFooterID:1,functionStore:{},macroAliasStore:{},macroAliasDisposals:[],traceryStore:{},themeHistory:[],themeHistoryFuture:[],currentTheme:{renderType:Config.renderTypes.sugarcube,rewind:true,fastForward:true,passageName:'load',newlineHandlingType:Config.newlineHandlingTypes.newlineToBr,debug:{allowTranscripts:true,allowSaves:true},errorLevels:{console:true,alert:false,inline:true}},setVariable:function setVariable(variableName,equalsType,newValue){if(typeof variableName!=='string'||!variableName){wideAlert('The variableName argument passed to '+'State.setVariable is not valid.');return;}else if(!equalsType||typeof equalsType!=='string'){wideAlert('The assignType argument passed to '+'State.setVariable is not valid.');return;}else if(typeof newValue==='undefined'){wideAlert('The newValue argument must be defined to set a '+'variable.');return;}var assignType=equalsType.trim();var currentState=State.currentVariableState;if(assignType==='='){currentState[variableName]=newValue;}else if(assignType==='+='){currentState[variableName]+=newValue;}else if(assignType==='-='){currentState[variableName]-=newValue;}else if(assignType==='*='){currentState[variableName]*=newValue;}else if(assignType==='/='){currentState[variableName]/=newValue;}else if(assignType==='%='){currentState[variableName]%=newValue;}else{wideAlert('The equalsType argument is not valid. Cannot '+'execute.');return;}if(State.getBinding(variableName)){State.updateBinding(variableName);}},getNewFooterID:function getNewFooterID(){return State.currentFooterID++;},newState:function newState(passageName){State.history.push(passageName);State.currentPassageName=passageName;State.historyFuture=[];var previousState=State.variableHistory[State.variableHistory.length-1];State.variableHistory.push({});State.currentVariableState=State.variableHistory[State.variableHistory.length-1];if(previousState){var states=getOwnPropertyNames(previousState);states.forEach(function(name){State.currentVariableState[name]=previousState[name];});}State.variableHistoryFuture=[];var deepWM=void 0;if(State.worldModelHistory.length){deepWM=deepCopy(State.currentWorldModelState);deepWM.passageName=passageName;State.worldModelHistory.push(deepWM);}else{deepWM=deepCopy(_worldModelTempStore);deepWM.passageName=passageName;State.worldModelHistory.push(deepWM);}State.currentWorldModelState=deepWM;State.worldModelHistoryFuture=[];Macro.world.restoreModelProtoFuncs.handler();State.bindingHistory.push({});State.currentBindingState=State.bindingHistory[State.bindingHistory.length-1];State.bindingHistoryFuture=[];var deepTheme=deepCopy(State.currentTheme);deepTheme.passageName=passageName;State.themeHistory.push(deepTheme);State.currentTheme=deepTheme;State.themeHistoryFuture=[];if(window.DEBUG){// shows basic memory allocations
for(var name in State){if(JSON.stringify(State[name])){console.log(name,JSON.stringify(State[name]).length);}else{console.log(name,0);}}console.log('total JS',JSON.stringify(State).length);console.log('total HTML',top.document.body.parentElement.innerHTML.length);console.log('__BREAK__');}},rewindTo:function rewindTo(passageName){var index=State.history.lastIndexOf(passageName);if(index===-1){wideAlert('The passagename '+passageName+' does not exist in the history. Cannot rewind.');return;}State.historyFuture=State.history.slice(index+1).concat(State.historyFuture);State.history=State.history.slice(0,index+1);State.currentPassageName=State.history[State.history.length-1];State.transcriptHistoryFuture=State.transcriptHistory.slice(index+1).concat(State.transcriptHistoryFuture);State.transcriptHistory=State.transcriptHistory.slice(0,index+1);State.variableHistoryFuture=State.variableHistory.slice(index+1).concat(State.variableHistoryFuture);State.variableHistory=State.variableHistory.slice(0,index+1);State.currentVariableState=State.variableHistory[State.variableHistory.length-1];var wmHistory=State.worldModelHistory;State.worldModelHistoryFuture=wmHistory.slice(index+1).concat(State.worldModelHistoryFuture);State.worldModelHistory=wmHistory.slice(0,index+1);State.currentWorldModelState=wmHistory[wmHistory.length-1];State.bindingHistoryFuture=State.bindingHistory.slice(index+1).concat(State.bindingHistoryFuture);State.bindingHistory=State.bindingHistory.slice(0,index+1);State.currentBindingState=State.bindingHistory[State.bindingHistory.length-1];State.themeHistoryFuture=State.themeHistory.slice(index+1).concat(State.themeHistoryFuture);State.themeHistory=State.themeHistory.slice(0,index+1);State.currentTheme=State.themeHistory[State.themeHistory.length-1];},unrewindTo:function unrewindTo(passageName){var index=State.historyFuture.indexOf(passageName);if(index===-1){wideAlert('The passagename '+passageName+' does not exist in the history. Cannot rewind.');return;}State.history=State.history.concat(State.historyFuture.slice(0,index+1));State.historyFuture=State.historyFuture.slice(index+1);State.currentPassageName=State.history[State.history.length-1];State.transcriptHistory=State.transcriptHistory.concat(State.transcriptHistoryFuture.slice(0,index+1));State.transcriptHistoryFuture=State.transcriptHistory.slice(index+1);State.variableHistory=State.variableHistory.concat(State.variableHistoryFuture.slice(0,index+1));State.variableHistoryFuture=State.variableHistoryFuture.slice(index+1);State.currentVariableState=State.variableHistory[State.variableHistory.length-1];var wmHistory=State.worldModelHistory;State.worldModelHistory=wmHistory.concat(State.worldModelHistoryFuture.slice(0,index+1));State.worldModelHistoryFuture=State.worldModelHistoryFuture.slice(index+1);State.currentWorldModelState=wmHistory[wmHistory.length-1];State.bindingHistory=State.bindingHistory.concat(State.bindingHistoryFuture.slice(0,index+1));State.bindingHistoryFuture=State.bindingHistoryFuture.slice(index+1);State.currentBindingState=State.bindingHistory[State.bindingHistory.length-1];State.themeHistory=State.themeHistory.concat(State.themeHistoryFuture.slice(0,index+1));State.themeHistoryFuture=State.themeHistoryFuture.slice(index+1);State.currentTheme=State.themeHistory[State.themeHistory.length-1];},addMacroAlias:function addMacroAlias(macroName,aliasName,disposeAfterPassage,override){if(!macroName){wideAlert('The macroName argument passed to '+'Macro.global.addmacroalias is not valid. Cannot add macro alias.');return;}else if(!(macroName in Macro)){wideAlert('The macroName argument passed to '+'Macro.global.addmacroalias does not correspond to an '+'existing macro. Cannot add macro alias.');return;}else if(!aliasName){wideAlert('The aliasName argument passed to '+'Macro.global.addmacroalias is not valid. Cannot add macro alias.');return;}else if(aliasName in Macro){wideAlert('A macro with the same name as the aliasName '+'argument, '+aliasName+', already exists in the '+'Macro object. Cannot execute.');return;}else if(aliasName in State.macroAliasStore&&override!==true&&(typeof override!=='string'||override.toLowerCase()!=='override')){wideAlert('An alias with the same name as the aliasName '+'argument, '+aliasName+', already exists in the '+'State.macroAliasStore object. Set the override '+'argument to true or "override" to override this error.');return;}State.macroAliasStore[aliasName]=Macro[macroName];if(disposeAfterPassage===true||typeof disposeAfterPassage==='string'&&disposeAfterPassage.toLowerCase()==='disposeafterpassage'){State.macroAliasDisposals.push(aliasName);}},addFunction:function addFunction(name,callback,override){if(!name){wideAlert('A TwineScript function cannot exist without a '+'valid name.');return;}else if(typeof callback!=='string'||!callback){wideAlert('The callback argument passed to '+'State.addFunction is not a valid, non-empty string.');return;}else if(name in Macro){wideAlert('There is already a property in the Macro object '+'named '+name+'. Cannot execute.');return;}else if(name in State.macroAliasStore){wideAlert('There is already a property in the '+'State.macroAliasStore named '+name+'. Cannot '+'execute.');return;}else if(name in State.functionStore&&override!==true&&(typeof override!=='string'||override.toLowerCase()!=='override')){wideAlert('There is already a property in '+'State.functionStore named '+name+'. Set the '+'override argument to true or "override" to '+'override this error.');return;}State.functionStore[name]={callback:callback,handler:function handler(){var replaced=callback;for(var ii=0;ii<arguments.length;ii++){var arg=arguments[ii];if((typeof arg==='undefined'?'undefined':_typeof(arg))==='object'){arg=JSON.stringify(arg);}var re=new RegExp('\\$args\\['+ii+']','g');replaced=replaced.replace(re,arg);}var match=$('<tw-match class="parseContainer">'+replaced+'</tw-match>')[0];Parser.parseNode(match);return match;}};},getBinding:function getBinding(nameOrExpression){if(typeof nameOrExpression!=='string'||!nameOrExpression){wideAlert('The nameOrExpression argument passed to '+'State.getBinding was not valid.');return;}return State.currentBindingState[nameOrExpression];},addBinding:function addBinding(nameOrExpression,callback){nameOrExpression=nameOrExpression.trim();if(nameOrExpression==='passageName'){wideAlert('"passageName" is reserved and cannot be used as '+'the source for a binding.');return;}if(nameOrExpression.startsWith('$')){nameOrExpression=nameOrExpression.slice(1);}State.currentBindingState[nameOrExpression]={callback:callback,selector:nameOrExpression,lastValue:null};},updateBinding:function updateBinding(nameOrExpression){if(typeof nameOrExpression!=='string'||!nameOrExpression){wideAlert('The nameOrExpression argument passed to '+'State.updateBinding was not valid.');return;}var binding=State.currentBindingState[nameOrExpression];if(!binding){wideAlert('There is no binding tied to the variable name or '+'expression '+nameOrExpression+'. '+'Cannot update binding.');return;}else if(typeof binding.selector==='undefined'){wideAlert('The selector property of the binding referred '+'to by the nameOrExpression argument '+'(passed to State.updateBinding) is not valid.');return;}else if(!binding.callback){wideAlert('The callback property of the binding referred '+'to by the nameOrExpression argument '+'(passed to State.updateBinding) is not valid.');return;}var selector='tw-binding[data-binding-selector="'+nameOrExpression+'"]';var elem=$(selector)[0];if(!elem){return;}if(typeof binding.lastValue==='undefined'||binding.lastValue===null||retVal!==binding.lastValue){$(elem).contents().remove();var span=$('<tw-match class="bindingContainer">'+binding.callback+'</tw-match>')[0];Parser.parseNode(span);elem.appendChild(span);}},updateBindings:function updateBindings(){var names=getOwnPropertyNames(State.currentBindingState);names.forEach(function(name){if(name!=='passageName'){State.updateBinding(name);}});},addTraceryGrammar:function addTraceryGrammar(name,grammar,modifiers){if(typeof name!=='string'||name===''){wideAlert('The name argument passed to State.addTraceryGrammar '+'is not valid. Cannot add.');return;}var object=void 0;if(!grammar){wideAlert('The grammar argument passed to '+'State.addTraceryGrammar is not valid. Cannot add.');return;}else if(typeof grammar==='string'){try{object=JSON.parse(grammar);}catch(jsonError){try{object=eval('('+grammar+')');}catch(evalError){wideAlert('Could not eval in-passage tracery source'+'(store).\n\n'+'The error is one of the following (#1 for JSON, '+'#2 for a raw, evalled string:\n#1:'+jsonError.message+'\n#2:'+evalError.message);return;}}}else if((typeof grammar==='undefined'?'undefined':_typeof(grammar))==='object'){object=grammar;}var traceried=tracery.createGrammar(object);var mods=modifiers;if(typeof modifiers==='string'){mods=saferCombinedParse(modifiers);}if(!mods){mods=baseEngModifiers;}traceried.addModifiers(mods);State.traceryStore[name]=traceried;},validateStateIntegrity:function validateStateIntegrity(){var val=void 0;var lengths=[State.history.length,State.variableHistory.length,State.worldModelHistory.length,State.bindingHistory.length,State.themeHistory.length];val=lengths[0];lengths.forEach(function(length){if(length!==val){wideAlert('One of the state history collections has a '+'different length than one or more of the other '+'collections. This may prevent the story from '+'functioning and continuing on will likely result '+'in further bugs.');return;}});var futureLengths=[State.historyFuture.length,State.variableHistoryFuture.length,State.worldModelHistoryFuture.length,State.bindingHistoryFuture.length,State.themeHistoryFuture.length];val=futureLengths[0];futureLengths.forEach(function(futureLength){if(futureLength!==val){wideAlert('One of the state future history collections has '+'a different length than one or more of '+'the other collections. This may prevent the story '+'from functioning and continuing on will likely '+'result in further bugs.');return;}});var currents=[State.currentVariableState,State.currentWorldModelState,State.currentBindingState,State.currentTheme];currents.forEach(function(current){if((typeof current==='undefined'?'undefined':_typeof(current))!=='object'){wideAlert('One of the state current properties is not '+'a valid object. This may prevent the story from '+'functioning and continuing on will likely result '+'in further bugs.');return;}});var selector='tw-passagedata[name="'+State.currentPassageName+'"]';if(typeof State.currentPassageName!=='string'||State.currentPassageName===''){wideAlert('The State.currentPassageName property is not a '+'string, or is an empty string. This may prevent '+'the story from functioning and continuing on will '+'likely result in further bugs.');return;}else if(!document.querySelector(selector)){wideAlert('The State.currentPassageName property does not '+'correspond to a tw-passagedata element. This may '+'prevent the story from functioning and continuing '+'on will likely result in further bugs.');return;}}};})();

},{}],11:[function(require,module,exports){
'use strict';var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol?"symbol":typeof obj;};function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}(function(){'use strict';Macro.addNamespace('world',null,function(actionType){if(!actionType){wideAlert('The actionType value passed to '+'Macro.world.handler is not valid.');return;}else if(typeof actionType!=='string'){wideAlert('The actionType value passed to '+'Macro.world.handler is not a string. '+'Cannot handle macro.');return;}actionType=actionType.trim();var action=worldActions[actionType];var args=from(arguments).slice(1);if(isFunction(action)){return action.apply({twine:'twine',node:this},args);}else{wideAlert('Can\'t do worldmodel action: '+action+'. No handler exists for this action.');}});Macro.add('add',{handler:function handler(name,type,objectOrParentModelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.add';if(typeof name!=='string'||name===''){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The name argument provided to '+'Macro.world.add is not valid.'));}else if(/[#!.:*?%@]/.test(name)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The name argument provided to '+'Macro.world.add contains one of '+'the reserved characters. The reserved '+'characters for names and types are '+'#, ., :, !, *, %, and @.'));}else if(!Number.isNaN(Number(name))){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'You cannot give a name that is only '+'numbers to a model, given that this could '+'conflict with current or future model ID '+'values.'));}else if(typeof type!=='string'||type===''){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The type argument provided to '+'Macro.world.add is not valid.'));}else if(/[#!.:*?%@]/.test(type)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The type argument provided to '+'Macro.world.add contains one of the '+'reserved characters. The reserved '+'characters for names and types are '+'#, ., :, !, *, %, and @.'));}else if(!worldActions.validateSetValue(name)||!worldActions.validateSetValue(type)||!worldActions.validateSetValue(objectOrParentModelArg)){var names=getOwnPropertyNames(reserved);names=names.filter(function(aa){// do not return array prototype properties
return!Array.prototype.hasOwnProperty(aa);}).filter(function(aa){// only return strings
var reserve=reserved[aa];return typeof reserve==='string';}).map(function(aa){return reserved[aa];}).join(', ');return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'You cannot add an object which shares '+'a name with one of the reserved words. '+'The reserved words are: '+names+'.'));}var existingModel=worldActions.get('#'+name);if(existingModel.type==='error'){var _constructor=modelConstructors[type];if(!_constructor){_constructor=modelConstructors.model;}var model=new _constructor(name,type);State.currentWorldModelState.all[name]=model;if(!(model.type in State.currentWorldModelState)){State.currentWorldModelState[model.type]={};}State.currentWorldModelState[model.type][model.name]='#'+model.name;if(objectOrParentModelArg){var parent=worldActions.get(objectOrParentModelArg);if(!parent||parent.type==='error'){var _type=model.type;var curState=State.currentWorldModelState;if(_type in curState){delete curState[_type][model.name];delete curState[_type][model.id];}delete curState.all[model.name];delete curState.all[model.id];return worldActions.formatOutput(this,parent);}worldActions.take(parent,model);}return worldActions.formatOutput(this,model);}else{return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'There is already a model by that name. '+'Each model must have a unique name.'));}}},'world');Macro.add('remove',{handler:function handler(modelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var model=worldActions.get(modelArg);var context='Macro.world.remove';if(!worldActions.validateSetValue(modelArg)||!worldActions.validateSetValue(model)){var names=getOwnPropertyNames(reserved);names=names.filter(function(aa){return!Array.prototype.hasOwnProperty(aa);}).filter(function(aa){return!reserved[aa].name;}).map(function(aa){return reserved[aa];}).join(', ');return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'You cannot remove an object that is, or '+'is named, one of the reserved words. The '+'reserved words are: '+names+'.'));}if(!model||model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.remove is not valid, or '+'the model does not exist: '+modelArg+'.'));}var type=model.type;var curState=State.currentWorldModelState;if(type in curState){delete curState[type][model.name];delete curState[type][model.id];}delete curState.all[model.name];delete curState.all[model.id];model.parentSelector=null;return worldActions.formatOutput(this,model);}},'world');Macro.add('get',{handler:function handler(modelArg,propertyName){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.get';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.get is not valid.'));}else if(typeof modelArg==='string'){modelArg=modelArg.replace(/&gt;/g,'>');}var model=modelArg;if(typeof model==='string'){try{model=saferJSONParse(model);}catch(e){// do nothing
}}var selector=void 0;if(typeof model==='string'&&model.trim()[0].match(/[#!.:*?]/)){selector=model.trim().split(/\s/);}if(selector&&selector.length){model=worldActions.processSelector(selector);}if(worldActions.validateModel(model)&&model.type!=='collection'){if(model.generic===true){model=State.currentWorldModelState.all[model.id];}else{model=State.currentWorldModelState.all[model.name];}}if(!worldActions.validateModel(model)){return{type:'error',message:'The modelArg argument passed to '+'Macro.world.get does not correspond to '+'an existing model.'};}else if(propertyName){if(propertyName[0]==='@'){return worldActions.formatOutput(this,worldActions.getAlias(model,propertyName.slice(1)));}else{return worldActions.formatOutput(this,model[propertyName]);}}else{return worldActions.formatOutput(this,model);}}},'world');Macro.add('processselector',{handler:function handler(selector){var _this=this,_arguments=arguments;for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.processselector/get';// if the argument is a string and not an array, convert it
// to an array
if(typeof selector==='string'){selector=selector.split(' ').filter(function(temp){return temp!=='';});}if(!('0'in selector)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The selector argument passed to '+'Macro.world.processselector is not '+'valid. The argument must be a non-empty string'+'or array.'));}var store={type:'collection',children:{}};var model=void 0;var componentType=selector[0][0];var componentValue=selector[0].slice(1);var curWMState=State.currentWorldModelState;if(componentType==='#'){model=curWMState.all[componentValue];if(typeof model==='undefined'&&!Number.isNaN(Number(componentValue))){var names=getOwnPropertyNames(curWMState.all);model=names.map(function(name){return curWMState.all[name];}).filter(function(model){return model.id===Math.floor(Number(componentValue));})[0];}}else if(componentType==='?'){var _player=curWMState.all.player;if(!('current'in _player)){throw new Error('There is no current property in '+'the player model. Cannot perform ? selectors.');}else if(!(componentValue in _player.current)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'There is no current property by the name '+componentValue+' in the player\'s current property.'));}var current=_player.current;var name=current[componentValue].slice(1);model=curWMState.all[name];}else if(componentType==='.'){model={type:'collection',children:{}};if(!(componentValue in curWMState)){// ADD ERROR HANDLING
wideAlert('Bad component value in processSelector!');return;}var namesOrIDs=getOwnPropertyNames(curWMState[componentValue]);namesOrIDs.forEach(function(nameOrID){model.children[nameOrID]='#'+nameOrID;});}else if(componentType==='*'&&componentValue===''){model={type:'collection',children:{}};var _names=getOwnPropertyNames(curWMState.all);_names.forEach(function(nameOrID){model.children[nameOrID]='#'+nameOrID;});}else if(componentType==='!'){if(componentValue==='*'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The * symbol cannot be part of a not '+'selector.'));}else if(componentValue[0]==='#'){model={type:'collection',children:{}};var _namesOrIDs=getOwnPropertyNames(curWMState.all);_namesOrIDs.forEach(function(nameOrID){if(componentValue.slice(1)!==nameOrID){model.children[nameOrID]='#'+nameOrID;}});}else if(componentValue[0]==='?'){var _ret=function(){var player=curWMState.all.player;var nameOrID=componentValue.slice(1);if(!('current'in player)){throw new Error('There is no current property '+'in the player model. Cannot perform ? '+'selectors.');}else if(!(nameOrID in player.current)){return{v:worldActions.formatOutput(_this,new ErrorModel(context,from(_arguments),'There is no current property by the'+'name '+componentValue+' in the '+'player\'s current property.'))};}var newNameOrID=player.current[nameOrID].slice(1);var current=curWMState.all[newNameOrID];model={type:'collection',children:{}};var namesOrIDs=getOwnPropertyNames(curWMState.all);namesOrIDs.forEach(function(nameOrID){if(current.name!==nameOrID&&current.id!==nameOrID){model.children[nameOrID]='#'+nameOrID;}});}();if((typeof _ret==='undefined'?'undefined':_typeof(_ret))==="object")return _ret.v;}else if(componentValue[0]==='.'){model={type:'collection',children:{}};var _namesOrIDs2=getOwnPropertyNames(curWMState.all);_namesOrIDs2.forEach(function(nameOrID){if(curWMState.all[nameOrID].type!==componentValue.slice(1)){model.children[nameOrID]='#'+nameOrID;}});}else if(componentValue[0]===':'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'A property cannot be part of a not '+'selector.'));}}else if(componentType===':'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'A property cannot be the first portion of a '+'selector.'));}if(!model){return{context:context,type:'error',message:'The model(s) indicated by the '+componentType+componentValue+' portion of the selector do not exist.'};}for(var _ii=1;_ii<selector.length;_ii++){store.children={};var toCheck='descendant';if(selector[_ii-1]==='>'){toCheck='child';}componentType=selector[_ii][0];componentValue=selector[_ii].slice(1,selector[_ii].length);if(componentType==='>'&&componentValue===''&&_ii+1 in selector){continue;}if(componentType==='#'&&componentValue==='root'){if(model.type==='collection'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'It is not possible to produce a root '+'from a collection of models.'));}var parents=[];var newParent=model.parent();while(newParent&&newParent.type!=='error'){var parentSelector=newParent.parentSelector;if(parents.indexOf(parentSelector)!==-1||parents.indexOf(newParent.parent())!==-1){throw new Error('A parent of one of the '+'specified models has a corrupted '+'descendence tree and contains itself, '+'or its selector, as a parent.');}parents.push(newParent.selector());parents.push(newParent);model=newParent;newParent=newParent.parent();}}else if(componentType==='#'){if(toCheck==='child'||model.type==='collection'){if(!('children'in model)){throw new Error('The model indicated by '+'the portion of the selector prior to '+componentType+componentValue+' does not have a children property.');}var _names2=getOwnPropertyNames(model.children);var temp=null;for(var _ii2=0;_ii2<_names2.length;_ii2++){var _nameOrID=_names2[_ii2];if(!(_nameOrID in model.children)){break;}var childName=model.children[_nameOrID].slice(1);temp=curWMState.all[childName];}model=temp;}else{if(!('descendants'in model)){throw new Error('The model indicated by '+'the portion of the selector prior to '+componentType+componentValue+' does not have a descendants property.');}var _names3=getOwnPropertyNames(model.descendants);var _temp=null;for(var _ii3=0;_ii3<_names3.length;_ii3++){var _nameOrID2=_names3[_ii3];if(!(_nameOrID2 in model.descendants)){break;}var descendantName=model.descendants[_nameOrID2].slice(1);_temp=curWMState.all[descendantName];}model=_temp;}}else if(componentType==='@'){model=worldActions.getAlias(model,componentValue);}else if(componentType==='?'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'A current (?) selector cannot occur after '+'the first portion of a selector.'));}else if(componentType==='!'){if(componentValue==='#root'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'A #root selector cannot have NOT (!) '+'applied to it.'));}else if(componentValue[0]==='#'){if(toCheck==='child'||model.type==='collection'){if(!model.children){throw new Error('The model indicated '+'by the portion of the selector '+'prior to '+componentType+componentValue+' does not have a children '+'property.');}var children=model.children;var _namesOrIDs3=getOwnPropertyNames(children);_namesOrIDs3.forEach(function(nameOrID){if(componentValue.slice(1)!==nameOrID){store.children[nameOrID]='#'+nameOrID;}});model=store;}else{if(!('descendants'in model)){throw new Error('The model indicated '+'by the portion of the selector '+'prior to '+componentType+componentValue+' does not have a descendants '+'property.');}var descendants=model.descendants;var _namesOrIDs4=getOwnPropertyNames(descendants);_namesOrIDs4.forEach(function(nameOrID){var sliced=componentValue.slice(1);if(sliced!==nameOrID){store.children[nameOrID]='#'+nameOrID;}});model=store;}}else if(componentValue[0]==='?'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'A current (?) selector cannot occur '+'after the first portion of a '+'selector.'));}else if(componentValue[0]==='.'){if(toCheck==='child'||model.type==='collection'){if(!('children'in model)){throw new Error('The model indicated '+'by the portion of the selector '+'prior to '+componentType+componentValue+' does not have a children '+'property.');}var _children=model.children;var _namesOrIDs5=getOwnPropertyNames(_children);_namesOrIDs5.forEach(function(nameOrID){if(curWMState.all[nameOrID].type!==componentValue.slice(1)){store.children[nameOrID]='#'+nameOrID;}});model=store;}else{if(!('descendants'in model)){throw new Error('The model indicated '+'by the portion of the selector '+'prior to '+componentType+componentValue+' does not have a descendants '+'property.');}var _descendants=model.descendants;var _namesOrIDs6=getOwnPropertyNames(_descendants);_namesOrIDs6.forEach(function(nameOrID){if(curWMState.all[nameOrID].type!==componentValue.slice(1)){store.children[nameOrID]='#'+nameOrID;}});model=store;}}else if(componentValue[0]===':'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'A property cannot be part of a not '+'selector.'));}model=store;}else if(componentType==='.'){if(toCheck==='child'||model.type==='collection'){if(!('children'in model)){throw new Error('The model indicated by '+'the portion of the selector prior to '+componentType+componentValue+' does not have a children property.');}var _namesOrIDs7=getOwnPropertyNames(model.children);_namesOrIDs7.forEach(function(nameOrID){if(nameOrID in curWMState[componentValue]){store.children[nameOrID]='#'+nameOrID;}});model=store;}else{if(!('descendants'in model)){throw new Error('The model indicated by '+'the portion of the selector prior to '+componentType+componentValue+' does not have a descendants property.');}var _namesOrIDs8=getOwnPropertyNames(model.descendants);_namesOrIDs8.forEach(function(nameOrID){if(nameOrID in curWMState[componentValue]){store.children[nameOrID]='#'+nameOrID;}});model=store;}}else if(componentType===':'){model=model[componentValue];}else if(componentType==='*'&&componentValue===''){if(toCheck==='child'||model.type==='collection'){if(!('children'in model)){throw new Error('The model indicated by '+'the portion of the selector prior to '+componentType+componentValue+' does not have a children property.');}model={type:'collection',children:model.children};}else{if(!('descendants'in model)){throw new Error('The model indicated by '+'the portion of the selector prior to '+componentType+componentValue+' does not have a descendants property.');}model={type:'collection',children:model.descendants};}}else{return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The character indicating the selector '+'portion type '+componentType+' is not valid.'));}if(typeof model==='undefined'||model===null){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model(s) indicated by the '+componentValue+' portion of the selector do not exist.'));}}return worldActions.formatOutput(this,model);}},'world');Macro.world.processSelector=Macro.world.processselector;Macro.world['process-selector']=Macro.world.processselector;Macro.add('set',{handler:function handler(modelArg,propertyName,value){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.set';var model=worldActions.get(modelArg);if(!model||model.type==='error'){return{type:'error',context:context,message:'The modelArg argument passed to '+'Macro.world.set is not valid.'};}else if(!worldActions.validateSetValue(propertyName)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'You can\'t set this value. The property '+propertyName+' is reserved.'));}model[propertyName]=value;return worldActions.formatOutput(this,model);}},'world');Macro.add('unset',{handler:function handler(modelArg,propertyName){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.unset';var model=worldActions.get(modelArg);if(!model||model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.set is not valid.'));}else if(!worldActions.validateSetValue(propertyName)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'You can\'t set this value. The property '+propertyName+' is reserved.'));}delete model[propertyName];return worldActions.formatOutput(this,model);}},'world');Macro.add('contains',{handler:function handler(parentModelArg,childModelArg,children){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.contains';var parentModel=worldActions.get(parentModelArg);if(!parentModel||parentModel.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The parentModelArg passed to '+'Macro.world.contains is not valid.'));}else if(parentModel.type==='collection'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The parentModelArg passed to '+'Macro.world.contains represents a '+'collection. In can only be used on single '+'parent models.'));}var childModel=worldActions.get(childModelArg);if(!childModel||childModel.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The childModelArg passed to '+'Macro.world.contains is not valid.'));}if(children===true||children==='children'){if(childModel.type==='collection'){var _children2=childModel.children;var names=getOwnPropertyNames(_children2);for(var _ii4=0;_ii4<names.length;_ii4++){if(names[_ii4]in parentModel.children){return true;}}return false;}else{var type=_typeof(parentModel.children[childModel.name]);return type==='object';}}else{if(childModel.type==='collection'){var retVal=false;var _children3=childModel.children;var _names4=getOwnPropertyNames(_children3);for(var _ii5=0;_ii5<_names4.length;_ii5++){if(_names4[_ii5]in parentModel.descendants){return true;}}return false;}else{return childModel.name in parentModel.descendants;}}}},'world');Macro.add('isset',{handler:function handler(modelArg,propertyName){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.isSet';var model=worldActions.get(modelArg);if(typeof model==='undefined'||model.type==='error'){return{context:context,type:'error',message:'The modelArg argument passed to '+'Macro.world.isset is not valid.'};}return propertyName in model;}},'world');Macro.world.isSet=Macro.world.isset;Macro.world['is-set']=Macro.world.isset;Macro.add('exists',{handler:function handler(modelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var model=worldActions.get(modelArg);if(typeof model==='undefined'||model.type==='error'){return false;}else{return true;}}},'world');Macro.add('give',{handler:function handler(modelArg,receiverModelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}return worldActions.take.call(this,receiverModelArg,modelArg);}},'world');Macro.add('take',{handler:function handler(modelArg,childModelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.take';var owner=worldActions.get(modelArg);if(!owner||owner.type==='error'){return new ErrorModel(context,from(arguments),'The model referred to by the modelArg '+'argument '+modelArg+' does not exist.');}var child=worldActions.get(childModelArg);if(typeof child==='undefined'||child.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model referred to by the '+'childModelArg argument '+childModelArg+' does not exist.'));}else if('children'in owner&&child.name in owner.children&&(child.generic!==true||worldActions.get(owner.children[child.name]).generic!==true)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'There is already a model with the same '+'name in the provided owner, '+owner.name+', and one or both are not generic.'));}var forbidden=worldActions.isForbidden(owner,'take',child);if(forbidden){return worldActions.formatOutput(new ErrorModel(context,from(arguments),'A model of type '+owner.type+' cannot take a model of type '+child.type+'.'));}var parents=[];var oldParent=child.parent();while(oldParent&&oldParent.type!=='error'){var selectorIndex=parents.indexOf(oldParent.parentSelector);var parentIndex=parents.indexOf(oldParent.parent());if(selectorIndex!==-1||parentIndex!==-1){throw new Error('A parent of one of the '+'specified models has a corrupted '+'descendence tree and contains itself, '+'or its selector, as a parent.');}parents.push(oldParent.selector());parents.push(oldParent);if(child.generic){delete oldParent.children[child.id];}else{delete oldParent.children[child.name];delete oldParent.descendants[child.name];}oldParent=oldParent.parent();}child.parentSelector=owner.selector();parents=[];var newParent=owner;if(child.generic){if(!(child.name in newParent.children)){newParent.children[child.name]='#'+child.id;}if(child.name in newParent.children){var _child=newParent.children[child.name];worldActions.get(_child).quantity+=_child.quantity;worldActions.remove(_child);return worldActions.formatOutput(this,owner);}}else{newParent.children[child.name]='#'+child.name;}return worldActions.formatOutput(this,owner);}},'world');Macro.add('isgeneric',{handler:function handler(modelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.isgeneric';var model=worldActions.get(modelArg);if(!model||model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model referred to by the modelArg '+'argument '+modelArg+' does not exist.'));}if(model.generic===true){return true;}else{return false;}}},'world');Macro.world.isGeneric=Macro.world.isgeneric;Macro.world['is-generic']=Macro.world.isgeneric;Macro.add('makegeneric',{handler:function handler(modelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.makegeneric';var model=worldActions.get(modelArg);if(!model||model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model referred to by the modelArg '+'argument '+modelArg+' does not exist.'));}model.generic=true;var curWMState=State.currentWorldModelState;// this model can no longer be searched by name
delete curWMState.all[model.name];delete curWMState[model.type][model.name];curWMState.all[model.id]=model;curWMState[model.type][model.id]='#'+model.id;var newParent=model.parent();if((typeof newParent==='undefined'?'undefined':_typeof(newParent))==='object'&&newParent!==null&&'children'in newParent){newParent.children[model.name]='#'+model.id;}var parents=[];while((typeof newParent==='undefined'?'undefined':_typeof(newParent))==='object'&&newParent!==null&&newParent.type!=='error'){var selectorIndex=parents.indexOf(oldParent.parentSelector);var parentIndex=parents.indexOf(oldParent.parent());if(selectorIndex!==-1||parentIndex!==-1){throw new Error('A parent of one of the '+'specified models has a corrupted '+'descendence tree and contains itself, '+'or its selector, as a parent.');}parents.push(newParent.selector());parents.push(newParent);delete newParent.descendants[model.name];newParent=newParent.parent();}return worldActions.formatOutput(this,model);}},'world');Macro.world.makegeneric=Macro.world.makegeneric;Macro.world['make-generic']=Macro.world.makegeneric;Macro.add('print',{handler:function handler(modelArg,string,newLine){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.print';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.print is not valid.'));}else if(typeof string!=='string'||string===''){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The string argument passed to '+'Macro.world.print is not valid.'));}var model=worldActions.get(modelArg);if(model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.print does not '+'correspond to an existing model.'));}var elem=document.createElement('tw-match');elem.className='worldmodelPrintContainer';elem.innerHTML=string;var treeWalker=document.createTreeWalker(elem,NodeFilter.SHOW_TEXT,{acceptNode:function acceptNode(node){var parent=node.parentNode;if(parent&&parent.tagName!=='SCRIPT'&&parent.tagName!=='STYLE'){return NodeFilter.FILTER_ACCEPT;}else{return NodeFilter.FILTER_REJECT;}}},false);var nodeList=[];while(treeWalker.nextNode()){nodeList.push(treeWalker.currentNode);}nodeList.forEach(function(node){var regex=/%(.+?)%/;var match=void 0;var string=node.textContent;while((match=regex.exec(string))!==null){var inner=match[1].trim();if(inner[0]===':'){inner=inner.slice(1,inner.length);}else if(inner[0]==='|'&&inner[inner.length-1]==='|'){try{inner=eval(inner);}catch(e){wideAlert('The Javascript raw string within '+'the Macro.world.print template '+'string is not well-formed. Please '+'note the compiler error in the next '+'alert.');wideAlert(e.message);inner=e.message;}}string=string.replace(match[0],worldActions.get(model,inner));}regex=/\{\{\S?.+?\S?\}\}/;while((match=regex.exec(string))!==null){var _inner=match[0].trim().slice(2,-2);var link='<tw-link class="passage" passage-name="';if(_inner.indexOf('|')!==-1){var split=_inner.split('|');link+=split[split.length-1]+'">';link+=split.slice(0,-1).join('|')+'</tw-link>';}else if(_inner.indexOf('->')!==-1){var _split=_inner.split('->');link+=_split[_split.length-1]+'">';link+=_split.slice(0,-1).join('->')+'</tw-link>';}else if(_inner.indexOf('<-')!==-1){var _split2=_inner.split('<-');link+=_split2[0]+'">';link+=_split2.slice(1).join('<-')+'</tw-link>';}else{link+=_inner+'">'+_inner+'</tw-link>';}string=string.replace(match[0],link);}$(node).replaceWith('<tw-match>'+string+'</tw-match>');});if(newLine===true||typeof newLine==='string'&&newLine.toLowerCase()==='newline'){elem.appendChild(document.createElement('br'));}else if(typeof newLine==='number'&&newLine>0){for(var _ii6=0;_ii6<newLine;_ii6++){elem.appendChild(document.createElement('br'));}}Parser.parseNode(elem);return elem;}},'world');Macro.add('getalias',{handler:function handler(modelArg,propertyName){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.getAlias';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.getAlias is not valid.'));}var model=worldActions.get(modelArg);if(!model||model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model referred to by the modelArg '+'argument passed to '+'Macro.world.getalias '+modelArg+' does not exist.'));}if(!('aliases'in model)){model.aliases={};}if(!propertyName){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The propertyName argument passed to '+'Macro.world.getalias is not valid.'));}if(propertyName in model.aliases){return worldActions.formatOutput(this,model.aliases[propertyName]);}else{return worldActions.formatOutput(this,model[propertyName]);}}},'world');Macro.world.getAlias=Macro.world.getalias;Macro.world['get-alias']=Macro.world.getAlias;Macro.add('addalias',{handler:function handler(modelArg,propertyName,alias){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.addalias';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.addalias is not valid.'));}var model=worldActions.get(modelArg);if(!model||model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model referred to by the modelArg '+'argument '+modelArg+' does not exist.'));}if(!propertyName){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The propertyName argument passed to '+'Macro.world.addalias is not valid.'));}else if(!(propertyName in model)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model represented by the modelArg '+'argument provided to '+'Macro.world.addalias does not have a '+'property matching the propertyName '+'argument. Cannot add alias.'));}if(!('aliases'in model)){model.aliases={};}if(typeof alias!=='string'||alias===''){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The alias argument passed to '+'Macro.world.addAlias is not a valid, '+'non-empty string. Cannot add alias.'));}model.aliases[propertyName]=alias;return worldActions.formatOutput(this,model);}},'world');Macro.world.addAlias=Macro.world.addalias;Macro.world['add-alias']=Macro.world.addalias;Macro.add('removealias',{handler:function handler(modelArg,propertyName){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.removealias';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.removealias is not '+'valid.'));}var model=worldActions.get(modelArg);if(!model||model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model referred to by the modelArg '+'argument '+modelArg+' does not exist.'));}if(!propertyName){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The propertyName argument passed to '+'Macro.world.removealias is not '+'valid.'));}else if(!(propertyName in model)){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The model represented by the modelArg '+'argument provided to '+'Macro.world.removealias does not '+'have a property matching the propertyName '+'argument. Cannot add alias.'));}if(!('aliases'in model)){model.aliases={};}delete model.aliases[propertyName];return worldActions.formatOutput(this,model);}},'world');Macro.world.removeAlias=Macro.world.removealias;Macro.world['remove-alias']=Macro.world.removealias;Macro.add('associated',{handler:function handler(modelArg,association,associatedModelArg){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var context='Macro.world.is';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.is is not valid.'));}else if(!association){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The association argument passed to '+'Macro.world.is is not valid.'));}var model=worldActions.get(modelArg);if(model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.is does not correspond '+'to an existing model.'));}if(associatedModelArg){if(!(association in model.associations)){return false;}var associatedModel=worldActions.get(associatedModelArg);if(associatedModel.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The associatedModelArg argument '+'passed to Macro.world.is does '+'not correspond to an existing model.'));}if(model.associations[association].indexOf(associatedModel.selector())===-1){return false;}return true;}else{var associateds=model.associations[association];var collection={type:'collection',children:{}};if(!associateds){return worldActions.formatOutput(this,collection);}for(var _ii7=0;_ii7<associateds.length;_ii7++){collection.children[associateds[_ii7]]=worldActions.get(associateds[_ii7]);}return worldActions.formatOutput(this,collection);}}},'world');Macro.add('associate',{handler:function handler(modelArg,association,associatedModelArg,converse){var context='Macro.world.associate';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.associate is not valid.'));}else if(!association){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The association argument passed to '+'Macro.world.associate is not valid.'));}else if(!associatedModelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The associatedModelArg argument passed to '+'Macro.world.associate is not valid.'));}var model=worldActions.get(modelArg);if(model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.associate does not '+'correspond to an existing model.'));}var associatedModel=worldActions.get(associatedModelArg);if(associatedModel.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The associatedModel argument passed to '+'Macro.world.associate does not '+'correspond to an existing model.'));}if(!(association in model.associations)){model.associations[association]=[];}var assoc=model.associations[association];if(assoc.indexOf(associatedModel.selector())===-1){model.associations[association].push(associatedModel.selector());}if(converse===true||converse==='converse'){var _converse=worldActions.getConverse(association);if(_converse.type==='error'){return worldActions.formatOutput(this,_converse);}if(!associatedModel.associations[_converse]){associatedModel.associations[_converse]=[];}var temp=associatedModel.associations[_converse];if(temp&&temp.indexOf(model.selector())===-1){associatedModel.associations[_converse].push(model.selector());}}return worldActions.formatOutput(this,model);}},'world');Macro.add('disassociate',{handler:function handler(modelArg,association,associatedModelArg,converse){var context='Macro.world.disassociate';if(!modelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.disassociate is not '+'valid.'));}else if(!association){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The association argument passed to '+'Macro.world.disassociate is not '+'valid.'));}else if(!associatedModelArg){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The associatedModelArg argument passed '+'to Macro.world.disassociate is not '+'valid.'));}var model=worldActions.get(modelArg);if(model.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The modelArg argument passed to '+'Macro.world.disassociate does not '+'correspond to an existing model.'));}var associatedModel=worldActions.get(associatedModelArg);if(associatedModel.type==='error'){return worldActions.formatOutput(this,new ErrorModel(context,from(arguments),'The associatedModel argument passed to '+'Macro.world.disassociate does not '+'correspond to an existing model.'));}if(!(association in model.associations)){return worldActions.formatOutput(this,model);}var associations=model.associations[association];if(associations.indexOf(associatedModel)===-1){return worldActions.formatOutput(this,model);}var toConcat=associations.slice(associations.indexOf(associatedModel+1));associations=associations.slice(0,associations.indexOf(associatedModel)).concat(toConcat);if(converse){if(!associatedModel.associations[association]){return worldActions.formatOutput(this,model);}var _converse2=worldActions.getConverse(association);if(_converse2.type==='error'){return _converse2;}var _associations=associatedModel.associations[_converse2];if(_associations.indexOf(model)===-1){return worldActions.formatOutput(this,model);}var _toConcat=_associations.slice(_associations.indexOf(model+1));_associations=_associations.slice(0,_associations.indexOf(model)).concat(_toConcat);}return worldActions.formatOutput(this,model);}},'world');var converses={north:'south',east:'west',south:'north',west:'east',above:'below',below:'above',left:'right',right:'left',forward:'back',back:'forward',over:'under',under:'over'};Macro.add('getconverse',{handler:function handler(normal){if(!converses[normal]){return worldActions.formatOutput(this,new ErrorModel('Macro.world.getconverse',from(arguments),'There is no converse relation for that '+'word.'));}return converses[normal];}},'world');Macro.world.getConverse=Macro.world.getconverse;Macro.world['get-converse']=Macro.world.getconverse;Macro.add('addconverse',{handler:function handler(normal,converse){if(normal in converses){return worldActions.formatOutput(this,new ErrorModel('Macro.world.addconverse',from(arguments),'There is already a converse relation for '+'that word. Remove the old one first.'));}converses[normal]=converse;return true;}},'world');Macro.world.addConverse=Macro.world.addconverse;Macro.world['add-converse']=Macro.world.addconverse;Macro.add('removeconverse',{handler:function handler(name){delete converses[name];return true;}},'world');Macro.world.removeConverse=Macro.world.removeconverse;Macro.world['remove-converse']=Macro.world.removeConverse;Macro.add('forbid',{handler:function handler(actorType,acteeType,action){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}if(!actorType){wideAlert('The actorType argument passed to '+'Macro.world.forbid is not valid.');return false;}else if(actorType==='*'){wideAlert('The only object that can have all actions '+'set to * is the builtin ErrorModel.');return false;}else if(!acteeType){wideAlert('The acteeType argument passed to '+'Macro.world.forbid is not valid.');return false;}else{var curWMState=State.currentWorldModelState;var value=curWMState.forbidden[actorType];if(!value){wideAlert('The actorType, '+actorType+', does not exist in '+'Macro.State.currentWorldModelState'+'.forbidden.');return false;}value=value[acteeType];if(!value){wideAlert('The acteeType, '+acteeType+', does not exist in '+'Macro.State.currentWorldModelState'+'.forbidden.'+actorType+'.');return false;}if(value.indexOf(action)===-1){value.push(action);}}return true;}},'world');Macro.add('unforbid',{handler:function handler(actorType,acteeType,action){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}if(!actorType){wideAlert('The actorType argument passed to '+'Macro.world.unforbid is not valid.');return false;}else if(!acteeType){wideAlert('The acteeType argument passed to '+'Macro.world.unforbid is not valid.');return false;}else if(!action){wideAlert('The action argument passed to '+'Macro.world.unforbid is not valid.');return false;}else{var curWMState=State.currentWorldModelState;var value=curWMState.forbidden[actorType];if(!value){wideAlert('The actorType, '+acteeType+', does not exist in Macro.State'+'.currentWorldModelState.forbidden.');return false;}value=value[acteeType];if(!value){wideAlert('The action, '+action+', does not exist in '+'Macro.State.currentWorldModelState'+'.forbidden.'+actorType+'.');return false;}else if(!value.filter){wideAlert('The specified collection in '+'Macro.State.currentWorldModelState'+'.forbidden.'+actorType+'.'+acteeType+' lacks a filter function property, '+'and is therefore invalid.');return false;}value=value.filter(function(act){return act!==action;});}return true;}},'world');Macro.add('isforbidden',{handler:function handler(actorType,action,acteeType){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}if(actorType&&actorType.type){actorType=actorType.type;}if(acteeType&&acteeType.type){acteeType=acteeType.type;}if(!actorType){wideAlert('The actorType argument passed to '+'Macro.world.isForbidden is not valid.');return false;}else if(!action){wideAlert('The action argument passed to '+'Macro.world.isForbidden is not valid.');return false;}else if(!acteeType){wideAlert('The acteeType argument passed to '+'Macro.world.isForbidden is not valid.');return false;}else{var curWMState=State.currentWorldModelState;var value=curWMState.forbidden[actorType];if(!value){//gatelyLog('The actorType, ' + actorType +
//', does not exist in Macro.State' +
//'.currentWorldModelState.forbidden.');
return false;}else if(value==='*'){return true;}value=value[action];if(!value){//gatelyLog('The acteeType, ' + acteeType +
//', does not exist in Macro.State' +
//'.currentWorldModelState.forbidden.' +
//actorType + '.');
return false;}else if(value==='*'){return true;}return from(value).indexOf(acteeType)!==-1;}}},'world');Macro.world.isForbidden=Macro.world.isforbidden;Macro.world['is-forbidden']=Macro.world.isforbidden;Macro.add('populatefrompassages',{handler:function handler(tag){var selector='tw-passagedata[tags~="world'+tag+'"], tw-passagedata[tags~="world-'+tag+'"]';var nodes=document.querySelectorAll(selector);for(var ii=0;ii<nodes.length;ii++){var name=nodes[ii].getAttribute('name');var replaced=name.replace(/s/g,'');// remove all whitespace, given that whitespace
// indicates descendance. temp solution, not ideal
worldActions.add(replaced,tag);}}},'world');Macro.world.populateFromPassages=Macro.world.populatefrompassages;Macro.world['populate-from-passages']=Macro.world.populatefrompassages;/* Macro.add('definehandler',
        {
            handler(name, codeStr, isDoubleTag) {
                name = name.trim();
                if (typeof(name) !== 'string' || name === '') {
                    wideAlert('The name argument passed to ' +
                        'Macro.world.defineHandler is not valid.');
                    return false;
                } else if (typeof(codeStr) !== 'string' || name === '') {
                    wideAlert('The codeStr argument passed to ' +
                        'Macro.world.defineHandler is empty or ' +
                        'not a valid string.');
                    return false;
                }
                try {
                    worldModel[name] = {
                        isDoubleTag: isDoubleTag,
                        handler: new Function(codeStr),
                    };
                } catch (e) {
                    wideAlert(e.message);
                    return false;
                }
                return true;
            }
        },
        'world'
    );
    Macro.world.defineHandler = Macro.world.definehandler;
    Macro.world['define-handler'] = Macro.world.definehandler; */Macro.add('validatemodel',{handler:function handler(model){if(!model||(typeof model==='undefined'?'undefined':_typeof(model))!=='object'){return false;}var jsType=(typeof model==='undefined'?'undefined':_typeof(model))==='object'&&model!==null;var modelType='type'in model&&typeof model.type==='string'&&model.type!==''&&model.type!=='error';var modelName='name'in model&&typeof model.name==='string'&&model.name!=='';if(model.name==='noone'){wideAlert('The noone model cannot be modified or validated '+'in any fashion, and attempting to validate it '+'will always return false.');return false;}var modelChildren='children'in model&&_typeof(model.children)==='object'&&model.children!==null;var modelDescendants='descendants'in model&&_typeof(model.descendants)==='object'&&model.descendants!==null;var isCollection='type'in model&&model.type==='collection'&&'children'in model&&_typeof(model.children)==='object'&&model.children!==null;if(jsType&&modelType&&modelName&&modelChildren&&modelDescendants||isCollection){return true;}else{return false;}}},'world');Macro.world.validateModel=Macro.world.validatemodel;Macro.world['validate-model']=Macro.world.validatemodel;Macro.add('validatesetvalue',{handler:function handler(modelArg){return reserved.indexOf(modelArg)===-1;}},'world');Macro.world.validateSetValue=Macro.world.validatesetvalue;Macro.world['validate-set-value']=Macro.world.validatesetvalue;Macro.add('formatoutput',{handler:function handler(caller,output){if(caller&&caller.twine&&typeof output!=='string'&&!isNode(output)&&!isElement(output)){return JSON.stringify(output);}else{return output;}}},'world');Macro.world.formatOutput=Macro.world.formatoutput;Macro.world['format-output']=Macro.world.formatoutput;Macro.add('addmodelconstructor',{handler:function handler(type,constructor,forbidden){if(!type){wideAlert('The type argument provided to '+'Macro.world.addmodelconstructor');}else if(type in modelConstructors){wideAlert('There is already a constructor for models of '+'type '+type+'.');return false;}else if(!isFunction(constructor)){wideAlert('The constructor argument,'+constructor.toString()+', provided to Macro.world.addmodelconstructor'+' is not a valid constructor function.');return false;}if(forbidden&&forbidden.length){for(var ii=0;ii<forbidden.length;ii++){// FILL IN HERE
}}modelConstructors[type]=constructor;return true;}},'world');Macro.world.addModelConstructor=Macro.world.addmodelconstructor;Macro.world['add-model-constructor']=Macro.world.addmodelconstructor;Macro.add('restoremodelprotofuncs',{handler:function handler(){var protoFuncs=getOwnPropertyNames(modelProtoFuncs);var models=getOwnPropertyNames(State.currentWorldModelState.all).map(function(nameOrID){return State.currentWorldModelState.all[nameOrID];});models.forEach(function(model){if(!('parent'in model)){model.parent=_worldModelTempStore.noone.parent;}if(!('selector'in model)){model.selector=_worldModelTempStore.noone.selector;}protoFuncs.forEach(function(func){var protoFunc=modelProtoFuncs[func];model[func]=protoFunc;});});}},'world');Macro.world.restoreModelProtoFuncs=Macro.world.restoremodelprotofuncs;Macro.world['restore-model-proto-funcs']=Macro.world.restoremodelprotofuncs;// a list of all worldmodel functions
var worldActions={};getOwnPropertyNames(Macro.world).map(function(name){if(name==='handler'){return;}if(typeof Macro.world[name]==='function'){worldActions[name]=Macro.world[name];}else if(typeof Macro.world[name].handler==='function'){worldActions[name]=Macro.world[name].handler;}});window._worldModelTempStore={all:{},error:{},// forbidden [actorType] [action] [acteeType]
forbidden:{location:{take:['location','error'],contains:['location','error'],give:'*',add:'*',remove:'*',forbid:'*',unforbid:'*',each:'*'},entity:{take:['location','entity','error'],contains:['location','entity','error'],give:['entity','error'],add:'*',remove:'*',forbid:'*',unforbid:'*',each:'*'},object:{take:['location','entity','error'],contains:['location','entity','error'],give:['error'],add:'*',remove:'*',forbid:'*',unforbid:'*',each:'*'},collection:{set:['error'],unset:['error'],give:'*',take:'*',add:'*',remove:'*',forbid:'*',unforbid:'*'},error:{give:'*',take:'*',contains:'*',add:'*',remove:'*',forbid:'*',unforbid:'*',set:'*',unset:'*',each:'*'}},_nextUnusedID:0,getNextUnusedId:function getNextUnusedId(){return this._nextUnusedID++;}};window.Model=function Model(name,type){_classCallCheck(this,Model);this.name=name;this.type=type;this.parentSelector=null;this.children={};this.descendants={};this.associations={};this.aliases={};this._internalSelector='#'+name;this.generic=false;this.quantity=1;this.id=_worldModelTempStore.getNextUnusedId();};var modelProtoFuncs={selector:function selector(newSelector){if(newSelector){this._internalSelector=newSelector;return;}if(!this._internalSelector){throw new Error('The model, '+this+', has no _internalSelector property. '+'Cannot get selector.');}if(this.generic){return this.parentSelector+' #'+this.id;}else{return this._internalSelector;}},parent:function parent(){if(this.parentSelector===null){return null;}var parent=worldActions.get(this.parentSelector);if(parent.type==='error'){return null;}return parent;},add:function add(name,type){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var thisObj=void 0;var callObj={};if(this instanceof String){thisObj=saferJSONParse(this.toString());if((typeof thisObj==='undefined'?'undefined':_typeof(thisObj))!=='object'||thisObj===null||!worldActions.validateModel(thisObj)){return;}callObj={twine:'twine'};}else{thisObj=this;}return worldActions.add.call(callObj,name,type,thisObj);},addAlias:function addAlias(propertyName,alias){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var thisObj=void 0;var callObj={};if(this instanceof String){thisObj=saferJSONParse(this.toString());if((typeof thisObj==='undefined'?'undefined':_typeof(thisObj))!=='object'||thisObj===null||!worldActions.validateModel(thisObj)){return;}callObj={twine:'twine'};}else{thisObj=this;}return worldActions.addAlias.call(callObj,thisObj,propertyName,alias);},getAlias:function getAlias(propertyName){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var thisObj=void 0;var callObj={};if(this instanceof String){thisObj=saferJSONParse(this.toString());if((typeof thisObj==='undefined'?'undefined':_typeof(thisObj))!=='object'||thisObj===null||!worldActions.validateModel(thisObj)){return;}callObj={twine:'twine'};}else{thisObj=this;}return worldActions.getAlias.call(callObj,thisObj,propertyName);},associate:function associate(association,associatedModelArg,converse){for(var ii=0;ii<arguments.length;ii++){if(arguments[ii]&&arguments[ii].type==='error'){return arguments[ii];}}var thisObj=void 0;var callObj={};if(this instanceof String){thisObj=saferJSONParse(this.toString());if((typeof thisObj==='undefined'?'undefined':_typeof(thisObj))!=='object'||thisObj===null||!worldActions.validateModel(thisObj)){return;}callObj={twine:'twine'};}else{thisObj=this;}return worldActions.associate.call(callObj,thisObj,association,associatedModelArg,converse);}};var protoFuncs=getOwnPropertyNames(modelProtoFuncs);protoFuncs.forEach(function(func){var protoFunc=modelProtoFuncs[func];// don't overwrite pre-existing properties
if(!(func in String.prototype)){String.prototype[func]=protoFunc;}Model.prototype[func]=protoFunc;});var LocationModel=function(_Model){_inherits(LocationModel,_Model);function LocationModel(name){_classCallCheck(this,LocationModel);return _possibleConstructorReturn(this,Object.getPrototypeOf(LocationModel).call(this,name,'location'));}return LocationModel;}(Model);;window.LocationModel=LocationModel;var EntityModel=function(_Model2){_inherits(EntityModel,_Model2);function EntityModel(name){_classCallCheck(this,EntityModel);return _possibleConstructorReturn(this,Object.getPrototypeOf(EntityModel).call(this,name,'entity'));}return EntityModel;}(Model);;window.EntityModel=EntityModel;var PlayerModel=function(_EntityModel){_inherits(PlayerModel,_EntityModel);function PlayerModel(name){_classCallCheck(this,PlayerModel);var _this4=_possibleConstructorReturn(this,Object.getPrototypeOf(PlayerModel).call(this,name,'player'));_this4.current={};return _this4;}return PlayerModel;}(EntityModel);;window.PlayerModel=PlayerModel;var ObjectModel=function(_Model3){_inherits(ObjectModel,_Model3);function ObjectModel(name){_classCallCheck(this,ObjectModel);return _possibleConstructorReturn(this,Object.getPrototypeOf(ObjectModel).call(this,name,'object'));}return ObjectModel;}(Model);;window.ObjectModel=ObjectModel;var errorID=0;window.ErrorModel=function(_Model4){_inherits(ErrorModel,_Model4);function ErrorModel(pointOfFailure,args,errorMessage){_classCallCheck(this,ErrorModel);var _this6=_possibleConstructorReturn(this,Object.getPrototypeOf(ErrorModel).call(this,'error'+errorID,'error'));errorID++;_this6.pointOfFailure=pointOfFailure;_this6.arguments=args;_this6.errorMessage=errorMessage;State.currentWorldModelState.error[_this6.name]=_this6;_this6.time=new Date();delete _this6.children;delete _this6.descendants;delete _this6.associations;delete _this6.aliases;delete _this6.generic;delete _this6.quantity;return _this6;}return ErrorModel;}(Model);var modelConstructors={location:LocationModel,entity:EntityModel,object:ObjectModel,error:ErrorModel,model:Model};var noone=new EntityModel('noone');_worldModelTempStore.all.noone=noone;_worldModelTempStore.noone=noone;var player=new PlayerModel('player');_worldModelTempStore.all.player=player;_worldModelTempStore.entity={};_worldModelTempStore.entity.player='#player';var reserved=['noone','error',noone];})();

},{}]},{},[2])
</script>
</body>
</html>