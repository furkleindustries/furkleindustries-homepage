(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{105:function(t,e,n){"use strict";function i(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],i=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done)&&(n.push(o.value),!e||n.length!==e);i=!0);}catch(s){r=!0,a=s}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}n.r(e);var r=n(43),a=n(39),o=n(40),u=n(41);function s(t,e,n){return(s=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(c){return!1}}()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&Object(u.a)(r,n.prototype),r}).apply(null,arguments)}function l(t){var e="function"===typeof Map?new Map:void 0;return(l=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!==typeof t)throw new TypeError("Super expression must either be null or a function");if("undefined"!==typeof e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return s(t,arguments,Object(a.a)(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),Object(u.a)(i,t)})(t)}var h,c,f=n(42);function v(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function d(t,e,n){return e&&v(t.prototype,e),n&&v(t,n),t}h=void 0,c=function(t){var e,n,u,s=function(){function t(){if(Object(f.a)(this,t),this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){var e=arguments[0];this.componentsString=e}else if(arguments[0]instanceof t.Component&&arguments[1]instanceof t){var n=arguments[0],i=arguments[1];this._components.push(n),this._components=this._components.concat(i._components)}else if(Array.isArray(arguments[0])){var r=arguments[0],a=!!arguments[1];this._components=this._components.concat(r),this._isRelative=a}}return d(t,[{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,r=0;r<e._components.length&&e._components[r].isParent;++r)i++;for(var a=0;a<this._components.length-i;++a)n._components.push(this._components[a]);for(var o=i;o<e._components.length;++o)n._components.push(e._components[o]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(e){var n=new t;return n._components.push.apply(n._components,this._components),n._components.push(e),n}},{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return this._components.length>0?this._components[0]:null}},{key:"tail",get:function(){return this._components.length>=2?new t(this._components.slice(1,this._components.length)):t.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return t>=0?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(e){if(this._components.length=0,this._componentsString=e,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));var n=this._componentsString.split("."),i=!0,r=!1,a=void 0;try{for(var o,u=n[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;/^(\-|\+)?([0-9]+|Infinity)$/.test(s)?this._components.push(new t.Component(parseInt(s))):this._components.push(new t.Component(s))}}catch(l){r=!0,a=l}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}}}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}();function h(t,e){return t instanceof e?m(t,e):null}function c(t,e){if(t instanceof e)return m(t,e);throw new Error("".concat(t," is not of type ").concat(e))}function v(t){if("number"==typeof t)return t;throw new Error("".concat(t," is not a number"))}function y(t){return t.hasValidName&&t.name?t:null}function p(t){return void 0===t?null:t}function m(t,e){return t}s.parentId="^",function(t){var e=function(){function e(t){Object(f.a)(this,e),this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}return d(e,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}},{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==t.parentId}}],[{key:"ToParent",value:function(){return new e(t.parentId)}}]),e}();t.Component=e}(s||(s={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),""}t.AssertType=function(t,n,i){e(t instanceof n,i)},t.Assert=e}(e||(e={}));var g=function(t){function e(){return Object(f.a)(this,e),Object(r.a)(this,Object(a.a)(e).apply(this,arguments))}return Object(o.a)(e,t),e}(l(Error));function S(t){throw new g("".concat(t," is null or undefined"))}var b=function(){function t(){Object(f.a)(this,t),this.parent=null,this._debugMetadata=null,this._path=null}return d(t,[{key:"DebugLineNumberOfPath",value:function(t){if(null===t)return null;var e=this.rootContentContainer;if(e){var n=e.ContentAtPath(t).obj;if(n){var i=n.debugMetadata;if(null!==i)return i.startLineNumber}}return null}},{key:"ResolvePath",value:function(t){if(null===t)return S("path");if(t.isRelative){var n=h(this,V);return null===n&&(e.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),n=h(this.parent,V),e.Assert(null!==n,"Expected parent to be a container"),e.Assert(t.GetComponent(0).isParent),t=t.tail),null===n?S("nearestContainer"):n.ContentAtPath(t)}var i=this.rootContentContainer;return null===i?S("contentContainer"):i.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.length,e.length),i=-1,r=0;r<n;++r){var a=e.GetComponent(r),o=t.GetComponent(r);if(!a.Equals(o))break;i=r}if(-1==i)return t;for(var u=e.componentCount-1-i,l=[],h=0;h<u;++h)l.push(s.Component.ToParent());for(var c=i+1;c<t.componentCount;++c)l.push(t.GetComponent(c));return new s(l,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}},{key:"Copy",value:function(){throw Error("Not Implemented: Doesn't support copying")}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(t){this._debugMetadata=t}},{key:"ownDebugMetadata",get:function(){return this._debugMetadata}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new s;else{for(var t=[],e=this,n=h(e.parent,V);null!==n;){var i=y(e);null!=i&&i.hasValidName?t.unshift(new s.Component(i.name)):t.unshift(new s.Component(n.content.indexOf(e))),e=n,n=h(n.parent,V)}this._path=new s(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return h(t,V)}}]),t}(),C=function(){function t(e){Object(f.a)(this,t),e=void 0!==e?e.toString():"",this.string=e}return d(t,[{key:"Append",value:function(t){null!==t&&(this.string+=t)}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this.string+="\n"}},{key:"AppendFormat",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,function(t,e){return void 0!==n[e]?n[e]:t})}},{key:"toString",value:function(){return this.string}},{key:"Length",get:function(){return this.string.length}}]),t}(),k=function(){function t(){if(Object(f.a)(this,t),this.originName=null,this.itemName=null,void 0!==arguments[1]){var e=arguments[0],n=arguments[1];this.originName=e,this.itemName=n}else if(arguments[0]){var i=arguments[0].toString().split(".");this.originName=i[0],this.itemName=i[1]}}return d(t,[{key:"toString",value:function(){return this.fullName}},{key:"Equals",value:function(e){if(e instanceof t){var n=e;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"copy",value:function(){return new t(this.originName,this.itemName)}},{key:"serialized",value:function(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}},{key:"isNull",get:function(){return null==this.originName&&null==this.itemName}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"fromSerializedKey",value:function(e){var n=JSON.parse(e);if(!t.isLikeInkListItem(n))return t.Null;var i=n;return new t(i.originName,i.itemName)}},{key:"isLikeInkListItem",value:function(t){return"object"==typeof t&&!(!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName"))&&("string"==typeof t.originName||null===typeof t.originName)&&("string"==typeof t.itemName||null===typeof t.itemName)}},{key:"Null",get:function(){return new t(null,null)}}]),t}(),T=function(t){function e(){var t,n=arguments;if(Object(f.a)(this,e),(t=Object(r.a)(this,Object(a.a)(e).call(this,n[0]instanceof e?n[0]:void 0))).origins=null,t._originNames=[],arguments[0]instanceof e){var i=arguments[0];i._originNames&&(t._originNames=i._originNames.slice())}else if("string"==typeof arguments[0]){var o=arguments[0],u=arguments[1];t.SetInitialOriginName(o);var s=u.listDefinitions.TryListGetDefinition(o,null);if(!s.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+o);t.origins=[s.result]}else if("object"==typeof arguments[0]&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){var l=arguments[0];t.Add(l.Key,l.Value)}return Object(r.a)(t)}return Object(o.a)(e,t),d(e,[{key:"AddItem",value:function(t){if(t instanceof k){var e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return S("this.origins");var n=!0,i=!1,r=void 0;try{for(var a,o=this.origins[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;if(u.name==e.originName){var s=u.TryGetValueForItem(e,0);if(s.exists)return void this.Add(e,s.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}}}catch(b){i=!0,r=b}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}var l=t,h=null;if(null===this.origins)return S("this.origins");var c=!0,f=!1,v=void 0;try{for(var d,y=this.origins[Symbol.iterator]();!(c=(d=y.next()).done);c=!0){var p=d.value;if(null===l)return S("itemName");if(p.ContainsItemWithName(l)){if(null!=h)throw new Error("Could not add the item "+l+" to this list because it could come from either "+p.name+" or "+h.name);h=p}}}catch(b){f=!0,v=b}finally{try{c||null==y.return||y.return()}finally{if(f)throw v}}if(null==h)throw new Error("Could not add the item "+l+" to this list because it isn't known to any list definitions previously associated with this list.");var m=new k(h.name,l),g=h.ValueForItem(m);this.Add(m,g)}},{key:"ContainsItemNamed",value:function(t){var e=!0,n=!1,r=void 0;try{for(var a,o=this[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=i(a.value,2),s=u[0];u[1];if(k.fromSerializedKey(s).itemName==t)return!0}}catch(l){n=!0,r=l}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}return!1}},{key:"ContainsKey",value:function(t){return this.has(t.serialized())}},{key:"Add",value:function(t,e){var n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(t));this.set(n,e)}},{key:"Remove",value:function(t){return this.delete(t.serialized())}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"Union",value:function(t){var n=new e(this),r=!0,a=!1,o=void 0;try{for(var u,s=t[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=i(u.value,2),h=l[0],c=l[1];n.set(h,c)}}catch(f){a=!0,o=f}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}},{key:"Intersect",value:function(t){var n=new e,r=!0,a=!1,o=void 0;try{for(var u,s=this[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=i(u.value,2),h=l[0],c=l[1];t.has(h)&&n.set(h,c)}}catch(f){a=!0,o=f}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}},{key:"Without",value:function(t){var n=new e(this),r=!0,a=!1,o=void 0;try{for(var u,s=t[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=i(u.value,2),h=l[0];l[1];n.delete(h)}}catch(c){a=!0,o=c}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}},{key:"Contains",value:function(t){var e=!0,n=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=i(a.value,2),s=u[0];u[1];if(!this.has(s))return!1}}catch(l){n=!0,r=l}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}return!0}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new e(this.maxItem):new e}},{key:"MinAsList",value:function(){return this.Count>0?new e(this.minItem):new e}},{key:"ListWithSubRange",value:function(t,n){if(0==this.Count)return new e;var i=this.orderedItems,r=0,a=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?r=t:t instanceof e&&t.Count>0&&(r=t.minItem.Value),Number.isInteger(n)?a=n:t instanceof e&&t.Count>0&&(a=n.maxItem.Value);var o=new e;o.SetInitialOriginNames(this.originNames);var u=!0,s=!1,l=void 0;try{for(var h,c=i[Symbol.iterator]();!(u=(h=c.next()).done);u=!0){var f=h.value;f.Value>=r&&f.Value<=a&&o.Add(f.Key,f.Value)}}catch(v){s=!0,l=v}finally{try{u||null==c.return||c.return()}finally{if(s)throw l}}return o}},{key:"Equals",value:function(t){if(t instanceof e==0)return!1;if(t.Count!=this.Count)return!1;var n=!0,r=!1,a=void 0;try{for(var o,u=this[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=i(o.value,2),l=s[0];s[1];if(!t.has(l))return!1}}catch(h){r=!0,a=h}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}return!0}},{key:"toString",value:function(){for(var t=this.orderedItems,e=new C,n=0;n<t.length;n++){n>0&&e.Append(", ");var i=t[n].Key;if(null===i.itemName)return S("item.itemName");e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return this.size}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every(function(n){return n.name!=t||(e=n,!1)}),e}},{key:"originNames",get:function(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);var t=!0,e=!1,n=void 0;try{for(var r,a=this[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=i(r.value,2),u=o[0],s=(o[1],k.fromSerializedKey(u));if(null===s.originName)return S("item.originName");this._originNames.push(s.originName)}}catch(l){e=!0,n=l}finally{try{t||null==a.return||a.return()}finally{if(e)throw n}}}return this._originNames}},{key:"maxItem",get:function(){var t={Key:k.Null,Value:0},e=!0,n=!1,r=void 0;try{for(var a,o=this[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=i(a.value,2),s=u[0],l=u[1],h=k.fromSerializedKey(s);(t.Key.isNull||l>t.Value)&&(t={Key:h,Value:l})}}catch(c){n=!0,r=c}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}return t}},{key:"minItem",get:function(){var t={Key:k.Null,Value:0},e=!0,n=!1,r=void 0;try{for(var a,o=this[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=i(a.value,2),s=u[0],l=u[1],h=k.fromSerializedKey(s);(t.Key.isNull||l<t.Value)&&(t={Key:h,Value:l})}}catch(c){n=!0,r=c}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}return t}},{key:"inverse",get:function(){var t=new e;if(null!=this.origins){var n=!0,r=!1,a=void 0;try{for(var o,u=this.origins[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value,l=!0,h=!1,c=void 0;try{for(var f,v=s.items[Symbol.iterator]();!(l=(f=v.next()).done);l=!0){var d=i(f.value,2),y=d[0],p=d[1],m=k.fromSerializedKey(y);this.ContainsKey(m)||t.Add(m,p)}}catch(g){h=!0,c=g}finally{try{l||null==v.return||v.return()}finally{if(h)throw c}}}}catch(g){r=!0,a=g}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}}return t}},{key:"all",get:function(){var t=new e;if(null!=this.origins){var n=!0,r=!1,a=void 0;try{for(var o,u=this.origins[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value,l=!0,h=!1,c=void 0;try{for(var f,v=s.items[Symbol.iterator]();!(l=(f=v.next()).done);l=!0){var d=i(f.value,2),y=d[0],p=d[1],m=k.fromSerializedKey(y);t.set(m.serialized(),p)}}catch(g){h=!0,c=g}finally{try{l||null==v.return||v.return()}finally{if(h)throw c}}}}catch(g){r=!0,a=g}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}}return t}},{key:"orderedItems",get:function(){var t=new Array,e=!0,n=!1,r=void 0;try{for(var a,o=this[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=i(a.value,2),s=u[0],l=u[1],h=k.fromSerializedKey(s);t.push({Key:h,Value:l})}}catch(c){n=!0,r=c}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}return t.sort(function(t,e){return null===t.Key.originName?S("x.Key.originName"):null===e.Key.originName?S("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0}),t}}]),e}(l(Map)),w=function(t){function e(t){var n;return Object(f.a)(this,e),(n=Object(r.a)(this,Object(a.a)(e).call(this,t))).useEndLineNumber=!1,n.message=t,n.name="StoryException",n}return Object(o.a)(e,t),e}(l(Error));function O(t,e,n){if(null===t)return{result:n,exists:!1};var i=t.get(e);return i?{result:i,exists:!0}:{result:n,exists:!1}}var _=function(t){function e(t){var n;return Object(f.a)(this,e),(n=Object(r.a)(this,Object(a.a)(e).call(this))).value=t,n}return Object(o.a)(e,t),d(e,[{key:"toString",value:function(){return null===this.value?S("Value.value"):this.value.toString()}},{key:"valueObject",get:function(){return this.value}}]),e}(function(t){function e(){return Object(f.a)(this,e),Object(r.a)(this,Object(a.a)(e).apply(this,arguments))}return Object(o.a)(e,t),d(e,[{key:"Copy",value:function(){return c(e.Create(this),b)}},{key:"BadCastException",value:function(t){return new w("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}],[{key:"Create",value:function(t){return"boolean"==typeof t&&(t=t?1:0),Number.isInteger(Number(t))?new x(Number(t)):isNaN(t)?"string"==typeof t?new N(String(t)):t instanceof s?new P(c(t,s)):t instanceof T?new I(c(t,T)):null:new E(Number(t))}}]),e}(b)),x=function(t){function e(t){return Object(f.a)(this,e),Object(r.a)(this,Object(a.a)(e).call(this,t||0))}return Object(o.a)(e,t),d(e,[{key:"Cast",value:function(t){if(null===this.value)return S("Value.value");if(t==this.valueType)return this;if(t==n.Float)return new E(this.value);if(t==n.String)return new N(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return n.Int}}]),e}(_),E=function(t){function e(t){return Object(f.a)(this,e),Object(r.a)(this,Object(a.a)(e).call(this,t||0))}return Object(o.a)(e,t),d(e,[{key:"Cast",value:function(t){if(null===this.value)return S("Value.value");if(t==this.valueType)return this;if(t==n.Int)return new x(this.value);if(t==n.String)return new N(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return n.Float}}]),e}(_),N=function(t){function e(t){var n;return Object(f.a)(this,e),(n=Object(r.a)(this,Object(a.a)(e).call(this,t||"")))._isNewline="\n"==n.value,n._isInlineWhitespace=!0,null===n.value?Object(r.a)(n,S("Value.value")):(n.value.length>0&&n.value.split("").every(function(t){return" "==t||"\t"==t||(n._isInlineWhitespace=!1,!1)}),Object(r.a)(n))}return Object(o.a)(e,t),d(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==n.Int){var e=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseInt(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new x(e.result);throw this.BadCastException(t)}if(t==n.Float){var i=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseFloat(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(i.exists)return new E(i.result);throw this.BadCastException(t)}throw this.BadCastException(t)}},{key:"valueType",get:function(){return n.String}},{key:"isTruthy",get:function(){return null===this.value?S("Value.value"):this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),e}(_),P=function(t){function e(t){return Object(f.a)(this,e),Object(r.a)(this,Object(a.a)(e).call(this,t))}return Object(o.a)(e,t),d(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"valueType",get:function(){return n.DivertTarget}},{key:"targetPath",get:function(){return null===this.value?S("Value.value"):this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a divert target")}}]),e}(_),A=function(t){function e(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return Object(f.a)(this,e),(n=Object(r.a)(this,Object(a.a)(e).call(this,t)))._contextIndex=i,n}return Object(o.a)(e,t),d(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new e(this.variableName,this.contextIndex)}},{key:"contextIndex",get:function(){return this._contextIndex},set:function(t){this._contextIndex=t}},{key:"variableName",get:function(){return null===this.value?S("Value.value"):this.value},set:function(t){this.value=t}},{key:"valueType",get:function(){return n.VariablePointer}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}}]),e}(_),I=function(t){function e(t,n){var i;return Object(f.a)(this,e),i=Object(r.a)(this,Object(a.a)(e).call(this,null)),t||n?t instanceof T?i.value=new T(t):t instanceof k&&"number"==typeof n&&(i.value=new T({Key:t,Value:n})):i.value=new T,i}return Object(o.a)(e,t),d(e,[{key:"Cast",value:function(t){if(null===this.value)return S("Value.value");if(t==n.Int){var e=this.value.maxItem;return e.Key.isNull?new x(0):new x(e.Value)}if(t==n.Float){var i=this.value.maxItem;return i.Key.isNull?new E(0):new E(i.Value)}if(t==n.String){var r=this.value.maxItem;return r.Key.isNull?new N(""):new N(r.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return null===this.value?S("this.value"):this.value.Count>0}},{key:"valueType",get:function(){return n.List}}]),d(e,null,[{key:"RetainListOriginsForAssignment",value:function(t,n){var i=h(t,e),r=h(n,e);return r&&null===r.value?S("newList.value"):i&&null===i.value?S("oldList.value"):void(i&&r&&0==r.value.Count&&r.value.SetInitialOriginNames(i.value.originNames))}}]),e}(_);!function(t){t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"}(n||(n={}));var F=function(){function t(){Object(f.a)(this,t),this.obj=null,this.approximate=!1}return d(t,[{key:"copy",value:function(){var e=new t;return e.obj=this.obj,e.approximate=this.approximate,e}},{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof V?this.obj:null}}]),t}(),V=function(t){function n(){var t;return Object(f.a)(this,n),(t=Object(r.a)(this,Object(a.a)(n).apply(this,arguments))).name="",t._content=[],t.namedContent=new Map,t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t._pathToFirstLeafContent=null,t}return Object(o.a)(n,t),d(n,[{key:"AddContent",value:function(t){if(Array.isArray(t)){var e=t,n=!0,i=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;this.AddContent(u)}}catch(l){i=!0,r=l}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}else{var s=t;if(this._content.push(s),s.parent)throw new Error("content is already in "+s.parent);s.parent=this,this.TryAddNamedContent(s)}}},{key:"TryAddNamedContent",value:function(t){var e=y(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}},{key:"AddToNamedContentOnly",value:function(t){e.AssertType(t,b,"Can only add Runtime.Objects to a Runtime.Container"),c(t,b).parent=this,this.namedContent.set(t.name,t)}},{key:"ContentAtPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;-1==i&&(i=t.length);var r=new F;r.approximate=!1;for(var a=this,o=this,u=e;u<i;++u){var s=t.GetComponent(u);if(null==a){r.approximate=!0;break}var l=a.ContentWithPathComponent(s);if(null==l){r.approximate=!0;break}o=l,a=h(l,n)}return r.obj=o,r}},{key:"InsertContent",value:function(t,e){if(this.content[e]=t,t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){this.content=this.content.concat(t.content);var e=!0,n=!1,i=void 0;try{for(var r,a=t.content[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=r.value;o.parent=this,this.TryAddNamedContent(o)}}catch(u){n=!0,i=u}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;if(null===t.name)return S("component.name");var e=O(this.namedContent,t.name,null);return e.exists?c(e.result,b):null}},{key:"BuildStringOfHierarchy",value:function(){var t;if(0==arguments.length)return t=new C,this.BuildStringOfHierarchy(t,0,null),t.toString();t=arguments[0];var r=arguments[1],a=arguments[2];function o(){for(var e=0;e<4*r;++e)t.Append(" ")}o(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==a&&t.Append("  <---"),t.AppendLine(),r++;for(var u=0;u<this.content.length;++u){var s=this.content[u];s instanceof n?s.BuildStringOfHierarchy(t,r,a):(o(),s instanceof N?(t.Append('"'),t.Append(s.toString().replace("\n","\\n")),t.Append('"')):t.Append(s.toString())),u!=this.content.length-1&&t.Append(","),s instanceof n||s!=a||t.Append("  <---"),t.AppendLine()}var l=new Map,h=!0,f=!1,v=void 0;try{for(var d,y=this.namedContent[Symbol.iterator]();!(h=(d=y.next()).done);h=!0){var p=i(d.value,2),m=p[0],g=p[1];this.content.indexOf(c(g,b))>=0||l.set(m,g)}}catch(E){f=!0,v=E}finally{try{h||null==y.return||y.return()}finally{if(f)throw v}}if(l.size>0){o(),t.AppendLine("-- named: --");var S=!0,k=!1,T=void 0;try{for(var w,O=l[Symbol.iterator]();!(S=(w=O.next()).done);S=!0){var _=i(w.value,2),x=(_[0],_[1]);e.AssertType(x,n,"Can only print out named Containers"),x.BuildStringOfHierarchy(t,r,a),t.AppendLine()}}catch(E){k=!0,T=E}finally{try{S||null==O.return||O.return()}finally{if(k)throw T}}}r--,o(),t.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t=new Map,e=!0,n=!1,r=void 0;try{for(var a,o=this.namedContent[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=i(a.value,2),s=u[0],l=c(u[1],b);t.set(s,l)}}catch(g){n=!0,r=g}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}var h=!0,f=!1,v=void 0;try{for(var d,p=this.content[Symbol.iterator]();!(h=(d=p.next()).done);h=!0){var m=y(d.value);null!=m&&m.hasValidName&&t.delete(m.name)}}catch(g){f=!0,v=g}finally{try{h||null==p.return||p.return()}finally{if(f)throw v}}return 0==t.size&&(t=null),t},set:function(t){var e=this.namedOnlyContent;if(null!=e){var n=!0,r=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=i(o.value,2),l=s[0];s[1];this.namedContent.delete(l)}}catch(g){r=!0,a=g}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}}if(null!=t){var h=!0,c=!1,f=void 0;try{for(var v,d=t[Symbol.iterator]();!(h=(v=d.next()).done);h=!0){var p=i(v.value,2),m=(p[0],y(p[1]));null!=m&&this.AddToNamedContentOnly(m)}}catch(g){c=!0,f=g}finally{try{h||null==d.return||d.return()}finally{if(c)throw f}}}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=n.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=n.CountFlags.Turns),this.countingAtStartOnly&&(t|=n.CountFlags.CountStartOnly),t==n.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;(e&n.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&n.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&n.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=[],e=this;e instanceof n;)e.content.length>0&&(t.push(new s.Component(0)),e=e.content[0]);return new s(t)}}]),n}(b);!function(t){!function(t){t[t.Visits=1]="Visits",t[t.Turns=2]="Turns",t[t.CountStartOnly=4]="CountStartOnly"}(t.CountFlags||(t.CountFlags={}))}(V||(V={}));var j=function(t){function e(){return Object(f.a)(this,e),Object(r.a)(this,Object(a.a)(e).apply(this,arguments))}return Object(o.a)(e,t),d(e,[{key:"toString",value:function(){return"Glue"}}]),e}(b),L=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.CommandType.NotSet;return Object(f.a)(this,e),(t=Object(r.a)(this,Object(a.a)(e).call(this)))._commandType=n,t}return Object(o.a)(e,t),d(e,[{key:"commandType",get:function(){return this._commandType}}]),d(e,[{key:"Copy",value:function(){return new e(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}}],[{key:"EvalStart",value:function(){return new e(e.CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new e(e.CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new e(e.CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new e(e.CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new e(e.CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new e(e.CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new e(e.CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new e(e.CommandType.BeginString)}},{key:"EndString",value:function(){return new e(e.CommandType.EndString)}},{key:"NoOp",value:function(){return new e(e.CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new e(e.CommandType.ChoiceCount)}},{key:"Turns",value:function(){return new e(e.CommandType.Turns)}},{key:"TurnsSince",value:function(){return new e(e.CommandType.TurnsSince)}},{key:"ReadCount",value:function(){return new e(e.CommandType.ReadCount)}},{key:"Random",value:function(){return new e(e.CommandType.Random)}},{key:"SeedRandom",value:function(){return new e(e.CommandType.SeedRandom)}},{key:"VisitIndex",value:function(){return new e(e.CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new e(e.CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new e(e.CommandType.StartThread)}},{key:"Done",value:function(){return new e(e.CommandType.Done)}},{key:"End",value:function(){return new e(e.CommandType.End)}},{key:"ListFromInt",value:function(){return new e(e.CommandType.ListFromInt)}},{key:"ListRange",value:function(){return new e(e.CommandType.ListRange)}},{key:"ListRandom",value:function(){return new e(e.CommandType.ListRandom)}}]),e}(b);!function(t){!function(t){t[t.NotSet=-1]="NotSet",t[t.EvalStart=0]="EvalStart",t[t.EvalOutput=1]="EvalOutput",t[t.EvalEnd=2]="EvalEnd",t[t.Duplicate=3]="Duplicate",t[t.PopEvaluatedValue=4]="PopEvaluatedValue",t[t.PopFunction=5]="PopFunction",t[t.PopTunnel=6]="PopTunnel",t[t.BeginString=7]="BeginString",t[t.EndString=8]="EndString",t[t.NoOp=9]="NoOp",t[t.ChoiceCount=10]="ChoiceCount",t[t.Turns=11]="Turns",t[t.TurnsSince=12]="TurnsSince",t[t.Random=13]="Random",t[t.SeedRandom=14]="SeedRandom",t[t.VisitIndex=15]="VisitIndex",t[t.SequenceShuffleIndex=16]="SequenceShuffleIndex",t[t.StartThread=17]="StartThread",t[t.Done=18]="Done",t[t.End=19]="End",t[t.ListFromInt=20]="ListFromInt",t[t.ListRange=21]="ListRange",t[t.ListRandom=22]="ListRandom",t[t.ReadCount=23]="ReadCount",t[t.TOTAL_VALUES=24]="TOTAL_VALUES"}(t.CommandType||(t.CommandType={}))}(L||(L={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(u||(u={}));var R=function(){function t(){Object(f.a)(this,t),this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}return d(t,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new t(this.container,this.index)}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new s.Component(this.index)):this.container.path}}],[{key:"StartOf",value:function(e){return new t(e,0)}},{key:"Null",get:function(){return new t(null,-1)}}]),t}(),D=function(t){function e(t){var n;return Object(f.a)(this,e),(n=Object(r.a)(this,Object(a.a)(e).call(this)))._targetPath=null,n._targetPointer=R.Null,n.variableDivertName=null,n.pushesToStack=!1,n.stackPushType=0,n.isExternal=!1,n.externalArgs=0,n.isConditional=!1,n.pushesToStack=!1,void 0!==t&&(n.pushesToStack=!0,n.stackPushType=t),n}return Object(o.a)(e,t),d(e,[{key:"Equals",value:function(t){var n=t;return n instanceof e&&this.hasVariableTarget==n.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==n.variableDivertName:null===this.targetPath?S("this.targetPath"):this.targetPath.Equals(n.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new C,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==u.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=R.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return S("this._targetPath");if(null===this._targetPath.lastComponent)return S("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return S("targetObj");this._targetPointer.container=t.parent instanceof V?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=R.StartOf(t instanceof V?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new s(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),e}(b),M=function(t){function e(){var t,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return Object(f.a)(this,e),(t=Object(r.a)(this,Object(a.a)(e).call(this)))._pathOnChoice=null,t.hasCondition=!1,t.hasStartContent=!1,t.hasChoiceOnlyContent=!1,t.isInvisibleDefault=!1,t.onceOnly=!0,t.onceOnly=n,t}return Object(o.a)(e,t),d(e,[{key:"toString",value:function(){return null===this.pathOnChoice?S("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}},{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return null===this._pathOnChoice?S("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return null===this.pathOnChoice?S("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new s(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}}]),e}(b),G=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return Object(f.a)(this,e),(t=Object(r.a)(this,Object(a.a)(e).call(this))).pathForCount=null,t.name=n,t}return Object(o.a)(e,t),d(e,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null===t?null:new s(t)}}]),e}(b),B=function(t){function e(t,n){var i;return Object(f.a)(this,e),(i=Object(r.a)(this,Object(a.a)(e).call(this))).variableName=t||null,i.isNewDeclaration=!!n,i.isGlobal=!1,i}return Object(o.a)(e,t),d(e,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}}]),e}(b),W=function(t){function e(){return Object(f.a)(this,e),Object(r.a)(this,Object(a.a)(e).apply(this,arguments))}return Object(o.a)(e,t),e}(b),J=function(t){function e(){var t;if(Object(f.a)(this,e),(t=Object(r.a)(this,Object(a.a)(e).call(this)))._name=null,t._numberOfParameters=0,t._prototype=null,t._isPrototype=!1,t._operationFuncs=null,0===arguments.length)e.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){var n=arguments[0];e.GenerateNativeFunctionsIfNecessary(),t.name=n}else if(2===arguments.length){var i=arguments[0],o=arguments[1];t._isPrototype=!0,t.name=i,t.numberOfParameters=o}return Object(r.a)(t)}return Object(o.a)(e,t),d(e,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");var e=!1,i=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;if(s instanceof W)throw new w('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');s instanceof I&&(e=!0)}}catch(c){r=!0,a=c}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}if(2==t.length&&e)return this.CallBinaryListOperation(t);var l=this.CoerceValuesToSingleType(t),h=l[0].valueType;return h==n.Int?this.CallType(l):h==n.Float?this.CallType(l):h==n.String?this.CallType(l):h==n.DivertTarget?this.CallType(l):h==n.List?this.CallType(l):null}},{key:"CallType",value:function(t){var e=c(t[0],_),n=e.valueType,i=e,r=t.length;if(2==r||1==r){if(null===this._operationFuncs)return S("NativeFunctionCall._operationFuncs");var a=this._operationFuncs.get(n);if(!a)throw new w("Cannot perform operation "+this.name+" on "+n);if(2==r){var o=c(t[1],_),u=a;if(null===i.value||null===o.value)return S("NativeFunctionCall.Call BinaryOp values");var s=u(i.value,o.value);return _.Create(s)}var l=a;if(null===i.value)return S("NativeFunctionCall.Call UnaryOp value");var h=l(i.value);return _.Create(h)}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof I&&t[1]instanceof x)return this.CallListIncrementOperation(t);var e=c(t[0],_),i=c(t[1],_);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==n.List&&i.valueType==n.List)){if(null===this._operationFuncs)return S("NativeFunctionCall._operationFuncs");var r=this._operationFuncs.get(n.Int);if(null===r)return S("NativeFunctionCall.CallBinaryListOperation op");var a=r(e.isTruthy?1:0,i.isTruthy?1:0);return new x(a)}if(e.valueType==n.List&&i.valueType==n.List)return this.CallType([e,i]);throw new w("Can not call use "+this.name+" operation on "+e.valueType+" and "+i.valueType)}},{key:"CallListIncrementOperation",value:function(t){var e=c(t[0],I),r=c(t[1],x),a=new T;if(null===e.value)return S("NativeFunctionCall.CallListIncrementOperation listVal.value");var o=!0,u=!1,s=void 0;try{for(var l,h=e.value[Symbol.iterator]();!(o=(l=h.next()).done);o=!0){var f=i(l.value,2),v=f[0],d=f[1],y=k.fromSerializedKey(v);if(null===this._operationFuncs)return S("NativeFunctionCall._operationFuncs");var p=this._operationFuncs.get(n.Int);if(null===r.value)return S("NativeFunctionCall.CallListIncrementOperation intVal.value");var m=p(d,r.value),g=null;if(null===e.value.origins)return S("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");var b=!0,C=!1,w=void 0;try{for(var O,_=e.value.origins[Symbol.iterator]();!(b=(O=_.next()).done);b=!0){var E=O.value;if(E.name==y.originName){g=E;break}}}catch(P){C=!0,w=P}finally{try{b||null==_.return||_.return()}finally{if(C)throw w}}if(null!=g){var N=g.TryGetItemWithValue(m,k.Null);N.exists&&a.Add(N.result,m)}}}catch(P){u=!0,s=P}finally{try{o||null==h.return||h.return()}finally{if(u)throw s}}return new I(a)}},{key:"CoerceValuesToSingleType",value:function(t){var e=n.Int,i=null,r=!0,a=!1,o=void 0;try{for(var u,s=t[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=c(u.value,_);l.valueType>e&&(e=l.valueType),l.valueType==n.List&&(i=h(l,I))}}catch(V){a=!0,o=V}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}var f=[];if(n[e]==n[n.List]){var v=!0,d=!1,y=void 0;try{for(var p,m=t[Symbol.iterator]();!(v=(p=m.next()).done);v=!0){var g=c(p.value,_);if(g.valueType==n.List)f.push(g);else{if(g.valueType!=n.Int)throw new w("Cannot mix Lists and "+g.valueType+" values in this operation");var b=parseInt(g.valueObject);if(null===(i=c(i,I)).value)return S("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var C=i.value.originOfMaxItem;if(null===C)return S("NativeFunctionCall.CoerceValuesToSingleType list");var T=C.TryGetItemWithValue(b,k.Null);if(!T.exists)throw new w("Could not find List item with the value "+b+" in "+C.name);var O=new I(T.result,b);f.push(O)}}}catch(V){d=!0,y=V}finally{try{v||null==m.return||m.return()}finally{if(d)throw y}}}else{var x=!0,E=!1,N=void 0;try{for(var P,A=t[Symbol.iterator]();!(x=(P=A.next()).done);x=!0){var F=c(P.value,_).Cast(e);f.push(F)}}catch(V){E=!0,N=V}finally{try{x||null==A.return||A.return()}finally{if(E)throw N}}}return f}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}},{key:"toString",value:function(){return'Native "'+this.name+'"'}},{key:"name",get:function(){return null===this._name?S("NativeFunctionCall._name"):this._name},set:function(t){this._name=t,this._isPrototype||(null===e._nativeFunctions?S("NativeFunctionCall._nativeFunctions"):this._prototype=e._nativeFunctions.get(this._name)||null)}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"CallWithName",value:function(t){return new e(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}},{key:"Identity",value:function(t){return t}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){if(null==this._nativeFunctions){this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return Math.round(t/e)}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddIntBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddIntBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddIntUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddIntBinaryOp(this.Pow,function(t,e){return Math.pow(t,e)}),this.AddIntUnaryOp(this.Floor,e.Identity),this.AddIntUnaryOp(this.Ceiling,e.Identity),this.AddIntUnaryOp(this.Int,e.Identity),this.AddIntUnaryOp(this.Float,function(t){return t}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddFloatBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddFloatBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Pow,function(t,e){return Math.pow(t,e)}),this.AddFloatUnaryOp(this.Floor,function(t){return Math.floor(t)}),this.AddFloatUnaryOp(this.Ceiling,function(t){return Math.ceil(t)}),this.AddFloatUnaryOp(this.Int,function(t){return Math.floor(t)}),this.AddFloatUnaryOp(this.Float,e.Identity),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e?1:0}),this.AddStringBinaryOp(this.NotEquals,function(t,e){return t!==e?1:0}),this.AddStringBinaryOp(this.Has,function(t,e){return t.includes(e)?1:0}),this.AddStringBinaryOp(this.Hasnt,function(t,e){return t.includes(e)?0:1}),this.AddListBinaryOp(this.Add,function(t,e){return t.Union(e)}),this.AddListBinaryOp(this.Subtract,function(t,e){return t.Without(e)}),this.AddListBinaryOp(this.Has,function(t,e){return t.Contains(e)?1:0}),this.AddListBinaryOp(this.Hasnt,function(t,e){return t.Contains(e)?0:1}),this.AddListBinaryOp(this.Intersect,function(t,e){return t.Intersect(e)}),this.AddListBinaryOp(this.Equal,function(t,e){return t.Equals(e)?1:0}),this.AddListBinaryOp(this.Greater,function(t,e){return t.GreaterThan(e)?1:0}),this.AddListBinaryOp(this.Less,function(t,e){return t.LessThan(e)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(t,e){return t.GreaterThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,function(t,e){return t.LessThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.NotEquals,function(t,e){return t.Equals(e)?0:1}),this.AddListBinaryOp(this.And,function(t,e){return t.Count>0&&e.Count>0?1:0}),this.AddListBinaryOp(this.Or,function(t,e){return t.Count>0||e.Count>0?1:0}),this.AddListUnaryOp(this.Not,function(t){return 0==t.Count?1:0}),this.AddListUnaryOp(this.Invert,function(t){return t.inverse}),this.AddListUnaryOp(this.All,function(t){return t.all}),this.AddListUnaryOp(this.ListMin,function(t){return t.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(t){return t.MaxAsList()}),this.AddListUnaryOp(this.Count,function(t){return t.Count}),this.AddListUnaryOp(this.ValueOfList,function(t){return t.maxItem.Value});this.AddOpToNativeFunc(this.Equal,2,n.DivertTarget,function(t,e){return t.Equals(e)?1:0}),this.AddOpToNativeFunc(this.NotEquals,2,n.DivertTarget,function(t,e){return t.Equals(e)?0:1})}}},{key:"AddOpToNativeFunc",value:function(t,n,i,r){if(null===this._nativeFunctions)return S("NativeFunctionCall._nativeFunctions");var a=this._nativeFunctions.get(t);a||(a=new e(t,n),this._nativeFunctions.set(t,a)),a.AddOpFuncForType(i,r)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,n.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,n.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,n.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,n.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,n.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,n.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,n.List,e)}}]),e}(b);J.Add="+",J.Subtract="-",J.Divide="/",J.Multiply="*",J.Mod="%",J.Negate="_",J.Equal="==",J.Greater=">",J.Less="<",J.GreaterThanOrEquals=">=",J.LessThanOrEquals="<=",J.NotEquals="!=",J.Not="!",J.And="&&",J.Or="||",J.Min="MIN",J.Max="MAX",J.Pow="POW",J.Floor="FLOOR",J.Ceiling="CEILING",J.Int="INT",J.Float="FLOAT",J.Has="?",J.Hasnt="!?",J.Intersect="^",J.ListMin="LIST_MIN",J.ListMax="LIST_MAX",J.All="LIST_ALL",J.Count="LIST_COUNT",J.ValueOfList="LIST_VALUE",J.Invert="LIST_INVERT",J._nativeFunctions=null;var q=function(t){function e(t){var n;return Object(f.a)(this,e),(n=Object(r.a)(this,Object(a.a)(e).call(this))).text=t.toString()||"",n}return Object(o.a)(e,t),d(e,[{key:"toString",value:function(){return"# "+this.text}}]),e}(b),K=function(t){function e(){var t;return Object(f.a)(this,e),(t=Object(r.a)(this,Object(a.a)(e).apply(this,arguments))).text="",t.index=0,t.threadAtGeneration=null,t.sourcePath="",t.targetPath=null,t.isInvisibleDefault=!1,t.originalThreadIndex=0,t}return Object(o.a)(e,t),d(e,[{key:"pathStringOnChoice",get:function(){return null===this.targetPath?S("Choice.targetPath"):this.targetPath.toString()},set:function(t){this.targetPath=new s(t)}}]),e}(b),U=function(){function t(e,n){Object(f.a)(this,t),this._name=e||"",this._items=null,this._itemNameToValues=n||new Map}return d(t,[{key:"ValueForItem",value:function(t){if(!t.itemName)return 0;var e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}},{key:"ContainsItemWithName",value:function(t){return this._itemNameToValues.has(t)}},{key:"TryGetItemWithValue",value:function(t,e){var n=!0,r=!1,a=void 0;try{for(var o,u=this._itemNameToValues[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=i(o.value,2),l=s[0];if(s[1]==t)return{result:new k(this.name,l),exists:!0}}}catch(h){r=!0,a=h}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}return{result:k.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t,e){if(!t.itemName)return{result:0,exists:!1};var n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items){this._items=new Map;var t=!0,e=!1,n=void 0;try{for(var r,a=this._itemNameToValues[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var o=i(r.value,2),u=o[0],s=o[1],l=new k(this.name,u);this._items.set(l.serialized(),s)}}catch(h){e=!0,n=h}finally{try{t||null==a.return||a.return()}finally{if(e)throw n}}}return this._items}}]),t}(),z=function(){function t(e){Object(f.a)(this,t),this._lists=new Map,this._allUnambiguousListValueCache=new Map;var n=!0,r=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value;this._lists.set(s.name,s);var l=!0,h=!1,c=void 0;try{for(var v,d=s.items[Symbol.iterator]();!(l=(v=d.next()).done);l=!0){var y=i(v.value,2),p=y[0],m=y[1],g=k.fromSerializedKey(p),S=new I(g,m);if(!g.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(g.itemName,S),this._allUnambiguousListValueCache.set(g.fullName,S)}}catch(b){h=!0,c=b}finally{try{l||null==d.return||d.return()}finally{if(h)throw c}}}}catch(b){r=!0,a=b}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}}return d(t,[{key:"TryListGetDefinition",value:function(t,e){if(null===t)return{result:e,exists:!1};var n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}},{key:"FindSingleItemListWithName",value:function(t){if(null===t)return S("name");var e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}},{key:"lists",get:function(){var t=[],e=!0,n=!1,r=void 0;try{for(var a,o=this._lists[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var u=i(a.value,2),s=(u[0],u[1]);t.push(s)}}catch(l){n=!0,r=l}finally{try{e||null==o.return||o.return()}finally{if(n)throw r}}return t}}]),t}(),H=function(){function t(){Object(f.a)(this,t)}return d(t,null,[{key:"ListToJArray",value:function(t){var e=[],n=!0,i=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;e.push(this.RuntimeObjectToJToken(u))}}catch(s){i=!0,r=s}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return e}},{key:"JArrayToRuntimeObjList",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=t.length;e&&n--;for(var i=[],r=0;r<n;r++){var a=t[r],o=this.JTokenToRuntimeObject(a);if(null===o)return S("runtimeObj");i.push(o)}return i}},{key:"DictionaryRuntimeObjsToJObject",value:function(t){var e={},n=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=i(o.value,2),l=s[0],c=h(s[1],b);null!=c&&(e[l]=this.RuntimeObjectToJToken(c))}}catch(f){r=!0,a=f}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}return e}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e=new Map;for(var n in t)if(t.hasOwnProperty(n)){var i=this.JTokenToRuntimeObject(t[n]);if(null===i)return S("inkObject");e.set(n,i)}return e}},{key:"JObjectToIntDictionary",value:function(t){var e=new Map;for(var n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}},{key:"IntDictionaryToJObject",value:function(t){var e={},n=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=i(o.value,2),l=s[0],h=s[1];e[l]=v(h)}}catch(c){r=!0,a=c}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}return e}},{key:"JTokenToRuntimeObject",value:function(e){if("number"==typeof e&&!isNaN(e))return _.Create(e);if("string"==typeof e){var n=e.toString(),i=n[0];if("^"==i)return new N(n.substring(1));if("\n"==i&&1==n.length)return new N("\n");if("<>"==n)return new j;for(var r=0;r<t._controlCommandNames.length;++r)if(n==t._controlCommandNames[r])return new L(r);if("L^"==n&&(n="^"),J.CallExistsWithName(n))return J.CallWithName(n);if("->->"==n)return L.PopTunnel();if("~ret"==n)return L.PopFunction();if("void"==n)return new W}if("object"==typeof e&&0==Array.isArray(e)){var a,o=e;if(o["^->"])return a=o["^->"],new P(new s(a.toString()));if(o["^var"]){a=o["^var"];var l=new A(a.toString());return"ci"in o&&(a=o.ci,l.contextIndex=parseInt(a)),l}var h=!1,c=!1,f=u.Function,v=!1;if((a=o["->"])?h=!0:(a=o["f()"])?(h=!0,c=!0,f=u.Function):(a=o["->t->"])?(h=!0,c=!0,f=u.Tunnel):(a=o["x()"])&&(h=!0,v=!0,c=!1,f=u.Function),h){var d=new D;d.pushesToStack=c,d.stackPushType=f,d.isExternal=v;var y=a.toString();return(a=o.var)?d.variableDivertName=y:d.targetPathString=y,d.isConditional=!!o.c,v&&(a=o.exArgs)&&(d.externalArgs=parseInt(a)),d}if(a=o["*"]){var p=new M;return p.pathStringOnChoice=a.toString(),(a=o.flg)&&(p.flags=parseInt(a)),p}if(a=o["VAR?"])return new G(a.toString());if(a=o["CNT?"]){var m=new G;return m.pathStringForCount=a.toString(),m}var g=!1,S=!1;if((a=o["VAR="])?(g=!0,S=!0):(a=o["temp="])&&(g=!0,S=!1),g){var b=a.toString(),C=!o.re,w=new B(b,C);return w.isGlobal=S,w}if(void 0!==o["#"])return a=o["#"],new q(a.toString());if(a=o.list){var O=a,x=new T;if(a=o.origins){var E=a;x.SetInitialOriginNames(E)}for(var F in O)if(O.hasOwnProperty(F)){var V=O[F],R=new k(F),K=parseInt(V);x.Add(R,K)}return new I(x)}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(Array.isArray(e))return this.JArrayToContainer(e);if(null==e)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(e))}},{key:"RuntimeObjectToJToken",value:function(e){var n=h(e,V);if(n)return this.ContainerToJArray(n);var i=h(e,D);if(i){var r,a="->";i.isExternal?a="x()":i.pushesToStack&&(i.stackPushType==u.Function?a="f()":i.stackPushType==u.Tunnel&&(a="->t->")),r=i.hasVariableTarget?i.variableDivertName:i.targetPathString;var o={};return o[a]=r,i.hasVariableTarget&&(o.var=!0),i.isConditional&&(o.c=!0),i.externalArgs>0&&(o.exArgs=i.externalArgs),o}var s=h(e,M);if(s){var l={};return l["*"]=s.pathStringOnChoice,l.flg=s.flags,l}var c=h(e,x);if(c)return c.value;var f=h(e,E);if(f)return f.value;var v=h(e,N);if(v)return v.isNewline?"\n":"^"+v.value;var d=h(e,I);if(d)return this.InkListToJObject(d);var y=h(e,P);if(y){var p={};return null===y.value?S("divTargetVal.value"):(p["^->"]=y.value.componentsString,p)}var m=h(e,A);if(m){var g={};return g["^var"]=m.value,g.ci=m.contextIndex,g}if(h(e,j))return"<>";var b=h(e,L);if(b)return t._controlCommandNames[b.commandType];var C=h(e,J);if(C){var k=C.name;return"^"==k&&(k="L^"),k}var T=h(e,G);if(T){var w={},O=T.pathStringForCount;return null!=O?w["CNT?"]=O:w["VAR?"]=T.name,w}var _=h(e,B);if(_){var F={};return F[_.isGlobal?"VAR=":"temp="]=_.variableName,_.isNewDeclaration||(F.re=!0),F}if(h(e,W))return"void";var R=h(e,q);if(R){var U={};return U["#"]=R.text,U}var z=h(e,K);if(z)return this.ChoiceToJObject(z);throw new Error("Failed to convert runtime object to Json token: "+e)}},{key:"ContainerToJArray",value:function(t){var e=this.ListToJArray(t.content),n=t.namedOnlyContent,i=t.countFlags;if(null!=n&&n.size>0||i>0||null!=t.name){var r;if(null!=n){for(var a in r=this.DictionaryRuntimeObjsToJObject(n))if(r.hasOwnProperty(a)){var o=r[a];if(null!=o){var u=o[o.length-1];null!=u&&(delete u["#n"],0==Object.keys(u).length&&(o[o.length-1]=null))}}}else r={};i>0&&(r["#f"]=i),null!=t.name&&(r["#n"]=t.name),e.push(r)}else e.push(null);return e}},{key:"JArrayToContainer",value:function(t){var e=new V;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i=new Map;for(var r in n)if("#f"==r)e.countFlags=parseInt(n[r]);else if("#n"==r)e.name=n[r].toString();else{var a=this.JTokenToRuntimeObject(n[r]),o=h(a,V);o&&(o.name=r),i.set(r,a)}e.namedOnlyContent=i}return e}},{key:"JObjectToChoice",value:function(t){var e=new K;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}},{key:"ChoiceToJObject",value:function(t){var e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.sourcePath,e.originalThreadIndex=t.originalThreadIndex,e.targetPath=t.pathStringOnChoice,e}},{key:"InkListToJObject",value:function(t){var e=t.value;if(null===e)return S("rawList");var n={},r={},a=!0,o=!1,u=void 0;try{for(var s,l=e[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var h=i(s.value,2),c=h[0],f=h[1];r[k.fromSerializedKey(c).toString()]=f}}catch(v){o=!0,u=v}finally{try{a||null==l.return||l.return()}finally{if(o)throw u}}return n.list=r,0==e.Count&&null!=e.originNames&&e.originNames.length>0&&(n.origins=e.originNames),n}},{key:"ListDefinitionsToJToken",value:function(t){var e={},n=!0,r=!1,a=void 0;try{for(var o,u=t.lists[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var s=o.value,l={},h=!0,c=!1,f=void 0;try{for(var v,d=s.items[Symbol.iterator]();!(h=(v=d.next()).done);h=!0){var y=i(v.value,2),p=y[0],m=y[1],g=k.fromSerializedKey(p);if(null===g.itemName)return S("item.itemName");l[g.itemName]=m}}catch(b){c=!0,f=b}finally{try{h||null==d.return||d.return()}finally{if(c)throw f}}e[s.name]=l}}catch(b){r=!0,a=b}finally{try{n||null==u.return||u.return()}finally{if(r)throw a}}return e}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e)if(e.hasOwnProperty(i)){var r=i.toString(),a=e[i],o=new Map;for(var u in a)if(e.hasOwnProperty(i)){var s=a[u];o.set(u,parseInt(s))}var l=new U(r,o);n.push(l)}return new z(n)}}]),t}();H._controlCommandNames=function(){var t=[];t[L.CommandType.EvalStart]="ev",t[L.CommandType.EvalOutput]="out",t[L.CommandType.EvalEnd]="/ev",t[L.CommandType.Duplicate]="du",t[L.CommandType.PopEvaluatedValue]="pop",t[L.CommandType.PopFunction]="~ret",t[L.CommandType.PopTunnel]="->->",t[L.CommandType.BeginString]="str",t[L.CommandType.EndString]="/str",t[L.CommandType.NoOp]="nop",t[L.CommandType.ChoiceCount]="choiceCnt",t[L.CommandType.Turns]="turn",t[L.CommandType.TurnsSince]="turns",t[L.CommandType.ReadCount]="readc",t[L.CommandType.Random]="rnd",t[L.CommandType.SeedRandom]="srnd",t[L.CommandType.VisitIndex]="visit",t[L.CommandType.SequenceShuffleIndex]="seq",t[L.CommandType.StartThread]="thread",t[L.CommandType.Done]="done",t[L.CommandType.End]="end",t[L.CommandType.ListFromInt]="listInt",t[L.CommandType.ListRange]="range",t[L.CommandType.ListRandom]="lrnd";for(var e=0;e<L.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t}();var X=function(){function t(){if(Object(f.a)(this,t),this._threadCounter=0,arguments[0]instanceof V||null===arguments[0]){var e=arguments[0];this._threads=[],this._threads.push(new t.Thread),this._threads[0].callstack.push(new t.Element(u.Tunnel,R.StartOf(e)))}else{var n=arguments[0];this._threads=[];var i=!0,r=!1,a=void 0;try{for(var o,s=n._threads[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;this._threads.push(l.Copy())}}catch(h){r=!0,a=h}finally{try{i||null==s.return||s.return()}finally{if(r)throw a}}}}return d(t,[{key:"SetJsonToken",value:function(e,n){this._threads.length=0;var i=e.threads,r=!0,a=!1,o=void 0;try{for(var u,s=i[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=u.value,h=new t.Thread(l,n);this._threads.push(h)}}catch(c){a=!0,o=c}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}this._threadCounter=parseInt(e.threadCounter)}},{key:"GetJsonToken",value:function(){var t={},e=[],n=!0,i=!1,r=void 0;try{for(var a,o=this._threads[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;e.push(u.jsonToken)}}catch(s){i=!0,r=s}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return t.threads=e,t.threadCounter=this._threadCounter,t}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"PopThread",value:function(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"Push",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=new t.Element(e,this.currentElement.currentPointer,!1);r.evaluationStackHeightWhenPushed=n,r.functionStartInOutputStream=i,this.callStack.push(r)}},{key:"CanPop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.CanPop(t))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}},{key:"GetTemporaryVariableWithName",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==e&&(e=this.currentElementIndex+1);var n=O(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}},{key:"SetTemporaryVariable",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;-1==i&&(i=this.currentElementIndex+1);var r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new w("Could not find temporary variable to set: "+t);var a=O(r.temporaryVariables,t,null);a.exists&&I.RetainListOriginsForAssignment(a.result,e),r.temporaryVariables.set(t,e)}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){return this._threads.filter(function(e){if(e.threadIndex==t)return e})[0]}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){e.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"canPopThread",get:function(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==u.FunctionEvaluationFromGame}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new C,e=0;e<this._threads.length;e++){var n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(var r=0;r<n.callstack.length;r++){n.callstack[r].type==u.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");var a=n.callstack[r].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),null===a.container)return S("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}]),t}();!function(t){var e=function(){function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Object(f.a)(this,t),this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=n.copy(),this.inExpressionEvaluation=i,this.temporaryVariables=new Map,this.type=e}return d(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return e.temporaryVariables=new Map(this.temporaryVariables),e.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,e.functionStartInOutputStream=this.functionStartInOutputStream,e}}]),t}();t.Element=e;var n=function(){function t(){if(Object(f.a)(this,t),this.threadIndex=0,this.previousPointer=R.Null,this.callstack=[],arguments[0]&&arguments[1]){var n=arguments[0],i=arguments[1];this.threadIndex=parseInt(n.threadIndex);var r=n.callstack,a=!0,o=!1,u=void 0;try{for(var l,h=r[Symbol.iterator]();!(a=(l=h.next()).done);a=!0){var c=l.value,v=void 0,d=c,y=parseInt(d.type),p=R.Null,m=d.cPath;if(void 0!==m){v=m.toString();var g=i.ContentAtPath(new s(v));if(p.container=g.container,p.index=parseInt(d.idx),null==g.obj)throw new Error("When loading state, internal story location couldn't be found: "+v+". Has the story changed since this save data was created?");if(g.approximate){if(null===p.container)return S("pointer.container");i.Warning("When loading state, exact internal story location couldn't be found: '"+v+"', so it was approximated to '"+p.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}var b=!!d.exp,C=new e(y,p,b),k=d.temp;C.temporaryVariables=H.JObjectToDictionaryRuntimeObjs(k),this.callstack.push(C)}}catch(O){o=!0,u=O}finally{try{a||null==h.return||h.return()}finally{if(o)throw u}}var T=n.previousContentObject;if(void 0!==T){var w=new s(T.toString());this.previousPointer=i.PointerAtPath(w)}}}return d(t,[{key:"Copy",value:function(){var e=new t;e.threadIndex=this.threadIndex;var n=!0,i=!1,r=void 0;try{for(var a,o=this.callstack[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;e.callstack.push(u.Copy())}}catch(s){i=!0,r=s}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return e.previousPointer=this.previousPointer.copy(),e}},{key:"jsonToken",get:function(){var t={},e=[],n=!0,i=!1,r=void 0;try{for(var a,o=this.callstack[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value,s={};if(!u.currentPointer.isNull){if(null===u.currentPointer.container)return S("el.currentPointer.container");s.cPath=u.currentPointer.container.path.componentsString,s.idx=u.currentPointer.index}s.exp=u.inExpressionEvaluation,s.type=u.type,s.temp=H.DictionaryRuntimeObjsToJObject(u.temporaryVariables),e.push(s)}}catch(h){i=!0,r=h}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}if(t.callstack=e,t.threadIndex=this.threadIndex,!this.previousPointer.isNull){var l=this.previousPointer.Resolve();if(null===l)return S("this.previousPointer.Resolve()");t.previousContentObject=l.path.toString()}return t}}]),t}();t.Thread=n}(X||(X={}));var $=function(){function t(e,n){Object(f.a)(this,t),this.variableChangedEventCallbacks=[],this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariables=new Set,this._globalVariables=new Map,this._callStack=e,this._listDefsOrigin=n;try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(e){}}return d(t,[{key:"variableChangedEvent",value:function(t,e){var n=!0,i=!1,r=void 0;try{for(var a,o=this.variableChangedEventCallbacks[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){(0,a.value)(t,e)}}catch(u){i=!0,r=u}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}},{key:"$",value:function(t,e){if(void 0===e){var n=this._globalVariables.get(t);return void 0===n&&(n=this._defaultGlobalVariables.get(t)),void 0!==n?n.valueObject:null}if(void 0===this._defaultGlobalVariables.get(t))throw new w("Cannot assign to a variable ("+t+") that hasn't been declared in the story");var i=_.Create(e);if(null==i)throw new w(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"CopyFrom",value:function(t){if(this._globalVariables=new Map(t._globalVariables),this._defaultGlobalVariables=new Map(t._defaultGlobalVariables),this.variableChangedEvent=t.variableChangedEvent,t.batchObservingVariableChanges!=this.batchObservingVariableChanges)if(t.batchObservingVariableChanges){if(this._batchObservingVariableChanges=!0,null===t._changedVariables)return S("toCopy._changedVariables");this._changedVariables=new Set(t._changedVariables)}else this._batchObservingVariableChanges=!1,this._changedVariables=null}},{key:"TryGetDefaultVariableValue",value:function(t){var e=O(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}},{key:"GlobalVariableExistsWithName",value:function(t){return this._globalVariables.has(t)}},{key:"GetVariableWithName",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=this.GetRawVariableWithName(t,e),i=h(n,A);return null!==i&&(n=this.ValueAtVariablePointer(i)),n}},{key:"GetRawVariableWithName",value:function(t,e){if(0==e||-1==e){var n=O(this._globalVariables,t,null);if(n.exists)return n.result;if(null===this._listDefsOrigin)return S("VariablesState._listDefsOrigin");var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName;if(null===n)return S("name");var i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this._globalVariables.has(n),t.isNewDeclaration){var a=h(e,A);null!==a&&(e=this.ResolveVariablePointer(a))}else{var o=null;do{null!=(o=h(this.GetRawVariableWithName(n,i),A))&&(n=o.variableName,r=0==(i=o.contextIndex))}while(null!=o)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=new Map(this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=c(t,I),i=c(e,I);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n=O(this._globalVariables,t,null);if(n.exists&&I.RetainListOriginsForAssignment(n.result,e),null===t)return S("variableName");if(this._globalVariables.set(t,e),null!=this.variableChangedEvent&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariables)return S("this._changedVariables");this._changedVariables.add(t)}else this.variableChangedEvent(t,e)}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=h(this.GetRawVariableWithName(t.variableName,e),A);return null!=n?n:new A(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this._globalVariables.get(t)?0:this._callStack.currentElementIndex}},{key:"ObserveVariableChange",value:function(t){this.variableChangedEventCallbacks.push(t)}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){if(this._batchObservingVariableChanges=t,t)this._changedVariables=new Set;else if(null!=this._changedVariables){var e=!0,n=!1,i=void 0;try{for(var r,a=this._changedVariables[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=r.value,u=this._globalVariables.get(o);u?this.variableChangedEvent(o,u):S("currentValue")}}catch(s){n=!0,i=s}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}}}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"jsonToken",get:function(){return H.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(t){this._globalVariables=H.JObjectToDictionaryRuntimeObjs(t)}}]),t}(),Q=function(){function t(e){Object(f.a)(this,t),this.seed=e%2147483647,this.seed<=0&&(this.seed+=2147483646)}return d(t,[{key:"next",value:function(){return this.seed=16807*this.seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),Y=function(){function t(e){Object(f.a)(this,t),this.kInkSaveStateVersion=8,this.kMinCompatibleLoadVersion=8,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=R.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.story=e,this._outputStream=[],this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new X(e.rootContentContainer),this._variablesState=new $(this.callStack,e.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this._currentTurnIndex=-1;var n=(new Date).getTime();this.storySeed=new Q(n).next()%100,this.previousRandom=0,this._currentChoices=[],this.GoToStart()}return d(t,[{key:"ToJson",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return JSON.stringify(this.jsonToken,null,t?2:0)}},{key:"toJson",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.ToJson(t)}},{key:"LoadJson",value:function(t){this.jsonToken=JSON.parse(t)}},{key:"VisitCountAtPathString",value:function(t){var e=O(this.visitCounts,t,null);return e.exists?e.result:0}},{key:"CleanOutputWhitespace",value:function(t){for(var e=new C,n=-1,i=0,r=0;r<t.length;r++){var a=t.charAt(r),o=" "==a||"\t"==a;o&&-1==n&&(n=r),o||("\n"!=a&&n>0&&n!=i&&e.Append(" "),n=-1),"\n"==a&&(i=r+1),o||e.Append(a)}return e.toString()}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=R.StartOf(this.story.mainContentContainer)}},{key:"Copy",value:function(){var e=new t(this.story);return e.outputStream.push.apply(e.outputStream,this._outputStream),this.OutputStreamDirty(),e._currentChoices.push.apply(e._currentChoices,this._currentChoices),this.hasError&&(e._currentErrors=[],e._currentErrors.push.apply(e._currentErrors,this.currentErrors||[])),this.hasWarning&&(e._currentWarnings=[],e._currentWarnings.push.apply(e._currentWarnings,this.currentWarnings||[])),e.callStack=new X(this.callStack),e._variablesState=new $(e.callStack,this.story.listDefinitions),e.variablesState.CopyFrom(this.variablesState),e.evaluationStack.push.apply(e.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(e.divertedPointer=this.divertedPointer.copy()),e.previousPointer=this.previousPointer.copy(),e._visitCounts=new Map(this.visitCounts),e._turnIndices=new Map(this.turnIndices),e._currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this._outputStream.length=0,null!==t&&this._outputStream.push.apply(this._outputStream,t),this.OutputStreamDirty()}},{key:"PushToOutputStream",value:function(t){var e=h(t,N);if(null!==e){var n=this.TrySplittingHeadTailWhitespace(e);if(null!==n){var i=!0,r=!1,a=void 0;try{for(var o,u=n[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;this.PushToOutputStreamIndividual(s)}}catch(l){r=!0,a=l}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){var e=t.value;if(null===e)return S("single.value");for(var n=-1,i=-1,r=0;r<e.length;++r){var a=e[r];if("\n"!=a){if(" "==a||"\t"==a)continue;break}-1==n&&(n=r),i=r}for(var o=-1,u=-1,s=0;s<e.length;++s){var l=e[s];if("\n"!=l){if(" "==l||"\t"==l)continue;break}-1==o&&(o=s),u=s}if(-1==n&&-1==o)return null;var h=[],c=0,f=e.length;if(-1!=n){if(n>0){var v=new N(e.substring(0,n));h.push(v)}h.push(new N("\n")),c=i+1}if(-1!=o&&(f=u),f>c){var d=e.substring(c,f-c);h.push(new N(d))}if(-1!=o&&u>i&&(h.push(new N("\n")),o<e.length-1)){var y=e.length-o-1,p=new N(e.substring(o+1,y));h.push(p)}return h}},{key:"PushToOutputStreamIndividual",value:function(t){var e=h(t,j),n=h(t,N),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){var r=-1,a=this.callStack.currentElement;a.type==u.Function&&(r=a.functionStartInOutputStream);for(var o=-1,s=this._outputStream.length-1;s>=0;s--){var l=this._outputStream[s],c=l instanceof L?l:null;if(null!=(l instanceof j?l:null)){o=s;break}if(null!=c&&c.commandType==L.CommandType.BeginString){s>=r&&(r=-1);break}}if(-1!=(-1!=o&&-1!=r?Math.min(r,o):-1!=o?o:r)){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(o>-1&&this.RemoveExistingGlue(),r>-1))for(var f=this.callStack.elements,v=f.length-1;v>=0;v--){var d=f[v];if(d.type!=u.Function)break;d.functionStartInOutputStream=-1}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return S("obj");this._outputStream.push(t),this.OutputStreamDirty()}}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var t=-1,e=this._outputStream.length-1;e>=0;){var n=this._outputStream[e],i=h(n,L),r=h(n,N);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this._outputStream.length;)h(this._outputStream[e],N)?this._outputStream.splice(e,1):e++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof j)this._outputStream.splice(t,1);else if(e instanceof L)break}this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(t){var e=h(t,I);if(e){var n=e.value;if(null===n)return S("rawList");if(null!=n.originNames){n.origins||(n.origins=[]),n.origins.length=0;var i=!0,r=!1,a=void 0;try{for(var o,u=n.originNames[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;if(null===this.story.listDefinitions)return S("StoryState.story.listDefinitions");var l=this.story.listDefinitions.TryListGetDefinition(s,null);if(null===l.result)return S("StoryState def.result");n.origins.indexOf(l.result)<0&&n.origins.push(l.result)}}catch(c){r=!0,a=c}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}}}if(null===t)return S("obj");this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(void 0===t)return p(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return p(this.evaluationStack.splice(this.evaluationStack.length-t,t))}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"ForceEnd",value:function(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.PopCallStack();this._currentChoices.length=0,this.currentPointer=R.Null,this.previousPointer=R.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){e.Assert(this.callStack.currentElement.type==u.Function);var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var n=this._outputStream.length-1;n>=t;n--){var i=this._outputStream[n],r=h(i,N),a=h(i,L);if(null!=r){if(a)break;if(!r.isNewline&&!r.isInlineWhitespace)break;this._outputStream.splice(n,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==u.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}},{key:"SetChosenPath",value:function(t,e){this._currentChoices.length=0;var n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this._currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(u.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=R.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!=t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(_.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==u.FunctionEvaluationFromGame&&(this.currentPointer=R.Null,this.didSafeExit=!0,!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=u.FunctionEvaluationFromGame)throw new w("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var i=this.PopEvaluationStack();null===e&&(e=i)}if(this.PopCallStack(u.FunctionEvaluationFromGame),e){if(e instanceof W)return null;var r=c(e,_);return r.valueType==n.DivertTarget?r.valueObject.toString():r.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"variablesState",get:function(){return this._variablesState}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:null===t.path?S("pointer.path"):t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&this.currentWarnings.length>0}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t=new C,e=!0,n=!1,i=void 0;try{for(var r,a=this._outputStream[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=h(r.value,N);null!==o&&t.Append(o.value)}}catch(u){n=!0,i=u}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){if(this._outputStreamTagsDirty){this._currentTags=[];var t=!0,e=!1,n=void 0;try{for(var i,r=this._outputStream[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var a=h(i.value,q);null!==a&&this._currentTags.push(a.text)}}catch(o){e=!0,n=o}finally{try{t||null==r.return||r.return()}finally{if(e)throw n}}this._outputStreamTagsDirty=!1}return this._currentTags}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"jsonToken",get:function(){var t,e={},n=!0,i=!1,r=void 0;try{for(var a,o=this._currentChoices[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;if(null===u.threadAtGeneration)return S("c.threadAtGeneration");u.originalThreadIndex=u.threadAtGeneration.threadIndex,null==this.callStack.ThreadWithIndex(u.originalThreadIndex)&&(null==t&&(t=new Map),t[u.originalThreadIndex.toString()]=u.threadAtGeneration.jsonToken)}}catch(s){i=!0,r=s}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}if(null!=t&&(e.choiceThreads=t),e.callstackThreads=this.callStack.GetJsonToken(),e.variablesState=this.variablesState.jsonToken,e.evalStack=H.ListToJArray(this.evaluationStack),e.outputStream=H.ListToJArray(this._outputStream),e.currentChoices=H.ListToJArray(this._currentChoices),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return S("this.divertedPointer.path");e.currentDivertTarget=this.divertedPointer.path.componentsString}return e.visitCounts=H.IntDictionaryToJObject(this.visitCounts),e.turnIndices=H.IntDictionaryToJObject(this.turnIndices),e.turnIdx=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.inkSaveVersion=this.kInkSaveStateVersion,e.inkFormatVersion=this.story.inkVersionCurrent,e},set:function(t){var e=t,n=e.inkSaveVersion;if(null==n)throw new w("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new w("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(e.callstackThreads,this.story),this.variablesState.jsonToken=e.variablesState,this._evaluationStack=H.JArrayToRuntimeObjList(e.evalStack),this._outputStream=H.JArrayToRuntimeObjList(e.outputStream),this.OutputStreamDirty(),this._currentChoices=H.JArrayToRuntimeObjList(e.currentChoices);var i=e.currentDivertTarget;if(null!=i){var r=new s(i.toString());this.divertedPointer=this.story.PointerAtPath(r)}this._visitCounts=H.JObjectToIntDictionary(e.visitCounts),this._turnIndices=H.JObjectToIntDictionary(e.turnIndices),this._currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom);var a=e.choiceThreads,o=!0,u=!1,l=void 0;try{for(var h,c=this._currentChoices[Symbol.iterator]();!(o=(h=c.next()).done);o=!0){var f=h.value,v=this.callStack.ThreadWithIndex(f.originalThreadIndex);if(null!=v)f.threadAtGeneration=v.Copy();else{var d=a[f.originalThreadIndex.toString()];f.threadAtGeneration=new X.Thread(d,this.story)}}}catch(y){u=!0,l=y}finally{try{o||null==c.return||c.return()}finally{if(u)throw l}}}},{key:"outputStreamEndsInNewline",get:function(){if(this._outputStream.length>0)for(var t=this._outputStream.length-1;t>=0&&!(this._outputStream[t]instanceof L);t--){var e=this._outputStream[t];if(e instanceof N){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof N)return!0;return!1}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=h(this._outputStream[t],L);if(e instanceof L&&e.commandType==L.CommandType.BeginString)return!0}return!1}}]),t}(),Z=function(){function t(){Object(f.a)(this,t),this.startTime=void 0}return d(t,[{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}},{key:"ElapsedMilliseconds",get:function(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}}]),t}();Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});var tt=function(t){function e(){var t,n;Object(f.a)(this,e),(t=Object(r.a)(this,Object(a.a)(e).call(this))).inkVersionCurrent=19,t.inkVersionMinimumCompatible=18,t._prevContainers=[],t.allowExternalFunctionFallbacks=!1,t._listDefinitions=null,t._variableObservers=null,t._hasValidatedExternals=!1,t._temporaryEvaluationContainer=null,t._asyncContinueActive=!1,t._stateAtLastNewline=null,t._recursiveContinueCount=0,t._profiler=null;var i=null,o=null;if(arguments[0]instanceof V)n=arguments[0],void 0!==arguments[1]&&(i=arguments[1]),t._mainContentContainer=n;else if("string"==typeof arguments[0]){var u=arguments[0];o=JSON.parse(u)}else o=arguments[0];if(null!=i&&(t._listDefinitions=new z(i)),t._externals=new Map,null!==o){var s=o,l=s.inkVersion;if(null==l)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");var h=parseInt(l);if(h>t.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(h<t.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");h!=t.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var v,d=s.root;if(null==d)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(v=s.listDefs)&&(t._listDefinitions=H.JTokenToListDefinitions(v)),t._mainContentContainer=c(H.JTokenToRuntimeObject(d),V),t.ResetState()}return t}return Object(o.a)(e,t),d(e,[{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJsonString",value:function(){var t=H.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,null!=this._listDefinitions&&(e.listDefs=H.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(e)}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new Y(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){if(null===this._state)return S("this._state");this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return S("this._state");this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent.get("global decl")){var t=this.state.currentPointer.copy();this.ChoosePath(new s("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();var e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new w("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new Z;n.Start();var i=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof w))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop(),!i&&this.canContinue||(null!=this._stateAtLastNewline&&(this.RestoreStateSnapshot(this._stateAtLastNewline),this._stateAtLastNewline=null),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(u.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(u.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!=this._stateAtLastNewline){if(null===this._stateAtLastNewline.currentTags)return S("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return S("this.state.currentTags");var t=this.CalculateNewlineOutputStateChange(this._stateAtLastNewline.currentText,this.state.currentText,this._stateAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==e.OutputStateChange.ExtendedBeyondNewline)return this.RestoreStateSnapshot(this._stateAtLastNewline),!0;t==e.OutputStateChange.NewlineRemoved&&(this._stateAtLastNewline=null)}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateAtLastNewline&&(this._stateAtLastNewline=this.StateSnapshot()):this._stateAtLastNewline=null)}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(t,n,i,r){if(null===t)return S("prevText");if(null===n)return S("currText");var a=n.length>=t.length&&"\n"==n.charAt(t.length-1);if(i==r&&t.length==n.length&&a)return e.OutputStateChange.NoChange;if(!a)return e.OutputStateChange.NewlineRemoved;if(r>i)return e.OutputStateChange.ExtendedBeyondNewline;for(var o=t.length;o<n.length;o++){var u=n.charAt(o);if(" "!=u&&"\t"!=u)return e.OutputStateChange.ExtendedBeyondNewline}return e.OutputStateChange.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new C;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){var e=this.mainContentContainer.namedContent.get(t);return e instanceof V?e:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return R.Null;var e=new R,n=t.length,i=null;return null===t.lastComponent?S("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(t){this._state=t}},{key:"Step",value:function(){var t=!0,e=this.state.currentPointer.copy();if(!e.isNull){for(var n=h(e.Resolve(),V);n&&(this.VisitContainer(n,!0),0!=n.content.length);)n=h((e=R.StartOf(n)).Resolve(),V);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);var i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(!this.state.currentPointer.isNull){r&&(t=!1);var a=h(i,M);if(a){var o=this.ProcessChoice(a);o&&this.state.generatedChoices.push(o),i=null,t=!1}if(i instanceof V&&(t=!1),t){var u=h(i,A);if(u&&-1==u.contextIndex){var s=this.state.callStack.ContextForVariableNamed(u.variableName);i=new A(u.variableName,s)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();var l=h(i,L);l&&l.commandType==L.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(!e.isNull&&-1!=e.index){if(this._prevContainers.length=0,!t.isNull)for(var n=h(t.Resolve(),V)||h(t.container,V);n;)this._prevContainers.push(n),n=h(n.parent,V);var i=e.Resolve();if(null!=i)for(var r=h(i.parent,V);r&&(this._prevContainers.indexOf(r)<0||r.countingAtStartOnly);){var a=r.content.length>0&&i==r.content[0];this.VisitContainer(r,a),i=r,r=h(r.parent,V)}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var i="",r="";if(t.hasChoiceOnlyContent&&(r=c(this.state.PopEvaluationStack(),N).value||""),t.hasStartContent&&(i=c(this.state.PopEvaluationStack(),N).value||""),t.onceOnly&&this.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;var a=new K;return a.targetPath=t.pathOnChoice,a.sourcePath=t.path.toString(),a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.currentThread.Copy(),a.text=(i+r).replace(/^[ \t]+|[ \t]+$/g,""),a}},{key:"IsTruthy",value:function(t){if(t instanceof _){var e=t;if(e instanceof P){var n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof D){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i=e.variableDivertName,r=this.state.variablesState.GetVariableWithName(i);if(null==r)this.Error("Tried to divert using a target from a variable that could not be found ("+i+")");else if(!(r instanceof P)){var a=h(r,x),o="Tried to divert to a target from a variable, but the variable ("+i+") didn't contain a divert target, it ";a instanceof x&&0==a.value?o+="was empty/null (the value 0).":o+="contained '"+r+"'.",this.Error(o)}var s=c(r,P);this.state.divertedPointer=this.PointerAtPath(s.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof L){var l=t;switch(l.commandType){case L.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case L.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case L.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var f=this.state.PopEvaluationStack();if(!(f instanceof W)){var v=new N(f.toString());this.state.PushToOutputStream(v)}}break;case L.CommandType.NoOp:break;case L.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case L.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case L.CommandType.PopFunction:case L.CommandType.PopTunnel:var d=l.commandType==L.CommandType.PopFunction?u.Function:u.Tunnel,y=null;if(d==u.Tunnel){var p=this.state.PopEvaluationStack();null===(y=h(p,P))&&this.Assert(p instanceof W,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==d&&this.state.callStack.canPop)this.state.PopCallStack(),y&&(this.state.divertedPointer=this.PointerAtPath(y.targetPath));else{var m=new Map;m.set(u.Function,"function return statement (~ return)"),m.set(u.Tunnel,"tunnel onwards statement (->->)");var g=m.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(g="end of flow (-> END or choice)");var b="Found "+m.get(d)+", when expected "+g;this.Error(b)}break;case L.CommandType.BeginString:this.state.PushToOutputStream(l),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case L.CommandType.EndString:for(var O=[],E=0,A=this.state.outputStream.length-1;A>=0;--A){var F=this.state.outputStream[A];E++;var j=h(F,L);if(j&&j.commandType==L.CommandType.BeginString)break;F instanceof N&&O.push(F)}this.state.PopFromOutputStream(E),O=O.reverse();var M=new C,q=!0,K=!1,U=void 0;try{for(var z,H=O[Symbol.iterator]();!(q=(z=H.next()).done);q=!0){var X=z.value;M.Append(X.toString())}}catch(Bt){K=!0,U=Bt}finally{try{q||null==H.return||H.return()}finally{if(K)throw U}}this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new N(M.toString()));break;case L.CommandType.ChoiceCount:var $=this.state.generatedChoices.length;this.state.PushEvaluationStack(new x($));break;case L.CommandType.Turns:this.state.PushEvaluationStack(new x(this.state.currentTurnIndex+1));break;case L.CommandType.TurnsSince:case L.CommandType.ReadCount:var Y=this.state.PopEvaluationStack();if(!(Y instanceof P)){var Z="";Y instanceof x&&(Z=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+Y+Z);break}var tt,et=c(Y,P),nt=h(this.ContentAtPath(et.targetPath).correctObj,V);null!=nt?tt=l.commandType==L.CommandType.TurnsSince?this.TurnsSinceForContainer(nt):this.VisitCountForContainer(nt):(tt=l.commandType==L.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+l.toString()+" lookup at "+et.targetPath.toString())),this.state.PushEvaluationStack(new x(tt));break;case L.CommandType.Random:var it=h(this.state.PopEvaluationStack(),x),rt=h(this.state.PopEvaluationStack(),x);if(null==rt||rt instanceof x==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==it||rt instanceof x==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===it.value)return S("maxInt.value");if(null===rt.value)return S("minInt.value");var at=it.value-rt.value+1;at<=0&&this.Error("RANDOM was called with minimum as "+rt.value+" and maximum as "+it.value+". The maximum must be larger");var ot=this.state.storySeed+this.state.previousRandom,ut=new Q(ot).next(),st=ut%at+rt.value;this.state.PushEvaluationStack(new x(st)),this.state.previousRandom=ut;break;case L.CommandType.SeedRandom:var lt=h(this.state.PopEvaluationStack(),x);if(null==lt||lt instanceof x==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===lt.value)return S("minInt.value");this.state.storySeed=lt.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new W);break;case L.CommandType.VisitIndex:var ht=this.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new x(ht));break;case L.CommandType.SequenceShuffleIndex:var ct=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new x(ct));break;case L.CommandType.StartThread:break;case L.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=R.Null);break;case L.CommandType.End:this.state.ForceEnd();break;case L.CommandType.ListFromInt:var ft=h(this.state.PopEvaluationStack(),x),vt=c(this.state.PopEvaluationStack(),N);if(null===ft)throw new w("Passed non-integer when creating a list element from a numerical value.");var dt=null;if(null===this.listDefinitions)return S("this.listDefinitions");var yt=this.listDefinitions.TryListGetDefinition(vt.value,null);if(!yt.exists)throw new w("Failed to find LIST called "+vt.value);if(null===ft.value)return S("minInt.value");var pt=yt.result.TryGetItemWithValue(ft.value,k.Null);pt.exists&&(dt=new I(pt.result,ft.value)),null==dt&&(dt=new I),this.state.PushEvaluationStack(dt);break;case L.CommandType.ListRange:var mt=h(this.state.PopEvaluationStack(),_),gt=h(this.state.PopEvaluationStack(),_),St=h(this.state.PopEvaluationStack(),I);if(null===St||null===gt||null===mt)throw new w("Expected list, minimum and maximum for LIST_RANGE");if(null===St.value)return S("targetList.value");var bt=St.value.ListWithSubRange(gt.valueObject,mt.valueObject);this.state.PushEvaluationStack(new I(bt));break;case L.CommandType.ListRandom:var Ct=this.state.PopEvaluationStack();if(null===Ct)throw new w("Expected list for LIST_RANDOM");var kt=Ct.value,Tt=null;if(null===kt)throw S("list");if(0==kt.Count)Tt=new T;else{for(var wt=this.state.storySeed+this.state.previousRandom,Ot=new Q(wt).next(),_t=Ot%kt.Count,xt=kt.entries(),Et=0;Et<=_t-1;Et++)xt.next();var Nt=xt.next().value,Pt={Key:k.fromSerializedKey(Nt[0]),Value:Nt[1]};if(null===Pt.Key.originName)return S("randomItem.Key.originName");(Tt=new T(Pt.Key.originName,this)).Add(Pt.Key,Pt.Value),this.state.previousRandom=Ot}this.state.PushEvaluationStack(new I(Tt));break;default:this.Error("unhandled ControlCommand: "+l)}return!0}if(t instanceof B){var At=t,It=this.state.PopEvaluationStack();return this.state.variablesState.Assign(At,It),!0}if(t instanceof G){var Ft=t,Vt=null;if(null!=Ft.pathForCount){var jt=Ft.containerForCount,Lt=this.VisitCountForContainer(jt);Vt=new x(Lt)}else if(null==(Vt=this.state.variablesState.GetVariableWithName(Ft.name))){var Rt=this.state.variablesState.TryGetDefaultVariableValue(Ft.name);null!=Rt?(this.Warning("Variable not found in save state: '"+Ft.name+"', but seems to have been newly created. Assigning value from latest ink's declaration: "+Rt),Vt=Rt,this.state.variablesState.SetGlobal(Ft.name,Vt)):(this.Warning("Variable not found: '"+Ft.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit."),Vt=new x(0))}return this.state.PushEvaluationStack(Vt),!0}if(t instanceof J){var Dt=t,Mt=this.state.PopEvaluationStack(Dt.numberOfParameters),Gt=Dt.Call(Mt);return this.state.PushEvaluationStack(Gt),!0}return!1}},{key:"ChoosePathString",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==u.Function){var i="",r=this.state.callStack.currentElement.currentPointer.container;throw null!=r&&(i="("+r.path.toString()+") "),new Error("Story was running a function "+i+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new s(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}},{key:"ChoosePath",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state.SetChosenPath(t,e),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");var n=e[t];return null===n.threadAtGeneration?S("choiceToChoose.threadAtGeneration"):null===n.targetPath?S("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");var i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");var r=[];r.push.apply(r,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);for(var a=new C;this.canContinue;)a.Append(this.Continue());var o=a.toString();this._state.ResetOutput(r);var u=this.state.CompleteFunctionEvaluationFromGame();return n?{returned:u,output:o}:u}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(u.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,e){if(null===t)return S("funcName");var n=this._externals.get(t),i=null;if(void 0===n){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(t),this.Assert(null!==i,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(u.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=R.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var r=[],a=0;a<e;++a){var o=c(this.state.PopEvaluationStack(),_).valueObject;r.push(o)}r.reverse();var s=n(r),l=null;null!=s?(l=_.Create(s),this.Assert(null!==l,"Could not create ink value from returned object of type "+typeof s)):l=new W,this.state.PushEvaluationStack(l)}},{key:"BindExternalFunctionGeneral",value:function(t,e){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,e)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunction",value:function(t,e){var n=this;this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){n.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");for(var i=[],r=0,a=t.length;r<a;r++)i[r]=n.TryCoerce(t[r]);return e.apply(null,i)})}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}},{key:"ValidateExternalBindings",value:function(){var t=null,e=null,n=arguments[1]||new Set;if(arguments[0]instanceof V&&(t=arguments[0]),arguments[0]instanceof b&&(e=arguments[0]),null===t&&null===e)if(this.ValidateExternalBindings(this._mainContentContainer,n),this._hasValidatedExternals=!0,0==n.size)this._hasValidatedExternals=!0;else{var r="Error: Missing function binding for external";r+=n.size>1?"s":"",r+=": '",r+=Array.from(n).join("', '"),r+="' ",r+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(r)}else if(null!=t){var a=!0,o=!1,u=void 0;try{for(var s,l=t.content[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var c=s.value;null!=c&&c.hasValidName||this.ValidateExternalBindings(c,n)}}catch(T){o=!0,u=T}finally{try{a||null==l.return||l.return()}finally{if(o)throw u}}var f=!0,v=!1,d=void 0;try{for(var y,p=t.namedContent[Symbol.iterator]();!(f=(y=p.next()).done);f=!0){var m=i(y.value,2),g=(m[0],m[1]);this.ValidateExternalBindings(h(g,b),n)}}catch(T){v=!0,d=T}finally{try{f||null==p.return||p.return()}finally{if(v)throw d}}}else if(null!=e){var C=h(e,D);if(C&&C.isExternal){var k=C.targetPathString;if(null===k)return S("name");this._externals.has(k)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(k)||n.add(k)}}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new w("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(void 0!==e){if(this._variableObservers.has(e)){var n=this._variableObservers.get(e);n.splice(n.indexOf(t),1)}}else{var i=this._variableObservers.keys(),r=!0,a=!1,o=void 0;try{for(var u,s=i[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=u.value,h=this._variableObservers.get(l);h.splice(h.indexOf(t),1)}}catch(c){a=!0,o=c}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}}}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!==this._variableObservers){var n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof _))throw new Error("Tried to get the value of a variable that isn't a standard type");var i=c(e,_),r=!0,a=!1,o=void 0;try{for(var u,s=n[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){(0,u.value)(t,i.valueObject)}}catch(l){a=!0,o=l}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}}}}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){var e=new s(t),n=this.ContentAtPath(e).container;if(null===n)return S("flowContainer");for(;;){var i=n.content[0];if(!(i instanceof V))break;n=i}var r=null,a=!0,o=!1,u=void 0;try{for(var l,c=n.content[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){var f=h(l.value,q);if(!f)break;null==r&&(r=[]),r.push(f.text)}}catch(v){o=!0,u=v}finally{try{a||null==c.return||c.return()}finally{if(o)throw u}}return r}},{key:"BuildStringOfHierarchy",value:function(){var t=new C;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new C;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=R.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(u.Function)?(this.state.PopCallStack(u.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new W),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return S("pointer.container");for(;e.index>=e.container.content.length;){t=!1;var n=h(e.container.parent,V);if(n instanceof V==0)break;var i=n.content.indexOf(e.container);if(-1==i)break;if((e=new R(n,i)).index++,t=!0,null===e.container)return S("pointer.container")}return t||(e=R.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.isInvisibleDefault});if(0==e.length||t.length>e.length)return!1;var n=e[0];return null===n.targetPath?S("choice.targetPath"):null===n.threadAtGeneration?S("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath,!1),!0)}},{key:"VisitCountForContainer",value:function(t){if(null===t)return S("container");if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var e=0,n=t.path.toString();return this.state.visitCounts.get(n)||e}},{key:"IncrementVisitCountForContainer",value:function(t){var e=0,n=t.path.toString();this.state.visitCounts.has(n)&&(e=this.state.visitCounts.get(n)),e++,this.state.visitCounts.set(n,e)}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e=t.path.toString();this.state.turnIndices.set(e,this.state.currentTurnIndex)}},{key:"TurnsSinceForContainer",value:function(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var e=t.path.toString(),n=this.state.turnIndices.get(e);return void 0!==n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var t=h(this.state.PopEvaluationStack(),x);if(!(t instanceof x))return this.Error("expected number of elements in sequence for shuffle index"),0;var e=this.state.currentPointer.container;if(null===e)return S("seqContainer");if(null===t.value)return S("numElementsIntVal.value");var n=t.value,i=c(this.state.PopEvaluationStack(),x).value;if(null===i)return S("seqCount");for(var r=i/n,a=i%n,o=e.path.toString(),u=0,s=0,l=o.length;s<l;s++)u+=o.charCodeAt(s)||0;for(var f=u+r+this.state.storySeed,v=new Q(Math.floor(f)),d=[],y=0;y<n;++y)d.push(y);for(var p=0;p<=a;++p){var m=v.next()%d.length,g=d[m];if(d.splice(m,1),p==a)return g}throw new Error("Should never reach here")}},{key:"Error",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=new w(t);throw n.useEndLineNumber=e,n}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=this.currentDebugMetadata,r=e?"WARNING":"ERROR";if(null!=i){var a=n?i.endLineNumber:i.startLineNumber;t="RUNTIME "+r+": '"+i.fileName+"' line "+a+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+r+": "+t:"RUNTIME "+r+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,e),e||this.state.ForceEnd()}},{key:"Assert",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}},{key:"currentChoices",get:function(){var t=[];if(null===this._state)return S("this._state");var e=!0,n=!1,i=void 0;try{for(var r,a=this._state.currentChoices[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=r.value;o.isInvisibleDefault||(o.index=t.length,t.push(o))}}catch(u){n=!0,i=u}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return t}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}},{key:"currentDebugMetadata",get:function(){var t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var n=this.state.callStack.elements.length-1;n>=0;--n)if(!(e=this.state.callStack.elements[n].currentPointer).isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var i=this.state.outputStream.length-1;i>=0;--i)if(null!==(t=this.state.outputStream[i].debugMetadata))return t;return null}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}]),e}(b);!function(t){!function(t){t[t.NoChange=0]="NoChange",t[t.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",t[t.NewlineRemoved=2]="NewlineRemoved"}(t.OutputStateChange||(t.OutputStateChange={}))}(tt||(tt={})),t.Story=tt,t.InkList=T,Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof t?c(exports):"function"==typeof define&&n(46)?define(["exports"],c):c((h=h||self).inkjs={})},39:function(t,e,n){"use strict";function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}n.d(e,"a",function(){return i})},40:function(t,e,n){"use strict";n.d(e,"a",function(){return r});var i=n(41);function r(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&Object(i.a)(t,e)}},41:function(t,e,n){"use strict";function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}n.d(e,"a",function(){return i})},42:function(t,e,n){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}n.d(e,"a",function(){return i})},43:function(t,e,n){"use strict";function i(t){return(i="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t){return(r="function"===typeof Symbol&&"symbol"===i(Symbol.iterator)?function(t){return i(t)}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":i(t)})(t)}function a(t,e){return!e||"object"!==r(e)&&"function"!==typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}n.d(e,"a",function(){return a})},46:function(t,e){(function(e){t.exports=e}).call(this,{})}}]);
//# sourceMappingURL=5.530cba02.chunk.js.map